{"ast":null,"code":"'use strict';\n\nvar mapboxgl = require('@plotly/mapbox-gl/dist/mapbox-gl-unminified');\nvar Lib = require('../../lib');\nvar geoUtils = require('../../lib/geo_location_utils');\nvar Registry = require('../../registry');\nvar Axes = require('../cartesian/axes');\nvar dragElement = require('../../components/dragelement');\nvar Fx = require('../../components/fx');\nvar dragHelpers = require('../../components/dragelement/helpers');\nvar drawMode = dragHelpers.drawMode;\nvar selectMode = dragHelpers.selectMode;\nvar prepSelect = require('../../components/selections').prepSelect;\nvar clearOutline = require('../../components/selections').clearOutline;\nvar clearSelectionsCache = require('../../components/selections').clearSelectionsCache;\nvar selectOnClick = require('../../components/selections').selectOnClick;\nvar constants = require('./constants');\nvar createMapboxLayer = require('./layers');\nfunction Mapbox(gd, id) {\n  this.id = id;\n  this.gd = gd;\n  var fullLayout = gd._fullLayout;\n  var context = gd._context;\n  this.container = fullLayout._glcontainer.node();\n  this.isStatic = context.staticPlot;\n\n  // unique id for this Mapbox instance\n  this.uid = fullLayout._uid + '-' + this.id;\n\n  // create framework on instantiation for a smoother first plot call\n  this.div = null;\n  this.xaxis = null;\n  this.yaxis = null;\n  this.createFramework(fullLayout);\n\n  // state variables used to infer how and what to update\n  this.map = null;\n  this.accessToken = null;\n  this.styleObj = null;\n  this.traceHash = {};\n  this.layerList = [];\n  this.belowLookup = {};\n  this.dragging = false;\n  this.wheeling = false;\n}\nvar proto = Mapbox.prototype;\nproto.plot = function (calcData, fullLayout, promises) {\n  var self = this;\n  var opts = fullLayout[self.id];\n\n  // remove map and create a new map if access token has change\n  if (self.map && opts.accesstoken !== self.accessToken) {\n    self.map.remove();\n    self.map = null;\n    self.styleObj = null;\n    self.traceHash = {};\n    self.layerList = [];\n  }\n  var promise;\n  if (!self.map) {\n    promise = new Promise(function (resolve, reject) {\n      self.createMap(calcData, fullLayout, resolve, reject);\n    });\n  } else {\n    promise = new Promise(function (resolve, reject) {\n      self.updateMap(calcData, fullLayout, resolve, reject);\n    });\n  }\n  promises.push(promise);\n};\nproto.createMap = function (calcData, fullLayout, resolve, reject) {\n  var self = this;\n  var opts = fullLayout[self.id];\n\n  // store style id and URL or object\n  var styleObj = self.styleObj = getStyleObj(opts.style, fullLayout);\n\n  // store access token associated with this map\n  self.accessToken = opts.accesstoken;\n  var bounds = opts.bounds;\n  var maxBounds = bounds ? [[bounds.west, bounds.south], [bounds.east, bounds.north]] : null;\n\n  // create the map!\n  var map = self.map = new mapboxgl.Map({\n    container: self.div,\n    style: styleObj.style,\n    center: convertCenter(opts.center),\n    zoom: opts.zoom,\n    bearing: opts.bearing,\n    pitch: opts.pitch,\n    maxBounds: maxBounds,\n    interactive: !self.isStatic,\n    preserveDrawingBuffer: self.isStatic,\n    doubleClickZoom: false,\n    boxZoom: false,\n    attributionControl: false\n  }).addControl(new mapboxgl.AttributionControl({\n    compact: true\n  }));\n\n  // make sure canvas does not inherit left and top css\n  map._canvas.style.left = '0px';\n  map._canvas.style.top = '0px';\n  self.rejectOnError(reject);\n  if (!self.isStatic) {\n    self.initFx(calcData, fullLayout);\n  }\n  var promises = [];\n  promises.push(new Promise(function (resolve) {\n    map.once('load', resolve);\n  }));\n  promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n  Promise.all(promises).then(function () {\n    self.fillBelowLookup(calcData, fullLayout);\n    self.updateData(calcData);\n    self.updateLayout(fullLayout);\n    self.resolveOnRender(resolve);\n  }).catch(reject);\n};\nproto.updateMap = function (calcData, fullLayout, resolve, reject) {\n  var self = this;\n  var map = self.map;\n  var opts = fullLayout[this.id];\n  self.rejectOnError(reject);\n  var promises = [];\n  var styleObj = getStyleObj(opts.style, fullLayout);\n  if (JSON.stringify(self.styleObj) !== JSON.stringify(styleObj)) {\n    self.styleObj = styleObj;\n    map.setStyle(styleObj.style);\n\n    // need to rebuild trace layers on reload\n    // to avoid 'lost event' errors\n    self.traceHash = {};\n    promises.push(new Promise(function (resolve) {\n      map.once('styledata', resolve);\n    }));\n  }\n  promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n  Promise.all(promises).then(function () {\n    self.fillBelowLookup(calcData, fullLayout);\n    self.updateData(calcData);\n    self.updateLayout(fullLayout);\n    self.resolveOnRender(resolve);\n  }).catch(reject);\n};\nproto.fillBelowLookup = function (calcData, fullLayout) {\n  var opts = fullLayout[this.id];\n  var layers = opts.layers;\n  var i, val;\n  var belowLookup = this.belowLookup = {};\n  var hasTraceAtTop = false;\n  for (i = 0; i < calcData.length; i++) {\n    var trace = calcData[i][0].trace;\n    var _module = trace._module;\n    if (typeof trace.below === 'string') {\n      val = trace.below;\n    } else if (_module.getBelow) {\n      // 'smart' default that depend the map's base layers\n      val = _module.getBelow(trace, this);\n    }\n    if (val === '') {\n      hasTraceAtTop = true;\n    }\n    belowLookup['trace-' + trace.uid] = val || '';\n  }\n  for (i = 0; i < layers.length; i++) {\n    var item = layers[i];\n    if (typeof item.below === 'string') {\n      val = item.below;\n    } else if (hasTraceAtTop) {\n      // if one or more trace(s) set `below:''` and\n      // layers[i].below is unset,\n      // place layer below traces\n      val = 'traces';\n    } else {\n      val = '';\n    }\n    belowLookup['layout-' + i] = val;\n  }\n\n  // N.B. If multiple layers have the 'below' value,\n  // we must clear the stashed 'below' field in order\n  // to make `traceHash[k].update()` and `layerList[i].update()`\n  // remove/add the all those layers to have preserve\n  // the correct layer ordering\n  var val2list = {};\n  var k, id;\n  for (k in belowLookup) {\n    val = belowLookup[k];\n    if (val2list[val]) {\n      val2list[val].push(k);\n    } else {\n      val2list[val] = [k];\n    }\n  }\n  for (val in val2list) {\n    var list = val2list[val];\n    if (list.length > 1) {\n      for (i = 0; i < list.length; i++) {\n        k = list[i];\n        if (k.indexOf('trace-') === 0) {\n          id = k.split('trace-')[1];\n          if (this.traceHash[id]) {\n            this.traceHash[id].below = null;\n          }\n        } else if (k.indexOf('layout-') === 0) {\n          id = k.split('layout-')[1];\n          if (this.layerList[id]) {\n            this.layerList[id].below = null;\n          }\n        }\n      }\n    }\n  }\n};\nvar traceType2orderIndex = {\n  choroplethmapbox: 0,\n  densitymapbox: 1,\n  scattermapbox: 2\n};\nproto.updateData = function (calcData) {\n  var traceHash = this.traceHash;\n  var traceObj, trace, i, j;\n\n  // Need to sort here by trace type here,\n  // in case traces with different `type` have the same\n  // below value, but sorting we ensure that\n  // e.g. choroplethmapbox traces will be below scattermapbox traces\n  var calcDataSorted = calcData.slice().sort(function (a, b) {\n    return traceType2orderIndex[a[0].trace.type] - traceType2orderIndex[b[0].trace.type];\n  });\n\n  // update or create trace objects\n  for (i = 0; i < calcDataSorted.length; i++) {\n    var calcTrace = calcDataSorted[i];\n    trace = calcTrace[0].trace;\n    traceObj = traceHash[trace.uid];\n    var didUpdate = false;\n    if (traceObj) {\n      if (traceObj.type === trace.type) {\n        traceObj.update(calcTrace);\n        didUpdate = true;\n      } else {\n        traceObj.dispose();\n      }\n    }\n    if (!didUpdate && trace._module) {\n      traceHash[trace.uid] = trace._module.plot(this, calcTrace);\n    }\n  }\n\n  // remove empty trace objects\n  var ids = Object.keys(traceHash);\n  idLoop: for (i = 0; i < ids.length; i++) {\n    var id = ids[i];\n    for (j = 0; j < calcData.length; j++) {\n      trace = calcData[j][0].trace;\n      if (id === trace.uid) continue idLoop;\n    }\n    traceObj = traceHash[id];\n    traceObj.dispose();\n    delete traceHash[id];\n  }\n};\nproto.updateLayout = function (fullLayout) {\n  var map = this.map;\n  var opts = fullLayout[this.id];\n  if (!this.dragging && !this.wheeling) {\n    map.setCenter(convertCenter(opts.center));\n    map.setZoom(opts.zoom);\n    map.setBearing(opts.bearing);\n    map.setPitch(opts.pitch);\n  }\n  this.updateLayers(fullLayout);\n  this.updateFramework(fullLayout);\n  this.updateFx(fullLayout);\n  this.map.resize();\n  if (this.gd._context._scrollZoom.mapbox) {\n    map.scrollZoom.enable();\n  } else {\n    map.scrollZoom.disable();\n  }\n};\nproto.resolveOnRender = function (resolve) {\n  var map = this.map;\n  map.on('render', function onRender() {\n    if (map.loaded()) {\n      map.off('render', onRender);\n      // resolve at end of render loop\n      //\n      // Need a 10ms delay (0ms should suffice to skip a thread in the\n      // render loop) to workaround mapbox-gl bug introduced in v1.3.0\n      setTimeout(resolve, 10);\n    }\n  });\n};\nproto.rejectOnError = function (reject) {\n  var map = this.map;\n  function handler() {\n    reject(new Error(constants.mapOnErrorMsg));\n  }\n  map.once('error', handler);\n  map.once('style.error', handler);\n  map.once('source.error', handler);\n  map.once('tile.error', handler);\n  map.once('layer.error', handler);\n};\nproto.createFramework = function (fullLayout) {\n  var self = this;\n  var div = self.div = document.createElement('div');\n  div.id = self.uid;\n  div.style.position = 'absolute';\n  self.container.appendChild(div);\n\n  // create mock x/y axes for hover routine\n  self.xaxis = {\n    _id: 'x',\n    c2p: function (v) {\n      return self.project(v).x;\n    }\n  };\n  self.yaxis = {\n    _id: 'y',\n    c2p: function (v) {\n      return self.project(v).y;\n    }\n  };\n  self.updateFramework(fullLayout);\n\n  // mock axis for hover formatting\n  self.mockAxis = {\n    type: 'linear',\n    showexponent: 'all',\n    exponentformat: 'B'\n  };\n  Axes.setConvert(self.mockAxis, fullLayout);\n};\nproto.initFx = function (calcData, fullLayout) {\n  var self = this;\n  var gd = self.gd;\n  var map = self.map;\n\n  // keep track of pan / zoom in user layout and emit relayout event\n  map.on('moveend', function (evt) {\n    if (!self.map) return;\n    var fullLayoutNow = gd._fullLayout;\n\n    // 'moveend' gets triggered by map.setCenter, map.setZoom,\n    // map.setBearing and map.setPitch.\n    //\n    // Here, we make sure that state updates amd 'plotly_relayout'\n    // are triggered only when the 'moveend' originates from a\n    // mouse target (filtering out API calls) to not\n    // duplicate 'plotly_relayout' events.\n\n    if (evt.originalEvent || self.wheeling) {\n      var optsNow = fullLayoutNow[self.id];\n      Registry.call('_storeDirectGUIEdit', gd.layout, fullLayoutNow._preGUI, self.getViewEdits(optsNow));\n      var viewNow = self.getView();\n      optsNow._input.center = optsNow.center = viewNow.center;\n      optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n      optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n      optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n      gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n    }\n    if (evt.originalEvent && evt.originalEvent.type === 'mouseup') {\n      self.dragging = false;\n    } else if (self.wheeling) {\n      self.wheeling = false;\n    }\n    if (fullLayoutNow._rehover) {\n      fullLayoutNow._rehover();\n    }\n  });\n  map.on('wheel', function () {\n    self.wheeling = true;\n  });\n  map.on('mousemove', function (evt) {\n    var bb = self.div.getBoundingClientRect();\n    var xy = [evt.originalEvent.offsetX, evt.originalEvent.offsetY];\n    evt.target.getBoundingClientRect = function () {\n      return bb;\n    };\n    self.xaxis.p2c = function () {\n      return map.unproject(xy).lng;\n    };\n    self.yaxis.p2c = function () {\n      return map.unproject(xy).lat;\n    };\n    gd._fullLayout._rehover = function () {\n      if (gd._fullLayout._hoversubplot === self.id && gd._fullLayout[self.id]) {\n        Fx.hover(gd, evt, self.id);\n      }\n    };\n    Fx.hover(gd, evt, self.id);\n    gd._fullLayout._hoversubplot = self.id;\n  });\n  function unhover() {\n    Fx.loneUnhover(fullLayout._hoverlayer);\n  }\n  map.on('dragstart', function () {\n    self.dragging = true;\n    unhover();\n  });\n  map.on('zoomstart', unhover);\n  map.on('mouseout', function () {\n    gd._fullLayout._hoversubplot = null;\n  });\n  function emitUpdate() {\n    var viewNow = self.getView();\n    gd.emit('plotly_relayouting', self.getViewEditsWithDerived(viewNow));\n  }\n  map.on('drag', emitUpdate);\n  map.on('zoom', emitUpdate);\n  map.on('dblclick', function () {\n    var optsNow = gd._fullLayout[self.id];\n    Registry.call('_storeDirectGUIEdit', gd.layout, gd._fullLayout._preGUI, self.getViewEdits(optsNow));\n    var viewInitial = self.viewInitial;\n    map.setCenter(convertCenter(viewInitial.center));\n    map.setZoom(viewInitial.zoom);\n    map.setBearing(viewInitial.bearing);\n    map.setPitch(viewInitial.pitch);\n    var viewNow = self.getView();\n    optsNow._input.center = optsNow.center = viewNow.center;\n    optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n    optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n    optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n    gd.emit('plotly_doubleclick', null);\n    gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n  });\n\n  // define event handlers on map creation, to keep one ref per map,\n  // so that map.on / map.off in updateFx works as expected\n  self.clearOutline = function () {\n    clearSelectionsCache(self.dragOptions);\n    clearOutline(self.dragOptions.gd);\n  };\n\n  /**\n   * Returns a click handler function that is supposed\n   * to handle clicks in pan mode.\n   */\n  self.onClickInPanFn = function (dragOptions) {\n    return function (evt) {\n      var clickMode = gd._fullLayout.clickmode;\n      if (clickMode.indexOf('select') > -1) {\n        selectOnClick(evt.originalEvent, gd, [self.xaxis], [self.yaxis], self.id, dragOptions);\n      }\n      if (clickMode.indexOf('event') > -1) {\n        // TODO: this does not support right-click. If we want to support it, we\n        // would likely need to change mapbox to use dragElement instead of straight\n        // mapbox event binding. Or perhaps better, make a simple wrapper with the\n        // right mousedown, mousemove, and mouseup handlers just for a left/right click\n        // pie would use this too.\n        Fx.click(gd, evt.originalEvent);\n      }\n    };\n  };\n};\nproto.updateFx = function (fullLayout) {\n  var self = this;\n  var map = self.map;\n  var gd = self.gd;\n  if (self.isStatic) return;\n  function invert(pxpy) {\n    var obj = self.map.unproject(pxpy);\n    return [obj.lng, obj.lat];\n  }\n  var dragMode = fullLayout.dragmode;\n  var fillRangeItems;\n  fillRangeItems = function (eventData, poly) {\n    if (poly.isRect) {\n      var ranges = eventData.range = {};\n      ranges[self.id] = [invert([poly.xmin, poly.ymin]), invert([poly.xmax, poly.ymax])];\n    } else {\n      var dataPts = eventData.lassoPoints = {};\n      dataPts[self.id] = poly.map(invert);\n    }\n  };\n\n  // Note: dragOptions is needed to be declared for all dragmodes because\n  // it's the object that holds persistent selection state.\n  // Merge old dragOptions with new to keep possibly initialized\n  // persistent selection state.\n  var oldDragOptions = self.dragOptions;\n  self.dragOptions = Lib.extendDeep(oldDragOptions || {}, {\n    dragmode: fullLayout.dragmode,\n    element: self.div,\n    gd: gd,\n    plotinfo: {\n      id: self.id,\n      domain: fullLayout[self.id].domain,\n      xaxis: self.xaxis,\n      yaxis: self.yaxis,\n      fillRangeItems: fillRangeItems\n    },\n    xaxes: [self.xaxis],\n    yaxes: [self.yaxis],\n    subplot: self.id\n  });\n\n  // Unregister the old handler before potentially registering\n  // a new one. Otherwise multiple click handlers might\n  // be registered resulting in unwanted behavior.\n  map.off('click', self.onClickInPanHandler);\n  if (selectMode(dragMode) || drawMode(dragMode)) {\n    map.dragPan.disable();\n    map.on('zoomstart', self.clearOutline);\n    self.dragOptions.prepFn = function (e, startX, startY) {\n      prepSelect(e, startX, startY, self.dragOptions, dragMode);\n    };\n    dragElement.init(self.dragOptions);\n  } else {\n    map.dragPan.enable();\n    map.off('zoomstart', self.clearOutline);\n    self.div.onmousedown = null;\n    self.div.ontouchstart = null;\n    self.div.removeEventListener('touchstart', self.div._ontouchstart);\n    // TODO: this does not support right-click. If we want to support it, we\n    // would likely need to change mapbox to use dragElement instead of straight\n    // mapbox event binding. Or perhaps better, make a simple wrapper with the\n    // right mousedown, mousemove, and mouseup handlers just for a left/right click\n    // pie would use this too.\n    self.onClickInPanHandler = self.onClickInPanFn(self.dragOptions);\n    map.on('click', self.onClickInPanHandler);\n  }\n};\nproto.updateFramework = function (fullLayout) {\n  var domain = fullLayout[this.id].domain;\n  var size = fullLayout._size;\n  var style = this.div.style;\n  style.width = size.w * (domain.x[1] - domain.x[0]) + 'px';\n  style.height = size.h * (domain.y[1] - domain.y[0]) + 'px';\n  style.left = size.l + domain.x[0] * size.w + 'px';\n  style.top = size.t + (1 - domain.y[1]) * size.h + 'px';\n  this.xaxis._offset = size.l + domain.x[0] * size.w;\n  this.xaxis._length = size.w * (domain.x[1] - domain.x[0]);\n  this.yaxis._offset = size.t + (1 - domain.y[1]) * size.h;\n  this.yaxis._length = size.h * (domain.y[1] - domain.y[0]);\n};\nproto.updateLayers = function (fullLayout) {\n  var opts = fullLayout[this.id];\n  var layers = opts.layers;\n  var layerList = this.layerList;\n  var i;\n\n  // if the layer arrays don't match,\n  // don't try to be smart,\n  // delete them all, and start all over.\n\n  if (layers.length !== layerList.length) {\n    for (i = 0; i < layerList.length; i++) {\n      layerList[i].dispose();\n    }\n    layerList = this.layerList = [];\n    for (i = 0; i < layers.length; i++) {\n      layerList.push(createMapboxLayer(this, i, layers[i]));\n    }\n  } else {\n    for (i = 0; i < layers.length; i++) {\n      layerList[i].update(layers[i]);\n    }\n  }\n};\nproto.destroy = function () {\n  if (this.map) {\n    this.map.remove();\n    this.map = null;\n    this.container.removeChild(this.div);\n  }\n};\nproto.toImage = function () {\n  this.map.stop();\n  return this.map.getCanvas().toDataURL();\n};\n\n// convenience wrapper to create set multiple layer\n// 'layout' or 'paint options at once.\nproto.setOptions = function (id, methodName, opts) {\n  for (var k in opts) {\n    this.map[methodName](id, k, opts[k]);\n  }\n};\nproto.getMapLayers = function () {\n  return this.map.getStyle().layers;\n};\n\n// convenience wrapper that first check in 'below' references\n// a layer that exist and then add the layer to the map,\nproto.addLayer = function (opts, below) {\n  var map = this.map;\n  if (typeof below === 'string') {\n    if (below === '') {\n      map.addLayer(opts, below);\n      return;\n    }\n    var mapLayers = this.getMapLayers();\n    for (var i = 0; i < mapLayers.length; i++) {\n      if (below === mapLayers[i].id) {\n        map.addLayer(opts, below);\n        return;\n      }\n    }\n    Lib.warn(['Trying to add layer with *below* value', below, 'referencing a layer that does not exist', 'or that does not yet exist.'].join(' '));\n  }\n  map.addLayer(opts);\n};\n\n// convenience method to project a [lon, lat] array to pixel coords\nproto.project = function (v) {\n  return this.map.project(new mapboxgl.LngLat(v[0], v[1]));\n};\n\n// get map's current view values in plotly.js notation\nproto.getView = function () {\n  var map = this.map;\n  var mapCenter = map.getCenter();\n  var lon = mapCenter.lng;\n  var lat = mapCenter.lat;\n  var center = {\n    lon: lon,\n    lat: lat\n  };\n  var canvas = map.getCanvas();\n  var w = parseInt(canvas.style.width);\n  var h = parseInt(canvas.style.height);\n  return {\n    center: center,\n    zoom: map.getZoom(),\n    bearing: map.getBearing(),\n    pitch: map.getPitch(),\n    _derived: {\n      coordinates: [map.unproject([0, 0]).toArray(), map.unproject([w, 0]).toArray(), map.unproject([w, h]).toArray(), map.unproject([0, h]).toArray()]\n    }\n  };\n};\nproto.getViewEdits = function (cont) {\n  var id = this.id;\n  var keys = ['center', 'zoom', 'bearing', 'pitch'];\n  var obj = {};\n  for (var i = 0; i < keys.length; i++) {\n    var k = keys[i];\n    obj[id + '.' + k] = cont[k];\n  }\n  return obj;\n};\nproto.getViewEditsWithDerived = function (cont) {\n  var id = this.id;\n  var obj = this.getViewEdits(cont);\n  obj[id + '._derived'] = cont._derived;\n  return obj;\n};\nfunction getStyleObj(val, fullLayout) {\n  var styleObj = {};\n  if (Lib.isPlainObject(val)) {\n    styleObj.id = val.id;\n    styleObj.style = val;\n  } else if (typeof val === 'string') {\n    styleObj.id = val;\n    if (constants.styleValuesMapbox.indexOf(val) !== -1) {\n      styleObj.style = convertStyleVal(val);\n    } else if (constants.stylesNonMapbox[val]) {\n      styleObj.style = constants.stylesNonMapbox[val];\n      var spec = styleObj.style.sources['plotly-' + val];\n      var tiles = spec ? spec.tiles : undefined;\n      if (tiles && tiles[0] && tiles[0].slice(-9) === '?api_key=') {\n        // provide api_key for stamen styles\n        tiles[0] += fullLayout._mapboxAccessToken;\n      }\n    } else {\n      styleObj.style = val;\n    }\n  } else {\n    styleObj.id = constants.styleValueDflt;\n    styleObj.style = convertStyleVal(constants.styleValueDflt);\n  }\n  styleObj.transition = {\n    duration: 0,\n    delay: 0\n  };\n  return styleObj;\n}\n\n// if style is part of the 'official' mapbox values, add URL prefix and suffix\nfunction convertStyleVal(val) {\n  return constants.styleUrlPrefix + val + '-' + constants.styleUrlSuffix;\n}\nfunction convertCenter(center) {\n  return [center.lon, center.lat];\n}\nmodule.exports = Mapbox;","map":{"version":3,"names":["mapboxgl","require","Lib","geoUtils","Registry","Axes","dragElement","Fx","dragHelpers","drawMode","selectMode","prepSelect","clearOutline","clearSelectionsCache","selectOnClick","constants","createMapboxLayer","Mapbox","gd","id","fullLayout","_fullLayout","context","_context","container","_glcontainer","node","isStatic","staticPlot","uid","_uid","div","xaxis","yaxis","createFramework","map","accessToken","styleObj","traceHash","layerList","belowLookup","dragging","wheeling","proto","prototype","plot","calcData","promises","self","opts","accesstoken","remove","promise","Promise","resolve","reject","createMap","updateMap","push","getStyleObj","style","bounds","maxBounds","west","south","east","north","Map","center","convertCenter","zoom","bearing","pitch","interactive","preserveDrawingBuffer","doubleClickZoom","boxZoom","attributionControl","addControl","AttributionControl","compact","_canvas","left","top","rejectOnError","initFx","once","concat","fetchTraceGeoData","all","then","fillBelowLookup","updateData","updateLayout","resolveOnRender","catch","JSON","stringify","setStyle","layers","i","val","hasTraceAtTop","length","trace","_module","below","getBelow","item","val2list","k","list","indexOf","split","traceType2orderIndex","choroplethmapbox","densitymapbox","scattermapbox","traceObj","j","calcDataSorted","slice","sort","a","b","type","calcTrace","didUpdate","update","dispose","ids","Object","keys","idLoop","setCenter","setZoom","setBearing","setPitch","updateLayers","updateFramework","updateFx","resize","_scrollZoom","mapbox","scrollZoom","enable","disable","on","onRender","loaded","off","setTimeout","handler","Error","mapOnErrorMsg","document","createElement","position","appendChild","_id","c2p","v","project","x","y","mockAxis","showexponent","exponentformat","setConvert","evt","fullLayoutNow","originalEvent","optsNow","call","layout","_preGUI","getViewEdits","viewNow","getView","_input","emit","getViewEditsWithDerived","_rehover","bb","getBoundingClientRect","xy","offsetX","offsetY","target","p2c","unproject","lng","lat","_hoversubplot","hover","unhover","loneUnhover","_hoverlayer","emitUpdate","viewInitial","dragOptions","onClickInPanFn","clickMode","clickmode","click","invert","pxpy","obj","dragMode","dragmode","fillRangeItems","eventData","poly","isRect","ranges","range","xmin","ymin","xmax","ymax","dataPts","lassoPoints","oldDragOptions","extendDeep","element","plotinfo","domain","xaxes","yaxes","subplot","onClickInPanHandler","dragPan","prepFn","e","startX","startY","init","onmousedown","ontouchstart","removeEventListener","_ontouchstart","size","_size","width","w","height","h","l","t","_offset","_length","destroy","removeChild","toImage","stop","getCanvas","toDataURL","setOptions","methodName","getMapLayers","getStyle","addLayer","mapLayers","warn","join","LngLat","mapCenter","getCenter","lon","canvas","parseInt","getZoom","getBearing","getPitch","_derived","coordinates","toArray","cont","isPlainObject","styleValuesMapbox","convertStyleVal","stylesNonMapbox","spec","sources","tiles","undefined","_mapboxAccessToken","styleValueDflt","transition","duration","delay","styleUrlPrefix","styleUrlSuffix","module","exports"],"sources":["E:/tog_workspace/TestFabric_main/TestFabric-main/node_modules/plotly.js/src/plots/mapbox/mapbox.js"],"sourcesContent":["'use strict';\n\nvar mapboxgl = require('@plotly/mapbox-gl/dist/mapbox-gl-unminified');\n\nvar Lib = require('../../lib');\nvar geoUtils = require('../../lib/geo_location_utils');\nvar Registry = require('../../registry');\nvar Axes = require('../cartesian/axes');\nvar dragElement = require('../../components/dragelement');\n\nvar Fx = require('../../components/fx');\nvar dragHelpers = require('../../components/dragelement/helpers');\nvar drawMode = dragHelpers.drawMode;\nvar selectMode = dragHelpers.selectMode;\n\nvar prepSelect = require('../../components/selections').prepSelect;\nvar clearOutline = require('../../components/selections').clearOutline;\nvar clearSelectionsCache = require('../../components/selections').clearSelectionsCache;\nvar selectOnClick = require('../../components/selections').selectOnClick;\n\nvar constants = require('./constants');\nvar createMapboxLayer = require('./layers');\n\nfunction Mapbox(gd, id) {\n    this.id = id;\n    this.gd = gd;\n\n    var fullLayout = gd._fullLayout;\n    var context = gd._context;\n\n    this.container = fullLayout._glcontainer.node();\n    this.isStatic = context.staticPlot;\n\n    // unique id for this Mapbox instance\n    this.uid = fullLayout._uid + '-' + this.id;\n\n    // create framework on instantiation for a smoother first plot call\n    this.div = null;\n    this.xaxis = null;\n    this.yaxis = null;\n    this.createFramework(fullLayout);\n\n    // state variables used to infer how and what to update\n    this.map = null;\n    this.accessToken = null;\n    this.styleObj = null;\n    this.traceHash = {};\n    this.layerList = [];\n    this.belowLookup = {};\n    this.dragging = false;\n    this.wheeling = false;\n}\n\nvar proto = Mapbox.prototype;\n\nproto.plot = function(calcData, fullLayout, promises) {\n    var self = this;\n    var opts = fullLayout[self.id];\n\n    // remove map and create a new map if access token has change\n    if(self.map && (opts.accesstoken !== self.accessToken)) {\n        self.map.remove();\n        self.map = null;\n        self.styleObj = null;\n        self.traceHash = {};\n        self.layerList = [];\n    }\n\n    var promise;\n\n    if(!self.map) {\n        promise = new Promise(function(resolve, reject) {\n            self.createMap(calcData, fullLayout, resolve, reject);\n        });\n    } else {\n        promise = new Promise(function(resolve, reject) {\n            self.updateMap(calcData, fullLayout, resolve, reject);\n        });\n    }\n\n    promises.push(promise);\n};\n\nproto.createMap = function(calcData, fullLayout, resolve, reject) {\n    var self = this;\n    var opts = fullLayout[self.id];\n\n    // store style id and URL or object\n    var styleObj = self.styleObj = getStyleObj(opts.style, fullLayout);\n\n    // store access token associated with this map\n    self.accessToken = opts.accesstoken;\n\n    var bounds = opts.bounds;\n    var maxBounds = bounds ? [[bounds.west, bounds.south], [bounds.east, bounds.north]] : null;\n\n    // create the map!\n    var map = self.map = new mapboxgl.Map({\n        container: self.div,\n\n        style: styleObj.style,\n        center: convertCenter(opts.center),\n        zoom: opts.zoom,\n        bearing: opts.bearing,\n        pitch: opts.pitch,\n        maxBounds: maxBounds,\n\n        interactive: !self.isStatic,\n        preserveDrawingBuffer: self.isStatic,\n\n        doubleClickZoom: false,\n        boxZoom: false,\n\n        attributionControl: false\n    })\n    .addControl(new mapboxgl.AttributionControl({\n        compact: true\n    }));\n\n\n    // make sure canvas does not inherit left and top css\n    map._canvas.style.left = '0px';\n    map._canvas.style.top = '0px';\n\n    self.rejectOnError(reject);\n\n    if(!self.isStatic) {\n        self.initFx(calcData, fullLayout);\n    }\n\n    var promises = [];\n\n    promises.push(new Promise(function(resolve) {\n        map.once('load', resolve);\n    }));\n\n    promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n\n    Promise.all(promises).then(function() {\n        self.fillBelowLookup(calcData, fullLayout);\n        self.updateData(calcData);\n        self.updateLayout(fullLayout);\n        self.resolveOnRender(resolve);\n    }).catch(reject);\n};\n\nproto.updateMap = function(calcData, fullLayout, resolve, reject) {\n    var self = this;\n    var map = self.map;\n    var opts = fullLayout[this.id];\n\n    self.rejectOnError(reject);\n\n    var promises = [];\n    var styleObj = getStyleObj(opts.style, fullLayout);\n\n    if(JSON.stringify(self.styleObj) !== JSON.stringify(styleObj)) {\n        self.styleObj = styleObj;\n        map.setStyle(styleObj.style);\n\n        // need to rebuild trace layers on reload\n        // to avoid 'lost event' errors\n        self.traceHash = {};\n\n        promises.push(new Promise(function(resolve) {\n            map.once('styledata', resolve);\n        }));\n    }\n\n    promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n\n    Promise.all(promises).then(function() {\n        self.fillBelowLookup(calcData, fullLayout);\n        self.updateData(calcData);\n        self.updateLayout(fullLayout);\n        self.resolveOnRender(resolve);\n    }).catch(reject);\n};\n\nproto.fillBelowLookup = function(calcData, fullLayout) {\n    var opts = fullLayout[this.id];\n    var layers = opts.layers;\n    var i, val;\n\n    var belowLookup = this.belowLookup = {};\n    var hasTraceAtTop = false;\n\n    for(i = 0; i < calcData.length; i++) {\n        var trace = calcData[i][0].trace;\n        var _module = trace._module;\n\n        if(typeof trace.below === 'string') {\n            val = trace.below;\n        } else if(_module.getBelow) {\n            // 'smart' default that depend the map's base layers\n            val = _module.getBelow(trace, this);\n        }\n\n        if(val === '') {\n            hasTraceAtTop = true;\n        }\n\n        belowLookup['trace-' + trace.uid] = val || '';\n    }\n\n    for(i = 0; i < layers.length; i++) {\n        var item = layers[i];\n\n        if(typeof item.below === 'string') {\n            val = item.below;\n        } else if(hasTraceAtTop) {\n            // if one or more trace(s) set `below:''` and\n            // layers[i].below is unset,\n            // place layer below traces\n            val = 'traces';\n        } else {\n            val = '';\n        }\n\n        belowLookup['layout-' + i] = val;\n    }\n\n    // N.B. If multiple layers have the 'below' value,\n    // we must clear the stashed 'below' field in order\n    // to make `traceHash[k].update()` and `layerList[i].update()`\n    // remove/add the all those layers to have preserve\n    // the correct layer ordering\n    var val2list = {};\n    var k, id;\n\n    for(k in belowLookup) {\n        val = belowLookup[k];\n        if(val2list[val]) {\n            val2list[val].push(k);\n        } else {\n            val2list[val] = [k];\n        }\n    }\n\n    for(val in val2list) {\n        var list = val2list[val];\n        if(list.length > 1) {\n            for(i = 0; i < list.length; i++) {\n                k = list[i];\n                if(k.indexOf('trace-') === 0) {\n                    id = k.split('trace-')[1];\n                    if(this.traceHash[id]) {\n                        this.traceHash[id].below = null;\n                    }\n                } else if(k.indexOf('layout-') === 0) {\n                    id = k.split('layout-')[1];\n                    if(this.layerList[id]) {\n                        this.layerList[id].below = null;\n                    }\n                }\n            }\n        }\n    }\n};\n\nvar traceType2orderIndex = {\n    choroplethmapbox: 0,\n    densitymapbox: 1,\n    scattermapbox: 2\n};\n\nproto.updateData = function(calcData) {\n    var traceHash = this.traceHash;\n    var traceObj, trace, i, j;\n\n    // Need to sort here by trace type here,\n    // in case traces with different `type` have the same\n    // below value, but sorting we ensure that\n    // e.g. choroplethmapbox traces will be below scattermapbox traces\n    var calcDataSorted = calcData.slice().sort(function(a, b) {\n        return (\n            traceType2orderIndex[a[0].trace.type] -\n            traceType2orderIndex[b[0].trace.type]\n        );\n    });\n\n    // update or create trace objects\n    for(i = 0; i < calcDataSorted.length; i++) {\n        var calcTrace = calcDataSorted[i];\n\n        trace = calcTrace[0].trace;\n        traceObj = traceHash[trace.uid];\n\n        var didUpdate = false;\n        if(traceObj) {\n            if(traceObj.type === trace.type) {\n                traceObj.update(calcTrace);\n                didUpdate = true;\n            } else {\n                traceObj.dispose();\n            }\n        }\n        if(!didUpdate && trace._module) {\n            traceHash[trace.uid] = trace._module.plot(this, calcTrace);\n        }\n    }\n\n    // remove empty trace objects\n    var ids = Object.keys(traceHash);\n    idLoop:\n    for(i = 0; i < ids.length; i++) {\n        var id = ids[i];\n\n        for(j = 0; j < calcData.length; j++) {\n            trace = calcData[j][0].trace;\n            if(id === trace.uid) continue idLoop;\n        }\n\n        traceObj = traceHash[id];\n        traceObj.dispose();\n        delete traceHash[id];\n    }\n};\n\nproto.updateLayout = function(fullLayout) {\n    var map = this.map;\n    var opts = fullLayout[this.id];\n\n    if(!this.dragging && !this.wheeling) {\n        map.setCenter(convertCenter(opts.center));\n        map.setZoom(opts.zoom);\n        map.setBearing(opts.bearing);\n        map.setPitch(opts.pitch);\n    }\n\n    this.updateLayers(fullLayout);\n    this.updateFramework(fullLayout);\n    this.updateFx(fullLayout);\n    this.map.resize();\n\n    if(this.gd._context._scrollZoom.mapbox) {\n        map.scrollZoom.enable();\n    } else {\n        map.scrollZoom.disable();\n    }\n};\n\nproto.resolveOnRender = function(resolve) {\n    var map = this.map;\n\n    map.on('render', function onRender() {\n        if(map.loaded()) {\n            map.off('render', onRender);\n            // resolve at end of render loop\n            //\n            // Need a 10ms delay (0ms should suffice to skip a thread in the\n            // render loop) to workaround mapbox-gl bug introduced in v1.3.0\n            setTimeout(resolve, 10);\n        }\n    });\n};\n\nproto.rejectOnError = function(reject) {\n    var map = this.map;\n\n    function handler() {\n        reject(new Error(constants.mapOnErrorMsg));\n    }\n\n    map.once('error', handler);\n    map.once('style.error', handler);\n    map.once('source.error', handler);\n    map.once('tile.error', handler);\n    map.once('layer.error', handler);\n};\n\nproto.createFramework = function(fullLayout) {\n    var self = this;\n\n    var div = self.div = document.createElement('div');\n    div.id = self.uid;\n    div.style.position = 'absolute';\n    self.container.appendChild(div);\n\n    // create mock x/y axes for hover routine\n    self.xaxis = {\n        _id: 'x',\n        c2p: function(v) { return self.project(v).x; }\n    };\n    self.yaxis = {\n        _id: 'y',\n        c2p: function(v) { return self.project(v).y; }\n    };\n\n    self.updateFramework(fullLayout);\n\n    // mock axis for hover formatting\n    self.mockAxis = {\n        type: 'linear',\n        showexponent: 'all',\n        exponentformat: 'B'\n    };\n    Axes.setConvert(self.mockAxis, fullLayout);\n};\n\nproto.initFx = function(calcData, fullLayout) {\n    var self = this;\n    var gd = self.gd;\n    var map = self.map;\n\n    // keep track of pan / zoom in user layout and emit relayout event\n    map.on('moveend', function(evt) {\n        if(!self.map) return;\n\n        var fullLayoutNow = gd._fullLayout;\n\n        // 'moveend' gets triggered by map.setCenter, map.setZoom,\n        // map.setBearing and map.setPitch.\n        //\n        // Here, we make sure that state updates amd 'plotly_relayout'\n        // are triggered only when the 'moveend' originates from a\n        // mouse target (filtering out API calls) to not\n        // duplicate 'plotly_relayout' events.\n\n        if(evt.originalEvent || self.wheeling) {\n            var optsNow = fullLayoutNow[self.id];\n            Registry.call('_storeDirectGUIEdit', gd.layout, fullLayoutNow._preGUI, self.getViewEdits(optsNow));\n\n            var viewNow = self.getView();\n            optsNow._input.center = optsNow.center = viewNow.center;\n            optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n            optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n            optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n            gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n        }\n        if(evt.originalEvent && evt.originalEvent.type === 'mouseup') {\n            self.dragging = false;\n        } else if(self.wheeling) {\n            self.wheeling = false;\n        }\n\n        if(fullLayoutNow._rehover) {\n            fullLayoutNow._rehover();\n        }\n    });\n\n    map.on('wheel', function() {\n        self.wheeling = true;\n    });\n\n    map.on('mousemove', function(evt) {\n        var bb = self.div.getBoundingClientRect();\n        var xy = [\n            evt.originalEvent.offsetX,\n            evt.originalEvent.offsetY\n        ];\n\n        evt.target.getBoundingClientRect = function() { return bb; };\n\n        self.xaxis.p2c = function() { return map.unproject(xy).lng; };\n        self.yaxis.p2c = function() { return map.unproject(xy).lat; };\n\n        gd._fullLayout._rehover = function() {\n            if(gd._fullLayout._hoversubplot === self.id && gd._fullLayout[self.id]) {\n                Fx.hover(gd, evt, self.id);\n            }\n        };\n\n        Fx.hover(gd, evt, self.id);\n        gd._fullLayout._hoversubplot = self.id;\n    });\n\n    function unhover() {\n        Fx.loneUnhover(fullLayout._hoverlayer);\n    }\n\n    map.on('dragstart', function() {\n        self.dragging = true;\n        unhover();\n    });\n    map.on('zoomstart', unhover);\n\n    map.on('mouseout', function() {\n        gd._fullLayout._hoversubplot = null;\n    });\n\n    function emitUpdate() {\n        var viewNow = self.getView();\n        gd.emit('plotly_relayouting', self.getViewEditsWithDerived(viewNow));\n    }\n\n    map.on('drag', emitUpdate);\n    map.on('zoom', emitUpdate);\n\n    map.on('dblclick', function() {\n        var optsNow = gd._fullLayout[self.id];\n        Registry.call('_storeDirectGUIEdit', gd.layout, gd._fullLayout._preGUI, self.getViewEdits(optsNow));\n\n        var viewInitial = self.viewInitial;\n        map.setCenter(convertCenter(viewInitial.center));\n        map.setZoom(viewInitial.zoom);\n        map.setBearing(viewInitial.bearing);\n        map.setPitch(viewInitial.pitch);\n\n        var viewNow = self.getView();\n        optsNow._input.center = optsNow.center = viewNow.center;\n        optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n        optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n        optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n\n        gd.emit('plotly_doubleclick', null);\n        gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n    });\n\n    // define event handlers on map creation, to keep one ref per map,\n    // so that map.on / map.off in updateFx works as expected\n    self.clearOutline = function() {\n        clearSelectionsCache(self.dragOptions);\n        clearOutline(self.dragOptions.gd);\n    };\n\n    /**\n     * Returns a click handler function that is supposed\n     * to handle clicks in pan mode.\n     */\n    self.onClickInPanFn = function(dragOptions) {\n        return function(evt) {\n            var clickMode = gd._fullLayout.clickmode;\n\n            if(clickMode.indexOf('select') > -1) {\n                selectOnClick(evt.originalEvent, gd, [self.xaxis], [self.yaxis], self.id, dragOptions);\n            }\n\n            if(clickMode.indexOf('event') > -1) {\n                // TODO: this does not support right-click. If we want to support it, we\n                // would likely need to change mapbox to use dragElement instead of straight\n                // mapbox event binding. Or perhaps better, make a simple wrapper with the\n                // right mousedown, mousemove, and mouseup handlers just for a left/right click\n                // pie would use this too.\n                Fx.click(gd, evt.originalEvent);\n            }\n        };\n    };\n};\n\nproto.updateFx = function(fullLayout) {\n    var self = this;\n    var map = self.map;\n    var gd = self.gd;\n\n    if(self.isStatic) return;\n\n    function invert(pxpy) {\n        var obj = self.map.unproject(pxpy);\n        return [obj.lng, obj.lat];\n    }\n\n    var dragMode = fullLayout.dragmode;\n    var fillRangeItems;\n\n    fillRangeItems = function(eventData, poly) {\n        if(poly.isRect) {\n            var ranges = eventData.range = {};\n            ranges[self.id] = [\n                invert([poly.xmin, poly.ymin]),\n                invert([poly.xmax, poly.ymax])\n            ];\n        } else {\n            var dataPts = eventData.lassoPoints = {};\n            dataPts[self.id] = poly.map(invert);\n        }\n    };\n\n    // Note: dragOptions is needed to be declared for all dragmodes because\n    // it's the object that holds persistent selection state.\n    // Merge old dragOptions with new to keep possibly initialized\n    // persistent selection state.\n    var oldDragOptions = self.dragOptions;\n    self.dragOptions = Lib.extendDeep(oldDragOptions || {}, {\n        dragmode: fullLayout.dragmode,\n        element: self.div,\n        gd: gd,\n        plotinfo: {\n            id: self.id,\n            domain: fullLayout[self.id].domain,\n            xaxis: self.xaxis,\n            yaxis: self.yaxis,\n            fillRangeItems: fillRangeItems\n        },\n        xaxes: [self.xaxis],\n        yaxes: [self.yaxis],\n        subplot: self.id\n    });\n\n    // Unregister the old handler before potentially registering\n    // a new one. Otherwise multiple click handlers might\n    // be registered resulting in unwanted behavior.\n    map.off('click', self.onClickInPanHandler);\n    if(selectMode(dragMode) || drawMode(dragMode)) {\n        map.dragPan.disable();\n        map.on('zoomstart', self.clearOutline);\n\n        self.dragOptions.prepFn = function(e, startX, startY) {\n            prepSelect(e, startX, startY, self.dragOptions, dragMode);\n        };\n\n        dragElement.init(self.dragOptions);\n    } else {\n        map.dragPan.enable();\n        map.off('zoomstart', self.clearOutline);\n        self.div.onmousedown = null;\n        self.div.ontouchstart = null;\n        self.div.removeEventListener('touchstart', self.div._ontouchstart);\n        // TODO: this does not support right-click. If we want to support it, we\n        // would likely need to change mapbox to use dragElement instead of straight\n        // mapbox event binding. Or perhaps better, make a simple wrapper with the\n        // right mousedown, mousemove, and mouseup handlers just for a left/right click\n        // pie would use this too.\n        self.onClickInPanHandler = self.onClickInPanFn(self.dragOptions);\n        map.on('click', self.onClickInPanHandler);\n    }\n};\n\nproto.updateFramework = function(fullLayout) {\n    var domain = fullLayout[this.id].domain;\n    var size = fullLayout._size;\n\n    var style = this.div.style;\n    style.width = size.w * (domain.x[1] - domain.x[0]) + 'px';\n    style.height = size.h * (domain.y[1] - domain.y[0]) + 'px';\n    style.left = size.l + domain.x[0] * size.w + 'px';\n    style.top = size.t + (1 - domain.y[1]) * size.h + 'px';\n\n    this.xaxis._offset = size.l + domain.x[0] * size.w;\n    this.xaxis._length = size.w * (domain.x[1] - domain.x[0]);\n\n    this.yaxis._offset = size.t + (1 - domain.y[1]) * size.h;\n    this.yaxis._length = size.h * (domain.y[1] - domain.y[0]);\n};\n\nproto.updateLayers = function(fullLayout) {\n    var opts = fullLayout[this.id];\n    var layers = opts.layers;\n    var layerList = this.layerList;\n    var i;\n\n    // if the layer arrays don't match,\n    // don't try to be smart,\n    // delete them all, and start all over.\n\n    if(layers.length !== layerList.length) {\n        for(i = 0; i < layerList.length; i++) {\n            layerList[i].dispose();\n        }\n\n        layerList = this.layerList = [];\n\n        for(i = 0; i < layers.length; i++) {\n            layerList.push(createMapboxLayer(this, i, layers[i]));\n        }\n    } else {\n        for(i = 0; i < layers.length; i++) {\n            layerList[i].update(layers[i]);\n        }\n    }\n};\n\nproto.destroy = function() {\n    if(this.map) {\n        this.map.remove();\n        this.map = null;\n        this.container.removeChild(this.div);\n    }\n};\n\nproto.toImage = function() {\n    this.map.stop();\n    return this.map.getCanvas().toDataURL();\n};\n\n// convenience wrapper to create set multiple layer\n// 'layout' or 'paint options at once.\nproto.setOptions = function(id, methodName, opts) {\n    for(var k in opts) {\n        this.map[methodName](id, k, opts[k]);\n    }\n};\n\nproto.getMapLayers = function() {\n    return this.map.getStyle().layers;\n};\n\n// convenience wrapper that first check in 'below' references\n// a layer that exist and then add the layer to the map,\nproto.addLayer = function(opts, below) {\n    var map = this.map;\n\n    if(typeof below === 'string') {\n        if(below === '') {\n            map.addLayer(opts, below);\n            return;\n        }\n\n        var mapLayers = this.getMapLayers();\n        for(var i = 0; i < mapLayers.length; i++) {\n            if(below === mapLayers[i].id) {\n                map.addLayer(opts, below);\n                return;\n            }\n        }\n\n        Lib.warn([\n            'Trying to add layer with *below* value',\n            below,\n            'referencing a layer that does not exist',\n            'or that does not yet exist.'\n        ].join(' '));\n    }\n\n    map.addLayer(opts);\n};\n\n// convenience method to project a [lon, lat] array to pixel coords\nproto.project = function(v) {\n    return this.map.project(new mapboxgl.LngLat(v[0], v[1]));\n};\n\n// get map's current view values in plotly.js notation\nproto.getView = function() {\n    var map = this.map;\n    var mapCenter = map.getCenter();\n    var lon = mapCenter.lng;\n    var lat = mapCenter.lat;\n    var center = { lon: lon, lat: lat };\n\n    var canvas = map.getCanvas();\n    var w = parseInt(canvas.style.width);\n    var h = parseInt(canvas.style.height);\n\n    return {\n        center: center,\n        zoom: map.getZoom(),\n        bearing: map.getBearing(),\n        pitch: map.getPitch(),\n        _derived: {\n            coordinates: [\n                map.unproject([0, 0]).toArray(),\n                map.unproject([w, 0]).toArray(),\n                map.unproject([w, h]).toArray(),\n                map.unproject([0, h]).toArray()\n            ]\n        }\n    };\n};\n\nproto.getViewEdits = function(cont) {\n    var id = this.id;\n    var keys = ['center', 'zoom', 'bearing', 'pitch'];\n    var obj = {};\n\n    for(var i = 0; i < keys.length; i++) {\n        var k = keys[i];\n        obj[id + '.' + k] = cont[k];\n    }\n\n    return obj;\n};\n\nproto.getViewEditsWithDerived = function(cont) {\n    var id = this.id;\n    var obj = this.getViewEdits(cont);\n    obj[id + '._derived'] = cont._derived;\n    return obj;\n};\n\nfunction getStyleObj(val, fullLayout) {\n    var styleObj = {};\n\n    if(Lib.isPlainObject(val)) {\n        styleObj.id = val.id;\n        styleObj.style = val;\n    } else if(typeof val === 'string') {\n        styleObj.id = val;\n\n        if(constants.styleValuesMapbox.indexOf(val) !== -1) {\n            styleObj.style = convertStyleVal(val);\n        } else if(constants.stylesNonMapbox[val]) {\n            styleObj.style = constants.stylesNonMapbox[val];\n            var spec = styleObj.style.sources['plotly-' + val];\n            var tiles = spec ? spec.tiles : undefined;\n            if(\n                tiles &&\n                tiles[0] &&\n                tiles[0].slice(-9) === '?api_key='\n            ) {\n                // provide api_key for stamen styles\n                tiles[0] += fullLayout._mapboxAccessToken;\n            }\n        } else {\n            styleObj.style = val;\n        }\n    } else {\n        styleObj.id = constants.styleValueDflt;\n        styleObj.style = convertStyleVal(constants.styleValueDflt);\n    }\n\n    styleObj.transition = {duration: 0, delay: 0};\n\n    return styleObj;\n}\n\n// if style is part of the 'official' mapbox values, add URL prefix and suffix\nfunction convertStyleVal(val) {\n    return constants.styleUrlPrefix + val + '-' + constants.styleUrlSuffix;\n}\n\nfunction convertCenter(center) {\n    return [center.lon, center.lat];\n}\n\nmodule.exports = Mapbox;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script"}