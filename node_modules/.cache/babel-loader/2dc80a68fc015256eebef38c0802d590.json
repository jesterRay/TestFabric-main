{"ast":null,"code":"'use strict';\n\nvar d3 = require('@plotly/d3');\nvar Plots = require('../../plots/plots');\nvar Fx = require('../../components/fx');\nvar Color = require('../../components/color');\nvar Drawing = require('../../components/drawing');\nvar Lib = require('../../lib');\nvar strScale = Lib.strScale;\nvar strTranslate = Lib.strTranslate;\nvar svgTextUtils = require('../../lib/svg_text_utils');\nvar uniformText = require('../bar/uniform_text');\nvar recordMinTextSize = uniformText.recordMinTextSize;\nvar clearMinTextSize = uniformText.clearMinTextSize;\nvar TEXTPAD = require('../bar/constants').TEXTPAD;\nvar helpers = require('./helpers');\nvar eventData = require('./event_data');\nvar isValidTextValue = require('../../lib').isValidTextValue;\nfunction plot(gd, cdModule) {\n  var isStatic = gd._context.staticPlot;\n  var fullLayout = gd._fullLayout;\n  var gs = fullLayout._size;\n  clearMinTextSize('pie', fullLayout);\n  prerenderTitles(cdModule, gd);\n  layoutAreas(cdModule, gs);\n  var plotGroups = Lib.makeTraceGroups(fullLayout._pielayer, cdModule, 'trace').each(function (cd) {\n    var plotGroup = d3.select(this);\n    var cd0 = cd[0];\n    var trace = cd0.trace;\n    setCoords(cd);\n\n    // TODO: miter might look better but can sometimes cause problems\n    // maybe miter with a small-ish stroke-miterlimit?\n    plotGroup.attr('stroke-linejoin', 'round');\n    plotGroup.each(function () {\n      var slices = d3.select(this).selectAll('g.slice').data(cd);\n      slices.enter().append('g').classed('slice', true);\n      slices.exit().remove();\n      var quadrants = [[[], []],\n      // y<0: x<0, x>=0\n      [[], []] // y>=0: x<0, x>=0\n      ];\n      var hasOutsideText = false;\n      slices.each(function (pt, i) {\n        if (pt.hidden) {\n          d3.select(this).selectAll('path,g').remove();\n          return;\n        }\n\n        // to have consistent event data compared to other traces\n        pt.pointNumber = pt.i;\n        pt.curveNumber = trace.index;\n        quadrants[pt.pxmid[1] < 0 ? 0 : 1][pt.pxmid[0] < 0 ? 0 : 1].push(pt);\n        var cx = cd0.cx;\n        var cy = cd0.cy;\n        var sliceTop = d3.select(this);\n        var slicePath = sliceTop.selectAll('path.surface').data([pt]);\n        slicePath.enter().append('path').classed('surface', true).style({\n          'pointer-events': isStatic ? 'none' : 'all'\n        });\n        sliceTop.call(attachFxHandlers, gd, cd);\n        if (trace.pull) {\n          var pull = +helpers.castOption(trace.pull, pt.pts) || 0;\n          if (pull > 0) {\n            cx += pull * pt.pxmid[0];\n            cy += pull * pt.pxmid[1];\n          }\n        }\n        pt.cxFinal = cx;\n        pt.cyFinal = cy;\n        function arc(start, finish, cw, scale) {\n          var dx = scale * (finish[0] - start[0]);\n          var dy = scale * (finish[1] - start[1]);\n          return 'a' + scale * cd0.r + ',' + scale * cd0.r + ' 0 ' + pt.largeArc + (cw ? ' 1 ' : ' 0 ') + dx + ',' + dy;\n        }\n        var hole = trace.hole;\n        if (pt.v === cd0.vTotal) {\n          // 100% fails bcs arc start and end are identical\n          var outerCircle = 'M' + (cx + pt.px0[0]) + ',' + (cy + pt.px0[1]) + arc(pt.px0, pt.pxmid, true, 1) + arc(pt.pxmid, pt.px0, true, 1) + 'Z';\n          if (hole) {\n            slicePath.attr('d', 'M' + (cx + hole * pt.px0[0]) + ',' + (cy + hole * pt.px0[1]) + arc(pt.px0, pt.pxmid, false, hole) + arc(pt.pxmid, pt.px0, false, hole) + 'Z' + outerCircle);\n          } else slicePath.attr('d', outerCircle);\n        } else {\n          var outerArc = arc(pt.px0, pt.px1, true, 1);\n          if (hole) {\n            var rim = 1 - hole;\n            slicePath.attr('d', 'M' + (cx + hole * pt.px1[0]) + ',' + (cy + hole * pt.px1[1]) + arc(pt.px1, pt.px0, false, hole) + 'l' + rim * pt.px0[0] + ',' + rim * pt.px0[1] + outerArc + 'Z');\n          } else {\n            slicePath.attr('d', 'M' + cx + ',' + cy + 'l' + pt.px0[0] + ',' + pt.px0[1] + outerArc + 'Z');\n          }\n        }\n\n        // add text\n        formatSliceLabel(gd, pt, cd0);\n        var textPosition = helpers.castOption(trace.textposition, pt.pts);\n        var sliceTextGroup = sliceTop.selectAll('g.slicetext').data(pt.text && textPosition !== 'none' ? [0] : []);\n        sliceTextGroup.enter().append('g').classed('slicetext', true);\n        sliceTextGroup.exit().remove();\n        sliceTextGroup.each(function () {\n          var sliceText = Lib.ensureSingle(d3.select(this), 'text', '', function (s) {\n            // prohibit tex interpretation until we can handle\n            // tex and regular text together\n            s.attr('data-notex', 1);\n          });\n          var font = Lib.ensureUniformFontSize(gd, textPosition === 'outside' ? determineOutsideTextFont(trace, pt, fullLayout.font) : determineInsideTextFont(trace, pt, fullLayout.font));\n          sliceText.text(pt.text).attr({\n            class: 'slicetext',\n            transform: '',\n            'text-anchor': 'middle'\n          }).call(Drawing.font, font).call(svgTextUtils.convertToTspans, gd);\n\n          // position the text relative to the slice\n          var textBB = Drawing.bBox(sliceText.node());\n          var transform;\n          if (textPosition === 'outside') {\n            transform = transformOutsideText(textBB, pt);\n          } else {\n            transform = transformInsideText(textBB, pt, cd0);\n            if (textPosition === 'auto' && transform.scale < 1) {\n              var newFont = Lib.ensureUniformFontSize(gd, trace.outsidetextfont);\n              sliceText.call(Drawing.font, newFont);\n              textBB = Drawing.bBox(sliceText.node());\n              transform = transformOutsideText(textBB, pt);\n            }\n          }\n          var textPosAngle = transform.textPosAngle;\n          var textXY = textPosAngle === undefined ? pt.pxmid : getCoords(cd0.r, textPosAngle);\n          transform.targetX = cx + textXY[0] * transform.rCenter + (transform.x || 0);\n          transform.targetY = cy + textXY[1] * transform.rCenter + (transform.y || 0);\n          computeTransform(transform, textBB);\n\n          // save some stuff to use later ensure no labels overlap\n          if (transform.outside) {\n            var targetY = transform.targetY;\n            pt.yLabelMin = targetY - textBB.height / 2;\n            pt.yLabelMid = targetY;\n            pt.yLabelMax = targetY + textBB.height / 2;\n            pt.labelExtraX = 0;\n            pt.labelExtraY = 0;\n            hasOutsideText = true;\n          }\n          transform.fontSize = font.size;\n          recordMinTextSize(trace.type, transform, fullLayout);\n          cd[i].transform = transform;\n          Lib.setTransormAndDisplay(sliceText, transform);\n        });\n      });\n\n      // add the title\n      var titleTextGroup = d3.select(this).selectAll('g.titletext').data(trace.title.text ? [0] : []);\n      titleTextGroup.enter().append('g').classed('titletext', true);\n      titleTextGroup.exit().remove();\n      titleTextGroup.each(function () {\n        var titleText = Lib.ensureSingle(d3.select(this), 'text', '', function (s) {\n          // prohibit tex interpretation as above\n          s.attr('data-notex', 1);\n        });\n        var txt = trace.title.text;\n        if (trace._meta) {\n          txt = Lib.templateString(txt, trace._meta);\n        }\n        titleText.text(txt).attr({\n          class: 'titletext',\n          transform: '',\n          'text-anchor': 'middle'\n        }).call(Drawing.font, trace.title.font).call(svgTextUtils.convertToTspans, gd);\n        var transform;\n        if (trace.title.position === 'middle center') {\n          transform = positionTitleInside(cd0);\n        } else {\n          transform = positionTitleOutside(cd0, gs);\n        }\n        titleText.attr('transform', strTranslate(transform.x, transform.y) + strScale(Math.min(1, transform.scale)) + strTranslate(transform.tx, transform.ty));\n      });\n\n      // now make sure no labels overlap (at least within one pie)\n      if (hasOutsideText) scootLabels(quadrants, trace);\n      plotTextLines(slices, trace);\n      if (hasOutsideText && trace.automargin) {\n        // TODO if we ever want to improve perf,\n        // we could reuse the textBB computed above together\n        // with the sliceText transform info\n        var traceBbox = Drawing.bBox(plotGroup.node());\n        var domain = trace.domain;\n        var vpw = gs.w * (domain.x[1] - domain.x[0]);\n        var vph = gs.h * (domain.y[1] - domain.y[0]);\n        var xgap = (0.5 * vpw - cd0.r) / gs.w;\n        var ygap = (0.5 * vph - cd0.r) / gs.h;\n        Plots.autoMargin(gd, 'pie.' + trace.uid + '.automargin', {\n          xl: domain.x[0] - xgap,\n          xr: domain.x[1] + xgap,\n          yb: domain.y[0] - ygap,\n          yt: domain.y[1] + ygap,\n          l: Math.max(cd0.cx - cd0.r - traceBbox.left, 0),\n          r: Math.max(traceBbox.right - (cd0.cx + cd0.r), 0),\n          b: Math.max(traceBbox.bottom - (cd0.cy + cd0.r), 0),\n          t: Math.max(cd0.cy - cd0.r - traceBbox.top, 0),\n          pad: 5\n        });\n      }\n    });\n  });\n\n  // This is for a bug in Chrome (as of 2015-07-22, and does not affect FF)\n  // if insidetextfont and outsidetextfont are different sizes, sometimes the size\n  // of an \"em\" gets taken from the wrong element at first so lines are\n  // spaced wrong. You just have to tell it to try again later and it gets fixed.\n  // I have no idea why we haven't seen this in other contexts. Also, sometimes\n  // it gets the initial draw correct but on redraw it gets confused.\n  setTimeout(function () {\n    plotGroups.selectAll('tspan').each(function () {\n      var s = d3.select(this);\n      if (s.attr('dy')) s.attr('dy', s.attr('dy'));\n    });\n  }, 0);\n}\n\n// TODO add support for transition\nfunction plotTextLines(slices, trace) {\n  slices.each(function (pt) {\n    var sliceTop = d3.select(this);\n    if (!pt.labelExtraX && !pt.labelExtraY) {\n      sliceTop.select('path.textline').remove();\n      return;\n    }\n\n    // first move the text to its new location\n    var sliceText = sliceTop.select('g.slicetext text');\n    pt.transform.targetX += pt.labelExtraX;\n    pt.transform.targetY += pt.labelExtraY;\n    Lib.setTransormAndDisplay(sliceText, pt.transform);\n\n    // then add a line to the new location\n    var lineStartX = pt.cxFinal + pt.pxmid[0];\n    var lineStartY = pt.cyFinal + pt.pxmid[1];\n    var textLinePath = 'M' + lineStartX + ',' + lineStartY;\n    var finalX = (pt.yLabelMax - pt.yLabelMin) * (pt.pxmid[0] < 0 ? -1 : 1) / 4;\n    if (pt.labelExtraX) {\n      var yFromX = pt.labelExtraX * pt.pxmid[1] / pt.pxmid[0];\n      var yNet = pt.yLabelMid + pt.labelExtraY - (pt.cyFinal + pt.pxmid[1]);\n      if (Math.abs(yFromX) > Math.abs(yNet)) {\n        textLinePath += 'l' + yNet * pt.pxmid[0] / pt.pxmid[1] + ',' + yNet + 'H' + (lineStartX + pt.labelExtraX + finalX);\n      } else {\n        textLinePath += 'l' + pt.labelExtraX + ',' + yFromX + 'v' + (yNet - yFromX) + 'h' + finalX;\n      }\n    } else {\n      textLinePath += 'V' + (pt.yLabelMid + pt.labelExtraY) + 'h' + finalX;\n    }\n    Lib.ensureSingle(sliceTop, 'path', 'textline').call(Color.stroke, trace.outsidetextfont.color).attr({\n      'stroke-width': Math.min(2, trace.outsidetextfont.size / 8),\n      d: textLinePath,\n      fill: 'none'\n    });\n  });\n}\nfunction attachFxHandlers(sliceTop, gd, cd) {\n  var cd0 = cd[0];\n  var cx = cd0.cx;\n  var cy = cd0.cy;\n  var trace = cd0.trace;\n  var isFunnelArea = trace.type === 'funnelarea';\n\n  // hover state vars\n  // have we drawn a hover label, so it should be cleared later\n  if (!('_hasHoverLabel' in trace)) trace._hasHoverLabel = false;\n  // have we emitted a hover event, so later an unhover event should be emitted\n  // note that click events do not depend on this - you can still get them\n  // with hovermode: false or if you were earlier dragging, then clicked\n  // in the same slice that you moused up in\n  if (!('_hasHoverEvent' in trace)) trace._hasHoverEvent = false;\n  sliceTop.on('mouseover', function (pt) {\n    // in case fullLayout or fullData has changed without a replot\n    var fullLayout2 = gd._fullLayout;\n    var trace2 = gd._fullData[trace.index];\n    if (gd._dragging || fullLayout2.hovermode === false) return;\n    var hoverinfo = trace2.hoverinfo;\n    if (Array.isArray(hoverinfo)) {\n      // super hacky: we need to pull out the *first* hoverinfo from\n      // pt.pts, then put it back into an array in a dummy trace\n      // and call castHoverinfo on that.\n      // TODO: do we want to have Fx.castHoverinfo somehow handle this?\n      // it already takes an array for index, for 2D, so this seems tricky.\n      hoverinfo = Fx.castHoverinfo({\n        hoverinfo: [helpers.castOption(hoverinfo, pt.pts)],\n        _module: trace._module\n      }, fullLayout2, 0);\n    }\n    if (hoverinfo === 'all') hoverinfo = 'label+text+value+percent+name';\n\n    // in case we dragged over the pie from another subplot,\n    // or if hover is turned off\n    if (trace2.hovertemplate || hoverinfo !== 'none' && hoverinfo !== 'skip' && hoverinfo) {\n      var rInscribed = pt.rInscribed || 0;\n      var hoverCenterX = cx + pt.pxmid[0] * (1 - rInscribed);\n      var hoverCenterY = cy + pt.pxmid[1] * (1 - rInscribed);\n      var separators = fullLayout2.separators;\n      var text = [];\n      if (hoverinfo && hoverinfo.indexOf('label') !== -1) text.push(pt.label);\n      pt.text = helpers.castOption(trace2.hovertext || trace2.text, pt.pts);\n      if (hoverinfo && hoverinfo.indexOf('text') !== -1) {\n        var tx = pt.text;\n        if (Lib.isValidTextValue(tx)) text.push(tx);\n      }\n      pt.value = pt.v;\n      pt.valueLabel = helpers.formatPieValue(pt.v, separators);\n      if (hoverinfo && hoverinfo.indexOf('value') !== -1) text.push(pt.valueLabel);\n      pt.percent = pt.v / cd0.vTotal;\n      pt.percentLabel = helpers.formatPiePercent(pt.percent, separators);\n      if (hoverinfo && hoverinfo.indexOf('percent') !== -1) text.push(pt.percentLabel);\n      var hoverLabel = trace2.hoverlabel;\n      var hoverFont = hoverLabel.font;\n      var bbox = [];\n      Fx.loneHover({\n        trace: trace,\n        x0: hoverCenterX - rInscribed * cd0.r,\n        x1: hoverCenterX + rInscribed * cd0.r,\n        y: hoverCenterY,\n        _x0: isFunnelArea ? cx + pt.TL[0] : hoverCenterX - rInscribed * cd0.r,\n        _x1: isFunnelArea ? cx + pt.TR[0] : hoverCenterX + rInscribed * cd0.r,\n        _y0: isFunnelArea ? cy + pt.TL[1] : hoverCenterY - rInscribed * cd0.r,\n        _y1: isFunnelArea ? cy + pt.BL[1] : hoverCenterY + rInscribed * cd0.r,\n        text: text.join('<br>'),\n        name: trace2.hovertemplate || hoverinfo.indexOf('name') !== -1 ? trace2.name : undefined,\n        idealAlign: pt.pxmid[0] < 0 ? 'left' : 'right',\n        color: helpers.castOption(hoverLabel.bgcolor, pt.pts) || pt.color,\n        borderColor: helpers.castOption(hoverLabel.bordercolor, pt.pts),\n        fontFamily: helpers.castOption(hoverFont.family, pt.pts),\n        fontSize: helpers.castOption(hoverFont.size, pt.pts),\n        fontColor: helpers.castOption(hoverFont.color, pt.pts),\n        nameLength: helpers.castOption(hoverLabel.namelength, pt.pts),\n        textAlign: helpers.castOption(hoverLabel.align, pt.pts),\n        hovertemplate: helpers.castOption(trace2.hovertemplate, pt.pts),\n        hovertemplateLabels: pt,\n        eventData: [eventData(pt, trace2)]\n      }, {\n        container: fullLayout2._hoverlayer.node(),\n        outerContainer: fullLayout2._paper.node(),\n        gd: gd,\n        inOut_bbox: bbox\n      });\n      pt.bbox = bbox[0];\n      trace._hasHoverLabel = true;\n    }\n    trace._hasHoverEvent = true;\n    gd.emit('plotly_hover', {\n      points: [eventData(pt, trace2)],\n      event: d3.event\n    });\n  });\n  sliceTop.on('mouseout', function (evt) {\n    var fullLayout2 = gd._fullLayout;\n    var trace2 = gd._fullData[trace.index];\n    var pt = d3.select(this).datum();\n    if (trace._hasHoverEvent) {\n      evt.originalEvent = d3.event;\n      gd.emit('plotly_unhover', {\n        points: [eventData(pt, trace2)],\n        event: d3.event\n      });\n      trace._hasHoverEvent = false;\n    }\n    if (trace._hasHoverLabel) {\n      Fx.loneUnhover(fullLayout2._hoverlayer.node());\n      trace._hasHoverLabel = false;\n    }\n  });\n  sliceTop.on('click', function (pt) {\n    // TODO: this does not support right-click. If we want to support it, we\n    // would likely need to change pie to use dragElement instead of straight\n    // map subplot event binding. Or perhaps better, make a simple wrapper with the\n    // right mousedown, mousemove, and mouseup handlers just for a left/right click\n    // map subplots would use this too.\n    var fullLayout2 = gd._fullLayout;\n    var trace2 = gd._fullData[trace.index];\n    if (gd._dragging || fullLayout2.hovermode === false) return;\n    gd._hoverdata = [eventData(pt, trace2)];\n    Fx.click(gd, d3.event);\n  });\n}\nfunction determineOutsideTextFont(trace, pt, layoutFont) {\n  var color = helpers.castOption(trace.outsidetextfont.color, pt.pts) || helpers.castOption(trace.textfont.color, pt.pts) || layoutFont.color;\n  var family = helpers.castOption(trace.outsidetextfont.family, pt.pts) || helpers.castOption(trace.textfont.family, pt.pts) || layoutFont.family;\n  var size = helpers.castOption(trace.outsidetextfont.size, pt.pts) || helpers.castOption(trace.textfont.size, pt.pts) || layoutFont.size;\n  var weight = helpers.castOption(trace.outsidetextfont.weight, pt.pts) || helpers.castOption(trace.textfont.weight, pt.pts) || layoutFont.weight;\n  var style = helpers.castOption(trace.outsidetextfont.style, pt.pts) || helpers.castOption(trace.textfont.style, pt.pts) || layoutFont.style;\n  var variant = helpers.castOption(trace.outsidetextfont.variant, pt.pts) || helpers.castOption(trace.textfont.variant, pt.pts) || layoutFont.variant;\n  var textcase = helpers.castOption(trace.outsidetextfont.textcase, pt.pts) || helpers.castOption(trace.textfont.textcase, pt.pts) || layoutFont.textcase;\n  var lineposition = helpers.castOption(trace.outsidetextfont.lineposition, pt.pts) || helpers.castOption(trace.textfont.lineposition, pt.pts) || layoutFont.lineposition;\n  var shadow = helpers.castOption(trace.outsidetextfont.shadow, pt.pts) || helpers.castOption(trace.textfont.shadow, pt.pts) || layoutFont.shadow;\n  return {\n    color: color,\n    family: family,\n    size: size,\n    weight: weight,\n    style: style,\n    variant: variant,\n    textcase: textcase,\n    lineposition: lineposition,\n    shadow: shadow\n  };\n}\nfunction determineInsideTextFont(trace, pt, layoutFont) {\n  var customColor = helpers.castOption(trace.insidetextfont.color, pt.pts);\n  if (!customColor && trace._input.textfont) {\n    // Why not simply using trace.textfont? Because if not set, it\n    // defaults to layout.font which has a default color. But if\n    // textfont.color and insidetextfont.color don't supply a value,\n    // a contrasting color shall be used.\n    customColor = helpers.castOption(trace._input.textfont.color, pt.pts);\n  }\n  var family = helpers.castOption(trace.insidetextfont.family, pt.pts) || helpers.castOption(trace.textfont.family, pt.pts) || layoutFont.family;\n  var size = helpers.castOption(trace.insidetextfont.size, pt.pts) || helpers.castOption(trace.textfont.size, pt.pts) || layoutFont.size;\n  var weight = helpers.castOption(trace.insidetextfont.weight, pt.pts) || helpers.castOption(trace.textfont.weight, pt.pts) || layoutFont.weight;\n  var style = helpers.castOption(trace.insidetextfont.style, pt.pts) || helpers.castOption(trace.textfont.style, pt.pts) || layoutFont.style;\n  var variant = helpers.castOption(trace.insidetextfont.variant, pt.pts) || helpers.castOption(trace.textfont.variant, pt.pts) || layoutFont.variant;\n  var textcase = helpers.castOption(trace.insidetextfont.textcase, pt.pts) || helpers.castOption(trace.textfont.textcase, pt.pts) || layoutFont.textcase;\n  var lineposition = helpers.castOption(trace.insidetextfont.lineposition, pt.pts) || helpers.castOption(trace.textfont.lineposition, pt.pts) || layoutFont.lineposition;\n  var shadow = helpers.castOption(trace.insidetextfont.shadow, pt.pts) || helpers.castOption(trace.textfont.shadow, pt.pts) || layoutFont.shadow;\n  return {\n    color: customColor || Color.contrast(pt.color),\n    family: family,\n    size: size,\n    weight: weight,\n    style: style,\n    variant: variant,\n    textcase: textcase,\n    lineposition: lineposition,\n    shadow: shadow\n  };\n}\nfunction prerenderTitles(cdModule, gd) {\n  var cd0, trace;\n\n  // Determine the width and height of the title for each pie.\n  for (var i = 0; i < cdModule.length; i++) {\n    cd0 = cdModule[i][0];\n    trace = cd0.trace;\n    if (trace.title.text) {\n      var txt = trace.title.text;\n      if (trace._meta) {\n        txt = Lib.templateString(txt, trace._meta);\n      }\n      var dummyTitle = Drawing.tester.append('text').attr('data-notex', 1).text(txt).call(Drawing.font, trace.title.font).call(svgTextUtils.convertToTspans, gd);\n      var bBox = Drawing.bBox(dummyTitle.node(), true);\n      cd0.titleBox = {\n        width: bBox.width,\n        height: bBox.height\n      };\n      dummyTitle.remove();\n    }\n  }\n}\nfunction transformInsideText(textBB, pt, cd0) {\n  var r = cd0.r || pt.rpx1;\n  var rInscribed = pt.rInscribed;\n  var isEmpty = pt.startangle === pt.stopangle;\n  if (isEmpty) {\n    return {\n      rCenter: 1 - rInscribed,\n      scale: 0,\n      rotate: 0,\n      textPosAngle: 0\n    };\n  }\n  var ring = pt.ring;\n  var isCircle = ring === 1 && Math.abs(pt.startangle - pt.stopangle) === Math.PI * 2;\n  var halfAngle = pt.halfangle;\n  var midAngle = pt.midangle;\n  var orientation = cd0.trace.insidetextorientation;\n  var isHorizontal = orientation === 'horizontal';\n  var isTangential = orientation === 'tangential';\n  var isRadial = orientation === 'radial';\n  var isAuto = orientation === 'auto';\n  var allTransforms = [];\n  var newT;\n  if (!isAuto) {\n    // max size if text is placed (horizontally) at the top or bottom of the arc\n\n    var considerCrossing = function (angle, key) {\n      if (isCrossing(pt, angle)) {\n        var dStart = Math.abs(angle - pt.startangle);\n        var dStop = Math.abs(angle - pt.stopangle);\n        var closestEdge = dStart < dStop ? dStart : dStop;\n        if (key === 'tan') {\n          newT = calcTanTransform(textBB, r, ring, closestEdge, 0);\n        } else {\n          // case of 'rad'\n          newT = calcRadTransform(textBB, r, ring, closestEdge, Math.PI / 2);\n        }\n        newT.textPosAngle = angle;\n        allTransforms.push(newT);\n      }\n    };\n\n    // to cover all cases with trace.rotation added\n    var i;\n    if (isHorizontal || isTangential) {\n      // top\n      for (i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * i, 'tan');\n      // bottom\n      for (i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 1), 'tan');\n    }\n    if (isHorizontal || isRadial) {\n      // left\n      for (i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 1.5), 'rad');\n      // right\n      for (i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 0.5), 'rad');\n    }\n  }\n  if (isCircle || isAuto || isHorizontal) {\n    // max size text can be inserted inside without rotating it\n    // this inscribes the text rectangle in a circle, which is then inscribed\n    // in the slice, so it will be an underestimate, which some day we may want\n    // to improve so this case can get more use\n    var textDiameter = Math.sqrt(textBB.width * textBB.width + textBB.height * textBB.height);\n    newT = {\n      scale: rInscribed * r * 2 / textDiameter,\n      // and the center position and rotation in this case\n      rCenter: 1 - rInscribed,\n      rotate: 0\n    };\n    newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n    if (newT.scale >= 1) return newT;\n    allTransforms.push(newT);\n  }\n  if (isAuto || isRadial) {\n    newT = calcRadTransform(textBB, r, ring, halfAngle, midAngle);\n    newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n    allTransforms.push(newT);\n  }\n  if (isAuto || isTangential) {\n    newT = calcTanTransform(textBB, r, ring, halfAngle, midAngle);\n    newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n    allTransforms.push(newT);\n  }\n  var id = 0;\n  var maxScale = 0;\n  for (var k = 0; k < allTransforms.length; k++) {\n    var s = allTransforms[k].scale;\n    if (maxScale < s) {\n      maxScale = s;\n      id = k;\n    }\n    if (!isAuto && maxScale >= 1) {\n      // respect test order for non-auto options\n      break;\n    }\n  }\n  return allTransforms[id];\n}\nfunction isCrossing(pt, angle) {\n  var start = pt.startangle;\n  var stop = pt.stopangle;\n  return start > angle && angle > stop || start < angle && angle < stop;\n}\nfunction calcRadTransform(textBB, r, ring, halfAngle, midAngle) {\n  r = Math.max(0, r - 2 * TEXTPAD);\n\n  // max size if text is rotated radially\n  var a = textBB.width / textBB.height;\n  var s = calcMaxHalfSize(a, halfAngle, r, ring);\n  return {\n    scale: s * 2 / textBB.height,\n    rCenter: calcRCenter(a, s / r),\n    rotate: calcRotate(midAngle)\n  };\n}\nfunction calcTanTransform(textBB, r, ring, halfAngle, midAngle) {\n  r = Math.max(0, r - 2 * TEXTPAD);\n\n  // max size if text is rotated tangentially\n  var a = textBB.height / textBB.width;\n  var s = calcMaxHalfSize(a, halfAngle, r, ring);\n  return {\n    scale: s * 2 / textBB.width,\n    rCenter: calcRCenter(a, s / r),\n    rotate: calcRotate(midAngle + Math.PI / 2)\n  };\n}\nfunction calcRCenter(a, b) {\n  return Math.cos(b) - a * b;\n}\nfunction calcRotate(t) {\n  return (180 / Math.PI * t + 720) % 180 - 90;\n}\nfunction calcMaxHalfSize(a, halfAngle, r, ring) {\n  var q = a + 1 / (2 * Math.tan(halfAngle));\n  return r * Math.min(1 / (Math.sqrt(q * q + 0.5) + q), ring / (Math.sqrt(a * a + ring / 2) + a));\n}\nfunction getInscribedRadiusFraction(pt, cd0) {\n  if (pt.v === cd0.vTotal && !cd0.trace.hole) return 1; // special case of 100% with no hole\n\n  return Math.min(1 / (1 + 1 / Math.sin(pt.halfangle)), pt.ring / 2);\n}\nfunction transformOutsideText(textBB, pt) {\n  var x = pt.pxmid[0];\n  var y = pt.pxmid[1];\n  var dx = textBB.width / 2;\n  var dy = textBB.height / 2;\n  if (x < 0) dx *= -1;\n  if (y < 0) dy *= -1;\n  return {\n    scale: 1,\n    rCenter: 1,\n    rotate: 0,\n    x: dx + Math.abs(dy) * (dx > 0 ? 1 : -1) / 2,\n    y: dy / (1 + x * x / (y * y)),\n    outside: true\n  };\n}\nfunction positionTitleInside(cd0) {\n  var textDiameter = Math.sqrt(cd0.titleBox.width * cd0.titleBox.width + cd0.titleBox.height * cd0.titleBox.height);\n  return {\n    x: cd0.cx,\n    y: cd0.cy,\n    scale: cd0.trace.hole * cd0.r * 2 / textDiameter,\n    tx: 0,\n    ty: -cd0.titleBox.height / 2 + cd0.trace.title.font.size\n  };\n}\nfunction positionTitleOutside(cd0, plotSize) {\n  var scaleX = 1;\n  var scaleY = 1;\n  var maxPull;\n  var trace = cd0.trace;\n  // position of the baseline point of the text box in the plot, before scaling.\n  // we anchored the text in the middle, so the baseline is on the bottom middle\n  // of the first line of text.\n  var topMiddle = {\n    x: cd0.cx,\n    y: cd0.cy\n  };\n  // relative translation of the text box after scaling\n  var translate = {\n    tx: 0,\n    ty: 0\n  };\n\n  // we reason below as if the baseline is the top middle point of the text box.\n  // so we must add the font size to approximate the y-coord. of the top.\n  // note that this correction must happen after scaling.\n  translate.ty += trace.title.font.size;\n  maxPull = getMaxPull(trace);\n  if (trace.title.position.indexOf('top') !== -1) {\n    topMiddle.y -= (1 + maxPull) * cd0.r;\n    translate.ty -= cd0.titleBox.height;\n  } else if (trace.title.position.indexOf('bottom') !== -1) {\n    topMiddle.y += (1 + maxPull) * cd0.r;\n  }\n  var rx = applyAspectRatio(cd0.r, cd0.trace.aspectratio);\n  var maxWidth = plotSize.w * (trace.domain.x[1] - trace.domain.x[0]) / 2;\n  if (trace.title.position.indexOf('left') !== -1) {\n    // we start the text at the left edge of the pie\n    maxWidth = maxWidth + rx;\n    topMiddle.x -= (1 + maxPull) * rx;\n    translate.tx += cd0.titleBox.width / 2;\n  } else if (trace.title.position.indexOf('center') !== -1) {\n    maxWidth *= 2;\n  } else if (trace.title.position.indexOf('right') !== -1) {\n    maxWidth = maxWidth + rx;\n    topMiddle.x += (1 + maxPull) * rx;\n    translate.tx -= cd0.titleBox.width / 2;\n  }\n  scaleX = maxWidth / cd0.titleBox.width;\n  scaleY = getTitleSpace(cd0, plotSize) / cd0.titleBox.height;\n  return {\n    x: topMiddle.x,\n    y: topMiddle.y,\n    scale: Math.min(scaleX, scaleY),\n    tx: translate.tx,\n    ty: translate.ty\n  };\n}\nfunction applyAspectRatio(x, aspectratio) {\n  return x / (aspectratio === undefined ? 1 : aspectratio);\n}\nfunction getTitleSpace(cd0, plotSize) {\n  var trace = cd0.trace;\n  var pieBoxHeight = plotSize.h * (trace.domain.y[1] - trace.domain.y[0]);\n  // use at most half of the plot for the title\n  return Math.min(cd0.titleBox.height, pieBoxHeight / 2);\n}\nfunction getMaxPull(trace) {\n  var maxPull = trace.pull;\n  if (!maxPull) return 0;\n  var j;\n  if (Lib.isArrayOrTypedArray(maxPull)) {\n    maxPull = 0;\n    for (j = 0; j < trace.pull.length; j++) {\n      if (trace.pull[j] > maxPull) maxPull = trace.pull[j];\n    }\n  }\n  return maxPull;\n}\nfunction scootLabels(quadrants, trace) {\n  var xHalf, yHalf, equatorFirst, farthestX, farthestY, xDiffSign, yDiffSign, thisQuad, oppositeQuad, wholeSide, i, thisQuadOutside, firstOppositeOutsidePt;\n  function topFirst(a, b) {\n    return a.pxmid[1] - b.pxmid[1];\n  }\n  function bottomFirst(a, b) {\n    return b.pxmid[1] - a.pxmid[1];\n  }\n  function scootOneLabel(thisPt, prevPt) {\n    if (!prevPt) prevPt = {};\n    var prevOuterY = prevPt.labelExtraY + (yHalf ? prevPt.yLabelMax : prevPt.yLabelMin);\n    var thisInnerY = yHalf ? thisPt.yLabelMin : thisPt.yLabelMax;\n    var thisOuterY = yHalf ? thisPt.yLabelMax : thisPt.yLabelMin;\n    var thisSliceOuterY = thisPt.cyFinal + farthestY(thisPt.px0[1], thisPt.px1[1]);\n    var newExtraY = prevOuterY - thisInnerY;\n    var xBuffer, i, otherPt, otherOuterY, otherOuterX, newExtraX;\n\n    // make sure this label doesn't overlap other labels\n    // this *only* has us move these labels vertically\n    if (newExtraY * yDiffSign > 0) thisPt.labelExtraY = newExtraY;\n\n    // make sure this label doesn't overlap any slices\n    if (!Lib.isArrayOrTypedArray(trace.pull)) return; // this can only happen with array pulls\n\n    for (i = 0; i < wholeSide.length; i++) {\n      otherPt = wholeSide[i];\n\n      // overlap can only happen if the other point is pulled more than this one\n      if (otherPt === thisPt || (helpers.castOption(trace.pull, thisPt.pts) || 0) >= (helpers.castOption(trace.pull, otherPt.pts) || 0)) {\n        continue;\n      }\n      if ((thisPt.pxmid[1] - otherPt.pxmid[1]) * yDiffSign > 0) {\n        // closer to the equator - by construction all of these happen first\n        // move the text vertically to get away from these slices\n        otherOuterY = otherPt.cyFinal + farthestY(otherPt.px0[1], otherPt.px1[1]);\n        newExtraY = otherOuterY - thisInnerY - thisPt.labelExtraY;\n        if (newExtraY * yDiffSign > 0) thisPt.labelExtraY += newExtraY;\n      } else if ((thisOuterY + thisPt.labelExtraY - thisSliceOuterY) * yDiffSign > 0) {\n        // farther from the equator - happens after we've done all the\n        // vertical moving we're going to do\n        // move horizontally to get away from these more polar slices\n\n        // if we're moving horz. based on a slice that's several slices away from this one\n        // then we need some extra space for the lines to labels between them\n        xBuffer = 3 * xDiffSign * Math.abs(i - wholeSide.indexOf(thisPt));\n        otherOuterX = otherPt.cxFinal + farthestX(otherPt.px0[0], otherPt.px1[0]);\n        newExtraX = otherOuterX + xBuffer - (thisPt.cxFinal + thisPt.pxmid[0]) - thisPt.labelExtraX;\n        if (newExtraX * xDiffSign > 0) thisPt.labelExtraX += newExtraX;\n      }\n    }\n  }\n  for (yHalf = 0; yHalf < 2; yHalf++) {\n    equatorFirst = yHalf ? topFirst : bottomFirst;\n    farthestY = yHalf ? Math.max : Math.min;\n    yDiffSign = yHalf ? 1 : -1;\n    for (xHalf = 0; xHalf < 2; xHalf++) {\n      farthestX = xHalf ? Math.max : Math.min;\n      xDiffSign = xHalf ? 1 : -1;\n\n      // first sort the array\n      // note this is a copy of cd, so cd itself doesn't get sorted\n      // but we can still modify points in place.\n      thisQuad = quadrants[yHalf][xHalf];\n      thisQuad.sort(equatorFirst);\n      oppositeQuad = quadrants[1 - yHalf][xHalf];\n      wholeSide = oppositeQuad.concat(thisQuad);\n      thisQuadOutside = [];\n      for (i = 0; i < thisQuad.length; i++) {\n        if (thisQuad[i].yLabelMid !== undefined) thisQuadOutside.push(thisQuad[i]);\n      }\n      firstOppositeOutsidePt = false;\n      for (i = 0; yHalf && i < oppositeQuad.length; i++) {\n        if (oppositeQuad[i].yLabelMid !== undefined) {\n          firstOppositeOutsidePt = oppositeQuad[i];\n          break;\n        }\n      }\n\n      // each needs to avoid the previous\n      for (i = 0; i < thisQuadOutside.length; i++) {\n        var prevPt = i && thisQuadOutside[i - 1];\n        // bottom half needs to avoid the first label of the top half\n        // top half we still need to call scootOneLabel on the first slice\n        // so we can avoid other slices, but we don't pass a prevPt\n        if (firstOppositeOutsidePt && !i) prevPt = firstOppositeOutsidePt;\n        scootOneLabel(thisQuadOutside[i], prevPt);\n      }\n    }\n  }\n}\nfunction layoutAreas(cdModule, plotSize) {\n  var scaleGroups = [];\n\n  // figure out the center and maximum radius\n  for (var i = 0; i < cdModule.length; i++) {\n    var cd0 = cdModule[i][0];\n    var trace = cd0.trace;\n    var domain = trace.domain;\n    var width = plotSize.w * (domain.x[1] - domain.x[0]);\n    var height = plotSize.h * (domain.y[1] - domain.y[0]);\n    // leave some space for the title, if it will be displayed outside\n    if (trace.title.text && trace.title.position !== 'middle center') {\n      height -= getTitleSpace(cd0, plotSize);\n    }\n    var rx = width / 2;\n    var ry = height / 2;\n    if (trace.type === 'funnelarea' && !trace.scalegroup) {\n      ry /= trace.aspectratio;\n    }\n    cd0.r = Math.min(rx, ry) / (1 + getMaxPull(trace));\n    cd0.cx = plotSize.l + plotSize.w * (trace.domain.x[1] + trace.domain.x[0]) / 2;\n    cd0.cy = plotSize.t + plotSize.h * (1 - trace.domain.y[0]) - height / 2;\n    if (trace.title.text && trace.title.position.indexOf('bottom') !== -1) {\n      cd0.cy -= getTitleSpace(cd0, plotSize);\n    }\n    if (trace.scalegroup && scaleGroups.indexOf(trace.scalegroup) === -1) {\n      scaleGroups.push(trace.scalegroup);\n    }\n  }\n  groupScale(cdModule, scaleGroups);\n}\nfunction groupScale(cdModule, scaleGroups) {\n  var cd0, i, trace;\n\n  // scale those that are grouped\n  for (var k = 0; k < scaleGroups.length; k++) {\n    var min = Infinity;\n    var g = scaleGroups[k];\n    for (i = 0; i < cdModule.length; i++) {\n      cd0 = cdModule[i][0];\n      trace = cd0.trace;\n      if (trace.scalegroup === g) {\n        var area;\n        if (trace.type === 'pie') {\n          area = cd0.r * cd0.r;\n        } else if (trace.type === 'funnelarea') {\n          var rx, ry;\n          if (trace.aspectratio > 1) {\n            rx = cd0.r;\n            ry = rx / trace.aspectratio;\n          } else {\n            ry = cd0.r;\n            rx = ry * trace.aspectratio;\n          }\n          rx *= (1 + trace.baseratio) / 2;\n          area = rx * ry;\n        }\n        min = Math.min(min, area / cd0.vTotal);\n      }\n    }\n    for (i = 0; i < cdModule.length; i++) {\n      cd0 = cdModule[i][0];\n      trace = cd0.trace;\n      if (trace.scalegroup === g) {\n        var v = min * cd0.vTotal;\n        if (trace.type === 'funnelarea') {\n          v /= (1 + trace.baseratio) / 2;\n          v /= trace.aspectratio;\n        }\n        cd0.r = Math.sqrt(v);\n      }\n    }\n  }\n}\nfunction setCoords(cd) {\n  var cd0 = cd[0];\n  var r = cd0.r;\n  var trace = cd0.trace;\n  var currentAngle = helpers.getRotationAngle(trace.rotation);\n  var angleFactor = 2 * Math.PI / cd0.vTotal;\n  var firstPt = 'px0';\n  var lastPt = 'px1';\n  var i, cdi, currentCoords;\n  if (trace.direction === 'counterclockwise') {\n    for (i = 0; i < cd.length; i++) {\n      if (!cd[i].hidden) break; // find the first non-hidden slice\n    }\n    if (i === cd.length) return; // all slices hidden\n\n    currentAngle += angleFactor * cd[i].v;\n    angleFactor *= -1;\n    firstPt = 'px1';\n    lastPt = 'px0';\n  }\n  currentCoords = getCoords(r, currentAngle);\n  for (i = 0; i < cd.length; i++) {\n    cdi = cd[i];\n    if (cdi.hidden) continue;\n    cdi[firstPt] = currentCoords;\n    cdi.startangle = currentAngle;\n    currentAngle += angleFactor * cdi.v / 2;\n    cdi.pxmid = getCoords(r, currentAngle);\n    cdi.midangle = currentAngle;\n    currentAngle += angleFactor * cdi.v / 2;\n    currentCoords = getCoords(r, currentAngle);\n    cdi.stopangle = currentAngle;\n    cdi[lastPt] = currentCoords;\n    cdi.largeArc = cdi.v > cd0.vTotal / 2 ? 1 : 0;\n    cdi.halfangle = Math.PI * Math.min(cdi.v / cd0.vTotal, 0.5);\n    cdi.ring = 1 - trace.hole;\n    cdi.rInscribed = getInscribedRadiusFraction(cdi, cd0);\n  }\n}\nfunction getCoords(r, angle) {\n  return [r * Math.sin(angle), -r * Math.cos(angle)];\n}\nfunction formatSliceLabel(gd, pt, cd0) {\n  var fullLayout = gd._fullLayout;\n  var trace = cd0.trace;\n  // look for textemplate\n  var texttemplate = trace.texttemplate;\n\n  // now insert text\n  var textinfo = trace.textinfo;\n  if (!texttemplate && textinfo && textinfo !== 'none') {\n    var parts = textinfo.split('+');\n    var hasFlag = function (flag) {\n      return parts.indexOf(flag) !== -1;\n    };\n    var hasLabel = hasFlag('label');\n    var hasText = hasFlag('text');\n    var hasValue = hasFlag('value');\n    var hasPercent = hasFlag('percent');\n    var separators = fullLayout.separators;\n    var text;\n    text = hasLabel ? [pt.label] : [];\n    if (hasText) {\n      var tx = helpers.getFirstFilled(trace.text, pt.pts);\n      if (isValidTextValue(tx)) text.push(tx);\n    }\n    if (hasValue) text.push(helpers.formatPieValue(pt.v, separators));\n    if (hasPercent) text.push(helpers.formatPiePercent(pt.v / cd0.vTotal, separators));\n    pt.text = text.join('<br>');\n  }\n  function makeTemplateVariables(pt) {\n    return {\n      label: pt.label,\n      value: pt.v,\n      valueLabel: helpers.formatPieValue(pt.v, fullLayout.separators),\n      percent: pt.v / cd0.vTotal,\n      percentLabel: helpers.formatPiePercent(pt.v / cd0.vTotal, fullLayout.separators),\n      color: pt.color,\n      text: pt.text,\n      customdata: Lib.castOption(trace, pt.i, 'customdata')\n    };\n  }\n  if (texttemplate) {\n    var txt = Lib.castOption(trace, pt.i, 'texttemplate');\n    if (!txt) {\n      pt.text = '';\n    } else {\n      var obj = makeTemplateVariables(pt);\n      var ptTx = helpers.getFirstFilled(trace.text, pt.pts);\n      if (isValidTextValue(ptTx) || ptTx === '') obj.text = ptTx;\n      pt.text = Lib.texttemplateString(txt, obj, gd._fullLayout._d3locale, obj, trace._meta || {});\n    }\n  }\n}\nfunction computeTransform(transform,\n// inout\ntextBB // in\n) {\n  var a = transform.rotate * Math.PI / 180;\n  var cosA = Math.cos(a);\n  var sinA = Math.sin(a);\n  var midX = (textBB.left + textBB.right) / 2;\n  var midY = (textBB.top + textBB.bottom) / 2;\n  transform.textX = midX * cosA - midY * sinA;\n  transform.textY = midX * sinA + midY * cosA;\n  transform.noCenter = true;\n}\nmodule.exports = {\n  plot: plot,\n  formatSliceLabel: formatSliceLabel,\n  transformInsideText: transformInsideText,\n  determineInsideTextFont: determineInsideTextFont,\n  positionTitleOutside: positionTitleOutside,\n  prerenderTitles: prerenderTitles,\n  layoutAreas: layoutAreas,\n  attachFxHandlers: attachFxHandlers,\n  computeTransform: computeTransform\n};","map":{"version":3,"names":["d3","require","Plots","Fx","Color","Drawing","Lib","strScale","strTranslate","svgTextUtils","uniformText","recordMinTextSize","clearMinTextSize","TEXTPAD","helpers","eventData","isValidTextValue","plot","gd","cdModule","isStatic","_context","staticPlot","fullLayout","_fullLayout","gs","_size","prerenderTitles","layoutAreas","plotGroups","makeTraceGroups","_pielayer","each","cd","plotGroup","select","cd0","trace","setCoords","attr","slices","selectAll","data","enter","append","classed","exit","remove","quadrants","hasOutsideText","pt","i","hidden","pointNumber","curveNumber","index","pxmid","push","cx","cy","sliceTop","slicePath","style","call","attachFxHandlers","pull","castOption","pts","cxFinal","cyFinal","arc","start","finish","cw","scale","dx","dy","r","largeArc","hole","v","vTotal","outerCircle","px0","outerArc","px1","rim","formatSliceLabel","textPosition","textposition","sliceTextGroup","text","sliceText","ensureSingle","s","font","ensureUniformFontSize","determineOutsideTextFont","determineInsideTextFont","class","transform","convertToTspans","textBB","bBox","node","transformOutsideText","transformInsideText","newFont","outsidetextfont","textPosAngle","textXY","undefined","getCoords","targetX","rCenter","x","targetY","y","computeTransform","outside","yLabelMin","height","yLabelMid","yLabelMax","labelExtraX","labelExtraY","fontSize","size","type","setTransormAndDisplay","titleTextGroup","title","titleText","txt","_meta","templateString","position","positionTitleInside","positionTitleOutside","Math","min","tx","ty","scootLabels","plotTextLines","automargin","traceBbox","domain","vpw","w","vph","h","xgap","ygap","autoMargin","uid","xl","xr","yb","yt","l","max","left","right","b","bottom","t","top","pad","setTimeout","lineStartX","lineStartY","textLinePath","finalX","yFromX","yNet","abs","stroke","color","d","fill","isFunnelArea","_hasHoverLabel","_hasHoverEvent","on","fullLayout2","trace2","_fullData","_dragging","hovermode","hoverinfo","Array","isArray","castHoverinfo","_module","hovertemplate","rInscribed","hoverCenterX","hoverCenterY","separators","indexOf","label","hovertext","value","valueLabel","formatPieValue","percent","percentLabel","formatPiePercent","hoverLabel","hoverlabel","hoverFont","bbox","loneHover","x0","x1","_x0","TL","_x1","TR","_y0","_y1","BL","join","name","idealAlign","bgcolor","borderColor","bordercolor","fontFamily","family","fontColor","nameLength","namelength","textAlign","align","hovertemplateLabels","container","_hoverlayer","outerContainer","_paper","inOut_bbox","emit","points","event","evt","datum","originalEvent","loneUnhover","_hoverdata","click","layoutFont","textfont","weight","variant","textcase","lineposition","shadow","customColor","insidetextfont","_input","contrast","length","dummyTitle","tester","titleBox","width","rpx1","isEmpty","startangle","stopangle","rotate","ring","isCircle","PI","halfAngle","halfangle","midAngle","midangle","orientation","insidetextorientation","isHorizontal","isTangential","isRadial","isAuto","allTransforms","newT","considerCrossing","angle","key","isCrossing","dStart","dStop","closestEdge","calcTanTransform","calcRadTransform","textDiameter","sqrt","id","maxScale","k","stop","a","calcMaxHalfSize","calcRCenter","calcRotate","cos","q","tan","getInscribedRadiusFraction","sin","plotSize","scaleX","scaleY","maxPull","topMiddle","translate","getMaxPull","rx","applyAspectRatio","aspectratio","maxWidth","getTitleSpace","pieBoxHeight","j","isArrayOrTypedArray","xHalf","yHalf","equatorFirst","farthestX","farthestY","xDiffSign","yDiffSign","thisQuad","oppositeQuad","wholeSide","thisQuadOutside","firstOppositeOutsidePt","topFirst","bottomFirst","scootOneLabel","thisPt","prevPt","prevOuterY","thisInnerY","thisOuterY","thisSliceOuterY","newExtraY","xBuffer","otherPt","otherOuterY","otherOuterX","newExtraX","sort","concat","scaleGroups","ry","scalegroup","groupScale","Infinity","g","area","baseratio","currentAngle","getRotationAngle","rotation","angleFactor","firstPt","lastPt","cdi","currentCoords","direction","texttemplate","textinfo","parts","split","hasFlag","flag","hasLabel","hasText","hasValue","hasPercent","getFirstFilled","makeTemplateVariables","customdata","obj","ptTx","texttemplateString","_d3locale","cosA","sinA","midX","midY","textX","textY","noCenter","module","exports"],"sources":["E:/tog_workspace/TestFabric_main/TestFabric-main/node_modules/plotly.js/src/traces/pie/plot.js"],"sourcesContent":["'use strict';\n\nvar d3 = require('@plotly/d3');\n\nvar Plots = require('../../plots/plots');\nvar Fx = require('../../components/fx');\nvar Color = require('../../components/color');\nvar Drawing = require('../../components/drawing');\nvar Lib = require('../../lib');\nvar strScale = Lib.strScale;\nvar strTranslate = Lib.strTranslate;\nvar svgTextUtils = require('../../lib/svg_text_utils');\nvar uniformText = require('../bar/uniform_text');\nvar recordMinTextSize = uniformText.recordMinTextSize;\nvar clearMinTextSize = uniformText.clearMinTextSize;\nvar TEXTPAD = require('../bar/constants').TEXTPAD;\n\nvar helpers = require('./helpers');\nvar eventData = require('./event_data');\nvar isValidTextValue = require('../../lib').isValidTextValue;\n\nfunction plot(gd, cdModule) {\n    var isStatic = gd._context.staticPlot;\n\n    var fullLayout = gd._fullLayout;\n    var gs = fullLayout._size;\n\n    clearMinTextSize('pie', fullLayout);\n\n    prerenderTitles(cdModule, gd);\n    layoutAreas(cdModule, gs);\n\n    var plotGroups = Lib.makeTraceGroups(fullLayout._pielayer, cdModule, 'trace').each(function(cd) {\n        var plotGroup = d3.select(this);\n        var cd0 = cd[0];\n        var trace = cd0.trace;\n\n        setCoords(cd);\n\n        // TODO: miter might look better but can sometimes cause problems\n        // maybe miter with a small-ish stroke-miterlimit?\n        plotGroup.attr('stroke-linejoin', 'round');\n\n        plotGroup.each(function() {\n            var slices = d3.select(this).selectAll('g.slice').data(cd);\n\n            slices.enter().append('g')\n                .classed('slice', true);\n            slices.exit().remove();\n\n            var quadrants = [\n                [[], []], // y<0: x<0, x>=0\n                [[], []] // y>=0: x<0, x>=0\n            ];\n            var hasOutsideText = false;\n\n            slices.each(function(pt, i) {\n                if(pt.hidden) {\n                    d3.select(this).selectAll('path,g').remove();\n                    return;\n                }\n\n                // to have consistent event data compared to other traces\n                pt.pointNumber = pt.i;\n                pt.curveNumber = trace.index;\n\n                quadrants[pt.pxmid[1] < 0 ? 0 : 1][pt.pxmid[0] < 0 ? 0 : 1].push(pt);\n\n                var cx = cd0.cx;\n                var cy = cd0.cy;\n                var sliceTop = d3.select(this);\n                var slicePath = sliceTop.selectAll('path.surface').data([pt]);\n\n                slicePath.enter().append('path')\n                    .classed('surface', true)\n                    .style({'pointer-events': isStatic ? 'none' : 'all'});\n\n                sliceTop.call(attachFxHandlers, gd, cd);\n\n                if(trace.pull) {\n                    var pull = +helpers.castOption(trace.pull, pt.pts) || 0;\n                    if(pull > 0) {\n                        cx += pull * pt.pxmid[0];\n                        cy += pull * pt.pxmid[1];\n                    }\n                }\n\n                pt.cxFinal = cx;\n                pt.cyFinal = cy;\n\n                function arc(start, finish, cw, scale) {\n                    var dx = scale * (finish[0] - start[0]);\n                    var dy = scale * (finish[1] - start[1]);\n\n                    return 'a' +\n                        (scale * cd0.r) + ',' + (scale * cd0.r) + ' 0 ' +\n                        pt.largeArc + (cw ? ' 1 ' : ' 0 ') + dx + ',' + dy;\n                }\n\n                var hole = trace.hole;\n                if(pt.v === cd0.vTotal) { // 100% fails bcs arc start and end are identical\n                    var outerCircle = 'M' + (cx + pt.px0[0]) + ',' + (cy + pt.px0[1]) +\n                        arc(pt.px0, pt.pxmid, true, 1) +\n                        arc(pt.pxmid, pt.px0, true, 1) + 'Z';\n                    if(hole) {\n                        slicePath.attr('d',\n                            'M' + (cx + hole * pt.px0[0]) + ',' + (cy + hole * pt.px0[1]) +\n                            arc(pt.px0, pt.pxmid, false, hole) +\n                            arc(pt.pxmid, pt.px0, false, hole) +\n                            'Z' + outerCircle);\n                    } else slicePath.attr('d', outerCircle);\n                } else {\n                    var outerArc = arc(pt.px0, pt.px1, true, 1);\n\n                    if(hole) {\n                        var rim = 1 - hole;\n                        slicePath.attr('d',\n                            'M' + (cx + hole * pt.px1[0]) + ',' + (cy + hole * pt.px1[1]) +\n                            arc(pt.px1, pt.px0, false, hole) +\n                            'l' + (rim * pt.px0[0]) + ',' + (rim * pt.px0[1]) +\n                            outerArc +\n                            'Z');\n                    } else {\n                        slicePath.attr('d',\n                            'M' + cx + ',' + cy +\n                            'l' + pt.px0[0] + ',' + pt.px0[1] +\n                            outerArc +\n                            'Z');\n                    }\n                }\n\n                // add text\n                formatSliceLabel(gd, pt, cd0);\n                var textPosition = helpers.castOption(trace.textposition, pt.pts);\n                var sliceTextGroup = sliceTop.selectAll('g.slicetext')\n                    .data(pt.text && (textPosition !== 'none') ? [0] : []);\n\n                sliceTextGroup.enter().append('g')\n                    .classed('slicetext', true);\n                sliceTextGroup.exit().remove();\n\n                sliceTextGroup.each(function() {\n                    var sliceText = Lib.ensureSingle(d3.select(this), 'text', '', function(s) {\n                        // prohibit tex interpretation until we can handle\n                        // tex and regular text together\n                        s.attr('data-notex', 1);\n                    });\n\n                    var font = Lib.ensureUniformFontSize(gd, textPosition === 'outside' ?\n                        determineOutsideTextFont(trace, pt, fullLayout.font) :\n                        determineInsideTextFont(trace, pt, fullLayout.font)\n                    );\n\n                    sliceText.text(pt.text)\n                        .attr({\n                            class: 'slicetext',\n                            transform: '',\n                            'text-anchor': 'middle'\n                        })\n                        .call(Drawing.font, font)\n                        .call(svgTextUtils.convertToTspans, gd);\n\n                    // position the text relative to the slice\n                    var textBB = Drawing.bBox(sliceText.node());\n                    var transform;\n\n                    if(textPosition === 'outside') {\n                        transform = transformOutsideText(textBB, pt);\n                    } else {\n                        transform = transformInsideText(textBB, pt, cd0);\n                        if(textPosition === 'auto' && transform.scale < 1) {\n                            var newFont = Lib.ensureUniformFontSize(gd, trace.outsidetextfont);\n\n                            sliceText.call(Drawing.font, newFont);\n                            textBB = Drawing.bBox(sliceText.node());\n\n                            transform = transformOutsideText(textBB, pt);\n                        }\n                    }\n\n                    var textPosAngle = transform.textPosAngle;\n                    var textXY = textPosAngle === undefined ? pt.pxmid : getCoords(cd0.r, textPosAngle);\n                    transform.targetX = cx + textXY[0] * transform.rCenter + (transform.x || 0);\n                    transform.targetY = cy + textXY[1] * transform.rCenter + (transform.y || 0);\n                    computeTransform(transform, textBB);\n\n                    // save some stuff to use later ensure no labels overlap\n                    if(transform.outside) {\n                        var targetY = transform.targetY;\n                        pt.yLabelMin = targetY - textBB.height / 2;\n                        pt.yLabelMid = targetY;\n                        pt.yLabelMax = targetY + textBB.height / 2;\n                        pt.labelExtraX = 0;\n                        pt.labelExtraY = 0;\n                        hasOutsideText = true;\n                    }\n\n                    transform.fontSize = font.size;\n                    recordMinTextSize(trace.type, transform, fullLayout);\n                    cd[i].transform = transform;\n\n                    Lib.setTransormAndDisplay(sliceText, transform);\n                });\n            });\n\n            // add the title\n            var titleTextGroup = d3.select(this).selectAll('g.titletext')\n                .data(trace.title.text ? [0] : []);\n\n            titleTextGroup.enter().append('g')\n                .classed('titletext', true);\n            titleTextGroup.exit().remove();\n\n            titleTextGroup.each(function() {\n                var titleText = Lib.ensureSingle(d3.select(this), 'text', '', function(s) {\n                    // prohibit tex interpretation as above\n                    s.attr('data-notex', 1);\n                });\n\n                var txt = trace.title.text;\n                if(trace._meta) {\n                    txt = Lib.templateString(txt, trace._meta);\n                }\n\n                titleText.text(txt)\n                    .attr({\n                        class: 'titletext',\n                        transform: '',\n                        'text-anchor': 'middle',\n                    })\n                .call(Drawing.font, trace.title.font)\n                .call(svgTextUtils.convertToTspans, gd);\n\n                var transform;\n\n                if(trace.title.position === 'middle center') {\n                    transform = positionTitleInside(cd0);\n                } else {\n                    transform = positionTitleOutside(cd0, gs);\n                }\n\n                titleText.attr('transform',\n                    strTranslate(transform.x, transform.y) +\n                    strScale(Math.min(1, transform.scale)) +\n                    strTranslate(transform.tx, transform.ty));\n            });\n\n            // now make sure no labels overlap (at least within one pie)\n            if(hasOutsideText) scootLabels(quadrants, trace);\n\n            plotTextLines(slices, trace);\n\n            if(hasOutsideText && trace.automargin) {\n                // TODO if we ever want to improve perf,\n                // we could reuse the textBB computed above together\n                // with the sliceText transform info\n                var traceBbox = Drawing.bBox(plotGroup.node());\n\n                var domain = trace.domain;\n                var vpw = gs.w * (domain.x[1] - domain.x[0]);\n                var vph = gs.h * (domain.y[1] - domain.y[0]);\n                var xgap = (0.5 * vpw - cd0.r) / gs.w;\n                var ygap = (0.5 * vph - cd0.r) / gs.h;\n\n                Plots.autoMargin(gd, 'pie.' + trace.uid + '.automargin', {\n                    xl: domain.x[0] - xgap,\n                    xr: domain.x[1] + xgap,\n                    yb: domain.y[0] - ygap,\n                    yt: domain.y[1] + ygap,\n                    l: Math.max(cd0.cx - cd0.r - traceBbox.left, 0),\n                    r: Math.max(traceBbox.right - (cd0.cx + cd0.r), 0),\n                    b: Math.max(traceBbox.bottom - (cd0.cy + cd0.r), 0),\n                    t: Math.max(cd0.cy - cd0.r - traceBbox.top, 0),\n                    pad: 5\n                });\n            }\n        });\n    });\n\n    // This is for a bug in Chrome (as of 2015-07-22, and does not affect FF)\n    // if insidetextfont and outsidetextfont are different sizes, sometimes the size\n    // of an \"em\" gets taken from the wrong element at first so lines are\n    // spaced wrong. You just have to tell it to try again later and it gets fixed.\n    // I have no idea why we haven't seen this in other contexts. Also, sometimes\n    // it gets the initial draw correct but on redraw it gets confused.\n    setTimeout(function() {\n        plotGroups.selectAll('tspan').each(function() {\n            var s = d3.select(this);\n            if(s.attr('dy')) s.attr('dy', s.attr('dy'));\n        });\n    }, 0);\n}\n\n// TODO add support for transition\nfunction plotTextLines(slices, trace) {\n    slices.each(function(pt) {\n        var sliceTop = d3.select(this);\n\n        if(!pt.labelExtraX && !pt.labelExtraY) {\n            sliceTop.select('path.textline').remove();\n            return;\n        }\n\n        // first move the text to its new location\n        var sliceText = sliceTop.select('g.slicetext text');\n\n        pt.transform.targetX += pt.labelExtraX;\n        pt.transform.targetY += pt.labelExtraY;\n\n        Lib.setTransormAndDisplay(sliceText, pt.transform);\n\n        // then add a line to the new location\n        var lineStartX = pt.cxFinal + pt.pxmid[0];\n        var lineStartY = pt.cyFinal + pt.pxmid[1];\n        var textLinePath = 'M' + lineStartX + ',' + lineStartY;\n        var finalX = (pt.yLabelMax - pt.yLabelMin) * (pt.pxmid[0] < 0 ? -1 : 1) / 4;\n\n        if(pt.labelExtraX) {\n            var yFromX = pt.labelExtraX * pt.pxmid[1] / pt.pxmid[0];\n            var yNet = pt.yLabelMid + pt.labelExtraY - (pt.cyFinal + pt.pxmid[1]);\n\n            if(Math.abs(yFromX) > Math.abs(yNet)) {\n                textLinePath +=\n                    'l' + (yNet * pt.pxmid[0] / pt.pxmid[1]) + ',' + yNet +\n                    'H' + (lineStartX + pt.labelExtraX + finalX);\n            } else {\n                textLinePath += 'l' + pt.labelExtraX + ',' + yFromX +\n                    'v' + (yNet - yFromX) +\n                    'h' + finalX;\n            }\n        } else {\n            textLinePath +=\n                'V' + (pt.yLabelMid + pt.labelExtraY) +\n                'h' + finalX;\n        }\n\n        Lib.ensureSingle(sliceTop, 'path', 'textline')\n            .call(Color.stroke, trace.outsidetextfont.color)\n            .attr({\n                'stroke-width': Math.min(2, trace.outsidetextfont.size / 8),\n                d: textLinePath,\n                fill: 'none'\n            });\n    });\n}\n\nfunction attachFxHandlers(sliceTop, gd, cd) {\n    var cd0 = cd[0];\n    var cx = cd0.cx;\n    var cy = cd0.cy;\n    var trace = cd0.trace;\n    var isFunnelArea = trace.type === 'funnelarea';\n\n    // hover state vars\n    // have we drawn a hover label, so it should be cleared later\n    if(!('_hasHoverLabel' in trace)) trace._hasHoverLabel = false;\n    // have we emitted a hover event, so later an unhover event should be emitted\n    // note that click events do not depend on this - you can still get them\n    // with hovermode: false or if you were earlier dragging, then clicked\n    // in the same slice that you moused up in\n    if(!('_hasHoverEvent' in trace)) trace._hasHoverEvent = false;\n\n    sliceTop.on('mouseover', function(pt) {\n        // in case fullLayout or fullData has changed without a replot\n        var fullLayout2 = gd._fullLayout;\n        var trace2 = gd._fullData[trace.index];\n\n        if(gd._dragging || fullLayout2.hovermode === false) return;\n\n        var hoverinfo = trace2.hoverinfo;\n        if(Array.isArray(hoverinfo)) {\n            // super hacky: we need to pull out the *first* hoverinfo from\n            // pt.pts, then put it back into an array in a dummy trace\n            // and call castHoverinfo on that.\n            // TODO: do we want to have Fx.castHoverinfo somehow handle this?\n            // it already takes an array for index, for 2D, so this seems tricky.\n            hoverinfo = Fx.castHoverinfo({\n                hoverinfo: [helpers.castOption(hoverinfo, pt.pts)],\n                _module: trace._module\n            }, fullLayout2, 0);\n        }\n\n        if(hoverinfo === 'all') hoverinfo = 'label+text+value+percent+name';\n\n        // in case we dragged over the pie from another subplot,\n        // or if hover is turned off\n        if(trace2.hovertemplate || (hoverinfo !== 'none' && hoverinfo !== 'skip' && hoverinfo)) {\n            var rInscribed = pt.rInscribed || 0;\n            var hoverCenterX = cx + pt.pxmid[0] * (1 - rInscribed);\n            var hoverCenterY = cy + pt.pxmid[1] * (1 - rInscribed);\n            var separators = fullLayout2.separators;\n            var text = [];\n\n            if(hoverinfo && hoverinfo.indexOf('label') !== -1) text.push(pt.label);\n            pt.text = helpers.castOption(trace2.hovertext || trace2.text, pt.pts);\n            if(hoverinfo && hoverinfo.indexOf('text') !== -1) {\n                var tx = pt.text;\n                if(Lib.isValidTextValue(tx)) text.push(tx);\n            }\n            pt.value = pt.v;\n            pt.valueLabel = helpers.formatPieValue(pt.v, separators);\n            if(hoverinfo && hoverinfo.indexOf('value') !== -1) text.push(pt.valueLabel);\n            pt.percent = pt.v / cd0.vTotal;\n            pt.percentLabel = helpers.formatPiePercent(pt.percent, separators);\n            if(hoverinfo && hoverinfo.indexOf('percent') !== -1) text.push(pt.percentLabel);\n\n            var hoverLabel = trace2.hoverlabel;\n            var hoverFont = hoverLabel.font;\n\n            var bbox = [];\n            Fx.loneHover({\n                trace: trace,\n                x0: hoverCenterX - rInscribed * cd0.r,\n                x1: hoverCenterX + rInscribed * cd0.r,\n                y: hoverCenterY,\n                _x0: isFunnelArea ? cx + pt.TL[0] : hoverCenterX - rInscribed * cd0.r,\n                _x1: isFunnelArea ? cx + pt.TR[0] : hoverCenterX + rInscribed * cd0.r,\n                _y0: isFunnelArea ? cy + pt.TL[1] : hoverCenterY - rInscribed * cd0.r,\n                _y1: isFunnelArea ? cy + pt.BL[1] : hoverCenterY + rInscribed * cd0.r,\n                text: text.join('<br>'),\n                name: (trace2.hovertemplate || hoverinfo.indexOf('name') !== -1) ? trace2.name : undefined,\n                idealAlign: pt.pxmid[0] < 0 ? 'left' : 'right',\n                color: helpers.castOption(hoverLabel.bgcolor, pt.pts) || pt.color,\n                borderColor: helpers.castOption(hoverLabel.bordercolor, pt.pts),\n                fontFamily: helpers.castOption(hoverFont.family, pt.pts),\n                fontSize: helpers.castOption(hoverFont.size, pt.pts),\n                fontColor: helpers.castOption(hoverFont.color, pt.pts),\n                nameLength: helpers.castOption(hoverLabel.namelength, pt.pts),\n                textAlign: helpers.castOption(hoverLabel.align, pt.pts),\n                hovertemplate: helpers.castOption(trace2.hovertemplate, pt.pts),\n                hovertemplateLabels: pt,\n                eventData: [eventData(pt, trace2)]\n            }, {\n                container: fullLayout2._hoverlayer.node(),\n                outerContainer: fullLayout2._paper.node(),\n                gd: gd,\n                inOut_bbox: bbox\n            });\n            pt.bbox = bbox[0];\n\n            trace._hasHoverLabel = true;\n        }\n\n        trace._hasHoverEvent = true;\n        gd.emit('plotly_hover', {\n            points: [eventData(pt, trace2)],\n            event: d3.event\n        });\n    });\n\n    sliceTop.on('mouseout', function(evt) {\n        var fullLayout2 = gd._fullLayout;\n        var trace2 = gd._fullData[trace.index];\n        var pt = d3.select(this).datum();\n\n        if(trace._hasHoverEvent) {\n            evt.originalEvent = d3.event;\n            gd.emit('plotly_unhover', {\n                points: [eventData(pt, trace2)],\n                event: d3.event\n            });\n            trace._hasHoverEvent = false;\n        }\n\n        if(trace._hasHoverLabel) {\n            Fx.loneUnhover(fullLayout2._hoverlayer.node());\n            trace._hasHoverLabel = false;\n        }\n    });\n\n    sliceTop.on('click', function(pt) {\n        // TODO: this does not support right-click. If we want to support it, we\n        // would likely need to change pie to use dragElement instead of straight\n        // map subplot event binding. Or perhaps better, make a simple wrapper with the\n        // right mousedown, mousemove, and mouseup handlers just for a left/right click\n        // map subplots would use this too.\n        var fullLayout2 = gd._fullLayout;\n        var trace2 = gd._fullData[trace.index];\n\n        if(gd._dragging || fullLayout2.hovermode === false) return;\n\n        gd._hoverdata = [eventData(pt, trace2)];\n        Fx.click(gd, d3.event);\n    });\n}\n\nfunction determineOutsideTextFont(trace, pt, layoutFont) {\n    var color =\n        helpers.castOption(trace.outsidetextfont.color, pt.pts) ||\n        helpers.castOption(trace.textfont.color, pt.pts) ||\n        layoutFont.color;\n\n    var family =\n        helpers.castOption(trace.outsidetextfont.family, pt.pts) ||\n        helpers.castOption(trace.textfont.family, pt.pts) ||\n        layoutFont.family;\n\n    var size =\n        helpers.castOption(trace.outsidetextfont.size, pt.pts) ||\n        helpers.castOption(trace.textfont.size, pt.pts) ||\n        layoutFont.size;\n\n    var weight =\n        helpers.castOption(trace.outsidetextfont.weight, pt.pts) ||\n        helpers.castOption(trace.textfont.weight, pt.pts) ||\n        layoutFont.weight;\n\n    var style =\n        helpers.castOption(trace.outsidetextfont.style, pt.pts) ||\n        helpers.castOption(trace.textfont.style, pt.pts) ||\n        layoutFont.style;\n\n    var variant =\n        helpers.castOption(trace.outsidetextfont.variant, pt.pts) ||\n        helpers.castOption(trace.textfont.variant, pt.pts) ||\n        layoutFont.variant;\n\n    var textcase =\n        helpers.castOption(trace.outsidetextfont.textcase, pt.pts) ||\n        helpers.castOption(trace.textfont.textcase, pt.pts) ||\n        layoutFont.textcase;\n\n    var lineposition =\n        helpers.castOption(trace.outsidetextfont.lineposition, pt.pts) ||\n        helpers.castOption(trace.textfont.lineposition, pt.pts) ||\n        layoutFont.lineposition;\n\n    var shadow =\n        helpers.castOption(trace.outsidetextfont.shadow, pt.pts) ||\n        helpers.castOption(trace.textfont.shadow, pt.pts) ||\n        layoutFont.shadow;\n\n    return {\n        color: color,\n        family: family,\n        size: size,\n        weight: weight,\n        style: style,\n        variant: variant,\n        textcase: textcase,\n        lineposition: lineposition,\n        shadow: shadow,\n    };\n}\n\nfunction determineInsideTextFont(trace, pt, layoutFont) {\n    var customColor = helpers.castOption(trace.insidetextfont.color, pt.pts);\n    if(!customColor && trace._input.textfont) {\n        // Why not simply using trace.textfont? Because if not set, it\n        // defaults to layout.font which has a default color. But if\n        // textfont.color and insidetextfont.color don't supply a value,\n        // a contrasting color shall be used.\n        customColor = helpers.castOption(trace._input.textfont.color, pt.pts);\n    }\n\n    var family =\n        helpers.castOption(trace.insidetextfont.family, pt.pts) ||\n        helpers.castOption(trace.textfont.family, pt.pts) ||\n        layoutFont.family;\n\n    var size =\n        helpers.castOption(trace.insidetextfont.size, pt.pts) ||\n        helpers.castOption(trace.textfont.size, pt.pts) ||\n        layoutFont.size;\n\n    var weight =\n        helpers.castOption(trace.insidetextfont.weight, pt.pts) ||\n        helpers.castOption(trace.textfont.weight, pt.pts) ||\n        layoutFont.weight;\n\n    var style =\n        helpers.castOption(trace.insidetextfont.style, pt.pts) ||\n        helpers.castOption(trace.textfont.style, pt.pts) ||\n        layoutFont.style;\n\n    var variant =\n        helpers.castOption(trace.insidetextfont.variant, pt.pts) ||\n        helpers.castOption(trace.textfont.variant, pt.pts) ||\n        layoutFont.variant;\n\n    var textcase =\n        helpers.castOption(trace.insidetextfont.textcase, pt.pts) ||\n        helpers.castOption(trace.textfont.textcase, pt.pts) ||\n        layoutFont.textcase;\n\n    var lineposition =\n        helpers.castOption(trace.insidetextfont.lineposition, pt.pts) ||\n        helpers.castOption(trace.textfont.lineposition, pt.pts) ||\n        layoutFont.lineposition;\n\n    var shadow =\n        helpers.castOption(trace.insidetextfont.shadow, pt.pts) ||\n        helpers.castOption(trace.textfont.shadow, pt.pts) ||\n        layoutFont.shadow;\n\n    return {\n        color: customColor || Color.contrast(pt.color),\n        family: family,\n        size: size,\n        weight: weight,\n        style: style,\n        variant: variant,\n        textcase: textcase,\n        lineposition: lineposition,\n        shadow: shadow,\n    };\n}\n\nfunction prerenderTitles(cdModule, gd) {\n    var cd0, trace;\n\n    // Determine the width and height of the title for each pie.\n    for(var i = 0; i < cdModule.length; i++) {\n        cd0 = cdModule[i][0];\n        trace = cd0.trace;\n\n        if(trace.title.text) {\n            var txt = trace.title.text;\n            if(trace._meta) {\n                txt = Lib.templateString(txt, trace._meta);\n            }\n\n            var dummyTitle = Drawing.tester.append('text')\n              .attr('data-notex', 1)\n              .text(txt)\n              .call(Drawing.font, trace.title.font)\n              .call(svgTextUtils.convertToTspans, gd);\n            var bBox = Drawing.bBox(dummyTitle.node(), true);\n            cd0.titleBox = {\n                width: bBox.width,\n                height: bBox.height,\n            };\n            dummyTitle.remove();\n        }\n    }\n}\n\nfunction transformInsideText(textBB, pt, cd0) {\n    var r = cd0.r || pt.rpx1;\n    var rInscribed = pt.rInscribed;\n\n    var isEmpty = pt.startangle === pt.stopangle;\n    if(isEmpty) {\n        return {\n            rCenter: 1 - rInscribed,\n            scale: 0,\n            rotate: 0,\n            textPosAngle: 0\n        };\n    }\n\n    var ring = pt.ring;\n    var isCircle = (ring === 1) && (Math.abs(pt.startangle - pt.stopangle) === Math.PI * 2);\n\n    var halfAngle = pt.halfangle;\n    var midAngle = pt.midangle;\n\n    var orientation = cd0.trace.insidetextorientation;\n    var isHorizontal = orientation === 'horizontal';\n    var isTangential = orientation === 'tangential';\n    var isRadial = orientation === 'radial';\n    var isAuto = orientation === 'auto';\n\n    var allTransforms = [];\n    var newT;\n\n    if(!isAuto) {\n        // max size if text is placed (horizontally) at the top or bottom of the arc\n\n        var considerCrossing = function(angle, key) {\n            if(isCrossing(pt, angle)) {\n                var dStart = Math.abs(angle - pt.startangle);\n                var dStop = Math.abs(angle - pt.stopangle);\n\n                var closestEdge = dStart < dStop ? dStart : dStop;\n\n                if(key === 'tan') {\n                    newT = calcTanTransform(textBB, r, ring, closestEdge, 0);\n                } else { // case of 'rad'\n                    newT = calcRadTransform(textBB, r, ring, closestEdge, Math.PI / 2);\n                }\n                newT.textPosAngle = angle;\n\n                allTransforms.push(newT);\n            }\n        };\n\n        // to cover all cases with trace.rotation added\n        var i;\n        if(isHorizontal || isTangential) {\n            // top\n            for(i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * i, 'tan');\n            // bottom\n            for(i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 1), 'tan');\n        }\n        if(isHorizontal || isRadial) {\n            // left\n            for(i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 1.5), 'rad');\n            // right\n            for(i = 4; i >= -4; i -= 2) considerCrossing(Math.PI * (i + 0.5), 'rad');\n        }\n    }\n\n    if(isCircle || isAuto || isHorizontal) {\n        // max size text can be inserted inside without rotating it\n        // this inscribes the text rectangle in a circle, which is then inscribed\n        // in the slice, so it will be an underestimate, which some day we may want\n        // to improve so this case can get more use\n        var textDiameter = Math.sqrt(textBB.width * textBB.width + textBB.height * textBB.height);\n\n        newT = {\n            scale: rInscribed * r * 2 / textDiameter,\n\n            // and the center position and rotation in this case\n            rCenter: 1 - rInscribed,\n            rotate: 0\n        };\n\n        newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n        if(newT.scale >= 1) return newT;\n\n        allTransforms.push(newT);\n    }\n\n    if(isAuto || isRadial) {\n        newT = calcRadTransform(textBB, r, ring, halfAngle, midAngle);\n        newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n        allTransforms.push(newT);\n    }\n\n    if(isAuto || isTangential) {\n        newT = calcTanTransform(textBB, r, ring, halfAngle, midAngle);\n        newT.textPosAngle = (pt.startangle + pt.stopangle) / 2;\n        allTransforms.push(newT);\n    }\n\n    var id = 0;\n    var maxScale = 0;\n    for(var k = 0; k < allTransforms.length; k++) {\n        var s = allTransforms[k].scale;\n        if(maxScale < s) {\n            maxScale = s;\n            id = k;\n        }\n\n        if(!isAuto && maxScale >= 1) {\n            // respect test order for non-auto options\n            break;\n        }\n    }\n    return allTransforms[id];\n}\n\nfunction isCrossing(pt, angle) {\n    var start = pt.startangle;\n    var stop = pt.stopangle;\n    return (\n        (start > angle && angle > stop) ||\n        (start < angle && angle < stop)\n    );\n}\n\nfunction calcRadTransform(textBB, r, ring, halfAngle, midAngle) {\n    r = Math.max(0, r - 2 * TEXTPAD);\n\n    // max size if text is rotated radially\n    var a = textBB.width / textBB.height;\n    var s = calcMaxHalfSize(a, halfAngle, r, ring);\n    return {\n        scale: s * 2 / textBB.height,\n        rCenter: calcRCenter(a, s / r),\n        rotate: calcRotate(midAngle)\n    };\n}\n\nfunction calcTanTransform(textBB, r, ring, halfAngle, midAngle) {\n    r = Math.max(0, r - 2 * TEXTPAD);\n\n    // max size if text is rotated tangentially\n    var a = textBB.height / textBB.width;\n    var s = calcMaxHalfSize(a, halfAngle, r, ring);\n    return {\n        scale: s * 2 / textBB.width,\n        rCenter: calcRCenter(a, s / r),\n        rotate: calcRotate(midAngle + Math.PI / 2)\n    };\n}\n\nfunction calcRCenter(a, b) {\n    return Math.cos(b) - a * b;\n}\n\nfunction calcRotate(t) {\n    return (180 / Math.PI * t + 720) % 180 - 90;\n}\n\nfunction calcMaxHalfSize(a, halfAngle, r, ring) {\n    var q = a + 1 / (2 * Math.tan(halfAngle));\n    return r * Math.min(\n        1 / (Math.sqrt(q * q + 0.5) + q),\n        ring / (Math.sqrt(a * a + ring / 2) + a)\n    );\n}\n\nfunction getInscribedRadiusFraction(pt, cd0) {\n    if(pt.v === cd0.vTotal && !cd0.trace.hole) return 1;// special case of 100% with no hole\n\n    return Math.min(1 / (1 + 1 / Math.sin(pt.halfangle)), pt.ring / 2);\n}\n\nfunction transformOutsideText(textBB, pt) {\n    var x = pt.pxmid[0];\n    var y = pt.pxmid[1];\n    var dx = textBB.width / 2;\n    var dy = textBB.height / 2;\n\n    if(x < 0) dx *= -1;\n    if(y < 0) dy *= -1;\n\n    return {\n        scale: 1,\n        rCenter: 1,\n        rotate: 0,\n        x: dx + Math.abs(dy) * (dx > 0 ? 1 : -1) / 2,\n        y: dy / (1 + x * x / (y * y)),\n        outside: true\n    };\n}\n\nfunction positionTitleInside(cd0) {\n    var textDiameter =\n        Math.sqrt(cd0.titleBox.width * cd0.titleBox.width + cd0.titleBox.height * cd0.titleBox.height);\n    return {\n        x: cd0.cx,\n        y: cd0.cy,\n        scale: cd0.trace.hole * cd0.r * 2 / textDiameter,\n        tx: 0,\n        ty: - cd0.titleBox.height / 2 + cd0.trace.title.font.size\n    };\n}\n\nfunction positionTitleOutside(cd0, plotSize) {\n    var scaleX = 1;\n    var scaleY = 1;\n    var maxPull;\n\n    var trace = cd0.trace;\n    // position of the baseline point of the text box in the plot, before scaling.\n    // we anchored the text in the middle, so the baseline is on the bottom middle\n    // of the first line of text.\n    var topMiddle = {\n        x: cd0.cx,\n        y: cd0.cy\n    };\n    // relative translation of the text box after scaling\n    var translate = {\n        tx: 0,\n        ty: 0\n    };\n\n    // we reason below as if the baseline is the top middle point of the text box.\n    // so we must add the font size to approximate the y-coord. of the top.\n    // note that this correction must happen after scaling.\n    translate.ty += trace.title.font.size;\n    maxPull = getMaxPull(trace);\n\n    if(trace.title.position.indexOf('top') !== -1) {\n        topMiddle.y -= (1 + maxPull) * cd0.r;\n        translate.ty -= cd0.titleBox.height;\n    } else if(trace.title.position.indexOf('bottom') !== -1) {\n        topMiddle.y += (1 + maxPull) * cd0.r;\n    }\n\n    var rx = applyAspectRatio(cd0.r, cd0.trace.aspectratio);\n\n    var maxWidth = plotSize.w * (trace.domain.x[1] - trace.domain.x[0]) / 2;\n    if(trace.title.position.indexOf('left') !== -1) {\n        // we start the text at the left edge of the pie\n        maxWidth = maxWidth + rx;\n        topMiddle.x -= (1 + maxPull) * rx;\n        translate.tx += cd0.titleBox.width / 2;\n    } else if(trace.title.position.indexOf('center') !== -1) {\n        maxWidth *= 2;\n    } else if(trace.title.position.indexOf('right') !== -1) {\n        maxWidth = maxWidth + rx;\n        topMiddle.x += (1 + maxPull) * rx;\n        translate.tx -= cd0.titleBox.width / 2;\n    }\n    scaleX = maxWidth / cd0.titleBox.width;\n    scaleY = getTitleSpace(cd0, plotSize) / cd0.titleBox.height;\n    return {\n        x: topMiddle.x,\n        y: topMiddle.y,\n        scale: Math.min(scaleX, scaleY),\n        tx: translate.tx,\n        ty: translate.ty\n    };\n}\n\nfunction applyAspectRatio(x, aspectratio) {\n    return x / ((aspectratio === undefined) ? 1 : aspectratio);\n}\n\nfunction getTitleSpace(cd0, plotSize) {\n    var trace = cd0.trace;\n    var pieBoxHeight = plotSize.h * (trace.domain.y[1] - trace.domain.y[0]);\n    // use at most half of the plot for the title\n    return Math.min(cd0.titleBox.height, pieBoxHeight / 2);\n}\n\nfunction getMaxPull(trace) {\n    var maxPull = trace.pull;\n    if(!maxPull) return 0;\n\n    var j;\n    if(Lib.isArrayOrTypedArray(maxPull)) {\n        maxPull = 0;\n        for(j = 0; j < trace.pull.length; j++) {\n            if(trace.pull[j] > maxPull) maxPull = trace.pull[j];\n        }\n    }\n    return maxPull;\n}\n\nfunction scootLabels(quadrants, trace) {\n    var xHalf, yHalf, equatorFirst, farthestX, farthestY,\n        xDiffSign, yDiffSign, thisQuad, oppositeQuad,\n        wholeSide, i, thisQuadOutside, firstOppositeOutsidePt;\n\n    function topFirst(a, b) { return a.pxmid[1] - b.pxmid[1]; }\n    function bottomFirst(a, b) { return b.pxmid[1] - a.pxmid[1]; }\n\n    function scootOneLabel(thisPt, prevPt) {\n        if(!prevPt) prevPt = {};\n\n        var prevOuterY = prevPt.labelExtraY + (yHalf ? prevPt.yLabelMax : prevPt.yLabelMin);\n        var thisInnerY = yHalf ? thisPt.yLabelMin : thisPt.yLabelMax;\n        var thisOuterY = yHalf ? thisPt.yLabelMax : thisPt.yLabelMin;\n        var thisSliceOuterY = thisPt.cyFinal + farthestY(thisPt.px0[1], thisPt.px1[1]);\n        var newExtraY = prevOuterY - thisInnerY;\n\n        var xBuffer, i, otherPt, otherOuterY, otherOuterX, newExtraX;\n\n        // make sure this label doesn't overlap other labels\n        // this *only* has us move these labels vertically\n        if(newExtraY * yDiffSign > 0) thisPt.labelExtraY = newExtraY;\n\n        // make sure this label doesn't overlap any slices\n        if(!Lib.isArrayOrTypedArray(trace.pull)) return; // this can only happen with array pulls\n\n        for(i = 0; i < wholeSide.length; i++) {\n            otherPt = wholeSide[i];\n\n            // overlap can only happen if the other point is pulled more than this one\n            if(otherPt === thisPt || (\n                (helpers.castOption(trace.pull, thisPt.pts) || 0) >=\n                (helpers.castOption(trace.pull, otherPt.pts) || 0))\n            ) {\n                continue;\n            }\n\n            if((thisPt.pxmid[1] - otherPt.pxmid[1]) * yDiffSign > 0) {\n                // closer to the equator - by construction all of these happen first\n                // move the text vertically to get away from these slices\n                otherOuterY = otherPt.cyFinal + farthestY(otherPt.px0[1], otherPt.px1[1]);\n                newExtraY = otherOuterY - thisInnerY - thisPt.labelExtraY;\n\n                if(newExtraY * yDiffSign > 0) thisPt.labelExtraY += newExtraY;\n            } else if((thisOuterY + thisPt.labelExtraY - thisSliceOuterY) * yDiffSign > 0) {\n                // farther from the equator - happens after we've done all the\n                // vertical moving we're going to do\n                // move horizontally to get away from these more polar slices\n\n                // if we're moving horz. based on a slice that's several slices away from this one\n                // then we need some extra space for the lines to labels between them\n                xBuffer = 3 * xDiffSign * Math.abs(i - wholeSide.indexOf(thisPt));\n\n                otherOuterX = otherPt.cxFinal + farthestX(otherPt.px0[0], otherPt.px1[0]);\n                newExtraX = otherOuterX + xBuffer - (thisPt.cxFinal + thisPt.pxmid[0]) - thisPt.labelExtraX;\n\n                if(newExtraX * xDiffSign > 0) thisPt.labelExtraX += newExtraX;\n            }\n        }\n    }\n\n    for(yHalf = 0; yHalf < 2; yHalf++) {\n        equatorFirst = yHalf ? topFirst : bottomFirst;\n        farthestY = yHalf ? Math.max : Math.min;\n        yDiffSign = yHalf ? 1 : -1;\n\n        for(xHalf = 0; xHalf < 2; xHalf++) {\n            farthestX = xHalf ? Math.max : Math.min;\n            xDiffSign = xHalf ? 1 : -1;\n\n            // first sort the array\n            // note this is a copy of cd, so cd itself doesn't get sorted\n            // but we can still modify points in place.\n            thisQuad = quadrants[yHalf][xHalf];\n            thisQuad.sort(equatorFirst);\n\n            oppositeQuad = quadrants[1 - yHalf][xHalf];\n            wholeSide = oppositeQuad.concat(thisQuad);\n\n            thisQuadOutside = [];\n            for(i = 0; i < thisQuad.length; i++) {\n                if(thisQuad[i].yLabelMid !== undefined) thisQuadOutside.push(thisQuad[i]);\n            }\n\n            firstOppositeOutsidePt = false;\n            for(i = 0; yHalf && i < oppositeQuad.length; i++) {\n                if(oppositeQuad[i].yLabelMid !== undefined) {\n                    firstOppositeOutsidePt = oppositeQuad[i];\n                    break;\n                }\n            }\n\n            // each needs to avoid the previous\n            for(i = 0; i < thisQuadOutside.length; i++) {\n                var prevPt = i && thisQuadOutside[i - 1];\n                // bottom half needs to avoid the first label of the top half\n                // top half we still need to call scootOneLabel on the first slice\n                // so we can avoid other slices, but we don't pass a prevPt\n                if(firstOppositeOutsidePt && !i) prevPt = firstOppositeOutsidePt;\n                scootOneLabel(thisQuadOutside[i], prevPt);\n            }\n        }\n    }\n}\n\nfunction layoutAreas(cdModule, plotSize) {\n    var scaleGroups = [];\n\n    // figure out the center and maximum radius\n    for(var i = 0; i < cdModule.length; i++) {\n        var cd0 = cdModule[i][0];\n        var trace = cd0.trace;\n\n        var domain = trace.domain;\n        var width = plotSize.w * (domain.x[1] - domain.x[0]);\n        var height = plotSize.h * (domain.y[1] - domain.y[0]);\n        // leave some space for the title, if it will be displayed outside\n        if(trace.title.text && trace.title.position !== 'middle center') {\n            height -= getTitleSpace(cd0, plotSize);\n        }\n\n        var rx = width / 2;\n        var ry = height / 2;\n        if(trace.type === 'funnelarea' && !trace.scalegroup) {\n            ry /= trace.aspectratio;\n        }\n\n        cd0.r = Math.min(rx, ry) / (1 + getMaxPull(trace));\n\n        cd0.cx = plotSize.l + plotSize.w * (trace.domain.x[1] + trace.domain.x[0]) / 2;\n        cd0.cy = plotSize.t + plotSize.h * (1 - trace.domain.y[0]) - height / 2;\n        if(trace.title.text && trace.title.position.indexOf('bottom') !== -1) {\n            cd0.cy -= getTitleSpace(cd0, plotSize);\n        }\n\n        if(trace.scalegroup && scaleGroups.indexOf(trace.scalegroup) === -1) {\n            scaleGroups.push(trace.scalegroup);\n        }\n    }\n\n    groupScale(cdModule, scaleGroups);\n}\n\nfunction groupScale(cdModule, scaleGroups) {\n    var cd0, i, trace;\n\n    // scale those that are grouped\n    for(var k = 0; k < scaleGroups.length; k++) {\n        var min = Infinity;\n        var g = scaleGroups[k];\n\n        for(i = 0; i < cdModule.length; i++) {\n            cd0 = cdModule[i][0];\n            trace = cd0.trace;\n\n            if(trace.scalegroup === g) {\n                var area;\n                if(trace.type === 'pie') {\n                    area = cd0.r * cd0.r;\n                } else if(trace.type === 'funnelarea') {\n                    var rx, ry;\n\n                    if(trace.aspectratio > 1) {\n                        rx = cd0.r;\n                        ry = rx / trace.aspectratio;\n                    } else {\n                        ry = cd0.r;\n                        rx = ry * trace.aspectratio;\n                    }\n\n                    rx *= (1 + trace.baseratio) / 2;\n\n                    area = rx * ry;\n                }\n\n                min = Math.min(min, area / cd0.vTotal);\n            }\n        }\n\n        for(i = 0; i < cdModule.length; i++) {\n            cd0 = cdModule[i][0];\n            trace = cd0.trace;\n            if(trace.scalegroup === g) {\n                var v = min * cd0.vTotal;\n                if(trace.type === 'funnelarea') {\n                    v /= (1 + trace.baseratio) / 2;\n                    v /= trace.aspectratio;\n                }\n\n                cd0.r = Math.sqrt(v);\n            }\n        }\n    }\n}\n\nfunction setCoords(cd) {\n    var cd0 = cd[0];\n    var r = cd0.r;\n    var trace = cd0.trace;\n    var currentAngle = helpers.getRotationAngle(trace.rotation);\n    var angleFactor = 2 * Math.PI / cd0.vTotal;\n    var firstPt = 'px0';\n    var lastPt = 'px1';\n\n    var i, cdi, currentCoords;\n\n    if(trace.direction === 'counterclockwise') {\n        for(i = 0; i < cd.length; i++) {\n            if(!cd[i].hidden) break; // find the first non-hidden slice\n        }\n        if(i === cd.length) return; // all slices hidden\n\n        currentAngle += angleFactor * cd[i].v;\n        angleFactor *= -1;\n        firstPt = 'px1';\n        lastPt = 'px0';\n    }\n\n    currentCoords = getCoords(r, currentAngle);\n\n    for(i = 0; i < cd.length; i++) {\n        cdi = cd[i];\n        if(cdi.hidden) continue;\n\n        cdi[firstPt] = currentCoords;\n\n        cdi.startangle = currentAngle;\n        currentAngle += angleFactor * cdi.v / 2;\n        cdi.pxmid = getCoords(r, currentAngle);\n        cdi.midangle = currentAngle;\n        currentAngle += angleFactor * cdi.v / 2;\n        currentCoords = getCoords(r, currentAngle);\n        cdi.stopangle = currentAngle;\n\n        cdi[lastPt] = currentCoords;\n\n        cdi.largeArc = (cdi.v > cd0.vTotal / 2) ? 1 : 0;\n\n        cdi.halfangle = Math.PI * Math.min(cdi.v / cd0.vTotal, 0.5);\n        cdi.ring = 1 - trace.hole;\n        cdi.rInscribed = getInscribedRadiusFraction(cdi, cd0);\n    }\n}\n\nfunction getCoords(r, angle) {\n    return [r * Math.sin(angle), -r * Math.cos(angle)];\n}\n\nfunction formatSliceLabel(gd, pt, cd0) {\n    var fullLayout = gd._fullLayout;\n    var trace = cd0.trace;\n    // look for textemplate\n    var texttemplate = trace.texttemplate;\n\n    // now insert text\n    var textinfo = trace.textinfo;\n    if(!texttemplate && textinfo && textinfo !== 'none') {\n        var parts = textinfo.split('+');\n        var hasFlag = function(flag) { return parts.indexOf(flag) !== -1; };\n        var hasLabel = hasFlag('label');\n        var hasText = hasFlag('text');\n        var hasValue = hasFlag('value');\n        var hasPercent = hasFlag('percent');\n\n        var separators = fullLayout.separators;\n        var text;\n\n        text = hasLabel ? [pt.label] : [];\n        if(hasText) {\n            var tx = helpers.getFirstFilled(trace.text, pt.pts);\n            if(isValidTextValue(tx)) text.push(tx);\n        }\n        if(hasValue) text.push(helpers.formatPieValue(pt.v, separators));\n        if(hasPercent) text.push(helpers.formatPiePercent(pt.v / cd0.vTotal, separators));\n        pt.text = text.join('<br>');\n    }\n\n    function makeTemplateVariables(pt) {\n        return {\n            label: pt.label,\n            value: pt.v,\n            valueLabel: helpers.formatPieValue(pt.v, fullLayout.separators),\n            percent: pt.v / cd0.vTotal,\n            percentLabel: helpers.formatPiePercent(pt.v / cd0.vTotal, fullLayout.separators),\n            color: pt.color,\n            text: pt.text,\n            customdata: Lib.castOption(trace, pt.i, 'customdata')\n        };\n    }\n\n    if(texttemplate) {\n        var txt = Lib.castOption(trace, pt.i, 'texttemplate');\n        if(!txt) {\n            pt.text = '';\n        } else {\n            var obj = makeTemplateVariables(pt);\n            var ptTx = helpers.getFirstFilled(trace.text, pt.pts);\n            if(isValidTextValue(ptTx) || ptTx === '') obj.text = ptTx;\n            pt.text = Lib.texttemplateString(txt, obj, gd._fullLayout._d3locale, obj, trace._meta || {});\n        }\n    }\n}\n\nfunction computeTransform(\n    transform,  // inout\n    textBB      // in\n) {\n    var a = transform.rotate * Math.PI / 180;\n    var cosA = Math.cos(a);\n    var sinA = Math.sin(a);\n    var midX = (textBB.left + textBB.right) / 2;\n    var midY = (textBB.top + textBB.bottom) / 2;\n    transform.textX = midX * cosA - midY * sinA;\n    transform.textY = midX * sinA + midY * cosA;\n    transform.noCenter = true;\n}\n\nmodule.exports = {\n    plot: plot,\n    formatSliceLabel: formatSliceLabel,\n    transformInsideText: transformInsideText,\n    determineInsideTextFont: determineInsideTextFont,\n    positionTitleOutside: positionTitleOutside,\n    prerenderTitles: prerenderTitles,\n    layoutAreas: layoutAreas,\n    attachFxHandlers: attachFxHandlers,\n    computeTransform: computeTransform\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script"}