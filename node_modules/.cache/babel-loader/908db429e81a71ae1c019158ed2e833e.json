{"ast":null,"code":"'use strict';\n\nvar d3Force = require('d3-force');\nvar interpolateNumber = require('d3-interpolate').interpolateNumber;\nvar d3 = require('@plotly/d3');\nvar d3Sankey = require('@plotly/d3-sankey');\nvar d3SankeyCircular = require('@plotly/d3-sankey-circular');\nvar c = require('./constants');\nvar tinycolor = require('tinycolor2');\nvar Color = require('../../components/color');\nvar Drawing = require('../../components/drawing');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar strRotate = Lib.strRotate;\nvar gup = require('../../lib/gup');\nvar keyFun = gup.keyFun;\nvar repeat = gup.repeat;\nvar unwrap = gup.unwrap;\nvar svgTextUtils = require('../../lib/svg_text_utils');\nvar Registry = require('../../registry');\nvar alignmentConstants = require('../../constants/alignment');\nvar CAP_SHIFT = alignmentConstants.CAP_SHIFT;\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar TEXTPAD = 3;\n\n// view models\n\nfunction sankeyModel(layout, d, traceIndex) {\n  var calcData = unwrap(d);\n  var trace = calcData.trace;\n  var domain = trace.domain;\n  var horizontal = trace.orientation === 'h';\n  var nodePad = trace.node.pad;\n  var nodeThickness = trace.node.thickness;\n  var nodeAlign = {\n    justify: d3Sankey.sankeyJustify,\n    left: d3Sankey.sankeyLeft,\n    right: d3Sankey.sankeyRight,\n    center: d3Sankey.sankeyCenter\n  }[trace.node.align];\n  var width = layout.width * (domain.x[1] - domain.x[0]);\n  var height = layout.height * (domain.y[1] - domain.y[0]);\n  var nodes = calcData._nodes;\n  var links = calcData._links;\n  var circular = calcData.circular;\n\n  // Select Sankey generator\n  var sankey;\n  if (circular) {\n    sankey = d3SankeyCircular.sankeyCircular().circularLinkGap(0);\n  } else {\n    sankey = d3Sankey.sankey();\n  }\n  sankey.iterations(c.sankeyIterations).size(horizontal ? [width, height] : [height, width]).nodeWidth(nodeThickness).nodePadding(nodePad).nodeId(function (d) {\n    return d.pointNumber;\n  }).nodeAlign(nodeAlign).nodes(nodes).links(links);\n  var graph = sankey();\n  if (sankey.nodePadding() < nodePad) {\n    Lib.warn('node.pad was reduced to ', sankey.nodePadding(), ' to fit within the figure.');\n  }\n\n  // Counters for nested loops\n  var i, j, k;\n\n  // Create transient nodes for animations\n  for (var nodePointNumber in calcData._groupLookup) {\n    var groupIndex = parseInt(calcData._groupLookup[nodePointNumber]);\n\n    // Find node representing groupIndex\n    var groupingNode;\n    for (i = 0; i < graph.nodes.length; i++) {\n      if (graph.nodes[i].pointNumber === groupIndex) {\n        groupingNode = graph.nodes[i];\n        break;\n      }\n    }\n    // If groupinNode is undefined, no links are targeting this group\n    if (!groupingNode) continue;\n    var child = {\n      pointNumber: parseInt(nodePointNumber),\n      x0: groupingNode.x0,\n      x1: groupingNode.x1,\n      y0: groupingNode.y0,\n      y1: groupingNode.y1,\n      partOfGroup: true,\n      sourceLinks: [],\n      targetLinks: []\n    };\n    graph.nodes.unshift(child);\n    groupingNode.childrenNodes.unshift(child);\n  }\n  function computeLinkConcentrations() {\n    for (i = 0; i < graph.nodes.length; i++) {\n      var node = graph.nodes[i];\n      // Links connecting the same two nodes are part of a flow\n      var flows = {};\n      var flowKey;\n      var link;\n      for (j = 0; j < node.targetLinks.length; j++) {\n        link = node.targetLinks[j];\n        flowKey = link.source.pointNumber + ':' + link.target.pointNumber;\n        if (!flows.hasOwnProperty(flowKey)) flows[flowKey] = [];\n        flows[flowKey].push(link);\n      }\n\n      // Compute statistics for each flow\n      var keys = Object.keys(flows);\n      for (j = 0; j < keys.length; j++) {\n        flowKey = keys[j];\n        var flowLinks = flows[flowKey];\n\n        // Find the total size of the flow and total size per label\n        var total = 0;\n        var totalPerLabel = {};\n        for (k = 0; k < flowLinks.length; k++) {\n          link = flowLinks[k];\n          if (!totalPerLabel[link.label]) totalPerLabel[link.label] = 0;\n          totalPerLabel[link.label] += link.value;\n          total += link.value;\n        }\n\n        // Find the ratio of the link's value and the size of the flow\n        for (k = 0; k < flowLinks.length; k++) {\n          link = flowLinks[k];\n          link.flow = {\n            value: total,\n            labelConcentration: totalPerLabel[link.label] / total,\n            concentration: link.value / total,\n            links: flowLinks\n          };\n          if (link.concentrationscale) {\n            link.color = tinycolor(link.concentrationscale(link.flow.labelConcentration));\n          }\n        }\n      }\n\n      // Gather statistics of all links at current node\n      var totalOutflow = 0;\n      for (j = 0; j < node.sourceLinks.length; j++) {\n        totalOutflow += node.sourceLinks[j].value;\n      }\n      for (j = 0; j < node.sourceLinks.length; j++) {\n        link = node.sourceLinks[j];\n        link.concentrationOut = link.value / totalOutflow;\n      }\n      var totalInflow = 0;\n      for (j = 0; j < node.targetLinks.length; j++) {\n        totalInflow += node.targetLinks[j].value;\n      }\n      for (j = 0; j < node.targetLinks.length; j++) {\n        link = node.targetLinks[j];\n        link.concenrationIn = link.value / totalInflow;\n      }\n    }\n  }\n  computeLinkConcentrations();\n\n  // Push any overlapping nodes down.\n  function resolveCollisionsTopToBottom(columns) {\n    columns.forEach(function (nodes) {\n      var node;\n      var dy;\n      var y = 0;\n      var n = nodes.length;\n      var i;\n      nodes.sort(function (a, b) {\n        return a.y0 - b.y0;\n      });\n      for (i = 0; i < n; ++i) {\n        node = nodes[i];\n        if (node.y0 >= y) {\n          // No overlap\n        } else {\n          dy = y - node.y0;\n          if (dy > 1e-6) node.y0 += dy, node.y1 += dy;\n        }\n        y = node.y1 + nodePad;\n      }\n    });\n  }\n\n  // Group nodes into columns based on their x position\n  function snapToColumns(nodes) {\n    // Sort nodes by x position\n    var orderedNodes = nodes.map(function (n, i) {\n      return {\n        x0: n.x0,\n        index: i\n      };\n    }).sort(function (a, b) {\n      return a.x0 - b.x0;\n    });\n    var columns = [];\n    var colNumber = -1;\n    var colX; // Position of column\n    var lastX = -Infinity; // Position of last node\n    var dx;\n    for (i = 0; i < orderedNodes.length; i++) {\n      var node = nodes[orderedNodes[i].index];\n      // If the node does not overlap with the last one\n      if (node.x0 > lastX + nodeThickness) {\n        // Start a new column\n        colNumber += 1;\n        colX = node.x0;\n      }\n      lastX = node.x0;\n\n      // Add node to its associated column\n      if (!columns[colNumber]) columns[colNumber] = [];\n      columns[colNumber].push(node);\n\n      // Change node's x position to align it with its column\n      dx = colX - node.x0;\n      node.x0 += dx, node.x1 += dx;\n    }\n    return columns;\n  }\n\n  // Force node position\n  if (trace.node.x.length && trace.node.y.length) {\n    for (i = 0; i < Math.min(trace.node.x.length, trace.node.y.length, graph.nodes.length); i++) {\n      if (trace.node.x[i] && trace.node.y[i]) {\n        var pos = [trace.node.x[i] * width, trace.node.y[i] * height];\n        graph.nodes[i].x0 = pos[0] - nodeThickness / 2;\n        graph.nodes[i].x1 = pos[0] + nodeThickness / 2;\n        var nodeHeight = graph.nodes[i].y1 - graph.nodes[i].y0;\n        graph.nodes[i].y0 = pos[1] - nodeHeight / 2;\n        graph.nodes[i].y1 = pos[1] + nodeHeight / 2;\n      }\n    }\n    if (trace.arrangement === 'snap') {\n      nodes = graph.nodes;\n      var columns = snapToColumns(nodes);\n      resolveCollisionsTopToBottom(columns);\n    }\n    // Update links\n    sankey.update(graph);\n  }\n  return {\n    circular: circular,\n    key: traceIndex,\n    trace: trace,\n    guid: Lib.randstr(),\n    horizontal: horizontal,\n    width: width,\n    height: height,\n    nodePad: trace.node.pad,\n    nodeLineColor: trace.node.line.color,\n    nodeLineWidth: trace.node.line.width,\n    linkLineColor: trace.link.line.color,\n    linkLineWidth: trace.link.line.width,\n    linkArrowLength: trace.link.arrowlen,\n    valueFormat: trace.valueformat,\n    valueSuffix: trace.valuesuffix,\n    textFont: trace.textfont,\n    translateX: domain.x[0] * layout.width + layout.margin.l,\n    translateY: layout.height - domain.y[1] * layout.height + layout.margin.t,\n    dragParallel: horizontal ? height : width,\n    dragPerpendicular: horizontal ? width : height,\n    arrangement: trace.arrangement,\n    sankey: sankey,\n    graph: graph,\n    forceLayouts: {},\n    interactionState: {\n      dragInProgress: false,\n      hovered: false\n    }\n  };\n}\nfunction linkModel(d, l, i) {\n  var tc = tinycolor(l.color);\n  var htc = tinycolor(l.hovercolor);\n  var basicKey = l.source.label + '|' + l.target.label;\n  var key = basicKey + '__' + i;\n\n  // for event data\n  l.trace = d.trace;\n  l.curveNumber = d.trace.index;\n  return {\n    circular: d.circular,\n    key: key,\n    traceId: d.key,\n    pointNumber: l.pointNumber,\n    link: l,\n    tinyColorHue: Color.tinyRGB(tc),\n    tinyColorAlpha: tc.getAlpha(),\n    tinyColorHoverHue: Color.tinyRGB(htc),\n    tinyColorHoverAlpha: htc.getAlpha(),\n    linkPath: linkPath,\n    linkLineColor: d.linkLineColor,\n    linkLineWidth: d.linkLineWidth,\n    linkArrowLength: d.linkArrowLength,\n    valueFormat: d.valueFormat,\n    valueSuffix: d.valueSuffix,\n    sankey: d.sankey,\n    parent: d,\n    interactionState: d.interactionState,\n    flow: l.flow\n  };\n}\nfunction createCircularClosedPathString(link, arrowLen) {\n  // Using coordinates computed by d3-sankey-circular\n  var pathString = '';\n  var offset = link.width / 2;\n  var coords = link.circularPathData;\n  if (link.circularLinkType === 'top') {\n    // Top path\n    pathString =\n    // start at the left of the target node\n    'M ' + (coords.targetX - arrowLen) + ' ' + (coords.targetY + offset) + ' ' + 'L' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY + offset) + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 1 ' + (coords.rightFullExtent - offset - arrowLen) + ' ' + (coords.targetY - coords.rightSmallArcRadius) + 'L' + (coords.rightFullExtent - offset - arrowLen) + ' ' + coords.verticalRightInnerExtent + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 1 ' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent - offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 1 ' + (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent + 'L' + (coords.leftFullExtent + offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 1 ' + coords.leftInnerExtent + ' ' + (coords.sourceY + offset) + 'L' + coords.sourceX + ' ' + (coords.sourceY + offset) +\n    // Walking back\n    'L' + coords.sourceX + ' ' + (coords.sourceY - offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.sourceY - offset) + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 0 ' + (coords.leftFullExtent - offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) + 'L' + (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 0 ' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) + 'L' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent + offset) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 0 ' + (coords.rightFullExtent + offset - arrowLen) + ' ' + coords.verticalRightInnerExtent + 'L' + (coords.rightFullExtent + offset - arrowLen) + ' ' + (coords.targetY - coords.rightSmallArcRadius) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 0 ' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY - offset) + 'L' + (coords.targetX - arrowLen) + ' ' + (coords.targetY - offset) + (arrowLen > 0 ? 'L' + coords.targetX + ' ' + coords.targetY : '') + 'Z';\n  } else {\n    // Bottom path\n    pathString =\n    // start at the left of the target node\n    'M ' + (coords.targetX - arrowLen) + ' ' + (coords.targetY - offset) + ' ' + 'L' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY - offset) + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 0 ' + (coords.rightFullExtent - offset - arrowLen) + ' ' + (coords.targetY + coords.rightSmallArcRadius) + 'L' + (coords.rightFullExtent - offset - arrowLen) + ' ' + coords.verticalRightInnerExtent + 'A' + (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 0 ' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent + offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 0 ' + (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent + 'L' + (coords.leftFullExtent + offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) + 'A' + (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 0 ' + coords.leftInnerExtent + ' ' + (coords.sourceY - offset) + 'L' + coords.sourceX + ' ' + (coords.sourceY - offset) +\n    // Walking back\n    'L' + coords.sourceX + ' ' + (coords.sourceY + offset) + 'L' + coords.leftInnerExtent + ' ' + (coords.sourceY + offset) + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 1 ' + (coords.leftFullExtent - offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) + 'L' + (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent + 'A' + (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 1 ' + coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) + 'L' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent - offset) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 1 ' + (coords.rightFullExtent + offset - arrowLen) + ' ' + coords.verticalRightInnerExtent + 'L' + (coords.rightFullExtent + offset - arrowLen) + ' ' + (coords.targetY + coords.rightSmallArcRadius) + 'A' + (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 1 ' + (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY + offset) + 'L' + (coords.targetX - arrowLen) + ' ' + (coords.targetY + offset) + (arrowLen > 0 ? 'L' + coords.targetX + ' ' + coords.targetY : '') + 'Z';\n  }\n  return pathString;\n}\nfunction linkPath() {\n  var curvature = 0.5;\n  function path(d) {\n    var arrowLen = d.linkArrowLength;\n    if (d.link.circular) {\n      return createCircularClosedPathString(d.link, arrowLen);\n    } else {\n      var maxArrowLength = Math.abs((d.link.target.x0 - d.link.source.x1) / 2);\n      if (arrowLen > maxArrowLength) {\n        arrowLen = maxArrowLength;\n      }\n      var x0 = d.link.source.x1;\n      var x1 = d.link.target.x0 - arrowLen;\n      var xi = interpolateNumber(x0, x1);\n      var x2 = xi(curvature);\n      var x3 = xi(1 - curvature);\n      var y0a = d.link.y0 - d.link.width / 2;\n      var y0b = d.link.y0 + d.link.width / 2;\n      var y1a = d.link.y1 - d.link.width / 2;\n      var y1b = d.link.y1 + d.link.width / 2;\n      var start = 'M' + x0 + ',' + y0a;\n      var upperCurve = 'C' + x2 + ',' + y0a + ' ' + x3 + ',' + y1a + ' ' + x1 + ',' + y1a;\n      var lowerCurve = 'C' + x3 + ',' + y1b + ' ' + x2 + ',' + y0b + ' ' + x0 + ',' + y0b;\n      var rightEnd = arrowLen > 0 ? 'L' + (x1 + arrowLen) + ',' + (y1a + d.link.width / 2) : '';\n      rightEnd += 'L' + x1 + ',' + y1b;\n      return start + upperCurve + rightEnd + lowerCurve + 'Z';\n    }\n  }\n  return path;\n}\nfunction nodeModel(d, n) {\n  var tc = tinycolor(n.color);\n  var zoneThicknessPad = c.nodePadAcross;\n  var zoneLengthPad = d.nodePad / 2;\n  n.dx = n.x1 - n.x0;\n  n.dy = n.y1 - n.y0;\n  var visibleThickness = n.dx;\n  var visibleLength = Math.max(0.5, n.dy);\n  var key = 'node_' + n.pointNumber;\n  // If it's a group, it's mutable and should be unique\n  if (n.group) {\n    key = Lib.randstr();\n  }\n\n  // for event data\n  n.trace = d.trace;\n  n.curveNumber = d.trace.index;\n  return {\n    index: n.pointNumber,\n    key: key,\n    partOfGroup: n.partOfGroup || false,\n    group: n.group,\n    traceId: d.key,\n    trace: d.trace,\n    node: n,\n    nodePad: d.nodePad,\n    nodeLineColor: d.nodeLineColor,\n    nodeLineWidth: d.nodeLineWidth,\n    textFont: d.textFont,\n    size: d.horizontal ? d.height : d.width,\n    visibleWidth: Math.ceil(visibleThickness),\n    visibleHeight: visibleLength,\n    zoneX: -zoneThicknessPad,\n    zoneY: -zoneLengthPad,\n    zoneWidth: visibleThickness + 2 * zoneThicknessPad,\n    zoneHeight: visibleLength + 2 * zoneLengthPad,\n    labelY: d.horizontal ? n.dy / 2 + 1 : n.dx / 2 + 1,\n    left: n.originalLayer === 1,\n    sizeAcross: d.width,\n    forceLayouts: d.forceLayouts,\n    horizontal: d.horizontal,\n    darkBackground: tc.getBrightness() <= 128,\n    tinyColorHue: Color.tinyRGB(tc),\n    tinyColorAlpha: tc.getAlpha(),\n    valueFormat: d.valueFormat,\n    valueSuffix: d.valueSuffix,\n    sankey: d.sankey,\n    graph: d.graph,\n    arrangement: d.arrangement,\n    uniqueNodeLabelPathId: [d.guid, d.key, key].join('_'),\n    interactionState: d.interactionState,\n    figure: d\n  };\n}\n\n// rendering snippets\n\nfunction updateNodePositions(sankeyNode) {\n  sankeyNode.attr('transform', function (d) {\n    return strTranslate(d.node.x0.toFixed(3), d.node.y0.toFixed(3));\n  });\n}\nfunction updateNodeShapes(sankeyNode) {\n  sankeyNode.call(updateNodePositions);\n}\nfunction updateShapes(sankeyNode, sankeyLink) {\n  sankeyNode.call(updateNodeShapes);\n  sankeyLink.attr('d', linkPath());\n}\nfunction sizeNode(rect) {\n  rect.attr('width', function (d) {\n    return d.node.x1 - d.node.x0;\n  }).attr('height', function (d) {\n    return d.visibleHeight;\n  });\n}\nfunction salientEnough(d) {\n  return d.link.width > 1 || d.linkLineWidth > 0;\n}\nfunction sankeyTransform(d) {\n  var offset = strTranslate(d.translateX, d.translateY);\n  return offset + (d.horizontal ? 'matrix(1 0 0 1 0 0)' : 'matrix(0 1 1 0 0 0)');\n}\n\n// event handling\n\nfunction attachPointerEvents(selection, sankey, eventSet) {\n  selection.on('.basic', null) // remove any preexisting handlers\n  .on('mouseover.basic', function (d) {\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.hover(this, d, sankey);\n      d.interactionState.hovered = [this, d];\n    }\n  }).on('mousemove.basic', function (d) {\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.follow(this, d);\n      d.interactionState.hovered = [this, d];\n    }\n  }).on('mouseout.basic', function (d) {\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.unhover(this, d, sankey);\n      d.interactionState.hovered = false;\n    }\n  }).on('click.basic', function (d) {\n    if (d.interactionState.hovered) {\n      eventSet.unhover(this, d, sankey);\n      d.interactionState.hovered = false;\n    }\n    if (!d.interactionState.dragInProgress && !d.partOfGroup) {\n      eventSet.select(this, d, sankey);\n    }\n  });\n}\nfunction attachDragHandler(sankeyNode, sankeyLink, callbacks, gd) {\n  var dragBehavior = d3.behavior.drag().origin(function (d) {\n    return {\n      x: d.node.x0 + d.visibleWidth / 2,\n      y: d.node.y0 + d.visibleHeight / 2\n    };\n  }).on('dragstart', function (d) {\n    if (d.arrangement === 'fixed') return;\n    Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'dragcover', function (s) {\n      gd._fullLayout._dragCover = s;\n    });\n    Lib.raiseToTop(this);\n    d.interactionState.dragInProgress = d.node;\n    saveCurrentDragPosition(d.node);\n    if (d.interactionState.hovered) {\n      callbacks.nodeEvents.unhover.apply(0, d.interactionState.hovered);\n      d.interactionState.hovered = false;\n    }\n    if (d.arrangement === 'snap') {\n      var forceKey = d.traceId + '|' + d.key;\n      if (d.forceLayouts[forceKey]) {\n        d.forceLayouts[forceKey].alpha(1);\n      } else {\n        // make a forceLayout if needed\n        attachForce(sankeyNode, forceKey, d, gd);\n      }\n      startForce(sankeyNode, sankeyLink, d, forceKey, gd);\n    }\n  }).on('drag', function (d) {\n    if (d.arrangement === 'fixed') return;\n    var x = d3.event.x;\n    var y = d3.event.y;\n    if (d.arrangement === 'snap') {\n      d.node.x0 = x - d.visibleWidth / 2;\n      d.node.x1 = x + d.visibleWidth / 2;\n      d.node.y0 = y - d.visibleHeight / 2;\n      d.node.y1 = y + d.visibleHeight / 2;\n    } else {\n      if (d.arrangement === 'freeform') {\n        d.node.x0 = x - d.visibleWidth / 2;\n        d.node.x1 = x + d.visibleWidth / 2;\n      }\n      y = Math.max(0, Math.min(d.size - d.visibleHeight / 2, y));\n      d.node.y0 = y - d.visibleHeight / 2;\n      d.node.y1 = y + d.visibleHeight / 2;\n    }\n    saveCurrentDragPosition(d.node);\n    if (d.arrangement !== 'snap') {\n      d.sankey.update(d.graph);\n      updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n    }\n  }).on('dragend', function (d) {\n    if (d.arrangement === 'fixed') return;\n    d.interactionState.dragInProgress = false;\n    for (var i = 0; i < d.node.childrenNodes.length; i++) {\n      d.node.childrenNodes[i].x = d.node.x;\n      d.node.childrenNodes[i].y = d.node.y;\n    }\n    if (d.arrangement !== 'snap') persistFinalNodePositions(d, gd);\n  });\n  sankeyNode.on('.drag', null) // remove possible previous handlers\n  .call(dragBehavior);\n}\nfunction attachForce(sankeyNode, forceKey, d, gd) {\n  // Attach force to nodes in the same column (same x coordinate)\n  switchToForceFormat(d.graph.nodes);\n  var nodes = d.graph.nodes.filter(function (n) {\n    return n.originalX === d.node.originalX;\n  })\n  // Filter out children\n  .filter(function (n) {\n    return !n.partOfGroup;\n  });\n  d.forceLayouts[forceKey] = d3Force.forceSimulation(nodes).alphaDecay(0).force('collide', d3Force.forceCollide().radius(function (n) {\n    return n.dy / 2 + d.nodePad / 2;\n  }).strength(1).iterations(c.forceIterations)).force('constrain', snappingForce(sankeyNode, forceKey, nodes, d, gd)).stop();\n}\nfunction startForce(sankeyNode, sankeyLink, d, forceKey, gd) {\n  window.requestAnimationFrame(function faster() {\n    var i;\n    for (i = 0; i < c.forceTicksPerFrame; i++) {\n      d.forceLayouts[forceKey].tick();\n    }\n    var nodes = d.graph.nodes;\n    switchToSankeyFormat(nodes);\n    d.sankey.update(d.graph);\n    updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n    if (d.forceLayouts[forceKey].alpha() > 0) {\n      window.requestAnimationFrame(faster);\n    } else {\n      // Make sure the final x position is equal to its original value\n      // because the force simulation will have numerical error\n      var x = d.node.originalX;\n      d.node.x0 = x - d.visibleWidth / 2;\n      d.node.x1 = x + d.visibleWidth / 2;\n      persistFinalNodePositions(d, gd);\n    }\n  });\n}\nfunction snappingForce(sankeyNode, forceKey, nodes, d) {\n  return function _snappingForce() {\n    var maxVelocity = 0;\n    for (var i = 0; i < nodes.length; i++) {\n      var n = nodes[i];\n      if (n === d.interactionState.dragInProgress) {\n        // constrain node position to the dragging pointer\n        n.x = n.lastDraggedX;\n        n.y = n.lastDraggedY;\n      } else {\n        n.vx = (n.originalX - n.x) / c.forceTicksPerFrame; // snap to layer\n        n.y = Math.min(d.size - n.dy / 2, Math.max(n.dy / 2, n.y)); // constrain to extent\n      }\n      maxVelocity = Math.max(maxVelocity, Math.abs(n.vx), Math.abs(n.vy));\n    }\n    if (!d.interactionState.dragInProgress && maxVelocity < 0.1 && d.forceLayouts[forceKey].alpha() > 0) {\n      d.forceLayouts[forceKey].alpha(0); // This will stop the animation loop\n    }\n  };\n}\n\n// basic data utilities\n\nfunction persistFinalNodePositions(d, gd) {\n  var x = [];\n  var y = [];\n  for (var i = 0; i < d.graph.nodes.length; i++) {\n    var nodeX = (d.graph.nodes[i].x0 + d.graph.nodes[i].x1) / 2;\n    var nodeY = (d.graph.nodes[i].y0 + d.graph.nodes[i].y1) / 2;\n    x.push(nodeX / d.figure.width);\n    y.push(nodeY / d.figure.height);\n  }\n  Registry.call('_guiRestyle', gd, {\n    'node.x': [x],\n    'node.y': [y]\n  }, d.trace.index).then(function () {\n    if (gd._fullLayout._dragCover) gd._fullLayout._dragCover.remove();\n  });\n}\nfunction persistOriginalPlace(nodes) {\n  var distinctLayerPositions = [];\n  var i;\n  for (i = 0; i < nodes.length; i++) {\n    nodes[i].originalX = (nodes[i].x0 + nodes[i].x1) / 2;\n    nodes[i].originalY = (nodes[i].y0 + nodes[i].y1) / 2;\n    if (distinctLayerPositions.indexOf(nodes[i].originalX) === -1) {\n      distinctLayerPositions.push(nodes[i].originalX);\n    }\n  }\n  distinctLayerPositions.sort(function (a, b) {\n    return a - b;\n  });\n  for (i = 0; i < nodes.length; i++) {\n    nodes[i].originalLayerIndex = distinctLayerPositions.indexOf(nodes[i].originalX);\n    nodes[i].originalLayer = nodes[i].originalLayerIndex / (distinctLayerPositions.length - 1);\n  }\n}\nfunction saveCurrentDragPosition(d) {\n  d.lastDraggedX = d.x0 + d.dx / 2;\n  d.lastDraggedY = d.y0 + d.dy / 2;\n}\nfunction sameLayer(d) {\n  return function (n) {\n    return n.node.originalX === d.node.originalX;\n  };\n}\nfunction switchToForceFormat(nodes) {\n  // force uses x, y as centers\n  for (var i = 0; i < nodes.length; i++) {\n    nodes[i].y = (nodes[i].y0 + nodes[i].y1) / 2;\n    nodes[i].x = (nodes[i].x0 + nodes[i].x1) / 2;\n  }\n}\nfunction switchToSankeyFormat(nodes) {\n  // sankey uses x0, x1, y0, y1\n  for (var i = 0; i < nodes.length; i++) {\n    nodes[i].y0 = nodes[i].y - nodes[i].dy / 2;\n    nodes[i].y1 = nodes[i].y0 + nodes[i].dy;\n    nodes[i].x0 = nodes[i].x - nodes[i].dx / 2;\n    nodes[i].x1 = nodes[i].x0 + nodes[i].dx;\n  }\n}\n\n// scene graph\nmodule.exports = function (gd, svg, calcData, layout, callbacks) {\n  var isStatic = gd._context.staticPlot;\n\n  // To prevent animation on first render\n  var firstRender = false;\n  Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'first-render', function () {\n    firstRender = true;\n  });\n\n  // To prevent animation on dragging\n  var dragcover = gd._fullLayout._dragCover;\n  var styledData = calcData.filter(function (d) {\n    return unwrap(d).trace.visible;\n  }).map(sankeyModel.bind(null, layout));\n  var sankey = svg.selectAll('.' + c.cn.sankey).data(styledData, keyFun);\n  sankey.exit().remove();\n  sankey.enter().append('g').classed(c.cn.sankey, true).style('box-sizing', 'content-box').style('position', 'absolute').style('left', 0).style('shape-rendering', 'geometricPrecision').style('pointer-events', isStatic ? 'none' : 'auto').attr('transform', sankeyTransform);\n  sankey.each(function (d, i) {\n    gd._fullData[i]._sankey = d;\n    // Create dragbox if missing\n    var dragboxClassName = 'bgsankey-' + d.trace.uid + '-' + i;\n    Lib.ensureSingle(gd._fullLayout._draggers, 'rect', dragboxClassName);\n    gd._fullData[i]._bgRect = d3.select('.' + dragboxClassName);\n\n    // Style dragbox\n    gd._fullData[i]._bgRect.style('pointer-events', isStatic ? 'none' : 'all').attr('width', d.width).attr('height', d.height).attr('x', d.translateX).attr('y', d.translateY).classed('bgsankey', true).style({\n      fill: 'transparent',\n      'stroke-width': 0\n    });\n  });\n  sankey.transition().ease(c.ease).duration(c.duration).attr('transform', sankeyTransform);\n  var sankeyLinks = sankey.selectAll('.' + c.cn.sankeyLinks).data(repeat, keyFun);\n  sankeyLinks.enter().append('g').classed(c.cn.sankeyLinks, true).style('fill', 'none');\n  var sankeyLink = sankeyLinks.selectAll('.' + c.cn.sankeyLink).data(function (d) {\n    var links = d.graph.links;\n    return links.filter(function (l) {\n      return l.value;\n    }).map(linkModel.bind(null, d));\n  }, keyFun);\n  sankeyLink.enter().append('path').classed(c.cn.sankeyLink, true).call(attachPointerEvents, sankey, callbacks.linkEvents);\n  sankeyLink.style('stroke', function (d) {\n    return salientEnough(d) ? Color.tinyRGB(tinycolor(d.linkLineColor)) : d.tinyColorHue;\n  }).style('stroke-opacity', function (d) {\n    return salientEnough(d) ? Color.opacity(d.linkLineColor) : d.tinyColorAlpha;\n  }).style('fill', function (d) {\n    return d.tinyColorHue;\n  }).style('fill-opacity', function (d) {\n    return d.tinyColorAlpha;\n  }).style('stroke-width', function (d) {\n    return salientEnough(d) ? d.linkLineWidth : 1;\n  }).attr('d', linkPath());\n  sankeyLink.style('opacity', function () {\n    return gd._context.staticPlot || firstRender || dragcover ? 1 : 0;\n  }).transition().ease(c.ease).duration(c.duration).style('opacity', 1);\n  sankeyLink.exit().transition().ease(c.ease).duration(c.duration).style('opacity', 0).remove();\n  var sankeyNodeSet = sankey.selectAll('.' + c.cn.sankeyNodeSet).data(repeat, keyFun);\n  sankeyNodeSet.enter().append('g').classed(c.cn.sankeyNodeSet, true);\n  sankeyNodeSet.style('cursor', function (d) {\n    switch (d.arrangement) {\n      case 'fixed':\n        return 'default';\n      case 'perpendicular':\n        return 'ns-resize';\n      default:\n        return 'move';\n    }\n  });\n  var sankeyNode = sankeyNodeSet.selectAll('.' + c.cn.sankeyNode).data(function (d) {\n    var nodes = d.graph.nodes;\n    persistOriginalPlace(nodes);\n    return nodes.map(nodeModel.bind(null, d));\n  }, keyFun);\n  sankeyNode.enter().append('g').classed(c.cn.sankeyNode, true).call(updateNodePositions).style('opacity', function (n) {\n    return (gd._context.staticPlot || firstRender) && !n.partOfGroup ? 1 : 0;\n  });\n  sankeyNode.call(attachPointerEvents, sankey, callbacks.nodeEvents).call(attachDragHandler, sankeyLink, callbacks, gd); // has to be here as it binds sankeyLink\n\n  sankeyNode.transition().ease(c.ease).duration(c.duration).call(updateNodePositions).style('opacity', function (n) {\n    return n.partOfGroup ? 0 : 1;\n  });\n  sankeyNode.exit().transition().ease(c.ease).duration(c.duration).style('opacity', 0).remove();\n  var nodeRect = sankeyNode.selectAll('.' + c.cn.nodeRect).data(repeat);\n  nodeRect.enter().append('rect').classed(c.cn.nodeRect, true).call(sizeNode);\n  nodeRect.style('stroke-width', function (d) {\n    return d.nodeLineWidth;\n  }).style('stroke', function (d) {\n    return Color.tinyRGB(tinycolor(d.nodeLineColor));\n  }).style('stroke-opacity', function (d) {\n    return Color.opacity(d.nodeLineColor);\n  }).style('fill', function (d) {\n    return d.tinyColorHue;\n  }).style('fill-opacity', function (d) {\n    return d.tinyColorAlpha;\n  });\n  nodeRect.transition().ease(c.ease).duration(c.duration).call(sizeNode);\n  var nodeLabel = sankeyNode.selectAll('.' + c.cn.nodeLabel).data(repeat);\n  nodeLabel.enter().append('text').classed(c.cn.nodeLabel, true).style('cursor', 'default');\n  nodeLabel.attr('data-notex', 1) // prohibit tex interpretation until we can handle tex and regular text together\n  .text(function (d) {\n    return d.node.label;\n  }).each(function (d) {\n    var e = d3.select(this);\n    Drawing.font(e, d.textFont);\n    svgTextUtils.convertToTspans(e, gd);\n  }).attr('text-anchor', function (d) {\n    return d.horizontal && d.left ? 'end' : 'start';\n  }).attr('transform', function (d) {\n    var e = d3.select(this);\n    // how much to shift a multi-line label to center it vertically.\n    var nLines = svgTextUtils.lineCount(e);\n    var blockHeight = d.textFont.size * ((nLines - 1) * LINE_SPACING - CAP_SHIFT);\n    var posX = d.nodeLineWidth / 2 + TEXTPAD;\n    var posY = ((d.horizontal ? d.visibleHeight : d.visibleWidth) - blockHeight) / 2;\n    if (d.horizontal) {\n      if (d.left) {\n        posX = -posX;\n      } else {\n        posX += d.visibleWidth;\n      }\n    }\n    var flipText = d.horizontal ? '' : 'scale(-1,1)' + strRotate(90);\n    return strTranslate(d.horizontal ? posX : posY, d.horizontal ? posY : posX) + flipText;\n  });\n  nodeLabel.transition().ease(c.ease).duration(c.duration);\n};","map":{"version":3,"names":["d3Force","require","interpolateNumber","d3","d3Sankey","d3SankeyCircular","c","tinycolor","Color","Drawing","Lib","strTranslate","strRotate","gup","keyFun","repeat","unwrap","svgTextUtils","Registry","alignmentConstants","CAP_SHIFT","LINE_SPACING","TEXTPAD","sankeyModel","layout","d","traceIndex","calcData","trace","domain","horizontal","orientation","nodePad","node","pad","nodeThickness","thickness","nodeAlign","justify","sankeyJustify","left","sankeyLeft","right","sankeyRight","center","sankeyCenter","align","width","x","height","y","nodes","_nodes","links","_links","circular","sankey","sankeyCircular","circularLinkGap","iterations","sankeyIterations","size","nodeWidth","nodePadding","nodeId","pointNumber","graph","warn","i","j","k","nodePointNumber","_groupLookup","groupIndex","parseInt","groupingNode","length","child","x0","x1","y0","y1","partOfGroup","sourceLinks","targetLinks","unshift","childrenNodes","computeLinkConcentrations","flows","flowKey","link","source","target","hasOwnProperty","push","keys","Object","flowLinks","total","totalPerLabel","label","value","flow","labelConcentration","concentration","concentrationscale","color","totalOutflow","concentrationOut","totalInflow","concenrationIn","resolveCollisionsTopToBottom","columns","forEach","dy","n","sort","a","b","snapToColumns","orderedNodes","map","index","colNumber","colX","lastX","Infinity","dx","Math","min","pos","nodeHeight","arrangement","update","key","guid","randstr","nodeLineColor","line","nodeLineWidth","linkLineColor","linkLineWidth","linkArrowLength","arrowlen","valueFormat","valueformat","valueSuffix","valuesuffix","textFont","textfont","translateX","margin","l","translateY","t","dragParallel","dragPerpendicular","forceLayouts","interactionState","dragInProgress","hovered","linkModel","tc","htc","hovercolor","basicKey","curveNumber","traceId","tinyColorHue","tinyRGB","tinyColorAlpha","getAlpha","tinyColorHoverHue","tinyColorHoverAlpha","linkPath","parent","createCircularClosedPathString","arrowLen","pathString","offset","coords","circularPathData","circularLinkType","targetX","targetY","rightInnerExtent","rightLargeArcRadius","rightSmallArcRadius","rightFullExtent","verticalRightInnerExtent","verticalFullExtent","leftInnerExtent","leftLargeArcRadius","leftFullExtent","verticalLeftInnerExtent","sourceY","leftSmallArcRadius","sourceX","curvature","path","maxArrowLength","abs","xi","x2","x3","y0a","y0b","y1a","y1b","start","upperCurve","lowerCurve","rightEnd","nodeModel","zoneThicknessPad","nodePadAcross","zoneLengthPad","visibleThickness","visibleLength","max","group","visibleWidth","ceil","visibleHeight","zoneX","zoneY","zoneWidth","zoneHeight","labelY","originalLayer","sizeAcross","darkBackground","getBrightness","uniqueNodeLabelPathId","join","figure","updateNodePositions","sankeyNode","attr","toFixed","updateNodeShapes","call","updateShapes","sankeyLink","sizeNode","rect","salientEnough","sankeyTransform","attachPointerEvents","selection","eventSet","on","hover","follow","unhover","select","attachDragHandler","callbacks","gd","dragBehavior","behavior","drag","origin","ensureSingle","_fullLayout","_infolayer","s","_dragCover","raiseToTop","saveCurrentDragPosition","nodeEvents","apply","forceKey","alpha","attachForce","startForce","event","filter","sameLayer","persistFinalNodePositions","switchToForceFormat","originalX","forceSimulation","alphaDecay","force","forceCollide","radius","strength","forceIterations","snappingForce","stop","window","requestAnimationFrame","faster","forceTicksPerFrame","tick","switchToSankeyFormat","_snappingForce","maxVelocity","lastDraggedX","lastDraggedY","vx","vy","nodeX","nodeY","then","remove","persistOriginalPlace","distinctLayerPositions","originalY","indexOf","originalLayerIndex","module","exports","svg","isStatic","_context","staticPlot","firstRender","dragcover","styledData","visible","bind","selectAll","cn","data","exit","enter","append","classed","style","each","_fullData","_sankey","dragboxClassName","uid","_draggers","_bgRect","fill","transition","ease","duration","sankeyLinks","linkEvents","opacity","sankeyNodeSet","nodeRect","nodeLabel","text","e","font","convertToTspans","nLines","lineCount","blockHeight","posX","posY","flipText"],"sources":["E:/tog_workspace/TestFabric_main/TestFabric-main/node_modules/plotly.js/src/traces/sankey/render.js"],"sourcesContent":["'use strict';\n\nvar d3Force = require('d3-force');\nvar interpolateNumber = require('d3-interpolate').interpolateNumber;\nvar d3 = require('@plotly/d3');\nvar d3Sankey = require('@plotly/d3-sankey');\nvar d3SankeyCircular = require('@plotly/d3-sankey-circular');\n\nvar c = require('./constants');\nvar tinycolor = require('tinycolor2');\nvar Color = require('../../components/color');\nvar Drawing = require('../../components/drawing');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar strRotate = Lib.strRotate;\nvar gup = require('../../lib/gup');\nvar keyFun = gup.keyFun;\nvar repeat = gup.repeat;\nvar unwrap = gup.unwrap;\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nvar Registry = require('../../registry');\n\nvar alignmentConstants = require('../../constants/alignment');\nvar CAP_SHIFT = alignmentConstants.CAP_SHIFT;\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar TEXTPAD = 3;\n\n// view models\n\nfunction sankeyModel(layout, d, traceIndex) {\n    var calcData = unwrap(d);\n    var trace = calcData.trace;\n    var domain = trace.domain;\n    var horizontal = trace.orientation === 'h';\n    var nodePad = trace.node.pad;\n    var nodeThickness = trace.node.thickness;\n    var nodeAlign = {\n        justify: d3Sankey.sankeyJustify,\n        left: d3Sankey.sankeyLeft,\n        right: d3Sankey.sankeyRight,\n        center: d3Sankey.sankeyCenter\n    }[trace.node.align];\n\n    var width = layout.width * (domain.x[1] - domain.x[0]);\n    var height = layout.height * (domain.y[1] - domain.y[0]);\n\n    var nodes = calcData._nodes;\n    var links = calcData._links;\n    var circular = calcData.circular;\n\n    // Select Sankey generator\n    var sankey;\n    if(circular) {\n        sankey = d3SankeyCircular\n            .sankeyCircular()\n            .circularLinkGap(0);\n    } else {\n        sankey = d3Sankey.sankey();\n    }\n\n    sankey\n      .iterations(c.sankeyIterations)\n      .size(horizontal ? [width, height] : [height, width])\n      .nodeWidth(nodeThickness)\n      .nodePadding(nodePad)\n      .nodeId(function(d) {\n          return d.pointNumber;\n      })\n      .nodeAlign(nodeAlign)\n      .nodes(nodes)\n      .links(links);\n\n    var graph = sankey();\n\n    if(sankey.nodePadding() < nodePad) {\n        Lib.warn('node.pad was reduced to ', sankey.nodePadding(), ' to fit within the figure.');\n    }\n\n    // Counters for nested loops\n    var i, j, k;\n\n    // Create transient nodes for animations\n    for(var nodePointNumber in calcData._groupLookup) {\n        var groupIndex = parseInt(calcData._groupLookup[nodePointNumber]);\n\n        // Find node representing groupIndex\n        var groupingNode;\n\n        for(i = 0; i < graph.nodes.length; i++) {\n            if(graph.nodes[i].pointNumber === groupIndex) {\n                groupingNode = graph.nodes[i];\n                break;\n            }\n        }\n        // If groupinNode is undefined, no links are targeting this group\n        if(!groupingNode) continue;\n\n        var child = {\n            pointNumber: parseInt(nodePointNumber),\n            x0: groupingNode.x0,\n            x1: groupingNode.x1,\n            y0: groupingNode.y0,\n            y1: groupingNode.y1,\n            partOfGroup: true,\n            sourceLinks: [],\n            targetLinks: []\n        };\n\n        graph.nodes.unshift(child);\n        groupingNode.childrenNodes.unshift(child);\n    }\n\n    function computeLinkConcentrations() {\n        for(i = 0; i < graph.nodes.length; i++) {\n            var node = graph.nodes[i];\n            // Links connecting the same two nodes are part of a flow\n            var flows = {};\n            var flowKey;\n            var link;\n            for(j = 0; j < node.targetLinks.length; j++) {\n                link = node.targetLinks[j];\n                flowKey = link.source.pointNumber + ':' + link.target.pointNumber;\n                if(!flows.hasOwnProperty(flowKey)) flows[flowKey] = [];\n                flows[flowKey].push(link);\n            }\n\n            // Compute statistics for each flow\n            var keys = Object.keys(flows);\n            for(j = 0; j < keys.length; j++) {\n                flowKey = keys[j];\n                var flowLinks = flows[flowKey];\n\n                // Find the total size of the flow and total size per label\n                var total = 0;\n                var totalPerLabel = {};\n                for(k = 0; k < flowLinks.length; k++) {\n                    link = flowLinks[k];\n                    if(!totalPerLabel[link.label]) totalPerLabel[link.label] = 0;\n                    totalPerLabel[link.label] += link.value;\n                    total += link.value;\n                }\n\n                // Find the ratio of the link's value and the size of the flow\n                for(k = 0; k < flowLinks.length; k++) {\n                    link = flowLinks[k];\n                    link.flow = {\n                        value: total,\n                        labelConcentration: totalPerLabel[link.label] / total,\n                        concentration: link.value / total,\n                        links: flowLinks\n                    };\n                    if(link.concentrationscale) {\n                        link.color = tinycolor(link.concentrationscale(link.flow.labelConcentration));\n                    }\n                }\n            }\n\n            // Gather statistics of all links at current node\n            var totalOutflow = 0;\n            for(j = 0; j < node.sourceLinks.length; j++) {\n                totalOutflow += node.sourceLinks[j].value;\n            }\n            for(j = 0; j < node.sourceLinks.length; j++) {\n                link = node.sourceLinks[j];\n                link.concentrationOut = link.value / totalOutflow;\n            }\n\n            var totalInflow = 0;\n            for(j = 0; j < node.targetLinks.length; j++) {\n                totalInflow += node.targetLinks[j].value;\n            }\n\n            for(j = 0; j < node.targetLinks.length; j++) {\n                link = node.targetLinks[j];\n                link.concenrationIn = link.value / totalInflow;\n            }\n        }\n    }\n    computeLinkConcentrations();\n\n    // Push any overlapping nodes down.\n    function resolveCollisionsTopToBottom(columns) {\n        columns.forEach(function(nodes) {\n            var node;\n            var dy;\n            var y = 0;\n            var n = nodes.length;\n            var i;\n            nodes.sort(function(a, b) {\n                return a.y0 - b.y0;\n            });\n            for(i = 0; i < n; ++i) {\n                node = nodes[i];\n                if(node.y0 >= y) {\n                    // No overlap\n                } else {\n                    dy = (y - node.y0);\n                    if(dy > 1e-6) node.y0 += dy, node.y1 += dy;\n                }\n                y = node.y1 + nodePad;\n            }\n        });\n    }\n\n    // Group nodes into columns based on their x position\n    function snapToColumns(nodes) {\n        // Sort nodes by x position\n        var orderedNodes = nodes.map(function(n, i) {\n            return {\n                x0: n.x0,\n                index: i\n            };\n        })\n        .sort(function(a, b) {\n            return a.x0 - b.x0;\n        });\n\n        var columns = [];\n        var colNumber = -1;\n        var colX; // Position of column\n        var lastX = -Infinity; // Position of last node\n        var dx;\n        for(i = 0; i < orderedNodes.length; i++) {\n            var node = nodes[orderedNodes[i].index];\n            // If the node does not overlap with the last one\n            if(node.x0 > lastX + nodeThickness) {\n                // Start a new column\n                colNumber += 1;\n                colX = node.x0;\n            }\n            lastX = node.x0;\n\n            // Add node to its associated column\n            if(!columns[colNumber]) columns[colNumber] = [];\n            columns[colNumber].push(node);\n\n            // Change node's x position to align it with its column\n            dx = colX - node.x0;\n            node.x0 += dx, node.x1 += dx;\n        }\n        return columns;\n    }\n\n    // Force node position\n    if(trace.node.x.length && trace.node.y.length) {\n        for(i = 0; i < Math.min(trace.node.x.length, trace.node.y.length, graph.nodes.length); i++) {\n            if(trace.node.x[i] && trace.node.y[i]) {\n                var pos = [trace.node.x[i] * width, trace.node.y[i] * height];\n                graph.nodes[i].x0 = pos[0] - nodeThickness / 2;\n                graph.nodes[i].x1 = pos[0] + nodeThickness / 2;\n\n                var nodeHeight = graph.nodes[i].y1 - graph.nodes[i].y0;\n                graph.nodes[i].y0 = pos[1] - nodeHeight / 2;\n                graph.nodes[i].y1 = pos[1] + nodeHeight / 2;\n            }\n        }\n        if(trace.arrangement === 'snap') {\n            nodes = graph.nodes;\n            var columns = snapToColumns(nodes);\n            resolveCollisionsTopToBottom(columns);\n        }\n        // Update links\n        sankey.update(graph);\n    }\n\n\n    return {\n        circular: circular,\n        key: traceIndex,\n        trace: trace,\n        guid: Lib.randstr(),\n        horizontal: horizontal,\n        width: width,\n        height: height,\n        nodePad: trace.node.pad,\n        nodeLineColor: trace.node.line.color,\n        nodeLineWidth: trace.node.line.width,\n        linkLineColor: trace.link.line.color,\n        linkLineWidth: trace.link.line.width,\n        linkArrowLength: trace.link.arrowlen,\n        valueFormat: trace.valueformat,\n        valueSuffix: trace.valuesuffix,\n        textFont: trace.textfont,\n        translateX: domain.x[0] * layout.width + layout.margin.l,\n        translateY: layout.height - domain.y[1] * layout.height + layout.margin.t,\n        dragParallel: horizontal ? height : width,\n        dragPerpendicular: horizontal ? width : height,\n        arrangement: trace.arrangement,\n        sankey: sankey,\n        graph: graph,\n        forceLayouts: {},\n        interactionState: {\n            dragInProgress: false,\n            hovered: false\n        }\n    };\n}\n\nfunction linkModel(d, l, i) {\n    var tc = tinycolor(l.color);\n    var htc = tinycolor(l.hovercolor);\n    var basicKey = l.source.label + '|' + l.target.label;\n    var key = basicKey + '__' + i;\n\n    // for event data\n    l.trace = d.trace;\n    l.curveNumber = d.trace.index;\n\n    return {\n        circular: d.circular,\n        key: key,\n        traceId: d.key,\n        pointNumber: l.pointNumber,\n        link: l,\n        tinyColorHue: Color.tinyRGB(tc),\n        tinyColorAlpha: tc.getAlpha(),\n        tinyColorHoverHue: Color.tinyRGB(htc),\n        tinyColorHoverAlpha: htc.getAlpha(),\n        linkPath: linkPath,\n        linkLineColor: d.linkLineColor,\n        linkLineWidth: d.linkLineWidth,\n        linkArrowLength: d.linkArrowLength,\n        valueFormat: d.valueFormat,\n        valueSuffix: d.valueSuffix,\n        sankey: d.sankey,\n        parent: d,\n        interactionState: d.interactionState,\n        flow: l.flow\n    };\n}\n\nfunction createCircularClosedPathString(link, arrowLen) {\n    // Using coordinates computed by d3-sankey-circular\n    var pathString = '';\n    var offset = link.width / 2;\n    var coords = link.circularPathData;\n    if(link.circularLinkType === 'top') {\n        // Top path\n        pathString =\n          // start at the left of the target node\n          'M ' +\n          (coords.targetX - arrowLen) + ' ' + (coords.targetY + offset) + ' ' +\n          'L' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY + offset) +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 1 ' +\n          (coords.rightFullExtent - offset - arrowLen) + ' ' + (coords.targetY - coords.rightSmallArcRadius) +\n          'L' +\n          (coords.rightFullExtent - offset - arrowLen) + ' ' + coords.verticalRightInnerExtent +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 1 ' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent - offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 1 ' +\n          (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent +\n          'L' +\n          (coords.leftFullExtent + offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 1 ' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY + offset) +\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY + offset) +\n\n          // Walking back\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY - offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY - offset) +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 0 ' +\n          (coords.leftFullExtent - offset) + ' ' + (coords.sourceY - coords.leftSmallArcRadius) +\n          'L' +\n          (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 0 ' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) +\n          'L' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent + offset) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 0 ' +\n          (coords.rightFullExtent + offset - arrowLen) + ' ' + coords.verticalRightInnerExtent +\n          'L' +\n          (coords.rightFullExtent + offset - arrowLen) + ' ' + (coords.targetY - coords.rightSmallArcRadius) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 0 ' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY - offset) +\n          'L' +\n          (coords.targetX - arrowLen) + ' ' + (coords.targetY - offset) +\n          (arrowLen > 0 ? 'L' + coords.targetX + ' ' + (coords.targetY) : '') +\n          'Z';\n    } else {\n        // Bottom path\n        pathString =\n          // start at the left of the target node\n          'M ' +\n          (coords.targetX - arrowLen) + ' ' + (coords.targetY - offset) + ' ' +\n          'L' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY - offset) +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightSmallArcRadius + offset) + ' 0 0 0 ' +\n          (coords.rightFullExtent - offset - arrowLen) + ' ' + (coords.targetY + coords.rightSmallArcRadius) +\n          'L' +\n          (coords.rightFullExtent - offset - arrowLen) + ' ' + coords.verticalRightInnerExtent +\n          'A' +\n          (coords.rightLargeArcRadius + offset) + ' ' + (coords.rightLargeArcRadius + offset) + ' 0 0 0 ' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent + offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent + offset) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftLargeArcRadius + offset) + ' 0 0 0 ' +\n          (coords.leftFullExtent + offset) + ' ' + coords.verticalLeftInnerExtent +\n          'L' +\n          (coords.leftFullExtent + offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) +\n          'A' +\n          (coords.leftLargeArcRadius + offset) + ' ' + (coords.leftSmallArcRadius + offset) + ' 0 0 0 ' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY - offset) +\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY - offset) +\n\n          // Walking back\n          'L' +\n          coords.sourceX + ' ' + (coords.sourceY + offset) +\n          'L' +\n          coords.leftInnerExtent + ' ' + (coords.sourceY + offset) +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftSmallArcRadius - offset) + ' 0 0 1 ' +\n          (coords.leftFullExtent - offset) + ' ' + (coords.sourceY + coords.leftSmallArcRadius) +\n          'L' +\n          (coords.leftFullExtent - offset) + ' ' + coords.verticalLeftInnerExtent +\n          'A' +\n          (coords.leftLargeArcRadius - offset) + ' ' + (coords.leftLargeArcRadius - offset) + ' 0 0 1 ' +\n          coords.leftInnerExtent + ' ' + (coords.verticalFullExtent - offset) +\n          'L' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.verticalFullExtent - offset) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightLargeArcRadius - offset) + ' 0 0 1 ' +\n          (coords.rightFullExtent + offset - arrowLen) + ' ' + coords.verticalRightInnerExtent +\n          'L' +\n          (coords.rightFullExtent + offset - arrowLen) + ' ' + (coords.targetY + coords.rightSmallArcRadius) +\n          'A' +\n          (coords.rightLargeArcRadius - offset) + ' ' + (coords.rightSmallArcRadius - offset) + ' 0 0 1 ' +\n          (coords.rightInnerExtent - arrowLen) + ' ' + (coords.targetY + offset) +\n          'L' +\n          (coords.targetX - arrowLen) + ' ' + (coords.targetY + offset) +\n          (arrowLen > 0 ? 'L' + coords.targetX + ' ' + (coords.targetY) : '') +\n          'Z';\n    }\n    return pathString;\n}\n\nfunction linkPath() {\n    var curvature = 0.5;\n    function path(d) {\n        var arrowLen = d.linkArrowLength;\n        if(d.link.circular) {\n            return createCircularClosedPathString(d.link, arrowLen);\n        } else {\n            var maxArrowLength = Math.abs((d.link.target.x0 - d.link.source.x1) / 2);\n            if(arrowLen > maxArrowLength) {\n                arrowLen = maxArrowLength;\n            }\n            var x0 = d.link.source.x1;\n            var x1 = d.link.target.x0 - arrowLen;\n            var xi = interpolateNumber(x0, x1);\n            var x2 = xi(curvature);\n            var x3 = xi(1 - curvature);\n            var y0a = d.link.y0 - d.link.width / 2;\n            var y0b = d.link.y0 + d.link.width / 2;\n            var y1a = d.link.y1 - d.link.width / 2;\n            var y1b = d.link.y1 + d.link.width / 2;\n            var start = 'M' + x0 + ',' + y0a;\n            var upperCurve = 'C' + x2 + ',' + y0a +\n                ' ' + x3 + ',' + y1a +\n                ' ' + x1 + ',' + y1a;\n            var lowerCurve = 'C' + x3 + ',' + y1b +\n                ' ' + x2 + ',' + y0b +\n                ' ' + x0 + ',' + y0b;\n\n            var rightEnd = arrowLen > 0 ? 'L' + (x1 + arrowLen) + ',' + (y1a + d.link.width / 2) : '';\n            rightEnd += 'L' + x1 + ',' + y1b;\n            return start + upperCurve + rightEnd + lowerCurve + 'Z';\n        }\n    }\n    return path;\n}\n\nfunction nodeModel(d, n) {\n    var tc = tinycolor(n.color);\n    var zoneThicknessPad = c.nodePadAcross;\n    var zoneLengthPad = d.nodePad / 2;\n    n.dx = n.x1 - n.x0;\n    n.dy = n.y1 - n.y0;\n    var visibleThickness = n.dx;\n    var visibleLength = Math.max(0.5, n.dy);\n\n    var key = 'node_' + n.pointNumber;\n    // If it's a group, it's mutable and should be unique\n    if(n.group) {\n        key = Lib.randstr();\n    }\n\n    // for event data\n    n.trace = d.trace;\n    n.curveNumber = d.trace.index;\n\n    return {\n        index: n.pointNumber,\n        key: key,\n        partOfGroup: n.partOfGroup || false,\n        group: n.group,\n        traceId: d.key,\n        trace: d.trace,\n        node: n,\n        nodePad: d.nodePad,\n        nodeLineColor: d.nodeLineColor,\n        nodeLineWidth: d.nodeLineWidth,\n        textFont: d.textFont,\n        size: d.horizontal ? d.height : d.width,\n        visibleWidth: Math.ceil(visibleThickness),\n        visibleHeight: visibleLength,\n        zoneX: -zoneThicknessPad,\n        zoneY: -zoneLengthPad,\n        zoneWidth: visibleThickness + 2 * zoneThicknessPad,\n        zoneHeight: visibleLength + 2 * zoneLengthPad,\n        labelY: d.horizontal ? n.dy / 2 + 1 : n.dx / 2 + 1,\n        left: n.originalLayer === 1,\n        sizeAcross: d.width,\n        forceLayouts: d.forceLayouts,\n        horizontal: d.horizontal,\n        darkBackground: tc.getBrightness() <= 128,\n        tinyColorHue: Color.tinyRGB(tc),\n        tinyColorAlpha: tc.getAlpha(),\n        valueFormat: d.valueFormat,\n        valueSuffix: d.valueSuffix,\n        sankey: d.sankey,\n        graph: d.graph,\n        arrangement: d.arrangement,\n        uniqueNodeLabelPathId: [d.guid, d.key, key].join('_'),\n        interactionState: d.interactionState,\n        figure: d\n    };\n}\n\n// rendering snippets\n\nfunction updateNodePositions(sankeyNode) {\n    sankeyNode\n        .attr('transform', function(d) {\n            return strTranslate(d.node.x0.toFixed(3), (d.node.y0).toFixed(3));\n        });\n}\n\nfunction updateNodeShapes(sankeyNode) {\n    sankeyNode.call(updateNodePositions);\n}\n\nfunction updateShapes(sankeyNode, sankeyLink) {\n    sankeyNode.call(updateNodeShapes);\n    sankeyLink.attr('d', linkPath());\n}\n\nfunction sizeNode(rect) {\n    rect\n      .attr('width', function(d) {return d.node.x1 - d.node.x0;})\n      .attr('height', function(d) {return d.visibleHeight;});\n}\n\nfunction salientEnough(d) {return (d.link.width > 1 || d.linkLineWidth > 0);}\n\nfunction sankeyTransform(d) {\n    var offset = strTranslate(d.translateX, d.translateY);\n    return offset + (d.horizontal ? 'matrix(1 0 0 1 0 0)' : 'matrix(0 1 1 0 0 0)');\n}\n\n// event handling\n\nfunction attachPointerEvents(selection, sankey, eventSet) {\n    selection\n        .on('.basic', null) // remove any preexisting handlers\n        .on('mouseover.basic', function(d) {\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.hover(this, d, sankey);\n                d.interactionState.hovered = [this, d];\n            }\n        })\n        .on('mousemove.basic', function(d) {\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.follow(this, d);\n                d.interactionState.hovered = [this, d];\n            }\n        })\n        .on('mouseout.basic', function(d) {\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.unhover(this, d, sankey);\n                d.interactionState.hovered = false;\n            }\n        })\n        .on('click.basic', function(d) {\n            if(d.interactionState.hovered) {\n                eventSet.unhover(this, d, sankey);\n                d.interactionState.hovered = false;\n            }\n            if(!d.interactionState.dragInProgress && !d.partOfGroup) {\n                eventSet.select(this, d, sankey);\n            }\n        });\n}\n\nfunction attachDragHandler(sankeyNode, sankeyLink, callbacks, gd) {\n    var dragBehavior = d3.behavior.drag()\n        .origin(function(d) {\n            return {\n                x: d.node.x0 + d.visibleWidth / 2,\n                y: d.node.y0 + d.visibleHeight / 2\n            };\n        })\n\n        .on('dragstart', function(d) {\n            if(d.arrangement === 'fixed') return;\n            Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'dragcover', function(s) {\n                gd._fullLayout._dragCover = s;\n            });\n            Lib.raiseToTop(this);\n            d.interactionState.dragInProgress = d.node;\n\n            saveCurrentDragPosition(d.node);\n            if(d.interactionState.hovered) {\n                callbacks.nodeEvents.unhover.apply(0, d.interactionState.hovered);\n                d.interactionState.hovered = false;\n            }\n            if(d.arrangement === 'snap') {\n                var forceKey = d.traceId + '|' + d.key;\n                if(d.forceLayouts[forceKey]) {\n                    d.forceLayouts[forceKey].alpha(1);\n                } else { // make a forceLayout if needed\n                    attachForce(sankeyNode, forceKey, d, gd);\n                }\n                startForce(sankeyNode, sankeyLink, d, forceKey, gd);\n            }\n        })\n\n        .on('drag', function(d) {\n            if(d.arrangement === 'fixed') return;\n            var x = d3.event.x;\n            var y = d3.event.y;\n            if(d.arrangement === 'snap') {\n                d.node.x0 = x - d.visibleWidth / 2;\n                d.node.x1 = x + d.visibleWidth / 2;\n                d.node.y0 = y - d.visibleHeight / 2;\n                d.node.y1 = y + d.visibleHeight / 2;\n            } else {\n                if(d.arrangement === 'freeform') {\n                    d.node.x0 = x - d.visibleWidth / 2;\n                    d.node.x1 = x + d.visibleWidth / 2;\n                }\n                y = Math.max(0, Math.min(d.size - d.visibleHeight / 2, y));\n                d.node.y0 = y - d.visibleHeight / 2;\n                d.node.y1 = y + d.visibleHeight / 2;\n            }\n\n            saveCurrentDragPosition(d.node);\n            if(d.arrangement !== 'snap') {\n                d.sankey.update(d.graph);\n                updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n            }\n        })\n\n        .on('dragend', function(d) {\n            if(d.arrangement === 'fixed') return;\n            d.interactionState.dragInProgress = false;\n            for(var i = 0; i < d.node.childrenNodes.length; i++) {\n                d.node.childrenNodes[i].x = d.node.x;\n                d.node.childrenNodes[i].y = d.node.y;\n            }\n            if(d.arrangement !== 'snap') persistFinalNodePositions(d, gd);\n        });\n\n    sankeyNode\n        .on('.drag', null) // remove possible previous handlers\n        .call(dragBehavior);\n}\n\nfunction attachForce(sankeyNode, forceKey, d, gd) {\n    // Attach force to nodes in the same column (same x coordinate)\n    switchToForceFormat(d.graph.nodes);\n    var nodes = d.graph.nodes\n        .filter(function(n) {return n.originalX === d.node.originalX;})\n        // Filter out children\n        .filter(function(n) {return !n.partOfGroup;});\n    d.forceLayouts[forceKey] = d3Force.forceSimulation(nodes)\n        .alphaDecay(0)\n        .force('collide', d3Force.forceCollide()\n            .radius(function(n) {return n.dy / 2 + d.nodePad / 2;})\n            .strength(1)\n            .iterations(c.forceIterations))\n        .force('constrain', snappingForce(sankeyNode, forceKey, nodes, d, gd))\n        .stop();\n}\n\nfunction startForce(sankeyNode, sankeyLink, d, forceKey, gd) {\n    window.requestAnimationFrame(function faster() {\n        var i;\n        for(i = 0; i < c.forceTicksPerFrame; i++) {\n            d.forceLayouts[forceKey].tick();\n        }\n\n        var nodes = d.graph.nodes;\n        switchToSankeyFormat(nodes);\n\n        d.sankey.update(d.graph);\n        updateShapes(sankeyNode.filter(sameLayer(d)), sankeyLink);\n\n        if(d.forceLayouts[forceKey].alpha() > 0) {\n            window.requestAnimationFrame(faster);\n        } else {\n            // Make sure the final x position is equal to its original value\n            // because the force simulation will have numerical error\n            var x = d.node.originalX;\n            d.node.x0 = x - d.visibleWidth / 2;\n            d.node.x1 = x + d.visibleWidth / 2;\n\n            persistFinalNodePositions(d, gd);\n        }\n    });\n}\n\nfunction snappingForce(sankeyNode, forceKey, nodes, d) {\n    return function _snappingForce() {\n        var maxVelocity = 0;\n        for(var i = 0; i < nodes.length; i++) {\n            var n = nodes[i];\n            if(n === d.interactionState.dragInProgress) { // constrain node position to the dragging pointer\n                n.x = n.lastDraggedX;\n                n.y = n.lastDraggedY;\n            } else {\n                n.vx = (n.originalX - n.x) / c.forceTicksPerFrame; // snap to layer\n                n.y = Math.min(d.size - n.dy / 2, Math.max(n.dy / 2, n.y)); // constrain to extent\n            }\n            maxVelocity = Math.max(maxVelocity, Math.abs(n.vx), Math.abs(n.vy));\n        }\n        if(!d.interactionState.dragInProgress && maxVelocity < 0.1 && d.forceLayouts[forceKey].alpha() > 0) {\n            d.forceLayouts[forceKey].alpha(0); // This will stop the animation loop\n        }\n    };\n}\n\n// basic data utilities\n\nfunction persistFinalNodePositions(d, gd) {\n    var x = [];\n    var y = [];\n    for(var i = 0; i < d.graph.nodes.length; i++) {\n        var nodeX = (d.graph.nodes[i].x0 + d.graph.nodes[i].x1) / 2;\n        var nodeY = (d.graph.nodes[i].y0 + d.graph.nodes[i].y1) / 2;\n        x.push(nodeX / d.figure.width);\n        y.push(nodeY / d.figure.height);\n    }\n    Registry.call('_guiRestyle', gd, {\n        'node.x': [x],\n        'node.y': [y]\n    }, d.trace.index)\n    .then(function() {\n        if(gd._fullLayout._dragCover) gd._fullLayout._dragCover.remove();\n    });\n}\n\nfunction persistOriginalPlace(nodes) {\n    var distinctLayerPositions = [];\n    var i;\n    for(i = 0; i < nodes.length; i++) {\n        nodes[i].originalX = (nodes[i].x0 + nodes[i].x1) / 2;\n        nodes[i].originalY = (nodes[i].y0 + nodes[i].y1) / 2;\n        if(distinctLayerPositions.indexOf(nodes[i].originalX) === -1) {\n            distinctLayerPositions.push(nodes[i].originalX);\n        }\n    }\n    distinctLayerPositions.sort(function(a, b) {return a - b;});\n    for(i = 0; i < nodes.length; i++) {\n        nodes[i].originalLayerIndex = distinctLayerPositions.indexOf(nodes[i].originalX);\n        nodes[i].originalLayer = nodes[i].originalLayerIndex / (distinctLayerPositions.length - 1);\n    }\n}\n\nfunction saveCurrentDragPosition(d) {\n    d.lastDraggedX = d.x0 + d.dx / 2;\n    d.lastDraggedY = d.y0 + d.dy / 2;\n}\n\nfunction sameLayer(d) {\n    return function(n) {return n.node.originalX === d.node.originalX;};\n}\n\nfunction switchToForceFormat(nodes) {\n    // force uses x, y as centers\n    for(var i = 0; i < nodes.length; i++) {\n        nodes[i].y = (nodes[i].y0 + nodes[i].y1) / 2;\n        nodes[i].x = (nodes[i].x0 + nodes[i].x1) / 2;\n    }\n}\n\nfunction switchToSankeyFormat(nodes) {\n    // sankey uses x0, x1, y0, y1\n    for(var i = 0; i < nodes.length; i++) {\n        nodes[i].y0 = nodes[i].y - nodes[i].dy / 2;\n        nodes[i].y1 = nodes[i].y0 + nodes[i].dy;\n\n        nodes[i].x0 = nodes[i].x - nodes[i].dx / 2;\n        nodes[i].x1 = nodes[i].x0 + nodes[i].dx;\n    }\n}\n\n// scene graph\nmodule.exports = function(gd, svg, calcData, layout, callbacks) {\n    var isStatic = gd._context.staticPlot;\n\n    // To prevent animation on first render\n    var firstRender = false;\n    Lib.ensureSingle(gd._fullLayout._infolayer, 'g', 'first-render', function() {\n        firstRender = true;\n    });\n\n    // To prevent animation on dragging\n    var dragcover = gd._fullLayout._dragCover;\n\n    var styledData = calcData\n            .filter(function(d) {return unwrap(d).trace.visible;})\n            .map(sankeyModel.bind(null, layout));\n\n    var sankey = svg.selectAll('.' + c.cn.sankey)\n        .data(styledData, keyFun);\n\n    sankey.exit()\n        .remove();\n\n    sankey.enter()\n        .append('g')\n        .classed(c.cn.sankey, true)\n        .style('box-sizing', 'content-box')\n        .style('position', 'absolute')\n        .style('left', 0)\n        .style('shape-rendering', 'geometricPrecision')\n        .style('pointer-events', isStatic ? 'none' : 'auto')\n        .attr('transform', sankeyTransform);\n\n    sankey.each(function(d, i) {\n        gd._fullData[i]._sankey = d;\n        // Create dragbox if missing\n        var dragboxClassName = 'bgsankey-' + d.trace.uid + '-' + i;\n        Lib.ensureSingle(gd._fullLayout._draggers, 'rect', dragboxClassName);\n\n        gd._fullData[i]._bgRect = d3.select('.' + dragboxClassName);\n\n        // Style dragbox\n        gd._fullData[i]._bgRect\n          .style('pointer-events', isStatic ? 'none' : 'all')\n          .attr('width', d.width)\n          .attr('height', d.height)\n          .attr('x', d.translateX)\n          .attr('y', d.translateY)\n          .classed('bgsankey', true)\n          .style({fill: 'transparent', 'stroke-width': 0});\n    });\n\n    sankey.transition()\n        .ease(c.ease).duration(c.duration)\n        .attr('transform', sankeyTransform);\n\n    var sankeyLinks = sankey.selectAll('.' + c.cn.sankeyLinks)\n        .data(repeat, keyFun);\n\n    sankeyLinks.enter()\n        .append('g')\n        .classed(c.cn.sankeyLinks, true)\n        .style('fill', 'none');\n\n    var sankeyLink = sankeyLinks.selectAll('.' + c.cn.sankeyLink)\n          .data(function(d) {\n              var links = d.graph.links;\n              return links\n                .filter(function(l) {return l.value;})\n                .map(linkModel.bind(null, d));\n          }, keyFun);\n\n    sankeyLink\n          .enter().append('path')\n          .classed(c.cn.sankeyLink, true)\n          .call(attachPointerEvents, sankey, callbacks.linkEvents);\n\n    sankeyLink\n        .style('stroke', function(d) {\n            return salientEnough(d) ? Color.tinyRGB(tinycolor(d.linkLineColor)) : d.tinyColorHue;\n        })\n        .style('stroke-opacity', function(d) {\n            return salientEnough(d) ? Color.opacity(d.linkLineColor) : d.tinyColorAlpha;\n        })\n        .style('fill', function(d) {\n            return d.tinyColorHue;\n        })\n        .style('fill-opacity', function(d) {\n            return d.tinyColorAlpha;\n        })\n        .style('stroke-width', function(d) {\n            return salientEnough(d) ? d.linkLineWidth : 1;\n        })\n        .attr('d', linkPath());\n\n    sankeyLink\n        .style('opacity', function() { return (gd._context.staticPlot || firstRender || dragcover) ? 1 : 0;})\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .style('opacity', 1);\n\n    sankeyLink.exit()\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .style('opacity', 0)\n        .remove();\n\n    var sankeyNodeSet = sankey.selectAll('.' + c.cn.sankeyNodeSet)\n        .data(repeat, keyFun);\n\n    sankeyNodeSet.enter()\n        .append('g')\n        .classed(c.cn.sankeyNodeSet, true);\n\n    sankeyNodeSet\n        .style('cursor', function(d) {\n            switch(d.arrangement) {\n                case 'fixed': return 'default';\n                case 'perpendicular': return 'ns-resize';\n                default: return 'move';\n            }\n        });\n\n    var sankeyNode = sankeyNodeSet.selectAll('.' + c.cn.sankeyNode)\n        .data(function(d) {\n            var nodes = d.graph.nodes;\n            persistOriginalPlace(nodes);\n            return nodes\n              .map(nodeModel.bind(null, d));\n        }, keyFun);\n\n    sankeyNode.enter()\n        .append('g')\n        .classed(c.cn.sankeyNode, true)\n        .call(updateNodePositions)\n        .style('opacity', function(n) { return ((gd._context.staticPlot || firstRender) && !n.partOfGroup) ? 1 : 0;});\n\n    sankeyNode\n        .call(attachPointerEvents, sankey, callbacks.nodeEvents)\n        .call(attachDragHandler, sankeyLink, callbacks, gd); // has to be here as it binds sankeyLink\n\n    sankeyNode\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .call(updateNodePositions)\n        .style('opacity', function(n) { return n.partOfGroup ? 0 : 1;});\n\n    sankeyNode.exit()\n        .transition()\n        .ease(c.ease).duration(c.duration)\n        .style('opacity', 0)\n        .remove();\n\n    var nodeRect = sankeyNode.selectAll('.' + c.cn.nodeRect)\n        .data(repeat);\n\n    nodeRect.enter()\n        .append('rect')\n        .classed(c.cn.nodeRect, true)\n        .call(sizeNode);\n\n    nodeRect\n        .style('stroke-width', function(d) {return d.nodeLineWidth;})\n        .style('stroke', function(d) {return Color.tinyRGB(tinycolor(d.nodeLineColor));})\n        .style('stroke-opacity', function(d) {return Color.opacity(d.nodeLineColor);})\n        .style('fill', function(d) {return d.tinyColorHue;})\n        .style('fill-opacity', function(d) {return d.tinyColorAlpha;});\n\n    nodeRect.transition()\n        .ease(c.ease).duration(c.duration)\n        .call(sizeNode);\n\n    var nodeLabel = sankeyNode.selectAll('.' + c.cn.nodeLabel)\n        .data(repeat);\n\n    nodeLabel.enter()\n        .append('text')\n        .classed(c.cn.nodeLabel, true)\n        .style('cursor', 'default');\n\n    nodeLabel\n        .attr('data-notex', 1) // prohibit tex interpretation until we can handle tex and regular text together\n        .text(function(d) { return d.node.label; })\n        .each(function(d) {\n            var e = d3.select(this);\n            Drawing.font(e, d.textFont);\n            svgTextUtils.convertToTspans(e, gd);\n        })\n        .attr('text-anchor', function(d) {\n            return (d.horizontal && d.left) ? 'end' : 'start';\n        })\n        .attr('transform', function(d) {\n            var e = d3.select(this);\n            // how much to shift a multi-line label to center it vertically.\n            var nLines = svgTextUtils.lineCount(e);\n            var blockHeight = d.textFont.size * (\n                (nLines - 1) * LINE_SPACING - CAP_SHIFT\n            );\n\n            var posX = d.nodeLineWidth / 2 + TEXTPAD;\n            var posY = ((d.horizontal ? d.visibleHeight : d.visibleWidth) - blockHeight) / 2;\n            if(d.horizontal) {\n                if(d.left) {\n                    posX = -posX;\n                } else {\n                    posX += d.visibleWidth;\n                }\n            }\n\n            var flipText = d.horizontal ? '' : (\n                'scale(-1,1)' + strRotate(90)\n            );\n\n            return strTranslate(\n                d.horizontal ? posX : posY,\n                d.horizontal ? posY : posX\n            ) + flipText;\n        });\n\n    nodeLabel\n        .transition()\n        .ease(c.ease).duration(c.duration);\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script"}