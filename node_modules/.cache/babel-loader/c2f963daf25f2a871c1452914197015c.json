{"ast":null,"code":"'use strict';\n\nvar d3 = require('@plotly/d3');\nvar interpolateNumber = require('d3-interpolate').interpolateNumber;\nvar Plotly = require('../../plot_api/plot_api');\nvar Fx = require('../../components/fx');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar Drawing = require('../../components/drawing');\nvar tinycolor = require('tinycolor2');\nvar svgTextUtils = require('../../lib/svg_text_utils');\nfunction performPlot(parcatsModels, graphDiv, layout, svg) {\n  var isStatic = graphDiv._context.staticPlot;\n  var viewModels = parcatsModels.map(createParcatsViewModel.bind(0, graphDiv, layout));\n\n  // Get (potentially empty) parcatslayer selection with bound data to single element array\n  var layerSelection = svg.selectAll('g.parcatslayer').data([null]);\n\n  // Initialize single parcatslayer group if it doesn't exist\n  layerSelection.enter().append('g').attr('class', 'parcatslayer').style('pointer-events', isStatic ? 'none' : 'all');\n\n  // Bind data to children of layerSelection and get reference to traceSelection\n  var traceSelection = layerSelection.selectAll('g.trace.parcats').data(viewModels, key);\n\n  // Initialize group for each trace/dimensions\n  var traceEnter = traceSelection.enter().append('g').attr('class', 'trace parcats');\n\n  // Update properties for each trace\n  traceSelection.attr('transform', function (d) {\n    return strTranslate(d.x, d.y);\n  });\n\n  // Initialize paths group\n  traceEnter.append('g').attr('class', 'paths');\n\n  // Update paths transform\n  var pathsSelection = traceSelection.select('g.paths');\n\n  // Get paths selection\n  var pathSelection = pathsSelection.selectAll('path.path').data(function (d) {\n    return d.paths;\n  }, key);\n\n  // Update existing path colors\n  pathSelection.attr('fill', function (d) {\n    return d.model.color;\n  });\n\n  // Create paths\n  var pathSelectionEnter = pathSelection.enter().append('path').attr('class', 'path').attr('stroke-opacity', 0).attr('fill', function (d) {\n    return d.model.color;\n  }).attr('fill-opacity', 0);\n  stylePathsNoHover(pathSelectionEnter);\n\n  // Set path geometry\n  pathSelection.attr('d', function (d) {\n    return d.svgD;\n  });\n\n  // sort paths\n  if (!pathSelectionEnter.empty()) {\n    // Only sort paths if there has been a change.\n    // Otherwise paths are already sorted or a hover operation may be in progress\n    pathSelection.sort(compareRawColor);\n  }\n\n  // Remove any old paths\n  pathSelection.exit().remove();\n\n  // Path hover\n  pathSelection.on('mouseover', mouseoverPath).on('mouseout', mouseoutPath).on('click', clickPath);\n\n  // Initialize dimensions group\n  traceEnter.append('g').attr('class', 'dimensions');\n\n  // Update dimensions transform\n  var dimensionsSelection = traceSelection.select('g.dimensions');\n\n  // Get dimension selection\n  var dimensionSelection = dimensionsSelection.selectAll('g.dimension').data(function (d) {\n    return d.dimensions;\n  }, key);\n\n  // Create dimension groups\n  dimensionSelection.enter().append('g').attr('class', 'dimension');\n\n  // Update dimension group transforms\n  dimensionSelection.attr('transform', function (d) {\n    return strTranslate(d.x, 0);\n  });\n\n  // Remove any old dimensions\n  dimensionSelection.exit().remove();\n\n  // Get category selection\n  var categorySelection = dimensionSelection.selectAll('g.category').data(function (d) {\n    return d.categories;\n  }, key);\n\n  // Initialize category groups\n  var categoryGroupEnterSelection = categorySelection.enter().append('g').attr('class', 'category');\n\n  // Update category transforms\n  categorySelection.attr('transform', function (d) {\n    return strTranslate(0, d.y);\n  });\n\n  // Initialize rectangle\n  categoryGroupEnterSelection.append('rect').attr('class', 'catrect').attr('pointer-events', 'none');\n\n  // Update rectangle\n  categorySelection.select('rect.catrect').attr('fill', 'none').attr('width', function (d) {\n    return d.width;\n  }).attr('height', function (d) {\n    return d.height;\n  });\n  styleCategoriesNoHover(categoryGroupEnterSelection);\n\n  // Initialize color band rects\n  var bandSelection = categorySelection.selectAll('rect.bandrect').data(/** @param {CategoryViewModel} catViewModel*/\n  function (catViewModel) {\n    return catViewModel.bands;\n  }, key);\n\n  // Raise all update bands to the top so that fading enter/exit bands will be behind\n  bandSelection.each(function () {\n    Lib.raiseToTop(this);\n  });\n\n  // Update band color\n  bandSelection.attr('fill', function (d) {\n    return d.color;\n  });\n  var bandsSelectionEnter = bandSelection.enter().append('rect').attr('class', 'bandrect').attr('stroke-opacity', 0).attr('fill', function (d) {\n    return d.color;\n  }).attr('fill-opacity', 0);\n  bandSelection.attr('fill', function (d) {\n    return d.color;\n  }).attr('width', function (d) {\n    return d.width;\n  }).attr('height', function (d) {\n    return d.height;\n  }).attr('y', function (d) {\n    return d.y;\n  }).attr('cursor', /** @param {CategoryBandViewModel} bandModel*/\n  function (bandModel) {\n    if (bandModel.parcatsViewModel.arrangement === 'fixed') {\n      return 'default';\n    } else if (bandModel.parcatsViewModel.arrangement === 'perpendicular') {\n      return 'ns-resize';\n    } else {\n      return 'move';\n    }\n  });\n  styleBandsNoHover(bandsSelectionEnter);\n  bandSelection.exit().remove();\n\n  // Initialize category label\n  categoryGroupEnterSelection.append('text').attr('class', 'catlabel').attr('pointer-events', 'none');\n\n  // Update category label\n  categorySelection.select('text.catlabel').attr('text-anchor', function (d) {\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      return 'start';\n    } else {\n      // Place label to the left of category\n      return 'end';\n    }\n  }).attr('alignment-baseline', 'middle').style('fill', 'rgb(0, 0, 0)').attr('x', function (d) {\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      return d.width + 5;\n    } else {\n      // Place label to the left of category\n      return -5;\n    }\n  }).attr('y', function (d) {\n    return d.height / 2;\n  }).text(function (d) {\n    return d.model.categoryLabel;\n  }).each(/** @param {CategoryViewModel} catModel*/\n  function (catModel) {\n    Drawing.font(d3.select(this), catModel.parcatsViewModel.categorylabelfont);\n    svgTextUtils.convertToTspans(d3.select(this), graphDiv);\n  });\n\n  // Initialize dimension label\n  categoryGroupEnterSelection.append('text').attr('class', 'dimlabel');\n\n  // Update dimension label\n  categorySelection.select('text.dimlabel').attr('text-anchor', 'middle').attr('alignment-baseline', 'baseline').attr('cursor', /** @param {CategoryViewModel} catModel*/\n  function (catModel) {\n    if (catModel.parcatsViewModel.arrangement === 'fixed') {\n      return 'default';\n    } else {\n      return 'ew-resize';\n    }\n  }).attr('x', function (d) {\n    return d.width / 2;\n  }).attr('y', -5).text(function (d, i) {\n    if (i === 0) {\n      // Add dimension label above topmost category\n      return d.parcatsViewModel.model.dimensions[d.model.dimensionInd].dimensionLabel;\n    } else {\n      return null;\n    }\n  }).each(/** @param {CategoryViewModel} catModel*/\n  function (catModel) {\n    Drawing.font(d3.select(this), catModel.parcatsViewModel.labelfont);\n  });\n\n  // Category hover\n  // categorySelection.select('rect.catrect')\n  categorySelection.selectAll('rect.bandrect').on('mouseover', mouseoverCategoryBand).on('mouseout', mouseoutCategory);\n\n  // Remove unused categories\n  categorySelection.exit().remove();\n\n  // Setup drag\n  dimensionSelection.call(d3.behavior.drag().origin(function (d) {\n    return {\n      x: d.x,\n      y: 0\n    };\n  }).on('dragstart', dragDimensionStart).on('drag', dragDimension).on('dragend', dragDimensionEnd));\n\n  // Save off selections to view models\n  traceSelection.each(function (d) {\n    d.traceSelection = d3.select(this);\n    d.pathSelection = d3.select(this).selectAll('g.paths').selectAll('path.path');\n    d.dimensionSelection = d3.select(this).selectAll('g.dimensions').selectAll('g.dimension');\n  });\n\n  // Remove any orphan traces\n  traceSelection.exit().remove();\n}\n\n/**\n * Create / update parcat traces\n *\n * @param {Object} graphDiv\n * @param {Object} svg\n * @param {Array.<ParcatsModel>} parcatsModels\n * @param {Layout} layout\n */\nmodule.exports = function (graphDiv, svg, parcatsModels, layout) {\n  performPlot(parcatsModels, graphDiv, layout, svg);\n};\n\n/**\n * Function the returns the key property of an object for use with as D3 join function\n * @param d\n */\nfunction key(d) {\n  return d.key;\n}\n\n/** True if a category view model is in the right-most display dimension\n * @param {CategoryViewModel} d */\nfunction catInRightDim(d) {\n  var numDims = d.parcatsViewModel.dimensions.length;\n  var leftDimInd = d.parcatsViewModel.dimensions[numDims - 1].model.dimensionInd;\n  return d.model.dimensionInd === leftDimInd;\n}\n\n/**\n * @param {PathViewModel} a\n * @param {PathViewModel} b\n */\nfunction compareRawColor(a, b) {\n  if (a.model.rawColor > b.model.rawColor) {\n    return 1;\n  } else if (a.model.rawColor < b.model.rawColor) {\n    return -1;\n  } else {\n    return 0;\n  }\n}\n\n/**\n * Handle path mouseover\n * @param {PathViewModel} d\n */\nfunction mouseoverPath(d) {\n  if (!d.parcatsViewModel.dragDimension) {\n    // We're not currently dragging\n\n    if (d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n      // hoverinfo is not skip, so we at least style the paths and emit interaction events\n\n      // Raise path to top\n      Lib.raiseToTop(this);\n      stylePathsHover(d3.select(this));\n\n      // Emit hover event\n      var points = buildPointsArrayForPath(d);\n      var constraints = buildConstraintsForPath(d);\n      d.parcatsViewModel.graphDiv.emit('plotly_hover', {\n        points: points,\n        event: d3.event,\n        constraints: constraints\n      });\n\n      // Handle hover label\n      if (d.parcatsViewModel.hoverinfoItems.indexOf('none') === -1) {\n        // hoverinfo is a combination of 'count' and 'probability'\n\n        // Mouse\n        var hoverX = d3.mouse(this)[0];\n\n        // Label\n        var gd = d.parcatsViewModel.graphDiv;\n        var trace = d.parcatsViewModel.trace;\n        var fullLayout = gd._fullLayout;\n        var rootBBox = fullLayout._paperdiv.node().getBoundingClientRect();\n        var graphDivBBox = d.parcatsViewModel.graphDiv.getBoundingClientRect();\n\n        // Find path center in path coordinates\n        var pathCenterX, pathCenterY, dimInd;\n        for (dimInd = 0; dimInd < d.leftXs.length - 1; dimInd++) {\n          if (d.leftXs[dimInd] + d.dimWidths[dimInd] - 2 <= hoverX && hoverX <= d.leftXs[dimInd + 1] + 2) {\n            var leftDim = d.parcatsViewModel.dimensions[dimInd];\n            var rightDim = d.parcatsViewModel.dimensions[dimInd + 1];\n            pathCenterX = (leftDim.x + leftDim.width + rightDim.x) / 2;\n            pathCenterY = (d.topYs[dimInd] + d.topYs[dimInd + 1] + d.height) / 2;\n            break;\n          }\n        }\n\n        // Find path center in root coordinates\n        var hoverCenterX = d.parcatsViewModel.x + pathCenterX;\n        var hoverCenterY = d.parcatsViewModel.y + pathCenterY;\n        var textColor = tinycolor.mostReadable(d.model.color, ['black', 'white']);\n        var count = d.model.count;\n        var prob = count / d.parcatsViewModel.model.count;\n        var labels = {\n          countLabel: count,\n          probabilityLabel: prob.toFixed(3)\n        };\n\n        // Build hover text\n        var hovertextParts = [];\n        if (d.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n          hovertextParts.push(['Count:', labels.countLabel].join(' '));\n        }\n        if (d.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n          hovertextParts.push(['P:', labels.probabilityLabel].join(' '));\n        }\n        var hovertext = hovertextParts.join('<br>');\n        var mouseX = d3.mouse(gd)[0];\n        Fx.loneHover({\n          trace: trace,\n          x: hoverCenterX - rootBBox.left + graphDivBBox.left,\n          y: hoverCenterY - rootBBox.top + graphDivBBox.top,\n          text: hovertext,\n          color: d.model.color,\n          borderColor: 'black',\n          fontFamily: 'Monaco, \"Courier New\", monospace',\n          fontSize: 10,\n          fontColor: textColor,\n          idealAlign: mouseX < hoverCenterX ? 'right' : 'left',\n          hovertemplate: (trace.line || {}).hovertemplate,\n          hovertemplateLabels: labels,\n          eventData: [{\n            data: trace._input,\n            fullData: trace,\n            count: count,\n            probability: prob\n          }]\n        }, {\n          container: fullLayout._hoverlayer.node(),\n          outerContainer: fullLayout._paper.node(),\n          gd: gd\n        });\n      }\n    }\n  }\n}\n\n/**\n * Handle path mouseout\n * @param {PathViewModel} d\n */\nfunction mouseoutPath(d) {\n  if (!d.parcatsViewModel.dragDimension) {\n    // We're not currently dragging\n    stylePathsNoHover(d3.select(this));\n\n    // Remove and hover label\n    Fx.loneUnhover(d.parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n\n    // Restore path order\n    d.parcatsViewModel.pathSelection.sort(compareRawColor);\n\n    // Emit unhover event\n    if (d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n      var points = buildPointsArrayForPath(d);\n      var constraints = buildConstraintsForPath(d);\n      d.parcatsViewModel.graphDiv.emit('plotly_unhover', {\n        points: points,\n        event: d3.event,\n        constraints: constraints\n      });\n    }\n  }\n}\n\n/**\n * Build array of point objects for a path\n *\n * For use in click/hover events\n * @param {PathViewModel} d\n */\nfunction buildPointsArrayForPath(d) {\n  var points = [];\n  var curveNumber = getTraceIndex(d.parcatsViewModel);\n  for (var i = 0; i < d.model.valueInds.length; i++) {\n    var pointNumber = d.model.valueInds[i];\n    points.push({\n      curveNumber: curveNumber,\n      pointNumber: pointNumber\n    });\n  }\n  return points;\n}\n\n/**\n * Build constraints object for a path\n *\n * For use in click/hover events\n * @param {PathViewModel} d\n */\nfunction buildConstraintsForPath(d) {\n  var constraints = {};\n  var dimensions = d.parcatsViewModel.model.dimensions;\n\n  // dimensions\n  for (var i = 0; i < dimensions.length; i++) {\n    var dimension = dimensions[i];\n    var category = dimension.categories[d.model.categoryInds[i]];\n    constraints[dimension.containerInd] = category.categoryValue;\n  }\n\n  // color\n  if (d.model.rawColor !== undefined) {\n    constraints.color = d.model.rawColor;\n  }\n  return constraints;\n}\n\n/**\n * Handle path click\n * @param {PathViewModel} d\n */\nfunction clickPath(d) {\n  if (d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n    // hoverinfo it's skip, so interaction events aren't disabled\n    var points = buildPointsArrayForPath(d);\n    var constraints = buildConstraintsForPath(d);\n    d.parcatsViewModel.graphDiv.emit('plotly_click', {\n      points: points,\n      event: d3.event,\n      constraints: constraints\n    });\n  }\n}\nfunction stylePathsNoHover(pathSelection) {\n  pathSelection.attr('fill', function (d) {\n    return d.model.color;\n  }).attr('fill-opacity', 0.6).attr('stroke', 'lightgray').attr('stroke-width', 0.2).attr('stroke-opacity', 1.0);\n}\nfunction stylePathsHover(pathSelection) {\n  pathSelection.attr('fill-opacity', 0.8).attr('stroke', function (d) {\n    return tinycolor.mostReadable(d.model.color, ['black', 'white']);\n  }).attr('stroke-width', 0.3);\n}\nfunction styleCategoryHover(categorySelection) {\n  categorySelection.select('rect.catrect').attr('stroke', 'black').attr('stroke-width', 2.5);\n}\nfunction styleCategoriesNoHover(categorySelection) {\n  categorySelection.select('rect.catrect').attr('stroke', 'black').attr('stroke-width', 1).attr('stroke-opacity', 1);\n}\nfunction styleBandsHover(bandsSelection) {\n  bandsSelection.attr('stroke', 'black').attr('stroke-width', 1.5);\n}\nfunction styleBandsNoHover(bandsSelection) {\n  bandsSelection.attr('stroke', 'black').attr('stroke-width', 0.2).attr('stroke-opacity', 1.0).attr('fill-opacity', 1.0);\n}\n\n/**\n * Return selection of all paths that pass through the specified category\n * @param {CategoryBandViewModel} catBandViewModel\n */\nfunction selectPathsThroughCategoryBandColor(catBandViewModel) {\n  var allPaths = catBandViewModel.parcatsViewModel.pathSelection;\n  var dimInd = catBandViewModel.categoryViewModel.model.dimensionInd;\n  var catInd = catBandViewModel.categoryViewModel.model.categoryInd;\n  return allPaths.filter(/** @param {PathViewModel} pathViewModel */\n  function (pathViewModel) {\n    return pathViewModel.model.categoryInds[dimInd] === catInd && pathViewModel.model.color === catBandViewModel.color;\n  });\n}\n\n/**\n * Perform hover styling for all paths that pass though the specified band element's category\n *\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction styleForCategoryHovermode(bandElement) {\n  // Get all bands in the current category\n  var bandSel = d3.select(bandElement.parentNode).selectAll('rect.bandrect');\n\n  // Raise and style paths\n  bandSel.each(function (bvm) {\n    var paths = selectPathsThroughCategoryBandColor(bvm);\n    stylePathsHover(paths);\n    paths.each(function () {\n      // Raise path to top\n      Lib.raiseToTop(this);\n    });\n  });\n\n  // Style category\n  styleCategoryHover(d3.select(bandElement.parentNode));\n}\n\n/**\n * Perform hover styling for all paths that pass though the category of the specified band element and share the\n * same color\n *\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction styleForColorHovermode(bandElement) {\n  var bandViewModel = d3.select(bandElement).datum();\n  var catPaths = selectPathsThroughCategoryBandColor(bandViewModel);\n  stylePathsHover(catPaths);\n  catPaths.each(function () {\n    // Raise path to top\n    Lib.raiseToTop(this);\n  });\n\n  // Style category for drag\n  d3.select(bandElement.parentNode).selectAll('rect.bandrect').filter(function (b) {\n    return b.color === bandViewModel.color;\n  }).each(function () {\n    Lib.raiseToTop(this);\n    styleBandsHover(d3.select(this));\n  });\n}\n\n/**\n * @param {HTMLElement} bandElement\n *  HTML element for band\n * @param eventName\n *  Event name (plotly_hover or plotly_click)\n * @param event\n *  Mouse Event\n */\nfunction emitPointsEventCategoryHovermode(bandElement, eventName, event) {\n  // Get all bands in the current category\n  var bandViewModel = d3.select(bandElement).datum();\n  var categoryModel = bandViewModel.categoryViewModel.model;\n  var gd = bandViewModel.parcatsViewModel.graphDiv;\n  var bandSel = d3.select(bandElement.parentNode).selectAll('rect.bandrect');\n  var points = [];\n  bandSel.each(function (bvm) {\n    var paths = selectPathsThroughCategoryBandColor(bvm);\n    paths.each(function (pathViewModel) {\n      // Extend points array\n      Array.prototype.push.apply(points, buildPointsArrayForPath(pathViewModel));\n    });\n  });\n  var constraints = {};\n  constraints[categoryModel.dimensionInd] = categoryModel.categoryValue;\n  gd.emit(eventName, {\n    points: points,\n    event: event,\n    constraints: constraints\n  });\n}\n\n/**\n * @param {HTMLElement} bandElement\n *  HTML element for band\n * @param eventName\n *  Event name (plotly_hover or plotly_click)\n * @param event\n *  Mouse Event\n */\nfunction emitPointsEventColorHovermode(bandElement, eventName, event) {\n  var bandViewModel = d3.select(bandElement).datum();\n  var categoryModel = bandViewModel.categoryViewModel.model;\n  var gd = bandViewModel.parcatsViewModel.graphDiv;\n  var paths = selectPathsThroughCategoryBandColor(bandViewModel);\n  var points = [];\n  paths.each(function (pathViewModel) {\n    // Extend points array\n    Array.prototype.push.apply(points, buildPointsArrayForPath(pathViewModel));\n  });\n  var constraints = {};\n  constraints[categoryModel.dimensionInd] = categoryModel.categoryValue;\n  // color\n  if (bandViewModel.rawColor !== undefined) {\n    constraints.color = bandViewModel.rawColor;\n  }\n  gd.emit(eventName, {\n    points: points,\n    event: event,\n    constraints: constraints\n  });\n}\n\n/**\n * Create hover label for a band element's category (for use when hoveron === 'category')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForCategoryHovermode(gd, rootBBox, bandElement) {\n  gd._fullLayout._calcInverseTransform(gd);\n  var scaleX = gd._fullLayout._invScaleX;\n  var scaleY = gd._fullLayout._invScaleY;\n\n  // Selections\n  var rectSelection = d3.select(bandElement.parentNode).select('rect.catrect');\n  var rectBoundingBox = rectSelection.node().getBoundingClientRect();\n\n  // Models\n  /** @type {CategoryViewModel} */\n  var catViewModel = rectSelection.datum();\n  var parcatsViewModel = catViewModel.parcatsViewModel;\n  var dimensionModel = parcatsViewModel.model.dimensions[catViewModel.model.dimensionInd];\n  var trace = parcatsViewModel.trace;\n\n  // Positions\n  var hoverCenterY = rectBoundingBox.top + rectBoundingBox.height / 2;\n  var hoverCenterX, hoverLabelIdealAlign;\n  if (parcatsViewModel.dimensions.length > 1 && dimensionModel.displayInd === parcatsViewModel.dimensions.length - 1) {\n    // right most dimension\n    hoverCenterX = rectBoundingBox.left;\n    hoverLabelIdealAlign = 'left';\n  } else {\n    hoverCenterX = rectBoundingBox.left + rectBoundingBox.width;\n    hoverLabelIdealAlign = 'right';\n  }\n  var count = catViewModel.model.count;\n  var catLabel = catViewModel.model.categoryLabel;\n  var prob = count / catViewModel.parcatsViewModel.model.count;\n  var labels = {\n    countLabel: count,\n    categoryLabel: catLabel,\n    probabilityLabel: prob.toFixed(3)\n  };\n\n  // Hover label text\n  var hoverinfoParts = [];\n  if (catViewModel.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n    hoverinfoParts.push(['Count:', labels.countLabel].join(' '));\n  }\n  if (catViewModel.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n    hoverinfoParts.push(['P(' + labels.categoryLabel + '):', labels.probabilityLabel].join(' '));\n  }\n  var hovertext = hoverinfoParts.join('<br>');\n  return {\n    trace: trace,\n    x: scaleX * (hoverCenterX - rootBBox.left),\n    y: scaleY * (hoverCenterY - rootBBox.top),\n    text: hovertext,\n    color: 'lightgray',\n    borderColor: 'black',\n    fontFamily: 'Monaco, \"Courier New\", monospace',\n    fontSize: 12,\n    fontColor: 'black',\n    idealAlign: hoverLabelIdealAlign,\n    hovertemplate: trace.hovertemplate,\n    hovertemplateLabels: labels,\n    eventData: [{\n      data: trace._input,\n      fullData: trace,\n      count: count,\n      category: catLabel,\n      probability: prob\n    }]\n  };\n}\n\n/**\n * Create hover label for a band element's category (for use when hoveron === 'category')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForDimensionHovermode(gd, rootBBox, bandElement) {\n  var allHoverlabels = [];\n  d3.select(bandElement.parentNode.parentNode).selectAll('g.category').select('rect.catrect').each(function () {\n    var bandNode = this;\n    allHoverlabels.push(createHoverLabelForCategoryHovermode(gd, rootBBox, bandNode));\n  });\n  return allHoverlabels;\n}\n\n/**\n * Create hover labels for a band element's category (for use when hoveron === 'dimension')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForColorHovermode(gd, rootBBox, bandElement) {\n  gd._fullLayout._calcInverseTransform(gd);\n  var scaleX = gd._fullLayout._invScaleX;\n  var scaleY = gd._fullLayout._invScaleY;\n  var bandBoundingBox = bandElement.getBoundingClientRect();\n\n  // Models\n  /** @type {CategoryBandViewModel} */\n  var bandViewModel = d3.select(bandElement).datum();\n  var catViewModel = bandViewModel.categoryViewModel;\n  var parcatsViewModel = catViewModel.parcatsViewModel;\n  var dimensionModel = parcatsViewModel.model.dimensions[catViewModel.model.dimensionInd];\n  var trace = parcatsViewModel.trace;\n\n  // positions\n  var hoverCenterY = bandBoundingBox.y + bandBoundingBox.height / 2;\n  var hoverCenterX, hoverLabelIdealAlign;\n  if (parcatsViewModel.dimensions.length > 1 && dimensionModel.displayInd === parcatsViewModel.dimensions.length - 1) {\n    // right most dimension\n    hoverCenterX = bandBoundingBox.left;\n    hoverLabelIdealAlign = 'left';\n  } else {\n    hoverCenterX = bandBoundingBox.left + bandBoundingBox.width;\n    hoverLabelIdealAlign = 'right';\n  }\n\n  // Labels\n  var catLabel = catViewModel.model.categoryLabel;\n\n  // Counts\n  var totalCount = bandViewModel.parcatsViewModel.model.count;\n  var bandColorCount = 0;\n  bandViewModel.categoryViewModel.bands.forEach(function (b) {\n    if (b.color === bandViewModel.color) {\n      bandColorCount += b.count;\n    }\n  });\n  var catCount = catViewModel.model.count;\n  var colorCount = 0;\n  parcatsViewModel.pathSelection.each(/** @param {PathViewModel} pathViewModel */\n  function (pathViewModel) {\n    if (pathViewModel.model.color === bandViewModel.color) {\n      colorCount += pathViewModel.model.count;\n    }\n  });\n  var pColorAndCat = bandColorCount / totalCount;\n  var pCatGivenColor = bandColorCount / colorCount;\n  var pColorGivenCat = bandColorCount / catCount;\n  var labels = {\n    countLabel: bandColorCount,\n    categoryLabel: catLabel,\n    probabilityLabel: pColorAndCat.toFixed(3)\n  };\n\n  // Hover label text\n  var hoverinfoParts = [];\n  if (catViewModel.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n    hoverinfoParts.push(['Count:', labels.countLabel].join(' '));\n  }\n  if (catViewModel.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n    hoverinfoParts.push('P(color ∩ ' + catLabel + '): ' + labels.probabilityLabel);\n    hoverinfoParts.push('P(' + catLabel + ' | color): ' + pCatGivenColor.toFixed(3));\n    hoverinfoParts.push('P(color | ' + catLabel + '): ' + pColorGivenCat.toFixed(3));\n  }\n  var hovertext = hoverinfoParts.join('<br>');\n\n  // Compute text color\n  var textColor = tinycolor.mostReadable(bandViewModel.color, ['black', 'white']);\n  return {\n    trace: trace,\n    x: scaleX * (hoverCenterX - rootBBox.left),\n    y: scaleY * (hoverCenterY - rootBBox.top),\n    // name: 'NAME',\n    text: hovertext,\n    color: bandViewModel.color,\n    borderColor: 'black',\n    fontFamily: 'Monaco, \"Courier New\", monospace',\n    fontColor: textColor,\n    fontSize: 10,\n    idealAlign: hoverLabelIdealAlign,\n    hovertemplate: trace.hovertemplate,\n    hovertemplateLabels: labels,\n    eventData: [{\n      data: trace._input,\n      fullData: trace,\n      category: catLabel,\n      count: totalCount,\n      probability: pColorAndCat,\n      categorycount: catCount,\n      colorcount: colorCount,\n      bandcolorcount: bandColorCount\n    }]\n  };\n}\n\n/**\n * Handle dimension mouseover\n * @param {CategoryBandViewModel} bandViewModel\n */\nfunction mouseoverCategoryBand(bandViewModel) {\n  if (!bandViewModel.parcatsViewModel.dragDimension) {\n    // We're not currently dragging\n\n    if (bandViewModel.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n      // hoverinfo is not skip, so we at least style the bands and emit interaction events\n\n      // Mouse\n      var mouseY = d3.mouse(this)[1];\n      if (mouseY < -1) {\n        // Hover is above above the category rectangle (probably the dimension title text)\n        return;\n      }\n      var gd = bandViewModel.parcatsViewModel.graphDiv;\n      var fullLayout = gd._fullLayout;\n      var rootBBox = fullLayout._paperdiv.node().getBoundingClientRect();\n      var hoveron = bandViewModel.parcatsViewModel.hoveron;\n\n      /** @type {HTMLElement} */\n      var bandElement = this;\n\n      // Handle style and events\n      if (hoveron === 'color') {\n        styleForColorHovermode(bandElement);\n        emitPointsEventColorHovermode(bandElement, 'plotly_hover', d3.event);\n      } else {\n        styleForCategoryHovermode(bandElement);\n        emitPointsEventCategoryHovermode(bandElement, 'plotly_hover', d3.event);\n      }\n\n      // Handle hover label\n      if (bandViewModel.parcatsViewModel.hoverinfoItems.indexOf('none') === -1) {\n        var hoverItems;\n        if (hoveron === 'category') {\n          hoverItems = createHoverLabelForCategoryHovermode(gd, rootBBox, bandElement);\n        } else if (hoveron === 'color') {\n          hoverItems = createHoverLabelForColorHovermode(gd, rootBBox, bandElement);\n        } else if (hoveron === 'dimension') {\n          hoverItems = createHoverLabelForDimensionHovermode(gd, rootBBox, bandElement);\n        }\n        if (hoverItems) {\n          Fx.loneHover(hoverItems, {\n            container: fullLayout._hoverlayer.node(),\n            outerContainer: fullLayout._paper.node(),\n            gd: gd\n          });\n        }\n      }\n    }\n  }\n}\n\n/**\n * Handle dimension mouseover\n * @param {CategoryBandViewModel} bandViewModel\n */\nfunction mouseoutCategory(bandViewModel) {\n  var parcatsViewModel = bandViewModel.parcatsViewModel;\n  if (!parcatsViewModel.dragDimension) {\n    // We're not dragging anything\n\n    // Reset unhovered styles\n    stylePathsNoHover(parcatsViewModel.pathSelection);\n    styleCategoriesNoHover(parcatsViewModel.dimensionSelection.selectAll('g.category'));\n    styleBandsNoHover(parcatsViewModel.dimensionSelection.selectAll('g.category').selectAll('rect.bandrect'));\n\n    // Remove hover label\n    Fx.loneUnhover(parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n\n    // Restore path order\n    parcatsViewModel.pathSelection.sort(compareRawColor);\n\n    // Emit unhover event\n    if (parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n      var hoveron = bandViewModel.parcatsViewModel.hoveron;\n      var bandElement = this;\n\n      // Handle style and events\n      if (hoveron === 'color') {\n        emitPointsEventColorHovermode(bandElement, 'plotly_unhover', d3.event);\n      } else {\n        emitPointsEventCategoryHovermode(bandElement, 'plotly_unhover', d3.event);\n      }\n    }\n  }\n}\n\n/**\n * Handle dimension drag start\n * @param {DimensionViewModel} d\n */\nfunction dragDimensionStart(d) {\n  // Check if dragging is supported\n  if (d.parcatsViewModel.arrangement === 'fixed') {\n    return;\n  }\n\n  // Save off initial drag indexes for dimension\n  d.dragDimensionDisplayInd = d.model.displayInd;\n  d.initialDragDimensionDisplayInds = d.parcatsViewModel.model.dimensions.map(function (d) {\n    return d.displayInd;\n  });\n  d.dragHasMoved = false;\n\n  // Check for category hit\n  d.dragCategoryDisplayInd = null;\n  d3.select(this).selectAll('g.category').select('rect.catrect').each(/** @param {CategoryViewModel} catViewModel */\n  function (catViewModel) {\n    var catMouseX = d3.mouse(this)[0];\n    var catMouseY = d3.mouse(this)[1];\n    if (-2 <= catMouseX && catMouseX <= catViewModel.width + 2 && -2 <= catMouseY && catMouseY <= catViewModel.height + 2) {\n      // Save off initial drag indexes for categories\n      d.dragCategoryDisplayInd = catViewModel.model.displayInd;\n      d.initialDragCategoryDisplayInds = d.model.categories.map(function (c) {\n        return c.displayInd;\n      });\n\n      // Initialize categories dragY to be the current y position\n      catViewModel.model.dragY = catViewModel.y;\n\n      // Raise category\n      Lib.raiseToTop(this.parentNode);\n\n      // Get band element\n      d3.select(this.parentNode).selectAll('rect.bandrect')\n      /** @param {CategoryBandViewModel} bandViewModel */.each(function (bandViewModel) {\n        if (bandViewModel.y < catMouseY && catMouseY <= bandViewModel.y + bandViewModel.height) {\n          d.potentialClickBand = this;\n        }\n      });\n    }\n  });\n\n  // Update toplevel drag dimension\n  d.parcatsViewModel.dragDimension = d;\n\n  // Remove hover label if any\n  Fx.loneUnhover(d.parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n}\n\n/**\n * Handle dimension drag\n * @param {DimensionViewModel} d\n */\nfunction dragDimension(d) {\n  // Check if dragging is supported\n  if (d.parcatsViewModel.arrangement === 'fixed') {\n    return;\n  }\n  d.dragHasMoved = true;\n  if (d.dragDimensionDisplayInd === null) {\n    return;\n  }\n  var dragDimInd = d.dragDimensionDisplayInd;\n  var prevDimInd = dragDimInd - 1;\n  var nextDimInd = dragDimInd + 1;\n  var dragDimension = d.parcatsViewModel.dimensions[dragDimInd];\n\n  // Update category\n  if (d.dragCategoryDisplayInd !== null) {\n    var dragCategory = dragDimension.categories[d.dragCategoryDisplayInd];\n\n    // Update dragY by dy\n    dragCategory.model.dragY += d3.event.dy;\n    var categoryY = dragCategory.model.dragY;\n\n    // Check for category drag swaps\n    var catDisplayInd = dragCategory.model.displayInd;\n    var dimCategoryViews = dragDimension.categories;\n    var catAbove = dimCategoryViews[catDisplayInd - 1];\n    var catBelow = dimCategoryViews[catDisplayInd + 1];\n\n    // Check for overlap above\n    if (catAbove !== undefined) {\n      if (categoryY < catAbove.y + catAbove.height / 2.0) {\n        // Swap display inds\n        dragCategory.model.displayInd = catAbove.model.displayInd;\n        catAbove.model.displayInd = catDisplayInd;\n      }\n    }\n    if (catBelow !== undefined) {\n      if (categoryY + dragCategory.height > catBelow.y + catBelow.height / 2.0) {\n        // Swap display inds\n        dragCategory.model.displayInd = catBelow.model.displayInd;\n        catBelow.model.displayInd = catDisplayInd;\n      }\n    }\n\n    // Update category drag display index\n    d.dragCategoryDisplayInd = dragCategory.model.displayInd;\n  }\n\n  // Update dimension position\n  if (d.dragCategoryDisplayInd === null || d.parcatsViewModel.arrangement === 'freeform') {\n    dragDimension.model.dragX = d3.event.x;\n\n    // Check for dimension swaps\n    var prevDimension = d.parcatsViewModel.dimensions[prevDimInd];\n    var nextDimension = d.parcatsViewModel.dimensions[nextDimInd];\n    if (prevDimension !== undefined) {\n      if (dragDimension.model.dragX < prevDimension.x + prevDimension.width) {\n        // Swap display inds\n        dragDimension.model.displayInd = prevDimension.model.displayInd;\n        prevDimension.model.displayInd = dragDimInd;\n      }\n    }\n    if (nextDimension !== undefined) {\n      if (dragDimension.model.dragX + dragDimension.width > nextDimension.x) {\n        // Swap display inds\n        dragDimension.model.displayInd = nextDimension.model.displayInd;\n        nextDimension.model.displayInd = d.dragDimensionDisplayInd;\n      }\n    }\n\n    // Update drag display index\n    d.dragDimensionDisplayInd = dragDimension.model.displayInd;\n  }\n\n  // Update view models\n  updateDimensionViewModels(d.parcatsViewModel);\n  updatePathViewModels(d.parcatsViewModel);\n\n  // Update svg geometry\n  updateSvgCategories(d.parcatsViewModel);\n  updateSvgPaths(d.parcatsViewModel);\n}\n\n/**\n * Handle dimension drag end\n * @param {DimensionViewModel} d\n */\nfunction dragDimensionEnd(d) {\n  // Check if dragging is supported\n  if (d.parcatsViewModel.arrangement === 'fixed') {\n    return;\n  }\n  if (d.dragDimensionDisplayInd === null) {\n    return;\n  }\n  d3.select(this).selectAll('text').attr('font-weight', 'normal');\n\n  // Compute restyle command\n  // -----------------------\n  var restyleData = {};\n  var traceInd = getTraceIndex(d.parcatsViewModel);\n\n  // ### Handle dimension reordering ###\n  var finalDragDimensionDisplayInds = d.parcatsViewModel.model.dimensions.map(function (d) {\n    return d.displayInd;\n  });\n  var anyDimsReordered = d.initialDragDimensionDisplayInds.some(function (initDimDisplay, dimInd) {\n    return initDimDisplay !== finalDragDimensionDisplayInds[dimInd];\n  });\n  if (anyDimsReordered) {\n    finalDragDimensionDisplayInds.forEach(function (finalDimDisplay, dimInd) {\n      var containerInd = d.parcatsViewModel.model.dimensions[dimInd].containerInd;\n      restyleData['dimensions[' + containerInd + '].displayindex'] = finalDimDisplay;\n    });\n  }\n\n  // ### Handle category reordering ###\n  var anyCatsReordered = false;\n  if (d.dragCategoryDisplayInd !== null) {\n    var finalDragCategoryDisplayInds = d.model.categories.map(function (c) {\n      return c.displayInd;\n    });\n    anyCatsReordered = d.initialDragCategoryDisplayInds.some(function (initCatDisplay, catInd) {\n      return initCatDisplay !== finalDragCategoryDisplayInds[catInd];\n    });\n    if (anyCatsReordered) {\n      // Sort a shallow copy of the category models by display index\n      var sortedCategoryModels = d.model.categories.slice().sort(function (a, b) {\n        return a.displayInd - b.displayInd;\n      });\n\n      // Get new categoryarray and ticktext values\n      var newCategoryArray = sortedCategoryModels.map(function (v) {\n        return v.categoryValue;\n      });\n      var newCategoryLabels = sortedCategoryModels.map(function (v) {\n        return v.categoryLabel;\n      });\n      restyleData['dimensions[' + d.model.containerInd + '].categoryarray'] = [newCategoryArray];\n      restyleData['dimensions[' + d.model.containerInd + '].ticktext'] = [newCategoryLabels];\n      restyleData['dimensions[' + d.model.containerInd + '].categoryorder'] = 'array';\n    }\n  }\n\n  // Handle potential click event\n  // ----------------------------\n  if (d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n    if (!d.dragHasMoved && d.potentialClickBand) {\n      if (d.parcatsViewModel.hoveron === 'color') {\n        emitPointsEventColorHovermode(d.potentialClickBand, 'plotly_click', d3.event.sourceEvent);\n      } else {\n        emitPointsEventCategoryHovermode(d.potentialClickBand, 'plotly_click', d3.event.sourceEvent);\n      }\n    }\n  }\n\n  // Nullify drag states\n  // -------------------\n  d.model.dragX = null;\n  if (d.dragCategoryDisplayInd !== null) {\n    var dragCategory = d.parcatsViewModel.dimensions[d.dragDimensionDisplayInd].categories[d.dragCategoryDisplayInd];\n    dragCategory.model.dragY = null;\n    d.dragCategoryDisplayInd = null;\n  }\n  d.dragDimensionDisplayInd = null;\n  d.parcatsViewModel.dragDimension = null;\n  d.dragHasMoved = null;\n  d.potentialClickBand = null;\n\n  // Update view models\n  // ------------------\n  updateDimensionViewModels(d.parcatsViewModel);\n  updatePathViewModels(d.parcatsViewModel);\n\n  // Perform transition\n  // ------------------\n  var transition = d3.transition().duration(300).ease('cubic-in-out');\n  transition.each(function () {\n    updateSvgCategories(d.parcatsViewModel, true);\n    updateSvgPaths(d.parcatsViewModel, true);\n  }).each('end', function () {\n    if (anyDimsReordered || anyCatsReordered) {\n      // Perform restyle if the order of categories or dimensions changed\n      Plotly.restyle(d.parcatsViewModel.graphDiv, restyleData, [traceInd]);\n    }\n  });\n}\n\n/**\n *\n * @param {ParcatsViewModel} parcatsViewModel\n */\nfunction getTraceIndex(parcatsViewModel) {\n  var traceInd;\n  var allTraces = parcatsViewModel.graphDiv._fullData;\n  for (var i = 0; i < allTraces.length; i++) {\n    if (parcatsViewModel.key === allTraces[i].uid) {\n      traceInd = i;\n      break;\n    }\n  }\n  return traceInd;\n}\n\n/** Update the svg paths for view model\n * @param {ParcatsViewModel} parcatsViewModel\n * @param {boolean} hasTransition Whether to update element with transition\n */\nfunction updateSvgPaths(parcatsViewModel, hasTransition) {\n  if (hasTransition === undefined) {\n    hasTransition = false;\n  }\n  function transition(selection) {\n    return hasTransition ? selection.transition() : selection;\n  }\n\n  // Update binding\n  parcatsViewModel.pathSelection.data(function (d) {\n    return d.paths;\n  }, key);\n\n  // Update paths\n  transition(parcatsViewModel.pathSelection).attr('d', function (d) {\n    return d.svgD;\n  });\n}\n\n/** Update the svg paths for view model\n * @param {ParcatsViewModel} parcatsViewModel\n * @param {boolean} hasTransition Whether to update element with transition\n */\nfunction updateSvgCategories(parcatsViewModel, hasTransition) {\n  if (hasTransition === undefined) {\n    hasTransition = false;\n  }\n  function transition(selection) {\n    return hasTransition ? selection.transition() : selection;\n  }\n\n  // Update binding\n  parcatsViewModel.dimensionSelection.data(function (d) {\n    return d.dimensions;\n  }, key);\n  var categorySelection = parcatsViewModel.dimensionSelection.selectAll('g.category').data(function (d) {\n    return d.categories;\n  }, key);\n\n  // Update dimension position\n  transition(parcatsViewModel.dimensionSelection).attr('transform', function (d) {\n    return strTranslate(d.x, 0);\n  });\n\n  // Update category position\n  transition(categorySelection).attr('transform', function (d) {\n    return strTranslate(0, d.y);\n  });\n  var dimLabelSelection = categorySelection.select('.dimlabel');\n\n  // ### Update dimension label\n  // Only the top-most display category should have the dimension label\n  dimLabelSelection.text(function (d, i) {\n    if (i === 0) {\n      // Add dimension label above topmost category\n      return d.parcatsViewModel.model.dimensions[d.model.dimensionInd].dimensionLabel;\n    } else {\n      return null;\n    }\n  });\n\n  // Update category label\n  // Categories in the right-most display dimension have their labels on\n  // the right, all others on the left\n  var catLabelSelection = categorySelection.select('.catlabel');\n  catLabelSelection.attr('text-anchor', function (d) {\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      return 'start';\n    } else {\n      // Place label to the left of category\n      return 'end';\n    }\n  }).attr('x', function (d) {\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      return d.width + 5;\n    } else {\n      // Place label to the left of category\n      return -5;\n    }\n  }).each(function (d) {\n    // Update attriubutes of <tspan> elements\n    var newX;\n    var newAnchor;\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      newX = d.width + 5;\n      newAnchor = 'start';\n    } else {\n      // Place label to the left of category\n      newX = -5;\n      newAnchor = 'end';\n    }\n    d3.select(this).selectAll('tspan').attr('x', newX).attr('text-anchor', newAnchor);\n  });\n\n  // Update bands\n  // Initialize color band rects\n  var bandSelection = categorySelection.selectAll('rect.bandrect').data(/** @param {CategoryViewModel} catViewModel*/\n  function (catViewModel) {\n    return catViewModel.bands;\n  }, key);\n  var bandsSelectionEnter = bandSelection.enter().append('rect').attr('class', 'bandrect').attr('cursor', 'move').attr('stroke-opacity', 0).attr('fill', function (d) {\n    return d.color;\n  }).attr('fill-opacity', 0);\n  bandSelection.attr('fill', function (d) {\n    return d.color;\n  }).attr('width', function (d) {\n    return d.width;\n  }).attr('height', function (d) {\n    return d.height;\n  }).attr('y', function (d) {\n    return d.y;\n  });\n  styleBandsNoHover(bandsSelectionEnter);\n\n  // Raise bands to the top\n  bandSelection.each(function () {\n    Lib.raiseToTop(this);\n  });\n\n  // Remove unused bands\n  bandSelection.exit().remove();\n}\n\n/**\n * Create a ParcatsViewModel traces\n * @param {Object} graphDiv\n *  Top-level graph div element\n * @param {Layout} layout\n *  SVG layout object\n * @param {Array.<ParcatsModel>} wrappedParcatsModel\n *  Wrapped ParcatsModel for this trace\n * @return {ParcatsViewModel}\n */\nfunction createParcatsViewModel(graphDiv, layout, wrappedParcatsModel) {\n  // Unwrap model\n  var parcatsModel = wrappedParcatsModel[0];\n\n  // Compute margin\n  var margin = layout.margin || {\n    l: 80,\n    r: 80,\n    t: 100,\n    b: 80\n  };\n\n  // Compute pixel position/extents\n  var trace = parcatsModel.trace;\n  var domain = trace.domain;\n  var figureWidth = layout.width;\n  var figureHeight = layout.height;\n  var traceWidth = Math.floor(figureWidth * (domain.x[1] - domain.x[0]));\n  var traceHeight = Math.floor(figureHeight * (domain.y[1] - domain.y[0]));\n  var traceX = domain.x[0] * figureWidth + margin.l;\n  var traceY = layout.height - domain.y[1] * layout.height + margin.t;\n\n  // Handle path shape\n  // -----------------\n  var pathShape = trace.line.shape;\n\n  // Handle hover info\n  // -----------------\n  var hoverinfoItems;\n  if (trace.hoverinfo === 'all') {\n    hoverinfoItems = ['count', 'probability'];\n  } else {\n    hoverinfoItems = (trace.hoverinfo || '').split('+');\n  }\n\n  // Construct parcatsViewModel\n  // --------------------------\n  var parcatsViewModel = {\n    trace: trace,\n    key: trace.uid,\n    model: parcatsModel,\n    x: traceX,\n    y: traceY,\n    width: traceWidth,\n    height: traceHeight,\n    hoveron: trace.hoveron,\n    hoverinfoItems: hoverinfoItems,\n    arrangement: trace.arrangement,\n    bundlecolors: trace.bundlecolors,\n    sortpaths: trace.sortpaths,\n    labelfont: trace.labelfont,\n    categorylabelfont: trace.tickfont,\n    pathShape: pathShape,\n    dragDimension: null,\n    margin: margin,\n    paths: [],\n    dimensions: [],\n    graphDiv: graphDiv,\n    traceSelection: null,\n    pathSelection: null,\n    dimensionSelection: null\n  };\n\n  // Update dimension view models if we have at least 1 dimension\n  if (parcatsModel.dimensions) {\n    updateDimensionViewModels(parcatsViewModel);\n\n    // Update path view models if we have at least 2 dimensions\n    updatePathViewModels(parcatsViewModel);\n  }\n  // Inside a categories view model\n  return parcatsViewModel;\n}\n\n/**\n * Build the SVG string to represents a parallel categories path\n * @param {Array.<Number>} leftXPositions\n *  Array of the x positions of the left edge of each dimension (in display order)\n * @param {Array.<Number>} pathYs\n *  Array of the y positions of the top of the path at each dimension (in display order)\n * @param {Array.<Number>} dimWidths\n *  Array of the widths of each dimension in display order\n * @param {Number} pathHeight\n *  The height of the path in pixels\n * @param {Number} curvature\n *  The curvature factor for the path. 0 results in a straight line and values greater than zero result in curved paths\n * @return {string}\n */\nfunction buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, curvature) {\n  // Compute the x midpoint of each path segment\n  var xRefPoints1 = [];\n  var xRefPoints2 = [];\n  var refInterpolator;\n  var d;\n  for (d = 0; d < dimWidths.length - 1; d++) {\n    refInterpolator = interpolateNumber(dimWidths[d] + leftXPositions[d], leftXPositions[d + 1]);\n    xRefPoints1.push(refInterpolator(curvature));\n    xRefPoints2.push(refInterpolator(1 - curvature));\n  }\n\n  // Move to top of path on left edge of left-most category\n  var svgD = 'M ' + leftXPositions[0] + ',' + pathYs[0];\n\n  // Horizontal line to right edge\n  svgD += 'l' + dimWidths[0] + ',0 ';\n\n  // Horizontal line to right edge\n  for (d = 1; d < dimWidths.length; d++) {\n    // Curve to left edge of category\n    svgD += 'C' + xRefPoints1[d - 1] + ',' + pathYs[d - 1] + ' ' + xRefPoints2[d - 1] + ',' + pathYs[d] + ' ' + leftXPositions[d] + ',' + pathYs[d];\n\n    // svgD += 'L' + leftXPositions[d] + ',' + pathYs[d];\n\n    // Horizontal line to right edge\n    svgD += 'l' + dimWidths[d] + ',0 ';\n  }\n\n  // Line down\n  svgD += 'l' + '0,' + pathHeight + ' ';\n\n  // Line to left edge of right-most category\n  svgD += 'l -' + dimWidths[dimWidths.length - 1] + ',0 ';\n  for (d = dimWidths.length - 2; d >= 0; d--) {\n    // Curve to right edge of category\n    svgD += 'C' + xRefPoints2[d] + ',' + (pathYs[d + 1] + pathHeight) + ' ' + xRefPoints1[d] + ',' + (pathYs[d] + pathHeight) + ' ' + (leftXPositions[d] + dimWidths[d]) + ',' + (pathYs[d] + pathHeight);\n\n    // svgD += 'L' + (leftXPositions[d] + dimWidths[d]) + ',' + (pathYs[d] + pathHeight);\n\n    // Horizontal line to right edge\n    svgD += 'l-' + dimWidths[d] + ',0 ';\n  }\n\n  // Close path\n  svgD += 'Z';\n  return svgD;\n}\n\n/**\n * Update the path view models based on the dimension view models in a ParcatsViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n */\nfunction updatePathViewModels(parcatsViewModel) {\n  // Initialize an array of the y position of the top of the next path to be added to each category.\n  //\n  // nextYPositions[d][c] is the y position of the next path through category with index c of dimension with index d\n  var dimensionViewModels = parcatsViewModel.dimensions;\n  var parcatsModel = parcatsViewModel.model;\n  var nextYPositions = dimensionViewModels.map(function (d) {\n    return d.categories.map(function (c) {\n      return c.y;\n    });\n  });\n\n  // Array from category index to category display index for each true dimension index\n  var catToDisplayIndPerDim = parcatsViewModel.model.dimensions.map(function (d) {\n    return d.categories.map(function (c) {\n      return c.displayInd;\n    });\n  });\n\n  // Array from true dimension index to dimension display index\n  var dimToDisplayInd = parcatsViewModel.model.dimensions.map(function (d) {\n    return d.displayInd;\n  });\n  var displayToDimInd = parcatsViewModel.dimensions.map(function (d) {\n    return d.model.dimensionInd;\n  });\n\n  // Array of the x position of the left edge of the rectangles for each dimension\n  var leftXPositions = dimensionViewModels.map(function (d) {\n    return d.x;\n  });\n\n  // Compute dimension widths\n  var dimWidths = dimensionViewModels.map(function (d) {\n    return d.width;\n  });\n\n  // Build sorted Array of PathModel objects\n  var pathModels = [];\n  for (var p in parcatsModel.paths) {\n    if (parcatsModel.paths.hasOwnProperty(p)) {\n      pathModels.push(parcatsModel.paths[p]);\n    }\n  }\n\n  // Compute category display inds to use for sorting paths\n  function pathDisplayCategoryInds(pathModel) {\n    var dimensionInds = pathModel.categoryInds.map(function (catInd, dimInd) {\n      return catToDisplayIndPerDim[dimInd][catInd];\n    });\n    var displayInds = displayToDimInd.map(function (dimInd) {\n      return dimensionInds[dimInd];\n    });\n    return displayInds;\n  }\n\n  // Sort in ascending order by display index array\n  pathModels.sort(function (v1, v2) {\n    // Build display inds for each path\n    var sortArray1 = pathDisplayCategoryInds(v1);\n    var sortArray2 = pathDisplayCategoryInds(v2);\n\n    // Handle path sort order\n    if (parcatsViewModel.sortpaths === 'backward') {\n      sortArray1.reverse();\n      sortArray2.reverse();\n    }\n\n    // Append the first value index of the path to break ties\n    sortArray1.push(v1.valueInds[0]);\n    sortArray2.push(v2.valueInds[0]);\n\n    // Handle color bundling\n    if (parcatsViewModel.bundlecolors) {\n      // Prepend sort array with the raw color value\n      sortArray1.unshift(v1.rawColor);\n      sortArray2.unshift(v2.rawColor);\n    }\n\n    // colors equal, sort by display categories\n    if (sortArray1 < sortArray2) {\n      return -1;\n    }\n    if (sortArray1 > sortArray2) {\n      return 1;\n    }\n    return 0;\n  });\n\n  // Create path models\n  var pathViewModels = new Array(pathModels.length);\n  var totalCount = dimensionViewModels[0].model.count;\n  var totalHeight = dimensionViewModels[0].categories.map(function (c) {\n    return c.height;\n  }).reduce(function (v1, v2) {\n    return v1 + v2;\n  });\n  for (var pathNumber = 0; pathNumber < pathModels.length; pathNumber++) {\n    var pathModel = pathModels[pathNumber];\n    var pathHeight;\n    if (totalCount > 0) {\n      pathHeight = totalHeight * (pathModel.count / totalCount);\n    } else {\n      pathHeight = 0;\n    }\n\n    // Build path y coords\n    var pathYs = new Array(nextYPositions.length);\n    for (var d = 0; d < pathModel.categoryInds.length; d++) {\n      var catInd = pathModel.categoryInds[d];\n      var catDisplayInd = catToDisplayIndPerDim[d][catInd];\n      var dimDisplayInd = dimToDisplayInd[d];\n\n      // Update next y position\n      pathYs[dimDisplayInd] = nextYPositions[dimDisplayInd][catDisplayInd];\n      nextYPositions[dimDisplayInd][catDisplayInd] += pathHeight;\n\n      // Update category color information\n      var catViewModle = parcatsViewModel.dimensions[dimDisplayInd].categories[catDisplayInd];\n      var numBands = catViewModle.bands.length;\n      var lastCatBand = catViewModle.bands[numBands - 1];\n      if (lastCatBand === undefined || pathModel.rawColor !== lastCatBand.rawColor) {\n        // Create a new band\n        var bandY = lastCatBand === undefined ? 0 : lastCatBand.y + lastCatBand.height;\n        catViewModle.bands.push({\n          key: bandY,\n          color: pathModel.color,\n          rawColor: pathModel.rawColor,\n          height: pathHeight,\n          width: catViewModle.width,\n          count: pathModel.count,\n          y: bandY,\n          categoryViewModel: catViewModle,\n          parcatsViewModel: parcatsViewModel\n        });\n      } else {\n        // Extend current band\n        var currentBand = catViewModle.bands[numBands - 1];\n        currentBand.height += pathHeight;\n        currentBand.count += pathModel.count;\n      }\n    }\n\n    // build svg path\n    var svgD;\n    if (parcatsViewModel.pathShape === 'hspline') {\n      svgD = buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, 0.5);\n    } else {\n      svgD = buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, 0);\n    }\n    pathViewModels[pathNumber] = {\n      key: pathModel.valueInds[0],\n      model: pathModel,\n      height: pathHeight,\n      leftXs: leftXPositions,\n      topYs: pathYs,\n      dimWidths: dimWidths,\n      svgD: svgD,\n      parcatsViewModel: parcatsViewModel\n    };\n  }\n  parcatsViewModel.paths = pathViewModels;\n\n  // * @property key\n  // *  Unique key for this model\n  // * @property {PathModel} model\n  // *  Source path model\n  // * @property {Number} height\n  // *  Height of this path (pixels)\n  // * @property {String} svgD\n  // *  SVG path \"d\" attribute string\n}\n\n/**\n * Update the dimension view models based on the dimension models in a ParcatsViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n */\nfunction updateDimensionViewModels(parcatsViewModel) {\n  // Compute dimension ordering\n  var dimensionsIndInfo = parcatsViewModel.model.dimensions.map(function (d) {\n    return {\n      displayInd: d.displayInd,\n      dimensionInd: d.dimensionInd\n    };\n  });\n  dimensionsIndInfo.sort(function (a, b) {\n    return a.displayInd - b.displayInd;\n  });\n  var dimensions = [];\n  for (var displayInd in dimensionsIndInfo) {\n    var dimensionInd = dimensionsIndInfo[displayInd].dimensionInd;\n    var dimModel = parcatsViewModel.model.dimensions[dimensionInd];\n    dimensions.push(createDimensionViewModel(parcatsViewModel, dimModel));\n  }\n  parcatsViewModel.dimensions = dimensions;\n}\n\n/**\n * Create a parcats DimensionViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n * @param {DimensionModel} dimensionModel\n * @return {DimensionViewModel}\n */\nfunction createDimensionViewModel(parcatsViewModel, dimensionModel) {\n  // Compute dimension x position\n  var categoryLabelPad = 40;\n  var dimWidth = 16;\n  var numDimensions = parcatsViewModel.model.dimensions.length;\n  var displayInd = dimensionModel.displayInd;\n\n  // Compute x coordinate values\n  var dimDx;\n  var dimX0;\n  var dimX;\n  if (numDimensions > 1) {\n    dimDx = (parcatsViewModel.width - 2 * categoryLabelPad - dimWidth) / (numDimensions - 1);\n  } else {\n    dimDx = 0;\n  }\n  dimX0 = categoryLabelPad;\n  dimX = dimX0 + dimDx * displayInd;\n\n  // Compute categories\n  var categories = [];\n  var maxCats = parcatsViewModel.model.maxCats;\n  var numCats = dimensionModel.categories.length;\n  var catSpacing = 8;\n  var totalCount = dimensionModel.count;\n  var totalHeight = parcatsViewModel.height - catSpacing * (maxCats - 1);\n  var nextCatHeight;\n  var nextCatModel;\n  var nextCat;\n  var catInd;\n  var catDisplayInd;\n\n  // Compute starting Y offset\n  var nextCatY = (maxCats - numCats) * catSpacing / 2.0;\n\n  // Compute category ordering\n  var categoryIndInfo = dimensionModel.categories.map(function (c) {\n    return {\n      displayInd: c.displayInd,\n      categoryInd: c.categoryInd\n    };\n  });\n  categoryIndInfo.sort(function (a, b) {\n    return a.displayInd - b.displayInd;\n  });\n  for (catDisplayInd = 0; catDisplayInd < numCats; catDisplayInd++) {\n    catInd = categoryIndInfo[catDisplayInd].categoryInd;\n    nextCatModel = dimensionModel.categories[catInd];\n    if (totalCount > 0) {\n      nextCatHeight = nextCatModel.count / totalCount * totalHeight;\n    } else {\n      nextCatHeight = 0;\n    }\n    nextCat = {\n      key: nextCatModel.valueInds[0],\n      model: nextCatModel,\n      width: dimWidth,\n      height: nextCatHeight,\n      y: nextCatModel.dragY !== null ? nextCatModel.dragY : nextCatY,\n      bands: [],\n      parcatsViewModel: parcatsViewModel\n    };\n    nextCatY = nextCatY + nextCatHeight + catSpacing;\n    categories.push(nextCat);\n  }\n  return {\n    key: dimensionModel.dimensionInd,\n    x: dimensionModel.dragX !== null ? dimensionModel.dragX : dimX,\n    y: 0,\n    width: dimWidth,\n    model: dimensionModel,\n    categories: categories,\n    parcatsViewModel: parcatsViewModel,\n    dragCategoryDisplayInd: null,\n    dragDimensionDisplayInd: null,\n    initialDragDimensionDisplayInds: null,\n    initialDragCategoryDisplayInds: null,\n    dragHasMoved: null,\n    potentialClickBand: null\n  };\n}\n\n// JSDoc typedefs\n// ==============\n/**\n * @typedef {Object} Layout\n *  Object containing svg layout information\n *\n * @property {Number} width (pixels)\n *  Usable width for Figure (after margins are removed)\n * @property {Number} height (pixels)\n *  Usable height for Figure (after margins are removed)\n * @property {Margin} margin\n *  Margin around the Figure (pixels)\n */\n\n/**\n * @typedef {Object} Margin\n *  Object containing padding information in pixels\n *\n * @property {Number} t\n *  Top margin\n * @property {Number} r\n *  Right margin\n * @property {Number} b\n *  Bottom margin\n * @property {Number} l\n *  Left margin\n */\n\n/**\n * @typedef {Object} Font\n *  Object containing font information\n *\n * @property {Number} size: Font size\n * @property {String} color: Font color\n * @property {String} family: Font family\n */\n\n/**\n * @typedef {Object} ParcatsViewModel\n *  Object containing calculated parcats view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {ParcatsModel} model\n *  Source parcats model\n * @property {Array.<DimensionViewModel>} dimensions\n *  Array of dimension view models\n * @property {Number} width\n *  Width for this trace (pixels)\n * @property {Number} height\n *  Height for this trace (pixels)\n * @property {Number} x\n *  X position of this trace with respect to the Figure (pixels)\n * @property {Number} y\n *  Y position of this trace with respect to the Figure (pixels)\n * @property {String} hoveron\n *  Hover interaction mode. One of: 'category', 'color', or 'dimension'\n * @property {Array.<String>} hoverinfoItems\n *  Info to display on hover. Array with a combination of 'counts' and/or 'probabilities', or 'none', or 'skip'\n * @property {String} arrangement\n *  Category arrangement. One of: 'perpendicular', 'freeform', or 'fixed'\n * @property {Boolean} bundlecolors\n *  Whether paths should be sorted so that like colors are bundled together as they pass through categories\n * @property {String} sortpaths\n *  If 'forward' then sort paths based on dimensions from left to right. If 'backward' sort based on dimensions\n *  from right to left\n * @property {Font} labelfont\n *  Font for the dimension labels\n * @property {Font} categorylabelfont\n *  Font for the category labels\n * @property {String} pathShape\n *  The shape of the paths. Either 'linear' or 'hspline'.\n * @property {DimensionViewModel|null} dragDimension\n *  Dimension currently being dragged. Null if no drag in progress\n * @property {Margin} margin\n *  Margin around the Figure\n * @property {Object} graphDiv\n *  Top-level graph div element\n * @property {Object} traceSelection\n *  D3 selection of this view models trace group element\n * @property {Object} pathSelection\n *  D3 selection of this view models path elements\n * @property {Object} dimensionSelection\n *  D3 selection of this view models dimension group element\n */\n\n/**\n * @typedef {Object} DimensionViewModel\n *  Object containing calculated parcats dimension view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {DimensionModel} model\n *  Source dimension model\n * @property {Number} x\n *  X position of the center of this dimension with respect to the Figure (pixels)\n * @property {Number} y\n *  Y position of the top of this dimension with respect to the Figure (pixels)\n * @property {Number} width\n *  Width of categories in this dimension (pixels)\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n * @property {Array.<CategoryViewModel>} categories\n *  Dimensions category view models\n * @property {Number|null} dragCategoryDisplayInd\n *  Display index of category currently being dragged. null if no category is being dragged\n * @property {Number|null} dragDimensionDisplayInd\n *  Display index of the dimension being dragged. null if no dimension is being dragged\n * @property {Array.<Number>|null} initialDragDimensionDisplayInds\n *  Dimensions display indexes at the beginning of the current drag. null if no dimension is being dragged\n * @property {Array.<Number>|null} initialDragCategoryDisplayInds\n *  Category display indexes for the at the beginning of the current drag. null if no category is being dragged\n * @property {HTMLElement} potentialClickBand\n *  Band under mouse when current drag began. If no drag movement takes place then a click will be emitted for this\n *  band. Null if not drag in progress.\n * @property {Boolean} dragHasMoved\n *  True if there is an active drag and the drag has moved. If drag doesn't move before being ended then\n *  this may be interpreted as a click. Null if no drag in progress\n */\n\n/**\n * @typedef {Object} CategoryViewModel\n *  Object containing calculated parcats category view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {CategoryModel} model\n *  Source category model\n * @property {Number} width\n *  Width for this category (pixels)\n * @property {Number} height\n *  Height for this category (pixels)\n * @property {Number} y\n *  Y position of this cateogry with respect to the Figure (pixels)\n * @property {Array.<CategoryBandViewModel>} bands\n *  Array of color bands inside the category\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n\n/**\n * @typedef {Object} CategoryBandViewModel\n *  Object containing calculated category band information. A category band is a region inside a category covering\n *  paths of a single color\n *\n * @property key\n *  Unique key for this model\n * @property color\n *  Band color\n * @property rawColor\n *  Raw color value for band\n * @property {Number} width\n *  Band width\n * @property {Number} height\n *  Band height\n * @property {Number} y\n *  Y position of top of the band with respect to the category\n * @property {Number} count\n *  The number of samples represented by the band\n * @property {CategoryViewModel} categoryViewModel\n *  The parent categorie's view model\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n\n/**\n * @typedef {Object} PathViewModel\n *  Object containing calculated parcats path view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {PathModel} model\n *  Source path model\n * @property {Number} height\n *  Height of this path (pixels)\n * @property {Array.<Number>} leftXs\n *  The x position of the left edge of each display dimension\n * @property {Array.<Number>} topYs\n *  The y position of the top of the path for each display dimension\n * @property {Array.<Number>} dimWidths\n *  The width of each display dimension\n * @property {String} svgD\n *  SVG path \"d\" attribute string\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */","map":{"version":3,"names":["d3","require","interpolateNumber","Plotly","Fx","Lib","strTranslate","Drawing","tinycolor","svgTextUtils","performPlot","parcatsModels","graphDiv","layout","svg","isStatic","_context","staticPlot","viewModels","map","createParcatsViewModel","bind","layerSelection","selectAll","data","enter","append","attr","style","traceSelection","key","traceEnter","d","x","y","pathsSelection","select","pathSelection","paths","model","color","pathSelectionEnter","stylePathsNoHover","svgD","empty","sort","compareRawColor","exit","remove","on","mouseoverPath","mouseoutPath","clickPath","dimensionsSelection","dimensionSelection","dimensions","categorySelection","categories","categoryGroupEnterSelection","width","height","styleCategoriesNoHover","bandSelection","catViewModel","bands","each","raiseToTop","bandsSelectionEnter","bandModel","parcatsViewModel","arrangement","styleBandsNoHover","catInRightDim","text","categoryLabel","catModel","font","categorylabelfont","convertToTspans","i","dimensionInd","dimensionLabel","labelfont","mouseoverCategoryBand","mouseoutCategory","call","behavior","drag","origin","dragDimensionStart","dragDimension","dragDimensionEnd","module","exports","numDims","length","leftDimInd","a","b","rawColor","hoverinfoItems","indexOf","stylePathsHover","points","buildPointsArrayForPath","constraints","buildConstraintsForPath","emit","event","hoverX","mouse","gd","trace","fullLayout","_fullLayout","rootBBox","_paperdiv","node","getBoundingClientRect","graphDivBBox","pathCenterX","pathCenterY","dimInd","leftXs","dimWidths","leftDim","rightDim","topYs","hoverCenterX","hoverCenterY","textColor","mostReadable","count","prob","labels","countLabel","probabilityLabel","toFixed","hovertextParts","push","join","hovertext","mouseX","loneHover","left","top","borderColor","fontFamily","fontSize","fontColor","idealAlign","hovertemplate","line","hovertemplateLabels","eventData","_input","fullData","probability","container","_hoverlayer","outerContainer","_paper","loneUnhover","curveNumber","getTraceIndex","valueInds","pointNumber","dimension","category","categoryInds","containerInd","categoryValue","undefined","styleCategoryHover","styleBandsHover","bandsSelection","selectPathsThroughCategoryBandColor","catBandViewModel","allPaths","categoryViewModel","catInd","categoryInd","filter","pathViewModel","styleForCategoryHovermode","bandElement","bandSel","parentNode","bvm","styleForColorHovermode","bandViewModel","datum","catPaths","emitPointsEventCategoryHovermode","eventName","categoryModel","Array","prototype","apply","emitPointsEventColorHovermode","createHoverLabelForCategoryHovermode","_calcInverseTransform","scaleX","_invScaleX","scaleY","_invScaleY","rectSelection","rectBoundingBox","dimensionModel","hoverLabelIdealAlign","displayInd","catLabel","hoverinfoParts","createHoverLabelForDimensionHovermode","allHoverlabels","bandNode","createHoverLabelForColorHovermode","bandBoundingBox","totalCount","bandColorCount","forEach","catCount","colorCount","pColorAndCat","pCatGivenColor","pColorGivenCat","categorycount","colorcount","bandcolorcount","mouseY","hoveron","hoverItems","dragDimensionDisplayInd","initialDragDimensionDisplayInds","dragHasMoved","dragCategoryDisplayInd","catMouseX","catMouseY","initialDragCategoryDisplayInds","c","dragY","potentialClickBand","dragDimInd","prevDimInd","nextDimInd","dragCategory","dy","categoryY","catDisplayInd","dimCategoryViews","catAbove","catBelow","dragX","prevDimension","nextDimension","updateDimensionViewModels","updatePathViewModels","updateSvgCategories","updateSvgPaths","restyleData","traceInd","finalDragDimensionDisplayInds","anyDimsReordered","some","initDimDisplay","finalDimDisplay","anyCatsReordered","finalDragCategoryDisplayInds","initCatDisplay","sortedCategoryModels","slice","newCategoryArray","v","newCategoryLabels","sourceEvent","transition","duration","ease","restyle","allTraces","_fullData","uid","hasTransition","selection","dimLabelSelection","catLabelSelection","newX","newAnchor","wrappedParcatsModel","parcatsModel","margin","l","r","t","domain","figureWidth","figureHeight","traceWidth","Math","floor","traceHeight","traceX","traceY","pathShape","shape","hoverinfo","split","bundlecolors","sortpaths","tickfont","buildSvgPath","leftXPositions","pathYs","pathHeight","curvature","xRefPoints1","xRefPoints2","refInterpolator","dimensionViewModels","nextYPositions","catToDisplayIndPerDim","dimToDisplayInd","displayToDimInd","pathModels","p","hasOwnProperty","pathDisplayCategoryInds","pathModel","dimensionInds","displayInds","v1","v2","sortArray1","sortArray2","reverse","unshift","pathViewModels","totalHeight","reduce","pathNumber","dimDisplayInd","catViewModle","numBands","lastCatBand","bandY","currentBand","dimensionsIndInfo","dimModel","createDimensionViewModel","categoryLabelPad","dimWidth","numDimensions","dimDx","dimX0","dimX","maxCats","numCats","catSpacing","nextCatHeight","nextCatModel","nextCat","nextCatY","categoryIndInfo"],"sources":["E:/tog_workspace/TestFabric_main/TestFabric-main/node_modules/plotly.js/src/traces/parcats/parcats.js"],"sourcesContent":["'use strict';\n\nvar d3 = require('@plotly/d3');\nvar interpolateNumber = require('d3-interpolate').interpolateNumber;\nvar Plotly = require('../../plot_api/plot_api');\nvar Fx = require('../../components/fx');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar Drawing = require('../../components/drawing');\nvar tinycolor = require('tinycolor2');\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nfunction performPlot(parcatsModels, graphDiv, layout, svg) {\n    var isStatic = graphDiv._context.staticPlot;\n\n    var viewModels = parcatsModels.map(createParcatsViewModel.bind(0, graphDiv, layout));\n\n    // Get (potentially empty) parcatslayer selection with bound data to single element array\n    var layerSelection = svg.selectAll('g.parcatslayer').data([null]);\n\n    // Initialize single parcatslayer group if it doesn't exist\n    layerSelection.enter()\n        .append('g')\n        .attr('class', 'parcatslayer')\n        .style('pointer-events', isStatic ? 'none' : 'all');\n\n    // Bind data to children of layerSelection and get reference to traceSelection\n    var traceSelection = layerSelection\n        .selectAll('g.trace.parcats')\n        .data(viewModels, key);\n\n    // Initialize group for each trace/dimensions\n    var traceEnter = traceSelection.enter()\n        .append('g')\n        .attr('class', 'trace parcats');\n\n    // Update properties for each trace\n    traceSelection\n        .attr('transform', function(d) {\n            return strTranslate(d.x, d.y);\n        });\n\n    // Initialize paths group\n    traceEnter\n        .append('g')\n        .attr('class', 'paths');\n\n    // Update paths transform\n    var pathsSelection = traceSelection\n        .select('g.paths');\n\n    // Get paths selection\n    var pathSelection = pathsSelection\n        .selectAll('path.path')\n        .data(function(d) {\n            return d.paths;\n        }, key);\n\n    // Update existing path colors\n    pathSelection\n        .attr('fill', function(d) {\n            return d.model.color;\n        });\n\n    // Create paths\n    var pathSelectionEnter = pathSelection\n        .enter()\n        .append('path')\n        .attr('class', 'path')\n        .attr('stroke-opacity', 0)\n        .attr('fill', function(d) {\n            return d.model.color;\n        })\n        .attr('fill-opacity', 0);\n\n    stylePathsNoHover(pathSelectionEnter);\n\n    // Set path geometry\n    pathSelection\n        .attr('d', function(d) {\n            return d.svgD;\n        });\n\n    // sort paths\n    if(!pathSelectionEnter.empty()) {\n        // Only sort paths if there has been a change.\n        // Otherwise paths are already sorted or a hover operation may be in progress\n        pathSelection.sort(compareRawColor);\n    }\n\n    // Remove any old paths\n    pathSelection.exit().remove();\n\n    // Path hover\n    pathSelection\n        .on('mouseover', mouseoverPath)\n        .on('mouseout', mouseoutPath)\n        .on('click', clickPath);\n\n    // Initialize dimensions group\n    traceEnter.append('g').attr('class', 'dimensions');\n\n    // Update dimensions transform\n    var dimensionsSelection = traceSelection\n        .select('g.dimensions');\n\n    // Get dimension selection\n    var dimensionSelection = dimensionsSelection\n        .selectAll('g.dimension')\n        .data(function(d) {\n            return d.dimensions;\n        }, key);\n\n    // Create dimension groups\n    dimensionSelection.enter()\n        .append('g')\n        .attr('class', 'dimension');\n\n    // Update dimension group transforms\n    dimensionSelection.attr('transform', function(d) {\n        return strTranslate(d.x, 0);\n    });\n\n    // Remove any old dimensions\n    dimensionSelection.exit().remove();\n\n    // Get category selection\n    var categorySelection = dimensionSelection\n        .selectAll('g.category')\n        .data(function(d) {\n            return d.categories;\n        }, key);\n\n    // Initialize category groups\n    var categoryGroupEnterSelection = categorySelection\n        .enter()\n        .append('g')\n        .attr('class', 'category');\n\n    // Update category transforms\n    categorySelection\n        .attr('transform', function(d) {\n            return strTranslate(0, d.y);\n        });\n\n\n    // Initialize rectangle\n    categoryGroupEnterSelection\n        .append('rect')\n        .attr('class', 'catrect')\n        .attr('pointer-events', 'none');\n\n\n    // Update rectangle\n    categorySelection.select('rect.catrect')\n        .attr('fill', 'none')\n        .attr('width', function(d) {\n            return d.width;\n        })\n        .attr('height', function(d) {\n            return d.height;\n        });\n\n    styleCategoriesNoHover(categoryGroupEnterSelection);\n\n    // Initialize color band rects\n    var bandSelection = categorySelection\n        .selectAll('rect.bandrect')\n        .data(\n            /** @param {CategoryViewModel} catViewModel*/\n            function(catViewModel) {\n                return catViewModel.bands;\n            }, key);\n\n    // Raise all update bands to the top so that fading enter/exit bands will be behind\n    bandSelection.each(function() {Lib.raiseToTop(this);});\n\n    // Update band color\n    bandSelection\n        .attr('fill', function(d) {\n            return d.color;\n        });\n\n    var bandsSelectionEnter = bandSelection.enter()\n        .append('rect')\n        .attr('class', 'bandrect')\n        .attr('stroke-opacity', 0)\n        .attr('fill', function(d) {\n            return d.color;\n        })\n        .attr('fill-opacity', 0);\n\n    bandSelection\n        .attr('fill', function(d) {\n            return d.color;\n        })\n        .attr('width', function(d) {\n            return d.width;\n        })\n        .attr('height', function(d) {\n            return d.height;\n        })\n        .attr('y', function(d) {\n            return d.y;\n        })\n        .attr('cursor',\n            /** @param {CategoryBandViewModel} bandModel*/\n            function(bandModel) {\n                if(bandModel.parcatsViewModel.arrangement === 'fixed') {\n                    return 'default';\n                } else if(bandModel.parcatsViewModel.arrangement === 'perpendicular') {\n                    return 'ns-resize';\n                } else {\n                    return 'move';\n                }\n            });\n\n    styleBandsNoHover(bandsSelectionEnter);\n\n    bandSelection.exit().remove();\n\n    // Initialize category label\n    categoryGroupEnterSelection\n        .append('text')\n        .attr('class', 'catlabel')\n        .attr('pointer-events', 'none');\n\n    // Update category label\n    categorySelection.select('text.catlabel')\n        .attr('text-anchor',\n            function(d) {\n                if(catInRightDim(d)) {\n                    // Place label to the right of category\n                    return 'start';\n                } else {\n                    // Place label to the left of category\n                    return 'end';\n                }\n            })\n        .attr('alignment-baseline', 'middle')\n        .style('fill', 'rgb(0, 0, 0)')\n        .attr('x',\n            function(d) {\n                if(catInRightDim(d)) {\n                    // Place label to the right of category\n                    return d.width + 5;\n                } else {\n                    // Place label to the left of category\n                    return -5;\n                }\n            })\n        .attr('y', function(d) {\n            return d.height / 2;\n        })\n        .text(function(d) {\n            return d.model.categoryLabel;\n        })\n        .each(\n            /** @param {CategoryViewModel} catModel*/\n            function(catModel) {\n                Drawing.font(d3.select(this), catModel.parcatsViewModel.categorylabelfont);\n                svgTextUtils.convertToTspans(d3.select(this), graphDiv);\n            });\n\n    // Initialize dimension label\n    categoryGroupEnterSelection\n        .append('text')\n        .attr('class', 'dimlabel');\n\n    // Update dimension label\n    categorySelection.select('text.dimlabel')\n        .attr('text-anchor', 'middle')\n        .attr('alignment-baseline', 'baseline')\n        .attr('cursor',\n             /** @param {CategoryViewModel} catModel*/\n            function(catModel) {\n                if(catModel.parcatsViewModel.arrangement === 'fixed') {\n                    return 'default';\n                } else {\n                    return 'ew-resize';\n                }\n            })\n        .attr('x', function(d) {\n            return d.width / 2;\n        })\n        .attr('y', -5)\n        .text(function(d, i) {\n            if(i === 0) {\n                // Add dimension label above topmost category\n                return d.parcatsViewModel.model.dimensions[d.model.dimensionInd].dimensionLabel;\n            } else {\n                return null;\n            }\n        })\n        .each(\n            /** @param {CategoryViewModel} catModel*/\n            function(catModel) {\n                Drawing.font(d3.select(this), catModel.parcatsViewModel.labelfont);\n            });\n\n    // Category hover\n    // categorySelection.select('rect.catrect')\n    categorySelection.selectAll('rect.bandrect')\n        .on('mouseover', mouseoverCategoryBand)\n        .on('mouseout', mouseoutCategory);\n\n    // Remove unused categories\n    categorySelection.exit().remove();\n\n    // Setup drag\n    dimensionSelection.call(d3.behavior.drag()\n        .origin(function(d) {\n            return {x: d.x, y: 0};\n        })\n        .on('dragstart', dragDimensionStart)\n        .on('drag', dragDimension)\n        .on('dragend', dragDimensionEnd));\n\n\n    // Save off selections to view models\n    traceSelection.each(function(d) {\n        d.traceSelection = d3.select(this);\n        d.pathSelection = d3.select(this).selectAll('g.paths').selectAll('path.path');\n        d.dimensionSelection = d3.select(this).selectAll('g.dimensions').selectAll('g.dimension');\n    });\n\n    // Remove any orphan traces\n    traceSelection.exit().remove();\n}\n\n/**\n * Create / update parcat traces\n *\n * @param {Object} graphDiv\n * @param {Object} svg\n * @param {Array.<ParcatsModel>} parcatsModels\n * @param {Layout} layout\n */\nmodule.exports = function(graphDiv, svg, parcatsModels, layout) {\n    performPlot(parcatsModels, graphDiv, layout, svg);\n};\n\n/**\n * Function the returns the key property of an object for use with as D3 join function\n * @param d\n */\nfunction key(d) {\n    return d.key;\n}\n\n /** True if a category view model is in the right-most display dimension\n  * @param {CategoryViewModel} d */\nfunction catInRightDim(d) {\n    var numDims = d.parcatsViewModel.dimensions.length;\n    var leftDimInd = d.parcatsViewModel.dimensions[numDims - 1].model.dimensionInd;\n    return d.model.dimensionInd === leftDimInd;\n}\n\n/**\n * @param {PathViewModel} a\n * @param {PathViewModel} b\n */\nfunction compareRawColor(a, b) {\n    if(a.model.rawColor > b.model.rawColor) {\n        return 1;\n    } else if(a.model.rawColor < b.model.rawColor) {\n        return -1;\n    } else {\n        return 0;\n    }\n}\n\n/**\n * Handle path mouseover\n * @param {PathViewModel} d\n */\nfunction mouseoverPath(d) {\n    if(!d.parcatsViewModel.dragDimension) {\n        // We're not currently dragging\n\n        if(d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n            // hoverinfo is not skip, so we at least style the paths and emit interaction events\n\n            // Raise path to top\n            Lib.raiseToTop(this);\n\n            stylePathsHover(d3.select(this));\n\n            // Emit hover event\n            var points = buildPointsArrayForPath(d);\n            var constraints = buildConstraintsForPath(d);\n            d.parcatsViewModel.graphDiv.emit('plotly_hover', {\n                points: points, event: d3.event, constraints: constraints\n            });\n\n            // Handle hover label\n            if(d.parcatsViewModel.hoverinfoItems.indexOf('none') === -1) {\n                // hoverinfo is a combination of 'count' and 'probability'\n\n                // Mouse\n                var hoverX = d3.mouse(this)[0];\n\n                // Label\n                var gd = d.parcatsViewModel.graphDiv;\n                var trace = d.parcatsViewModel.trace;\n                var fullLayout = gd._fullLayout;\n                var rootBBox = fullLayout._paperdiv.node().getBoundingClientRect();\n                var graphDivBBox = d.parcatsViewModel.graphDiv.getBoundingClientRect();\n\n                // Find path center in path coordinates\n                var pathCenterX,\n                    pathCenterY,\n                    dimInd;\n\n                for(dimInd = 0; dimInd < (d.leftXs.length - 1); dimInd++) {\n                    if(d.leftXs[dimInd] + d.dimWidths[dimInd] - 2 <= hoverX && hoverX <= d.leftXs[dimInd + 1] + 2) {\n                        var leftDim = d.parcatsViewModel.dimensions[dimInd];\n                        var rightDim = d.parcatsViewModel.dimensions[dimInd + 1];\n                        pathCenterX = (leftDim.x + leftDim.width + rightDim.x) / 2;\n                        pathCenterY = (d.topYs[dimInd] + d.topYs[dimInd + 1] + d.height) / 2;\n                        break;\n                    }\n                }\n\n                // Find path center in root coordinates\n                var hoverCenterX = d.parcatsViewModel.x + pathCenterX;\n                var hoverCenterY = d.parcatsViewModel.y + pathCenterY;\n\n                var textColor = tinycolor.mostReadable(d.model.color, ['black', 'white']);\n\n                var count = d.model.count;\n                var prob = count / d.parcatsViewModel.model.count;\n                var labels = {\n                    countLabel: count,\n                    probabilityLabel: prob.toFixed(3)\n                };\n\n                // Build hover text\n                var hovertextParts = [];\n                if(d.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n                    hovertextParts.push(['Count:', labels.countLabel].join(' '));\n                }\n                if(d.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n                    hovertextParts.push(['P:', labels.probabilityLabel].join(' '));\n                }\n\n                var hovertext = hovertextParts.join('<br>');\n                var mouseX = d3.mouse(gd)[0];\n\n                Fx.loneHover({\n                    trace: trace,\n                    x: hoverCenterX - rootBBox.left + graphDivBBox.left,\n                    y: hoverCenterY - rootBBox.top + graphDivBBox.top,\n                    text: hovertext,\n                    color: d.model.color,\n                    borderColor: 'black',\n                    fontFamily: 'Monaco, \"Courier New\", monospace',\n                    fontSize: 10,\n                    fontColor: textColor,\n                    idealAlign: mouseX < hoverCenterX ? 'right' : 'left',\n                    hovertemplate: (trace.line || {}).hovertemplate,\n                    hovertemplateLabels: labels,\n                    eventData: [{\n                        data: trace._input,\n                        fullData: trace,\n                        count: count,\n                        probability: prob\n                    }]\n                }, {\n                    container: fullLayout._hoverlayer.node(),\n                    outerContainer: fullLayout._paper.node(),\n                    gd: gd\n                });\n            }\n        }\n    }\n}\n\n/**\n * Handle path mouseout\n * @param {PathViewModel} d\n */\nfunction mouseoutPath(d) {\n    if(!d.parcatsViewModel.dragDimension) {\n        // We're not currently dragging\n        stylePathsNoHover(d3.select(this));\n\n        // Remove and hover label\n        Fx.loneUnhover(d.parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n\n        // Restore path order\n        d.parcatsViewModel.pathSelection.sort(compareRawColor);\n\n        // Emit unhover event\n        if(d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n            var points = buildPointsArrayForPath(d);\n            var constraints = buildConstraintsForPath(d);\n            d.parcatsViewModel.graphDiv.emit('plotly_unhover', {\n                points: points, event: d3.event, constraints: constraints\n            });\n        }\n    }\n}\n\n/**\n * Build array of point objects for a path\n *\n * For use in click/hover events\n * @param {PathViewModel} d\n */\nfunction buildPointsArrayForPath(d) {\n    var points = [];\n    var curveNumber = getTraceIndex(d.parcatsViewModel);\n\n    for(var i = 0; i < d.model.valueInds.length; i++) {\n        var pointNumber = d.model.valueInds[i];\n        points.push({\n            curveNumber: curveNumber,\n            pointNumber: pointNumber\n        });\n    }\n    return points;\n}\n\n/**\n * Build constraints object for a path\n *\n * For use in click/hover events\n * @param {PathViewModel} d\n */\nfunction buildConstraintsForPath(d) {\n    var constraints = {};\n    var dimensions = d.parcatsViewModel.model.dimensions;\n\n    // dimensions\n    for(var i = 0; i < dimensions.length; i++) {\n        var dimension = dimensions[i];\n        var category = dimension.categories[d.model.categoryInds[i]];\n        constraints[dimension.containerInd] = category.categoryValue;\n    }\n\n    // color\n    if(d.model.rawColor !== undefined) {\n        constraints.color = d.model.rawColor;\n    }\n    return constraints;\n}\n\n/**\n * Handle path click\n * @param {PathViewModel} d\n */\nfunction clickPath(d) {\n    if(d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n        // hoverinfo it's skip, so interaction events aren't disabled\n        var points = buildPointsArrayForPath(d);\n        var constraints = buildConstraintsForPath(d);\n        d.parcatsViewModel.graphDiv.emit('plotly_click', {\n            points: points, event: d3.event, constraints: constraints\n        });\n    }\n}\n\nfunction stylePathsNoHover(pathSelection) {\n    pathSelection\n        .attr('fill', function(d) {\n            return d.model.color;\n        })\n        .attr('fill-opacity', 0.6)\n        .attr('stroke', 'lightgray')\n        .attr('stroke-width', 0.2)\n        .attr('stroke-opacity', 1.0);\n}\n\nfunction stylePathsHover(pathSelection) {\n    pathSelection\n        .attr('fill-opacity', 0.8)\n        .attr('stroke', function(d) {\n            return tinycolor.mostReadable(d.model.color, ['black', 'white']);\n        })\n        .attr('stroke-width', 0.3);\n}\n\nfunction styleCategoryHover(categorySelection) {\n    categorySelection\n        .select('rect.catrect')\n        .attr('stroke', 'black')\n        .attr('stroke-width', 2.5);\n}\n\nfunction styleCategoriesNoHover(categorySelection) {\n    categorySelection\n        .select('rect.catrect')\n        .attr('stroke', 'black')\n        .attr('stroke-width', 1)\n        .attr('stroke-opacity', 1);\n}\n\nfunction styleBandsHover(bandsSelection) {\n    bandsSelection\n        .attr('stroke', 'black')\n        .attr('stroke-width', 1.5);\n}\n\nfunction styleBandsNoHover(bandsSelection) {\n    bandsSelection\n        .attr('stroke', 'black')\n        .attr('stroke-width', 0.2)\n        .attr('stroke-opacity', 1.0)\n        .attr('fill-opacity', 1.0);\n}\n\n/**\n * Return selection of all paths that pass through the specified category\n * @param {CategoryBandViewModel} catBandViewModel\n */\nfunction selectPathsThroughCategoryBandColor(catBandViewModel) {\n    var allPaths = catBandViewModel.parcatsViewModel.pathSelection;\n    var dimInd = catBandViewModel.categoryViewModel.model.dimensionInd;\n    var catInd = catBandViewModel.categoryViewModel.model.categoryInd;\n\n    return allPaths\n        .filter(\n            /** @param {PathViewModel} pathViewModel */\n            function(pathViewModel) {\n                return pathViewModel.model.categoryInds[dimInd] === catInd &&\n                    pathViewModel.model.color === catBandViewModel.color;\n            });\n}\n\n\n/**\n * Perform hover styling for all paths that pass though the specified band element's category\n *\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction styleForCategoryHovermode(bandElement) {\n    // Get all bands in the current category\n    var bandSel = d3.select(bandElement.parentNode).selectAll('rect.bandrect');\n\n    // Raise and style paths\n    bandSel.each(function(bvm) {\n        var paths = selectPathsThroughCategoryBandColor(bvm);\n        stylePathsHover(paths);\n        paths.each(function() {\n            // Raise path to top\n            Lib.raiseToTop(this);\n        });\n    });\n\n    // Style category\n    styleCategoryHover(d3.select(bandElement.parentNode));\n}\n\n/**\n * Perform hover styling for all paths that pass though the category of the specified band element and share the\n * same color\n *\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction styleForColorHovermode(bandElement) {\n    var bandViewModel = d3.select(bandElement).datum();\n    var catPaths = selectPathsThroughCategoryBandColor(bandViewModel);\n    stylePathsHover(catPaths);\n    catPaths.each(function() {\n        // Raise path to top\n        Lib.raiseToTop(this);\n    });\n\n    // Style category for drag\n    d3.select(bandElement.parentNode)\n        .selectAll('rect.bandrect')\n        .filter(function(b) {return b.color === bandViewModel.color;})\n        .each(function() {\n            Lib.raiseToTop(this);\n            styleBandsHover(d3.select(this));\n        });\n}\n\n\n/**\n * @param {HTMLElement} bandElement\n *  HTML element for band\n * @param eventName\n *  Event name (plotly_hover or plotly_click)\n * @param event\n *  Mouse Event\n */\nfunction emitPointsEventCategoryHovermode(bandElement, eventName, event) {\n    // Get all bands in the current category\n    var bandViewModel = d3.select(bandElement).datum();\n    var categoryModel = bandViewModel.categoryViewModel.model;\n    var gd = bandViewModel.parcatsViewModel.graphDiv;\n    var bandSel = d3.select(bandElement.parentNode).selectAll('rect.bandrect');\n\n    var points = [];\n    bandSel.each(function(bvm) {\n        var paths = selectPathsThroughCategoryBandColor(bvm);\n        paths.each(function(pathViewModel) {\n            // Extend points array\n            Array.prototype.push.apply(points, buildPointsArrayForPath(pathViewModel));\n        });\n    });\n\n    var constraints = {};\n    constraints[categoryModel.dimensionInd] = categoryModel.categoryValue;\n    gd.emit(eventName, {\n        points: points, event: event, constraints: constraints\n    });\n}\n\n/**\n * @param {HTMLElement} bandElement\n *  HTML element for band\n * @param eventName\n *  Event name (plotly_hover or plotly_click)\n * @param event\n *  Mouse Event\n */\nfunction emitPointsEventColorHovermode(bandElement, eventName, event) {\n    var bandViewModel = d3.select(bandElement).datum();\n    var categoryModel = bandViewModel.categoryViewModel.model;\n    var gd = bandViewModel.parcatsViewModel.graphDiv;\n    var paths = selectPathsThroughCategoryBandColor(bandViewModel);\n\n    var points = [];\n    paths.each(function(pathViewModel) {\n        // Extend points array\n        Array.prototype.push.apply(points, buildPointsArrayForPath(pathViewModel));\n    });\n\n    var constraints = {};\n    constraints[categoryModel.dimensionInd] = categoryModel.categoryValue;\n    // color\n    if(bandViewModel.rawColor !== undefined) {\n        constraints.color = bandViewModel.rawColor;\n    }\n    gd.emit(eventName, {\n        points: points, event: event, constraints: constraints\n    });\n}\n\n/**\n * Create hover label for a band element's category (for use when hoveron === 'category')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForCategoryHovermode(gd, rootBBox, bandElement) {\n    gd._fullLayout._calcInverseTransform(gd);\n    var scaleX = gd._fullLayout._invScaleX;\n    var scaleY = gd._fullLayout._invScaleY;\n\n    // Selections\n    var rectSelection = d3.select(bandElement.parentNode).select('rect.catrect');\n    var rectBoundingBox = rectSelection.node().getBoundingClientRect();\n\n    // Models\n    /** @type {CategoryViewModel} */\n    var catViewModel = rectSelection.datum();\n    var parcatsViewModel = catViewModel.parcatsViewModel;\n    var dimensionModel = parcatsViewModel.model.dimensions[catViewModel.model.dimensionInd];\n    var trace = parcatsViewModel.trace;\n\n    // Positions\n    var hoverCenterY = rectBoundingBox.top + rectBoundingBox.height / 2;\n    var hoverCenterX,\n        hoverLabelIdealAlign;\n\n    if(parcatsViewModel.dimensions.length > 1 &&\n        dimensionModel.displayInd === parcatsViewModel.dimensions.length - 1) {\n        // right most dimension\n        hoverCenterX = rectBoundingBox.left;\n        hoverLabelIdealAlign = 'left';\n    } else {\n        hoverCenterX = rectBoundingBox.left + rectBoundingBox.width;\n        hoverLabelIdealAlign = 'right';\n    }\n\n    var count = catViewModel.model.count;\n    var catLabel = catViewModel.model.categoryLabel;\n    var prob = count / catViewModel.parcatsViewModel.model.count;\n    var labels = {\n        countLabel: count,\n        categoryLabel: catLabel,\n        probabilityLabel: prob.toFixed(3)\n    };\n\n    // Hover label text\n    var hoverinfoParts = [];\n    if(catViewModel.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n        hoverinfoParts.push(['Count:', labels.countLabel].join(' '));\n    }\n    if(catViewModel.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n        hoverinfoParts.push(['P(' + labels.categoryLabel + '):', labels.probabilityLabel].join(' '));\n    }\n\n    var hovertext = hoverinfoParts.join('<br>');\n    return {\n        trace: trace,\n        x: scaleX * (hoverCenterX - rootBBox.left),\n        y: scaleY * (hoverCenterY - rootBBox.top),\n        text: hovertext,\n        color: 'lightgray',\n        borderColor: 'black',\n        fontFamily: 'Monaco, \"Courier New\", monospace',\n        fontSize: 12,\n        fontColor: 'black',\n        idealAlign: hoverLabelIdealAlign,\n        hovertemplate: trace.hovertemplate,\n        hovertemplateLabels: labels,\n        eventData: [{\n            data: trace._input,\n            fullData: trace,\n            count: count,\n            category: catLabel,\n            probability: prob\n        }]\n    };\n}\n\n/**\n * Create hover label for a band element's category (for use when hoveron === 'category')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForDimensionHovermode(gd, rootBBox, bandElement) {\n    var allHoverlabels = [];\n\n    d3.select(bandElement.parentNode.parentNode)\n        .selectAll('g.category')\n        .select('rect.catrect')\n        .each(function() {\n            var bandNode = this;\n            allHoverlabels.push(createHoverLabelForCategoryHovermode(gd, rootBBox, bandNode));\n        });\n\n    return allHoverlabels;\n}\n\n/**\n * Create hover labels for a band element's category (for use when hoveron === 'dimension')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForColorHovermode(gd, rootBBox, bandElement) {\n    gd._fullLayout._calcInverseTransform(gd);\n    var scaleX = gd._fullLayout._invScaleX;\n    var scaleY = gd._fullLayout._invScaleY;\n\n    var bandBoundingBox = bandElement.getBoundingClientRect();\n\n    // Models\n    /** @type {CategoryBandViewModel} */\n    var bandViewModel = d3.select(bandElement).datum();\n    var catViewModel = bandViewModel.categoryViewModel;\n    var parcatsViewModel = catViewModel.parcatsViewModel;\n    var dimensionModel = parcatsViewModel.model.dimensions[catViewModel.model.dimensionInd];\n    var trace = parcatsViewModel.trace;\n\n    // positions\n    var hoverCenterY = bandBoundingBox.y + bandBoundingBox.height / 2;\n\n    var hoverCenterX,\n        hoverLabelIdealAlign;\n    if(parcatsViewModel.dimensions.length > 1 &&\n        dimensionModel.displayInd === parcatsViewModel.dimensions.length - 1) {\n        // right most dimension\n        hoverCenterX = bandBoundingBox.left;\n        hoverLabelIdealAlign = 'left';\n    } else {\n        hoverCenterX = bandBoundingBox.left + bandBoundingBox.width;\n        hoverLabelIdealAlign = 'right';\n    }\n\n    // Labels\n    var catLabel = catViewModel.model.categoryLabel;\n\n    // Counts\n    var totalCount = bandViewModel.parcatsViewModel.model.count;\n\n    var bandColorCount = 0;\n    bandViewModel.categoryViewModel.bands.forEach(function(b) {\n        if(b.color === bandViewModel.color) {\n            bandColorCount += b.count;\n        }\n    });\n\n    var catCount = catViewModel.model.count;\n\n    var colorCount = 0;\n    parcatsViewModel.pathSelection.each(\n        /** @param {PathViewModel} pathViewModel */\n        function(pathViewModel) {\n            if(pathViewModel.model.color === bandViewModel.color) {\n                colorCount += pathViewModel.model.count;\n            }\n        });\n\n    var pColorAndCat = bandColorCount / totalCount;\n    var pCatGivenColor = bandColorCount / colorCount;\n    var pColorGivenCat = bandColorCount / catCount;\n\n    var labels = {\n        countLabel: bandColorCount,\n        categoryLabel: catLabel,\n        probabilityLabel: pColorAndCat.toFixed(3)\n    };\n\n    // Hover label text\n    var hoverinfoParts = [];\n    if(catViewModel.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n        hoverinfoParts.push(['Count:', labels.countLabel].join(' '));\n    }\n    if(catViewModel.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n        hoverinfoParts.push('P(color ∩ ' + catLabel + '): ' + labels.probabilityLabel);\n        hoverinfoParts.push('P(' + catLabel + ' | color): ' + pCatGivenColor.toFixed(3));\n        hoverinfoParts.push('P(color | ' + catLabel + '): ' + pColorGivenCat.toFixed(3));\n    }\n\n    var hovertext = hoverinfoParts.join('<br>');\n\n    // Compute text color\n    var textColor = tinycolor.mostReadable(bandViewModel.color, ['black', 'white']);\n\n    return {\n        trace: trace,\n        x: scaleX * (hoverCenterX - rootBBox.left),\n        y: scaleY * (hoverCenterY - rootBBox.top),\n        // name: 'NAME',\n        text: hovertext,\n        color: bandViewModel.color,\n        borderColor: 'black',\n        fontFamily: 'Monaco, \"Courier New\", monospace',\n        fontColor: textColor,\n        fontSize: 10,\n        idealAlign: hoverLabelIdealAlign,\n        hovertemplate: trace.hovertemplate,\n        hovertemplateLabels: labels,\n        eventData: [{\n            data: trace._input,\n            fullData: trace,\n            category: catLabel,\n            count: totalCount,\n            probability: pColorAndCat,\n            categorycount: catCount,\n            colorcount: colorCount,\n            bandcolorcount: bandColorCount\n        }]\n    };\n}\n\n/**\n * Handle dimension mouseover\n * @param {CategoryBandViewModel} bandViewModel\n */\nfunction mouseoverCategoryBand(bandViewModel) {\n    if(!bandViewModel.parcatsViewModel.dragDimension) {\n        // We're not currently dragging\n\n        if(bandViewModel.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n            // hoverinfo is not skip, so we at least style the bands and emit interaction events\n\n            // Mouse\n            var mouseY = d3.mouse(this)[1];\n            if(mouseY < -1) {\n                // Hover is above above the category rectangle (probably the dimension title text)\n                return;\n            }\n\n            var gd = bandViewModel.parcatsViewModel.graphDiv;\n            var fullLayout = gd._fullLayout;\n            var rootBBox = fullLayout._paperdiv.node().getBoundingClientRect();\n            var hoveron = bandViewModel.parcatsViewModel.hoveron;\n\n            /** @type {HTMLElement} */\n            var bandElement = this;\n\n            // Handle style and events\n            if(hoveron === 'color') {\n                styleForColorHovermode(bandElement);\n                emitPointsEventColorHovermode(bandElement, 'plotly_hover', d3.event);\n            } else {\n                styleForCategoryHovermode(bandElement);\n                emitPointsEventCategoryHovermode(bandElement, 'plotly_hover', d3.event);\n            }\n\n            // Handle hover label\n            if(bandViewModel.parcatsViewModel.hoverinfoItems.indexOf('none') === -1) {\n                var hoverItems;\n                if(hoveron === 'category') {\n                    hoverItems = createHoverLabelForCategoryHovermode(gd, rootBBox, bandElement);\n                } else if(hoveron === 'color') {\n                    hoverItems = createHoverLabelForColorHovermode(gd, rootBBox, bandElement);\n                } else if(hoveron === 'dimension') {\n                    hoverItems = createHoverLabelForDimensionHovermode(gd, rootBBox, bandElement);\n                }\n\n                if(hoverItems) {\n                    Fx.loneHover(hoverItems, {\n                        container: fullLayout._hoverlayer.node(),\n                        outerContainer: fullLayout._paper.node(),\n                        gd: gd\n                    });\n                }\n            }\n        }\n    }\n}\n\n\n/**\n * Handle dimension mouseover\n * @param {CategoryBandViewModel} bandViewModel\n */\nfunction mouseoutCategory(bandViewModel) {\n    var parcatsViewModel = bandViewModel.parcatsViewModel;\n\n    if(!parcatsViewModel.dragDimension) {\n        // We're not dragging anything\n\n        // Reset unhovered styles\n        stylePathsNoHover(parcatsViewModel.pathSelection);\n        styleCategoriesNoHover(parcatsViewModel.dimensionSelection.selectAll('g.category'));\n        styleBandsNoHover(parcatsViewModel.dimensionSelection.selectAll('g.category').selectAll('rect.bandrect'));\n\n        // Remove hover label\n        Fx.loneUnhover(parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n\n        // Restore path order\n        parcatsViewModel.pathSelection.sort(compareRawColor);\n\n        // Emit unhover event\n        if(parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n            var hoveron = bandViewModel.parcatsViewModel.hoveron;\n            var bandElement = this;\n\n            // Handle style and events\n            if(hoveron === 'color') {\n                emitPointsEventColorHovermode(bandElement, 'plotly_unhover', d3.event);\n            } else {\n                emitPointsEventCategoryHovermode(bandElement, 'plotly_unhover', d3.event);\n            }\n        }\n    }\n}\n\n\n/**\n * Handle dimension drag start\n * @param {DimensionViewModel} d\n */\nfunction dragDimensionStart(d) {\n    // Check if dragging is supported\n    if(d.parcatsViewModel.arrangement === 'fixed') {\n        return;\n    }\n\n    // Save off initial drag indexes for dimension\n    d.dragDimensionDisplayInd = d.model.displayInd;\n    d.initialDragDimensionDisplayInds = d.parcatsViewModel.model.dimensions.map(function(d) {return d.displayInd;});\n    d.dragHasMoved = false;\n\n    // Check for category hit\n    d.dragCategoryDisplayInd = null;\n    d3.select(this)\n        .selectAll('g.category')\n        .select('rect.catrect')\n        .each(\n            /** @param {CategoryViewModel} catViewModel */\n            function(catViewModel) {\n                var catMouseX = d3.mouse(this)[0];\n                var catMouseY = d3.mouse(this)[1];\n\n\n                if(-2 <= catMouseX && catMouseX <= catViewModel.width + 2 &&\n                    -2 <= catMouseY && catMouseY <= catViewModel.height + 2) {\n                    // Save off initial drag indexes for categories\n                    d.dragCategoryDisplayInd = catViewModel.model.displayInd;\n                    d.initialDragCategoryDisplayInds = d.model.categories.map(function(c) {\n                        return c.displayInd;\n                    });\n\n                    // Initialize categories dragY to be the current y position\n                    catViewModel.model.dragY = catViewModel.y;\n\n                    // Raise category\n                    Lib.raiseToTop(this.parentNode);\n\n                    // Get band element\n                    d3.select(this.parentNode)\n                        .selectAll('rect.bandrect')\n                        /** @param {CategoryBandViewModel} bandViewModel */\n                        .each(function(bandViewModel) {\n                            if(bandViewModel.y < catMouseY && catMouseY <= bandViewModel.y + bandViewModel.height) {\n                                d.potentialClickBand = this;\n                            }\n                        });\n                }\n            });\n\n    // Update toplevel drag dimension\n    d.parcatsViewModel.dragDimension = d;\n\n    // Remove hover label if any\n    Fx.loneUnhover(d.parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n}\n\n/**\n * Handle dimension drag\n * @param {DimensionViewModel} d\n */\nfunction dragDimension(d) {\n    // Check if dragging is supported\n    if(d.parcatsViewModel.arrangement === 'fixed') {\n        return;\n    }\n\n    d.dragHasMoved = true;\n\n    if(d.dragDimensionDisplayInd === null) {\n        return;\n    }\n\n    var dragDimInd = d.dragDimensionDisplayInd;\n    var prevDimInd = dragDimInd - 1;\n    var nextDimInd = dragDimInd + 1;\n\n    var dragDimension = d.parcatsViewModel\n        .dimensions[dragDimInd];\n\n    // Update category\n    if(d.dragCategoryDisplayInd !== null) {\n        var dragCategory = dragDimension.categories[d.dragCategoryDisplayInd];\n\n        // Update dragY by dy\n        dragCategory.model.dragY += d3.event.dy;\n        var categoryY = dragCategory.model.dragY;\n\n        // Check for category drag swaps\n        var catDisplayInd = dragCategory.model.displayInd;\n        var dimCategoryViews = dragDimension.categories;\n\n        var catAbove = dimCategoryViews[catDisplayInd - 1];\n        var catBelow = dimCategoryViews[catDisplayInd + 1];\n\n        // Check for overlap above\n        if(catAbove !== undefined) {\n            if(categoryY < (catAbove.y + catAbove.height / 2.0)) {\n                // Swap display inds\n                dragCategory.model.displayInd = catAbove.model.displayInd;\n                catAbove.model.displayInd = catDisplayInd;\n            }\n        }\n\n        if(catBelow !== undefined) {\n            if((categoryY + dragCategory.height) > (catBelow.y + catBelow.height / 2.0)) {\n                // Swap display inds\n                dragCategory.model.displayInd = catBelow.model.displayInd;\n                catBelow.model.displayInd = catDisplayInd;\n            }\n        }\n\n        // Update category drag display index\n        d.dragCategoryDisplayInd = dragCategory.model.displayInd;\n    }\n\n    // Update dimension position\n    if(d.dragCategoryDisplayInd === null || d.parcatsViewModel.arrangement === 'freeform') {\n        dragDimension.model.dragX = d3.event.x;\n\n        // Check for dimension swaps\n        var prevDimension = d.parcatsViewModel.dimensions[prevDimInd];\n        var nextDimension = d.parcatsViewModel.dimensions[nextDimInd];\n\n        if(prevDimension !== undefined) {\n            if(dragDimension.model.dragX < (prevDimension.x + prevDimension.width)) {\n                // Swap display inds\n                dragDimension.model.displayInd = prevDimension.model.displayInd;\n                prevDimension.model.displayInd = dragDimInd;\n            }\n        }\n\n        if(nextDimension !== undefined) {\n            if((dragDimension.model.dragX + dragDimension.width) > nextDimension.x) {\n                // Swap display inds\n                dragDimension.model.displayInd = nextDimension.model.displayInd;\n                nextDimension.model.displayInd = d.dragDimensionDisplayInd;\n            }\n        }\n\n        // Update drag display index\n        d.dragDimensionDisplayInd = dragDimension.model.displayInd;\n    }\n\n    // Update view models\n    updateDimensionViewModels(d.parcatsViewModel);\n    updatePathViewModels(d.parcatsViewModel);\n\n    // Update svg geometry\n    updateSvgCategories(d.parcatsViewModel);\n    updateSvgPaths(d.parcatsViewModel);\n}\n\n\n/**\n * Handle dimension drag end\n * @param {DimensionViewModel} d\n */\nfunction dragDimensionEnd(d) {\n    // Check if dragging is supported\n    if(d.parcatsViewModel.arrangement === 'fixed') {\n        return;\n    }\n\n    if(d.dragDimensionDisplayInd === null) {\n        return;\n    }\n\n    d3.select(this).selectAll('text').attr('font-weight', 'normal');\n\n    // Compute restyle command\n    // -----------------------\n    var restyleData = {};\n    var traceInd = getTraceIndex(d.parcatsViewModel);\n\n    // ### Handle dimension reordering ###\n    var finalDragDimensionDisplayInds = d.parcatsViewModel.model.dimensions.map(function(d) {return d.displayInd;});\n    var anyDimsReordered = d.initialDragDimensionDisplayInds.some(function(initDimDisplay, dimInd) {\n        return initDimDisplay !== finalDragDimensionDisplayInds[dimInd];\n    });\n\n    if(anyDimsReordered) {\n        finalDragDimensionDisplayInds.forEach(function(finalDimDisplay, dimInd) {\n            var containerInd = d.parcatsViewModel.model.dimensions[dimInd].containerInd;\n            restyleData['dimensions[' + containerInd + '].displayindex'] = finalDimDisplay;\n        });\n    }\n\n    // ### Handle category reordering ###\n    var anyCatsReordered = false;\n    if(d.dragCategoryDisplayInd !== null) {\n        var finalDragCategoryDisplayInds = d.model.categories.map(function(c) {\n            return c.displayInd;\n        });\n\n        anyCatsReordered = d.initialDragCategoryDisplayInds.some(function(initCatDisplay, catInd) {\n            return initCatDisplay !== finalDragCategoryDisplayInds[catInd];\n        });\n\n        if(anyCatsReordered) {\n            // Sort a shallow copy of the category models by display index\n            var sortedCategoryModels = d.model.categories.slice().sort(\n                function(a, b) { return a.displayInd - b.displayInd; });\n\n            // Get new categoryarray and ticktext values\n            var newCategoryArray = sortedCategoryModels.map(function(v) { return v.categoryValue; });\n            var newCategoryLabels = sortedCategoryModels.map(function(v) { return v.categoryLabel; });\n\n            restyleData['dimensions[' + d.model.containerInd + '].categoryarray'] = [newCategoryArray];\n            restyleData['dimensions[' + d.model.containerInd + '].ticktext'] = [newCategoryLabels];\n            restyleData['dimensions[' + d.model.containerInd + '].categoryorder'] = 'array';\n        }\n    }\n\n    // Handle potential click event\n    // ----------------------------\n    if(d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n        if(!d.dragHasMoved && d.potentialClickBand) {\n            if(d.parcatsViewModel.hoveron === 'color') {\n                emitPointsEventColorHovermode(d.potentialClickBand, 'plotly_click', d3.event.sourceEvent);\n            } else {\n                emitPointsEventCategoryHovermode(d.potentialClickBand, 'plotly_click', d3.event.sourceEvent);\n            }\n        }\n    }\n\n    // Nullify drag states\n    // -------------------\n    d.model.dragX = null;\n    if(d.dragCategoryDisplayInd !== null) {\n        var dragCategory = d.parcatsViewModel\n            .dimensions[d.dragDimensionDisplayInd]\n            .categories[d.dragCategoryDisplayInd];\n\n        dragCategory.model.dragY = null;\n        d.dragCategoryDisplayInd = null;\n    }\n\n    d.dragDimensionDisplayInd = null;\n    d.parcatsViewModel.dragDimension = null;\n    d.dragHasMoved = null;\n    d.potentialClickBand = null;\n\n    // Update view models\n    // ------------------\n    updateDimensionViewModels(d.parcatsViewModel);\n    updatePathViewModels(d.parcatsViewModel);\n\n    // Perform transition\n    // ------------------\n    var transition = d3.transition()\n        .duration(300)\n        .ease('cubic-in-out');\n\n    transition\n        .each(function() {\n            updateSvgCategories(d.parcatsViewModel, true);\n            updateSvgPaths(d.parcatsViewModel, true);\n        })\n        .each('end', function() {\n            if(anyDimsReordered || anyCatsReordered) {\n                // Perform restyle if the order of categories or dimensions changed\n                Plotly.restyle(d.parcatsViewModel.graphDiv, restyleData, [traceInd]);\n            }\n        });\n}\n\n/**\n *\n * @param {ParcatsViewModel} parcatsViewModel\n */\nfunction getTraceIndex(parcatsViewModel) {\n    var traceInd;\n    var allTraces = parcatsViewModel.graphDiv._fullData;\n    for(var i = 0; i < allTraces.length; i++) {\n        if(parcatsViewModel.key === allTraces[i].uid) {\n            traceInd = i;\n            break;\n        }\n    }\n    return traceInd;\n}\n\n/** Update the svg paths for view model\n * @param {ParcatsViewModel} parcatsViewModel\n * @param {boolean} hasTransition Whether to update element with transition\n */\nfunction updateSvgPaths(parcatsViewModel, hasTransition) {\n    if(hasTransition === undefined) {\n        hasTransition = false;\n    }\n\n    function transition(selection) {\n        return hasTransition ? selection.transition() : selection;\n    }\n\n    // Update binding\n    parcatsViewModel.pathSelection.data(function(d) {\n        return d.paths;\n    }, key);\n\n    // Update paths\n    transition(parcatsViewModel.pathSelection).attr('d', function(d) {\n        return d.svgD;\n    });\n}\n\n/** Update the svg paths for view model\n * @param {ParcatsViewModel} parcatsViewModel\n * @param {boolean} hasTransition Whether to update element with transition\n */\nfunction updateSvgCategories(parcatsViewModel, hasTransition) {\n    if(hasTransition === undefined) {\n        hasTransition = false;\n    }\n\n    function transition(selection) {\n        return hasTransition ? selection.transition() : selection;\n    }\n\n    // Update binding\n    parcatsViewModel.dimensionSelection\n        .data(function(d) {\n            return d.dimensions;\n        }, key);\n\n    var categorySelection = parcatsViewModel.dimensionSelection\n        .selectAll('g.category')\n        .data(function(d) {return d.categories;}, key);\n\n    // Update dimension position\n    transition(parcatsViewModel.dimensionSelection)\n        .attr('transform', function(d) {\n            return strTranslate(d.x, 0);\n        });\n\n    // Update category position\n    transition(categorySelection)\n        .attr('transform', function(d) {\n            return strTranslate(0, d.y);\n        });\n\n    var dimLabelSelection = categorySelection.select('.dimlabel');\n\n    // ### Update dimension label\n    // Only the top-most display category should have the dimension label\n    dimLabelSelection\n        .text(function(d, i) {\n            if(i === 0) {\n                // Add dimension label above topmost category\n                return d.parcatsViewModel.model.dimensions[d.model.dimensionInd].dimensionLabel;\n            } else {\n                return null;\n            }\n        });\n\n    // Update category label\n    // Categories in the right-most display dimension have their labels on\n    // the right, all others on the left\n    var catLabelSelection = categorySelection.select('.catlabel');\n    catLabelSelection\n        .attr('text-anchor',\n            function(d) {\n                if(catInRightDim(d)) {\n                    // Place label to the right of category\n                    return 'start';\n                } else {\n                    // Place label to the left of category\n                    return 'end';\n                }\n            })\n        .attr('x',\n            function(d) {\n                if(catInRightDim(d)) {\n                    // Place label to the right of category\n                    return d.width + 5;\n                } else {\n                    // Place label to the left of category\n                    return -5;\n                }\n            })\n        .each(function(d) {\n            // Update attriubutes of <tspan> elements\n            var newX;\n            var newAnchor;\n            if(catInRightDim(d)) {\n                // Place label to the right of category\n                newX = d.width + 5;\n                newAnchor = 'start';\n            } else {\n                // Place label to the left of category\n                newX = -5;\n                newAnchor = 'end';\n            }\n            d3.select(this)\n                .selectAll('tspan')\n                .attr('x', newX)\n                .attr('text-anchor', newAnchor);\n        });\n\n    // Update bands\n    // Initialize color band rects\n    var bandSelection = categorySelection\n        .selectAll('rect.bandrect')\n        .data(\n            /** @param {CategoryViewModel} catViewModel*/\n            function(catViewModel) {\n                return catViewModel.bands;\n            }, key);\n\n    var bandsSelectionEnter = bandSelection.enter()\n        .append('rect')\n        .attr('class', 'bandrect')\n        .attr('cursor', 'move')\n        .attr('stroke-opacity', 0)\n        .attr('fill', function(d) {\n            return d.color;\n        })\n        .attr('fill-opacity', 0);\n\n    bandSelection\n        .attr('fill', function(d) {\n            return d.color;\n        })\n        .attr('width', function(d) {\n            return d.width;\n        })\n        .attr('height', function(d) {\n            return d.height;\n        })\n        .attr('y', function(d) {\n            return d.y;\n        });\n\n    styleBandsNoHover(bandsSelectionEnter);\n\n    // Raise bands to the top\n    bandSelection.each(function() {Lib.raiseToTop(this);});\n\n    // Remove unused bands\n    bandSelection.exit().remove();\n}\n\n/**\n * Create a ParcatsViewModel traces\n * @param {Object} graphDiv\n *  Top-level graph div element\n * @param {Layout} layout\n *  SVG layout object\n * @param {Array.<ParcatsModel>} wrappedParcatsModel\n *  Wrapped ParcatsModel for this trace\n * @return {ParcatsViewModel}\n */\nfunction createParcatsViewModel(graphDiv, layout, wrappedParcatsModel) {\n    // Unwrap model\n    var parcatsModel = wrappedParcatsModel[0];\n\n    // Compute margin\n    var margin = layout.margin || {l: 80, r: 80, t: 100, b: 80};\n\n    // Compute pixel position/extents\n    var trace = parcatsModel.trace;\n    var domain = trace.domain;\n    var figureWidth = layout.width;\n    var figureHeight = layout.height;\n    var traceWidth = Math.floor(figureWidth * (domain.x[1] - domain.x[0]));\n    var traceHeight = Math.floor(figureHeight * (domain.y[1] - domain.y[0]));\n    var traceX = domain.x[0] * figureWidth + margin.l;\n    var traceY = layout.height - domain.y[1] * layout.height + margin.t;\n\n    // Handle path shape\n    // -----------------\n    var pathShape = trace.line.shape;\n\n    // Handle hover info\n    // -----------------\n    var hoverinfoItems;\n    if(trace.hoverinfo === 'all') {\n        hoverinfoItems = ['count', 'probability'];\n    } else {\n        hoverinfoItems = (trace.hoverinfo || '').split('+');\n    }\n\n    // Construct parcatsViewModel\n    // --------------------------\n    var parcatsViewModel = {\n        trace: trace,\n        key: trace.uid,\n        model: parcatsModel,\n        x: traceX,\n        y: traceY,\n        width: traceWidth,\n        height: traceHeight,\n        hoveron: trace.hoveron,\n        hoverinfoItems: hoverinfoItems,\n        arrangement: trace.arrangement,\n        bundlecolors: trace.bundlecolors,\n        sortpaths: trace.sortpaths,\n        labelfont: trace.labelfont,\n        categorylabelfont: trace.tickfont,\n        pathShape: pathShape,\n        dragDimension: null,\n        margin: margin,\n        paths: [],\n        dimensions: [],\n        graphDiv: graphDiv,\n        traceSelection: null,\n        pathSelection: null,\n        dimensionSelection: null\n    };\n\n    // Update dimension view models if we have at least 1 dimension\n    if(parcatsModel.dimensions) {\n        updateDimensionViewModels(parcatsViewModel);\n\n        // Update path view models if we have at least 2 dimensions\n        updatePathViewModels(parcatsViewModel);\n    }\n    // Inside a categories view model\n    return parcatsViewModel;\n}\n\n/**\n * Build the SVG string to represents a parallel categories path\n * @param {Array.<Number>} leftXPositions\n *  Array of the x positions of the left edge of each dimension (in display order)\n * @param {Array.<Number>} pathYs\n *  Array of the y positions of the top of the path at each dimension (in display order)\n * @param {Array.<Number>} dimWidths\n *  Array of the widths of each dimension in display order\n * @param {Number} pathHeight\n *  The height of the path in pixels\n * @param {Number} curvature\n *  The curvature factor for the path. 0 results in a straight line and values greater than zero result in curved paths\n * @return {string}\n */\nfunction buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, curvature) {\n    // Compute the x midpoint of each path segment\n    var xRefPoints1 = [];\n    var xRefPoints2 = [];\n    var refInterpolator;\n    var d;\n\n    for(d = 0; d < dimWidths.length - 1; d++) {\n        refInterpolator = interpolateNumber(dimWidths[d] + leftXPositions[d], leftXPositions[d + 1]);\n        xRefPoints1.push(refInterpolator(curvature));\n        xRefPoints2.push(refInterpolator(1 - curvature));\n    }\n\n    // Move to top of path on left edge of left-most category\n    var svgD = 'M ' + leftXPositions[0] + ',' + pathYs[0];\n\n    // Horizontal line to right edge\n    svgD += 'l' + dimWidths[0] + ',0 ';\n\n    // Horizontal line to right edge\n    for(d = 1; d < dimWidths.length; d++) {\n        // Curve to left edge of category\n        svgD += 'C' + xRefPoints1[d - 1] + ',' + pathYs[d - 1] +\n              ' ' + xRefPoints2[d - 1] + ',' + pathYs[d] +\n              ' ' + leftXPositions[d] + ',' + pathYs[d];\n\n        // svgD += 'L' + leftXPositions[d] + ',' + pathYs[d];\n\n        // Horizontal line to right edge\n        svgD += 'l' + dimWidths[d] + ',0 ';\n    }\n\n    // Line down\n    svgD += 'l' + '0,' + pathHeight + ' ';\n\n    // Line to left edge of right-most category\n    svgD += 'l -' + dimWidths[dimWidths.length - 1] + ',0 ';\n\n    for(d = dimWidths.length - 2; d >= 0; d--) {\n        // Curve to right edge of category\n        svgD += 'C' + xRefPoints2[d] + ',' + (pathYs[d + 1] + pathHeight) +\n             ' ' + xRefPoints1[d] + ',' + (pathYs[d] + pathHeight) +\n             ' ' + (leftXPositions[d] + dimWidths[d]) + ',' + (pathYs[d] + pathHeight);\n\n        // svgD += 'L' + (leftXPositions[d] + dimWidths[d]) + ',' + (pathYs[d] + pathHeight);\n\n        // Horizontal line to right edge\n        svgD += 'l-' + dimWidths[d] + ',0 ';\n    }\n\n    // Close path\n    svgD += 'Z';\n    return svgD;\n}\n\n/**\n * Update the path view models based on the dimension view models in a ParcatsViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n */\nfunction updatePathViewModels(parcatsViewModel) {\n    // Initialize an array of the y position of the top of the next path to be added to each category.\n    //\n    // nextYPositions[d][c] is the y position of the next path through category with index c of dimension with index d\n    var dimensionViewModels = parcatsViewModel.dimensions;\n    var parcatsModel = parcatsViewModel.model;\n    var nextYPositions = dimensionViewModels.map(\n        function(d) {\n            return d.categories.map(\n                function(c) {\n                    return c.y;\n                });\n        });\n\n    // Array from category index to category display index for each true dimension index\n    var catToDisplayIndPerDim = parcatsViewModel.model.dimensions.map(\n        function(d) {\n            return d.categories.map(function(c) {return c.displayInd;});\n        });\n\n    // Array from true dimension index to dimension display index\n    var dimToDisplayInd = parcatsViewModel.model.dimensions.map(function(d) {return d.displayInd;});\n    var displayToDimInd = parcatsViewModel.dimensions.map(function(d) {return d.model.dimensionInd;});\n\n    // Array of the x position of the left edge of the rectangles for each dimension\n    var leftXPositions = dimensionViewModels.map(\n        function(d) {\n            return d.x;\n        });\n\n    // Compute dimension widths\n    var dimWidths = dimensionViewModels.map(function(d) {return d.width;});\n\n    // Build sorted Array of PathModel objects\n    var pathModels = [];\n    for(var p in parcatsModel.paths) {\n        if(parcatsModel.paths.hasOwnProperty(p)) {\n            pathModels.push(parcatsModel.paths[p]);\n        }\n    }\n\n    // Compute category display inds to use for sorting paths\n    function pathDisplayCategoryInds(pathModel) {\n        var dimensionInds = pathModel.categoryInds.map(function(catInd, dimInd) {return catToDisplayIndPerDim[dimInd][catInd];});\n        var displayInds = displayToDimInd.map(function(dimInd) {\n            return dimensionInds[dimInd];\n        });\n        return displayInds;\n    }\n\n    // Sort in ascending order by display index array\n    pathModels.sort(function(v1, v2) {\n        // Build display inds for each path\n        var sortArray1 = pathDisplayCategoryInds(v1);\n        var sortArray2 = pathDisplayCategoryInds(v2);\n\n        // Handle path sort order\n        if(parcatsViewModel.sortpaths === 'backward') {\n            sortArray1.reverse();\n            sortArray2.reverse();\n        }\n\n        // Append the first value index of the path to break ties\n        sortArray1.push(v1.valueInds[0]);\n        sortArray2.push(v2.valueInds[0]);\n\n        // Handle color bundling\n        if(parcatsViewModel.bundlecolors) {\n            // Prepend sort array with the raw color value\n            sortArray1.unshift(v1.rawColor);\n            sortArray2.unshift(v2.rawColor);\n        }\n\n        // colors equal, sort by display categories\n        if(sortArray1 < sortArray2) {\n            return -1;\n        }\n        if(sortArray1 > sortArray2) {\n            return 1;\n        }\n\n        return 0;\n    });\n\n    // Create path models\n    var pathViewModels = new Array(pathModels.length);\n    var totalCount = dimensionViewModels[0].model.count;\n    var totalHeight = dimensionViewModels[0].categories\n        .map(function(c) { return c.height; })\n        .reduce(function(v1, v2) { return v1 + v2; });\n\n\n    for(var pathNumber = 0; pathNumber < pathModels.length; pathNumber++) {\n        var pathModel = pathModels[pathNumber];\n\n        var pathHeight;\n        if(totalCount > 0) {\n            pathHeight = totalHeight * (pathModel.count / totalCount);\n        } else {\n            pathHeight = 0;\n        }\n\n        // Build path y coords\n        var pathYs = new Array(nextYPositions.length);\n        for(var d = 0; d < pathModel.categoryInds.length; d++) {\n            var catInd = pathModel.categoryInds[d];\n            var catDisplayInd = catToDisplayIndPerDim[d][catInd];\n            var dimDisplayInd = dimToDisplayInd[d];\n\n            // Update next y position\n            pathYs[dimDisplayInd] = nextYPositions[dimDisplayInd][catDisplayInd];\n            nextYPositions[dimDisplayInd][catDisplayInd] += pathHeight;\n\n            // Update category color information\n            var catViewModle = parcatsViewModel.dimensions[dimDisplayInd].categories[catDisplayInd];\n            var numBands = catViewModle.bands.length;\n            var lastCatBand = catViewModle.bands[numBands - 1];\n\n            if(lastCatBand === undefined || pathModel.rawColor !== lastCatBand.rawColor) {\n                // Create a new band\n                var bandY = lastCatBand === undefined ? 0 : lastCatBand.y + lastCatBand.height;\n                catViewModle.bands.push({\n                    key: bandY,\n                    color: pathModel.color,\n                    rawColor: pathModel.rawColor,\n                    height: pathHeight,\n                    width: catViewModle.width,\n                    count: pathModel.count,\n                    y: bandY,\n                    categoryViewModel: catViewModle,\n                    parcatsViewModel: parcatsViewModel\n                });\n            } else {\n                // Extend current band\n                var currentBand = catViewModle.bands[numBands - 1];\n                currentBand.height += pathHeight;\n                currentBand.count += pathModel.count;\n            }\n        }\n\n        // build svg path\n        var svgD;\n        if(parcatsViewModel.pathShape === 'hspline') {\n            svgD = buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, 0.5);\n        } else {\n            svgD = buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, 0);\n        }\n\n        pathViewModels[pathNumber] = {\n            key: pathModel.valueInds[0],\n            model: pathModel,\n            height: pathHeight,\n            leftXs: leftXPositions,\n            topYs: pathYs,\n            dimWidths: dimWidths,\n            svgD: svgD,\n            parcatsViewModel: parcatsViewModel\n        };\n    }\n\n    parcatsViewModel.paths = pathViewModels;\n\n // * @property key\n // *  Unique key for this model\n // * @property {PathModel} model\n // *  Source path model\n // * @property {Number} height\n // *  Height of this path (pixels)\n // * @property {String} svgD\n // *  SVG path \"d\" attribute string\n}\n\n/**\n * Update the dimension view models based on the dimension models in a ParcatsViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n */\nfunction updateDimensionViewModels(parcatsViewModel) {\n    // Compute dimension ordering\n    var dimensionsIndInfo = parcatsViewModel.model.dimensions.map(function(d) {\n        return {displayInd: d.displayInd, dimensionInd: d.dimensionInd};\n    });\n\n    dimensionsIndInfo.sort(function(a, b) {\n        return a.displayInd - b.displayInd;\n    });\n\n    var dimensions = [];\n    for(var displayInd in dimensionsIndInfo) {\n        var dimensionInd = dimensionsIndInfo[displayInd].dimensionInd;\n        var dimModel = parcatsViewModel.model.dimensions[dimensionInd];\n        dimensions.push(createDimensionViewModel(parcatsViewModel, dimModel));\n    }\n\n    parcatsViewModel.dimensions = dimensions;\n}\n\n/**\n * Create a parcats DimensionViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n * @param {DimensionModel} dimensionModel\n * @return {DimensionViewModel}\n */\nfunction createDimensionViewModel(parcatsViewModel, dimensionModel) {\n    // Compute dimension x position\n    var categoryLabelPad = 40;\n    var dimWidth = 16;\n    var numDimensions = parcatsViewModel.model.dimensions.length;\n    var displayInd = dimensionModel.displayInd;\n\n    // Compute x coordinate values\n    var dimDx;\n    var dimX0;\n    var dimX;\n\n    if(numDimensions > 1) {\n        dimDx = (parcatsViewModel.width - 2 * categoryLabelPad - dimWidth) / (numDimensions - 1);\n    } else {\n        dimDx = 0;\n    }\n    dimX0 = categoryLabelPad;\n    dimX = dimX0 + dimDx * displayInd;\n\n    // Compute categories\n    var categories = [];\n    var maxCats = parcatsViewModel.model.maxCats;\n    var numCats = dimensionModel.categories.length;\n    var catSpacing = 8;\n    var totalCount = dimensionModel.count;\n    var totalHeight = parcatsViewModel.height - catSpacing * (maxCats - 1);\n    var nextCatHeight;\n    var nextCatModel;\n    var nextCat;\n    var catInd;\n    var catDisplayInd;\n\n    // Compute starting Y offset\n    var nextCatY = (maxCats - numCats) * catSpacing / 2.0;\n\n    // Compute category ordering\n    var categoryIndInfo = dimensionModel.categories.map(function(c) {\n        return {displayInd: c.displayInd, categoryInd: c.categoryInd};\n    });\n\n    categoryIndInfo.sort(function(a, b) {\n        return a.displayInd - b.displayInd;\n    });\n\n    for(catDisplayInd = 0; catDisplayInd < numCats; catDisplayInd++) {\n        catInd = categoryIndInfo[catDisplayInd].categoryInd;\n        nextCatModel = dimensionModel.categories[catInd];\n\n        if(totalCount > 0) {\n            nextCatHeight = (nextCatModel.count / totalCount) * totalHeight;\n        } else {\n            nextCatHeight = 0;\n        }\n\n        nextCat = {\n            key: nextCatModel.valueInds[0],\n            model: nextCatModel,\n            width: dimWidth,\n            height: nextCatHeight,\n            y: nextCatModel.dragY !== null ? nextCatModel.dragY : nextCatY,\n            bands: [],\n            parcatsViewModel: parcatsViewModel\n        };\n\n        nextCatY = nextCatY + nextCatHeight + catSpacing;\n        categories.push(nextCat);\n    }\n\n    return {\n        key: dimensionModel.dimensionInd,\n        x: dimensionModel.dragX !== null ? dimensionModel.dragX : dimX,\n        y: 0,\n        width: dimWidth,\n        model: dimensionModel,\n        categories: categories,\n        parcatsViewModel: parcatsViewModel,\n        dragCategoryDisplayInd: null,\n        dragDimensionDisplayInd: null,\n        initialDragDimensionDisplayInds: null,\n        initialDragCategoryDisplayInds: null,\n        dragHasMoved: null,\n        potentialClickBand: null\n    };\n}\n\n// JSDoc typedefs\n// ==============\n/**\n * @typedef {Object} Layout\n *  Object containing svg layout information\n *\n * @property {Number} width (pixels)\n *  Usable width for Figure (after margins are removed)\n * @property {Number} height (pixels)\n *  Usable height for Figure (after margins are removed)\n * @property {Margin} margin\n *  Margin around the Figure (pixels)\n */\n\n/**\n * @typedef {Object} Margin\n *  Object containing padding information in pixels\n *\n * @property {Number} t\n *  Top margin\n * @property {Number} r\n *  Right margin\n * @property {Number} b\n *  Bottom margin\n * @property {Number} l\n *  Left margin\n */\n\n/**\n * @typedef {Object} Font\n *  Object containing font information\n *\n * @property {Number} size: Font size\n * @property {String} color: Font color\n * @property {String} family: Font family\n */\n\n/**\n * @typedef {Object} ParcatsViewModel\n *  Object containing calculated parcats view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {ParcatsModel} model\n *  Source parcats model\n * @property {Array.<DimensionViewModel>} dimensions\n *  Array of dimension view models\n * @property {Number} width\n *  Width for this trace (pixels)\n * @property {Number} height\n *  Height for this trace (pixels)\n * @property {Number} x\n *  X position of this trace with respect to the Figure (pixels)\n * @property {Number} y\n *  Y position of this trace with respect to the Figure (pixels)\n * @property {String} hoveron\n *  Hover interaction mode. One of: 'category', 'color', or 'dimension'\n * @property {Array.<String>} hoverinfoItems\n *  Info to display on hover. Array with a combination of 'counts' and/or 'probabilities', or 'none', or 'skip'\n * @property {String} arrangement\n *  Category arrangement. One of: 'perpendicular', 'freeform', or 'fixed'\n * @property {Boolean} bundlecolors\n *  Whether paths should be sorted so that like colors are bundled together as they pass through categories\n * @property {String} sortpaths\n *  If 'forward' then sort paths based on dimensions from left to right. If 'backward' sort based on dimensions\n *  from right to left\n * @property {Font} labelfont\n *  Font for the dimension labels\n * @property {Font} categorylabelfont\n *  Font for the category labels\n * @property {String} pathShape\n *  The shape of the paths. Either 'linear' or 'hspline'.\n * @property {DimensionViewModel|null} dragDimension\n *  Dimension currently being dragged. Null if no drag in progress\n * @property {Margin} margin\n *  Margin around the Figure\n * @property {Object} graphDiv\n *  Top-level graph div element\n * @property {Object} traceSelection\n *  D3 selection of this view models trace group element\n * @property {Object} pathSelection\n *  D3 selection of this view models path elements\n * @property {Object} dimensionSelection\n *  D3 selection of this view models dimension group element\n */\n\n/**\n * @typedef {Object} DimensionViewModel\n *  Object containing calculated parcats dimension view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {DimensionModel} model\n *  Source dimension model\n * @property {Number} x\n *  X position of the center of this dimension with respect to the Figure (pixels)\n * @property {Number} y\n *  Y position of the top of this dimension with respect to the Figure (pixels)\n * @property {Number} width\n *  Width of categories in this dimension (pixels)\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n * @property {Array.<CategoryViewModel>} categories\n *  Dimensions category view models\n * @property {Number|null} dragCategoryDisplayInd\n *  Display index of category currently being dragged. null if no category is being dragged\n * @property {Number|null} dragDimensionDisplayInd\n *  Display index of the dimension being dragged. null if no dimension is being dragged\n * @property {Array.<Number>|null} initialDragDimensionDisplayInds\n *  Dimensions display indexes at the beginning of the current drag. null if no dimension is being dragged\n * @property {Array.<Number>|null} initialDragCategoryDisplayInds\n *  Category display indexes for the at the beginning of the current drag. null if no category is being dragged\n * @property {HTMLElement} potentialClickBand\n *  Band under mouse when current drag began. If no drag movement takes place then a click will be emitted for this\n *  band. Null if not drag in progress.\n * @property {Boolean} dragHasMoved\n *  True if there is an active drag and the drag has moved. If drag doesn't move before being ended then\n *  this may be interpreted as a click. Null if no drag in progress\n */\n\n/**\n * @typedef {Object} CategoryViewModel\n *  Object containing calculated parcats category view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {CategoryModel} model\n *  Source category model\n * @property {Number} width\n *  Width for this category (pixels)\n * @property {Number} height\n *  Height for this category (pixels)\n * @property {Number} y\n *  Y position of this cateogry with respect to the Figure (pixels)\n * @property {Array.<CategoryBandViewModel>} bands\n *  Array of color bands inside the category\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n\n/**\n * @typedef {Object} CategoryBandViewModel\n *  Object containing calculated category band information. A category band is a region inside a category covering\n *  paths of a single color\n *\n * @property key\n *  Unique key for this model\n * @property color\n *  Band color\n * @property rawColor\n *  Raw color value for band\n * @property {Number} width\n *  Band width\n * @property {Number} height\n *  Band height\n * @property {Number} y\n *  Y position of top of the band with respect to the category\n * @property {Number} count\n *  The number of samples represented by the band\n * @property {CategoryViewModel} categoryViewModel\n *  The parent categorie's view model\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n\n/**\n * @typedef {Object} PathViewModel\n *  Object containing calculated parcats path view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {PathModel} model\n *  Source path model\n * @property {Number} height\n *  Height of this path (pixels)\n * @property {Array.<Number>} leftXs\n *  The x position of the left edge of each display dimension\n * @property {Array.<Number>} topYs\n *  The y position of the top of the path for each display dimension\n * @property {Array.<Number>} dimWidths\n *  The width of each display dimension\n * @property {String} svgD\n *  SVG path \"d\" attribute string\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n"],"mappings":"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A;IACtB,CAAC;IAEDoS,QAAQ,GAAGA,QAAQ,GAAGH,aAAa,GAAGD,UAAU;IAChD5S,UAAU,CAACkF,IAAI,CAAC6N,OAAO,CAAC;EAC5B;EAEA,OAAO;IACH1U,GAAG,EAAEkL,cAAc,CAAChI,YAAY;IAChC/C,CAAC,EAAE+K,cAAc,CAAC4C,KAAK,KAAK,IAAI,GAAG5C,cAAc,CAAC4C,KAAK,GAAGsG,IAAI;IAC9DhU,CAAC,EAAE,CAAC;IACJyB,KAAK,EAAEmS,QAAQ;IACfvT,KAAK,EAAEyK,cAAc;IACrBvJ,UAAU,EAAEA,UAAU;IACtBY,gBAAgB,EAAEA,gBAAgB;IAClCsK,sBAAsB,EAAE,IAAI;IAC5BH,uBAAuB,EAAE,IAAI;IAC7BC,+BAA+B,EAAE,IAAI;IACrCK,8BAA8B,EAAE,IAAI;IACpCJ,YAAY,EAAE,IAAI;IAClBO,kBAAkB,EAAE;EACxB,CAAC;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","ignoreList":[]},"metadata":{},"sourceType":"script"}