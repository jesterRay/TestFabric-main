{"ast":null,"code":"'use strict';\n\nvar d3 = require('@plotly/d3');\nvar tinycolor = require('tinycolor2');\nvar Plots = require('../../plots/plots');\nvar Registry = require('../../registry');\nvar Axes = require('../../plots/cartesian/axes');\nvar dragElement = require('../dragelement');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar extendFlat = require('../../lib/extend').extendFlat;\nvar setCursor = require('../../lib/setcursor');\nvar Drawing = require('../drawing');\nvar Color = require('../color');\nvar Titles = require('../titles');\nvar svgTextUtils = require('../../lib/svg_text_utils');\nvar flipScale = require('../colorscale/helpers').flipScale;\nvar handleAxisDefaults = require('../../plots/cartesian/axis_defaults');\nvar handleAxisPositionDefaults = require('../../plots/cartesian/position_defaults');\nvar axisLayoutAttrs = require('../../plots/cartesian/layout_attributes');\nvar alignmentConstants = require('../../constants/alignment');\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar FROM_TL = alignmentConstants.FROM_TL;\nvar FROM_BR = alignmentConstants.FROM_BR;\nvar cn = require('./constants').cn;\nfunction draw(gd) {\n  var fullLayout = gd._fullLayout;\n  var colorBars = fullLayout._infolayer.selectAll('g.' + cn.colorbar).data(makeColorBarData(gd), function (opts) {\n    return opts._id;\n  });\n  colorBars.enter().append('g').attr('class', function (opts) {\n    return opts._id;\n  }).classed(cn.colorbar, true);\n  colorBars.each(function (opts) {\n    var g = d3.select(this);\n    Lib.ensureSingle(g, 'rect', cn.cbbg);\n    Lib.ensureSingle(g, 'g', cn.cbfills);\n    Lib.ensureSingle(g, 'g', cn.cblines);\n    Lib.ensureSingle(g, 'g', cn.cbaxis, function (s) {\n      s.classed(cn.crisp, true);\n    });\n    Lib.ensureSingle(g, 'g', cn.cbtitleunshift, function (s) {\n      s.append('g').classed(cn.cbtitle, true);\n    });\n    Lib.ensureSingle(g, 'rect', cn.cboutline);\n    var done = drawColorBar(g, opts, gd);\n    if (done && done.then) (gd._promises || []).push(done);\n    if (gd._context.edits.colorbarPosition) {\n      makeEditable(g, opts, gd);\n    }\n  });\n  colorBars.exit().each(function (opts) {\n    Plots.autoMargin(gd, opts._id);\n  }).remove();\n  colorBars.order();\n}\nfunction makeColorBarData(gd) {\n  var fullLayout = gd._fullLayout;\n  var calcdata = gd.calcdata;\n  var out = [];\n\n  // single out item\n  var opts;\n  // colorbar attr parent container\n  var cont;\n  // trace attr container\n  var trace;\n  // colorbar options\n  var cbOpt;\n  function initOpts(opts) {\n    return extendFlat(opts, {\n      // fillcolor can be a d3 scale, domain is z values, range is colors\n      // or leave it out for no fill,\n      // or set to a string constant for single-color fill\n      _fillcolor: null,\n      // line.color has the same options as fillcolor\n      _line: {\n        color: null,\n        width: null,\n        dash: null\n      },\n      // levels of lines to draw.\n      // note that this DOES NOT determine the extent of the bar\n      // that's given by the domain of fillcolor\n      // (or line.color if no fillcolor domain)\n      _levels: {\n        start: null,\n        end: null,\n        size: null\n      },\n      // separate fill levels (for example, heatmap coloring of a\n      // contour map) if this is omitted, fillcolors will be\n      // evaluated halfway between levels\n      _filllevels: null,\n      // for continuous colorscales: fill with a gradient instead of explicit levels\n      // value should be the colorscale [[0, c0], [v1, c1], ..., [1, cEnd]]\n      _fillgradient: null,\n      // when using a gradient, we need the data range specified separately\n      _zrange: null\n    });\n  }\n  function calcOpts() {\n    if (typeof cbOpt.calc === 'function') {\n      cbOpt.calc(gd, trace, opts);\n    } else {\n      opts._fillgradient = cont.reversescale ? flipScale(cont.colorscale) : cont.colorscale;\n      opts._zrange = [cont[cbOpt.min], cont[cbOpt.max]];\n    }\n  }\n  for (var i = 0; i < calcdata.length; i++) {\n    var cd = calcdata[i];\n    trace = cd[0].trace;\n    if (!trace._module) continue;\n    var moduleOpts = trace._module.colorbar;\n    if (trace.visible === true && moduleOpts) {\n      var allowsMultiplotCbs = Array.isArray(moduleOpts);\n      var cbOpts = allowsMultiplotCbs ? moduleOpts : [moduleOpts];\n      for (var j = 0; j < cbOpts.length; j++) {\n        cbOpt = cbOpts[j];\n        var contName = cbOpt.container;\n        cont = contName ? trace[contName] : trace;\n        if (cont && cont.showscale) {\n          opts = initOpts(cont.colorbar);\n          opts._id = 'cb' + trace.uid + (allowsMultiplotCbs && contName ? '-' + contName : '');\n          opts._traceIndex = trace.index;\n          opts._propPrefix = (contName ? contName + '.' : '') + 'colorbar.';\n          opts._meta = trace._meta;\n          calcOpts();\n          out.push(opts);\n        }\n      }\n    }\n  }\n  for (var k in fullLayout._colorAxes) {\n    cont = fullLayout[k];\n    if (cont.showscale) {\n      var colorAxOpts = fullLayout._colorAxes[k];\n      opts = initOpts(cont.colorbar);\n      opts._id = 'cb' + k;\n      opts._propPrefix = k + '.colorbar.';\n      opts._meta = fullLayout._meta;\n      cbOpt = {\n        min: 'cmin',\n        max: 'cmax'\n      };\n      if (colorAxOpts[0] !== 'heatmap') {\n        trace = colorAxOpts[1];\n        cbOpt.calc = trace._module.colorbar.calc;\n      }\n      calcOpts();\n      out.push(opts);\n    }\n  }\n  return out;\n}\nfunction drawColorBar(g, opts, gd) {\n  var isVertical = opts.orientation === 'v';\n  var len = opts.len;\n  var lenmode = opts.lenmode;\n  var thickness = opts.thickness;\n  var thicknessmode = opts.thicknessmode;\n  var outlinewidth = opts.outlinewidth;\n  var borderwidth = opts.borderwidth;\n  var bgcolor = opts.bgcolor;\n  var xanchor = opts.xanchor;\n  var yanchor = opts.yanchor;\n  var xpad = opts.xpad;\n  var ypad = opts.ypad;\n  var optsX = opts.x;\n  var optsY = isVertical ? opts.y : 1 - opts.y;\n  var isPaperY = opts.yref === 'paper';\n  var isPaperX = opts.xref === 'paper';\n  var fullLayout = gd._fullLayout;\n  var gs = fullLayout._size;\n  var fillColor = opts._fillcolor;\n  var line = opts._line;\n  var title = opts.title;\n  var titleSide = title.side;\n  var zrange = opts._zrange || d3.extent((typeof fillColor === 'function' ? fillColor : line.color).domain());\n  var lineColormap = typeof line.color === 'function' ? line.color : function () {\n    return line.color;\n  };\n  var fillColormap = typeof fillColor === 'function' ? fillColor : function () {\n    return fillColor;\n  };\n  var levelsIn = opts._levels;\n  var levelsOut = calcLevels(gd, opts, zrange);\n  var fillLevels = levelsOut.fill;\n  var lineLevels = levelsOut.line;\n\n  // we calculate pixel sizes based on the specified graph size,\n  // not the actual (in case something pushed the margins around)\n  // which is a little odd but avoids an odd iterative effect\n  // when the colorbar itself is pushing the margins.\n  // but then the fractional size is calculated based on the\n  // actual graph size, so that the axes will size correctly.\n  var thickPx = Math.round(thickness * (thicknessmode === 'fraction' ? isVertical ? gs.w : gs.h : 1));\n  var thickFrac = thickPx / (isVertical ? gs.w : gs.h);\n  var lenPx = Math.round(len * (lenmode === 'fraction' ? isVertical ? gs.h : gs.w : 1));\n  var lenFrac = lenPx / (isVertical ? gs.h : gs.w);\n  var posW = isPaperX ? gs.w : gd._fullLayout.width;\n  var posH = isPaperY ? gs.h : gd._fullLayout.height;\n\n  // x positioning: do it initially just for left anchor,\n  // then fix at the end (since we don't know the width yet)\n  var uPx = Math.round(isVertical ? optsX * posW + xpad : optsY * posH + ypad);\n  var xRatio = {\n    center: 0.5,\n    right: 1\n  }[xanchor] || 0;\n  var yRatio = {\n    top: 1,\n    middle: 0.5\n  }[yanchor] || 0;\n\n  // for dragging... this is getting a little muddled...\n  var uFrac = isVertical ? optsX - xRatio * thickFrac : optsY - yRatio * thickFrac;\n\n  // y/x positioning (for v/h) we can do correctly from the start\n  var vFrac = isVertical ? optsY - yRatio * lenFrac : optsX - xRatio * lenFrac;\n  var vPx = Math.round(isVertical ? posH * (1 - vFrac) : posW * vFrac);\n\n  // stash a few things for makeEditable\n  opts._lenFrac = lenFrac;\n  opts._thickFrac = thickFrac;\n  opts._uFrac = uFrac;\n  opts._vFrac = vFrac;\n\n  // stash mocked axis for contour label formatting\n  var ax = opts._axis = mockColorBarAxis(gd, opts, zrange);\n\n  // position can't go in through supplyDefaults\n  // because that restricts it to [0,1]\n  ax.position = thickFrac + (isVertical ? optsX + xpad / gs.w : optsY + ypad / gs.h);\n  var topOrBottom = ['top', 'bottom'].indexOf(titleSide) !== -1;\n  if (isVertical && topOrBottom) {\n    ax.title.side = titleSide;\n    ax.titlex = optsX + xpad / gs.w;\n    ax.titley = vFrac + (title.side === 'top' ? lenFrac - ypad / gs.h : ypad / gs.h);\n  }\n  if (!isVertical && !topOrBottom) {\n    ax.title.side = titleSide;\n    ax.titley = optsY + ypad / gs.h;\n    ax.titlex = vFrac + xpad / gs.w; // right side\n  }\n  if (line.color && opts.tickmode === 'auto') {\n    ax.tickmode = 'linear';\n    ax.tick0 = levelsIn.start;\n    var dtick = levelsIn.size;\n    // expand if too many contours, so we don't get too many ticks\n    var autoNtick = Lib.constrain(lenPx / 50, 4, 15) + 1;\n    var dtFactor = (zrange[1] - zrange[0]) / ((opts.nticks || autoNtick) * dtick);\n    if (dtFactor > 1) {\n      var dtexp = Math.pow(10, Math.floor(Math.log(dtFactor) / Math.LN10));\n      dtick *= dtexp * Lib.roundUp(dtFactor / dtexp, [2, 5, 10]);\n      // if the contours are at round multiples, reset tick0\n      // so they're still at round multiples. Otherwise,\n      // keep the first label on the first contour level\n      if ((Math.abs(levelsIn.start) / levelsIn.size + 1e-6) % 1 < 2e-6) {\n        ax.tick0 = 0;\n      }\n    }\n    ax.dtick = dtick;\n  }\n\n  // set domain after init, because we may want to\n  // allow it outside [0,1]\n  ax.domain = isVertical ? [vFrac + ypad / gs.h, vFrac + lenFrac - ypad / gs.h] : [vFrac + xpad / gs.w, vFrac + lenFrac - xpad / gs.w];\n  ax.setScale();\n  g.attr('transform', strTranslate(Math.round(gs.l), Math.round(gs.t)));\n  var titleCont = g.select('.' + cn.cbtitleunshift).attr('transform', strTranslate(-Math.round(gs.l), -Math.round(gs.t)));\n  var ticklabelposition = ax.ticklabelposition;\n  var titleFontSize = ax.title.font.size;\n  var axLayer = g.select('.' + cn.cbaxis);\n  var titleEl;\n  var titleHeight = 0;\n  var titleWidth = 0;\n  function drawTitle(titleClass, titleOpts) {\n    var dfltTitleOpts = {\n      propContainer: ax,\n      propName: opts._propPrefix + 'title',\n      traceIndex: opts._traceIndex,\n      _meta: opts._meta,\n      placeholder: fullLayout._dfltTitle.colorbar,\n      containerGroup: g.select('.' + cn.cbtitle)\n    };\n\n    // this class-to-rotate thing with convertToTspans is\n    // getting hackier and hackier... delete groups with the\n    // wrong class (in case earlier the colorbar was drawn on\n    // a different side, I think?)\n    var otherClass = titleClass.charAt(0) === 'h' ? titleClass.substr(1) : 'h' + titleClass;\n    g.selectAll('.' + otherClass + ',.' + otherClass + '-math-group').remove();\n    Titles.draw(gd, titleClass, extendFlat(dfltTitleOpts, titleOpts || {}));\n  }\n  function drawDummyTitle() {\n    // draw the title so we know how much room it needs\n    // when we squish the axis.\n    // On vertical colorbars this only applies to top or bottom titles, not right side.\n    // On horizontal colorbars this only applies to right, etc.\n\n    if (isVertical && topOrBottom || !isVertical && !topOrBottom) {\n      var x, y;\n      if (titleSide === 'top') {\n        x = xpad + gs.l + posW * optsX;\n        y = ypad + gs.t + posH * (1 - vFrac - lenFrac) + 3 + titleFontSize * 0.75;\n      }\n      if (titleSide === 'bottom') {\n        x = xpad + gs.l + posW * optsX;\n        y = ypad + gs.t + posH * (1 - vFrac) - 3 - titleFontSize * 0.25;\n      }\n      if (titleSide === 'right') {\n        y = ypad + gs.t + posH * optsY + 3 + titleFontSize * 0.75;\n        x = xpad + gs.l + posW * vFrac;\n      }\n      drawTitle(ax._id + 'title', {\n        attributes: {\n          x: x,\n          y: y,\n          'text-anchor': isVertical ? 'start' : 'middle'\n        }\n      });\n    }\n  }\n  function drawCbTitle() {\n    if (isVertical && !topOrBottom || !isVertical && topOrBottom) {\n      var pos = ax.position || 0;\n      var mid = ax._offset + ax._length / 2;\n      var x, y;\n      if (titleSide === 'right') {\n        y = mid;\n        x = gs.l + posW * pos + 10 + titleFontSize * (ax.showticklabels ? 1 : 0.5);\n      } else {\n        x = mid;\n        if (titleSide === 'bottom') {\n          y = gs.t + posH * pos + 10 + (ticklabelposition.indexOf('inside') === -1 ? ax.tickfont.size : 0) + (ax.ticks !== 'intside' ? opts.ticklen || 0 : 0);\n        }\n        if (titleSide === 'top') {\n          var nlines = title.text.split('<br>').length;\n          y = gs.t + posH * pos + 10 - thickPx - LINE_SPACING * titleFontSize * nlines;\n        }\n      }\n      drawTitle((isVertical ?\n      // the 'h' + is a hack to get around the fact that\n      // convertToTspans rotates any 'y...' class by 90 degrees.\n      // TODO: find a better way to control this.\n      'h' : 'v') + ax._id + 'title', {\n        avoid: {\n          selection: d3.select(gd).selectAll('g.' + ax._id + 'tick'),\n          side: titleSide,\n          offsetTop: isVertical ? 0 : gs.t,\n          offsetLeft: isVertical ? gs.l : 0,\n          maxShift: isVertical ? fullLayout.width : fullLayout.height\n        },\n        attributes: {\n          x: x,\n          y: y,\n          'text-anchor': 'middle'\n        },\n        transform: {\n          rotate: isVertical ? -90 : 0,\n          offset: 0\n        }\n      });\n    }\n  }\n  function drawAxis() {\n    if (!isVertical && !topOrBottom || isVertical && topOrBottom) {\n      // squish the axis top to make room for the title\n      var titleGroup = g.select('.' + cn.cbtitle);\n      var titleText = titleGroup.select('text');\n      var titleTrans = [-outlinewidth / 2, outlinewidth / 2];\n      var mathJaxNode = titleGroup.select('.h' + ax._id + 'title-math-group').node();\n      var lineSize = 15.6;\n      if (titleText.node()) {\n        lineSize = parseInt(titleText.node().style.fontSize, 10) * LINE_SPACING;\n      }\n      var bb;\n      if (mathJaxNode) {\n        bb = Drawing.bBox(mathJaxNode);\n        titleWidth = bb.width;\n        titleHeight = bb.height;\n        if (titleHeight > lineSize) {\n          // not entirely sure how mathjax is doing\n          // vertical alignment, but this seems to work.\n          titleTrans[1] -= (titleHeight - lineSize) / 2;\n        }\n      } else if (titleText.node() && !titleText.classed(cn.jsPlaceholder)) {\n        bb = Drawing.bBox(titleText.node());\n        titleWidth = bb.width;\n        titleHeight = bb.height;\n      }\n      if (isVertical) {\n        if (titleHeight) {\n          // buffer btwn colorbar and title\n          // TODO: configurable\n          titleHeight += 5;\n          if (titleSide === 'top') {\n            ax.domain[1] -= titleHeight / gs.h;\n            titleTrans[1] *= -1;\n          } else {\n            ax.domain[0] += titleHeight / gs.h;\n            var nlines = svgTextUtils.lineCount(titleText);\n            titleTrans[1] += (1 - nlines) * lineSize;\n          }\n          titleGroup.attr('transform', strTranslate(titleTrans[0], titleTrans[1]));\n          ax.setScale();\n        }\n      } else {\n        // horizontal colorbars\n        if (titleWidth) {\n          if (titleSide === 'right') {\n            ax.domain[0] += (titleWidth + titleFontSize / 2) / gs.w;\n          }\n          titleGroup.attr('transform', strTranslate(titleTrans[0], titleTrans[1]));\n          ax.setScale();\n        }\n      }\n    }\n    g.selectAll('.' + cn.cbfills + ',.' + cn.cblines).attr('transform', isVertical ? strTranslate(0, Math.round(gs.h * (1 - ax.domain[1]))) : strTranslate(Math.round(gs.w * ax.domain[0]), 0));\n    axLayer.attr('transform', isVertical ? strTranslate(0, Math.round(-gs.t)) : strTranslate(Math.round(-gs.l), 0));\n    var fills = g.select('.' + cn.cbfills).selectAll('rect.' + cn.cbfill).attr('style', '').data(fillLevels);\n    fills.enter().append('rect').classed(cn.cbfill, true).attr('style', '');\n    fills.exit().remove();\n    var zBounds = zrange.map(ax.c2p).map(Math.round).sort(function (a, b) {\n      return a - b;\n    });\n    fills.each(function (d, i) {\n      var z = [i === 0 ? zrange[0] : (fillLevels[i] + fillLevels[i - 1]) / 2, i === fillLevels.length - 1 ? zrange[1] : (fillLevels[i] + fillLevels[i + 1]) / 2].map(ax.c2p).map(Math.round);\n\n      // offset the side adjoining the next rectangle so they\n      // overlap, to prevent antialiasing gaps\n      if (isVertical) {\n        z[1] = Lib.constrain(z[1] + (z[1] > z[0]) ? 1 : -1, zBounds[0], zBounds[1]);\n      } /* else {\n          // TODO: horizontal case\n        } */\n\n      // Colorbar cannot currently support opacities so we\n      // use an opaque fill even when alpha channels present\n      var fillEl = d3.select(this).attr(isVertical ? 'x' : 'y', uPx).attr(isVertical ? 'y' : 'x', d3.min(z)).attr(isVertical ? 'width' : 'height', Math.max(thickPx, 2)).attr(isVertical ? 'height' : 'width', Math.max(d3.max(z) - d3.min(z), 2));\n      if (opts._fillgradient) {\n        Drawing.gradient(fillEl, gd, opts._id, isVertical ? 'vertical' : 'horizontalreversed', opts._fillgradient, 'fill');\n      } else {\n        // tinycolor can't handle exponents and\n        // at this scale, removing it makes no difference.\n        var colorString = fillColormap(d).replace('e-', '');\n        fillEl.attr('fill', tinycolor(colorString).toHexString());\n      }\n    });\n    var lines = g.select('.' + cn.cblines).selectAll('path.' + cn.cbline).data(line.color && line.width ? lineLevels : []);\n    lines.enter().append('path').classed(cn.cbline, true);\n    lines.exit().remove();\n    lines.each(function (d) {\n      var a = uPx;\n      var b = Math.round(ax.c2p(d)) + line.width / 2 % 1;\n      d3.select(this).attr('d', 'M' + (isVertical ? a + ',' + b : b + ',' + a) + (isVertical ? 'h' : 'v') + thickPx).call(Drawing.lineGroupStyle, line.width, lineColormap(d), line.dash);\n    });\n\n    // force full redraw of labels and ticks\n    axLayer.selectAll('g.' + ax._id + 'tick,path').remove();\n    var shift = uPx + thickPx + (outlinewidth || 0) / 2 - (opts.ticks === 'outside' ? 1 : 0);\n    var vals = Axes.calcTicks(ax);\n    var tickSign = Axes.getTickSigns(ax)[2];\n    Axes.drawTicks(gd, ax, {\n      vals: ax.ticks === 'inside' ? Axes.clipEnds(ax, vals) : vals,\n      layer: axLayer,\n      path: Axes.makeTickPath(ax, shift, tickSign),\n      transFn: Axes.makeTransTickFn(ax)\n    });\n    return Axes.drawLabels(gd, ax, {\n      vals: vals,\n      layer: axLayer,\n      transFn: Axes.makeTransTickLabelFn(ax),\n      labelFns: Axes.makeLabelFns(ax, shift)\n    });\n  }\n\n  // wait for the axis & title to finish rendering before\n  // continuing positioning\n  // TODO: why are we redrawing multiple times now with this?\n  // I guess autoMargin doesn't like being post-promise?\n  function positionCB() {\n    var bb;\n    var innerThickness = thickPx + outlinewidth / 2;\n    if (ticklabelposition.indexOf('inside') === -1) {\n      bb = Drawing.bBox(axLayer.node());\n      innerThickness += isVertical ? bb.width : bb.height;\n    }\n    titleEl = titleCont.select('text');\n    var titleWidth = 0;\n    var topSideVertical = isVertical && titleSide === 'top';\n    var rightSideHorizontal = !isVertical && titleSide === 'right';\n    var moveY = 0;\n    if (titleEl.node() && !titleEl.classed(cn.jsPlaceholder)) {\n      var _titleHeight;\n      var mathJaxNode = titleCont.select('.h' + ax._id + 'title-math-group').node();\n      if (mathJaxNode && (isVertical && topOrBottom || !isVertical && !topOrBottom)) {\n        bb = Drawing.bBox(mathJaxNode);\n        titleWidth = bb.width;\n        _titleHeight = bb.height;\n      } else {\n        // note: the formula below works for all title sides,\n        // (except for top/bottom mathjax, above)\n        // but the weird gs.l is because the titleunshift\n        // transform gets removed by Drawing.bBox\n        bb = Drawing.bBox(titleCont.node());\n        titleWidth = bb.right - gs.l - (isVertical ? uPx : vPx);\n        _titleHeight = bb.bottom - gs.t - (isVertical ? vPx : uPx);\n        if (!isVertical && titleSide === 'top') {\n          innerThickness += bb.height;\n          moveY = bb.height;\n        }\n      }\n      if (rightSideHorizontal) {\n        titleEl.attr('transform', strTranslate(titleWidth / 2 + titleFontSize / 2, 0));\n        titleWidth *= 2;\n      }\n      innerThickness = Math.max(innerThickness, isVertical ? titleWidth : _titleHeight);\n    }\n    var outerThickness = (isVertical ? xpad : ypad) * 2 + innerThickness + borderwidth + outlinewidth / 2;\n    var hColorbarMoveTitle = 0;\n    if (!isVertical && title.text && yanchor === 'bottom' && optsY <= 0) {\n      hColorbarMoveTitle = outerThickness / 2;\n      outerThickness += hColorbarMoveTitle;\n      moveY += hColorbarMoveTitle;\n    }\n    fullLayout._hColorbarMoveTitle = hColorbarMoveTitle;\n    fullLayout._hColorbarMoveCBTitle = moveY;\n    var extraW = borderwidth + outlinewidth;\n\n    // TODO - are these the correct positions?\n    var lx = (isVertical ? uPx : vPx) - extraW / 2 - (isVertical ? xpad : 0);\n    var ly = (isVertical ? vPx : uPx) - (isVertical ? lenPx : ypad + moveY - hColorbarMoveTitle);\n    g.select('.' + cn.cbbg).attr('x', lx).attr('y', ly).attr(isVertical ? 'width' : 'height', Math.max(outerThickness - hColorbarMoveTitle, 2)).attr(isVertical ? 'height' : 'width', Math.max(lenPx + extraW, 2)).call(Color.fill, bgcolor).call(Color.stroke, opts.bordercolor).style('stroke-width', borderwidth);\n    var moveX = rightSideHorizontal ? Math.max(titleWidth - 10, 0) : 0;\n    g.selectAll('.' + cn.cboutline).attr('x', (isVertical ? uPx : vPx + xpad) + moveX).attr('y', (isVertical ? vPx + ypad - lenPx : uPx) + (topSideVertical ? titleHeight : 0)).attr(isVertical ? 'width' : 'height', Math.max(thickPx, 2)).attr(isVertical ? 'height' : 'width', Math.max(lenPx - (isVertical ? 2 * ypad + titleHeight : 2 * xpad + moveX), 2)).call(Color.stroke, opts.outlinecolor).style({\n      fill: 'none',\n      'stroke-width': outlinewidth\n    });\n    var xShift = isVertical ? xRatio * outerThickness : 0;\n    var yShift = isVertical ? 0 : (1 - yRatio) * outerThickness - moveY;\n    xShift = isPaperX ? gs.l - xShift : -xShift;\n    yShift = isPaperY ? gs.t - yShift : -yShift;\n    g.attr('transform', strTranslate(xShift, yShift));\n    if (!isVertical && (borderwidth || tinycolor(bgcolor).getAlpha() && !tinycolor.equals(fullLayout.paper_bgcolor, bgcolor))) {\n      // for horizontal colorbars when there is a border line or having different background color\n      // hide/adjust x positioning for the first/last tick labels if they go outside the border\n      var tickLabels = axLayer.selectAll('text');\n      var numTicks = tickLabels[0].length;\n      var border = g.select('.' + cn.cbbg).node();\n      var oBb = Drawing.bBox(border);\n      var oTr = Drawing.getTranslate(g);\n      var TEXTPAD = 2;\n      tickLabels.each(function (d, i) {\n        var first = 0;\n        var last = numTicks - 1;\n        if (i === first || i === last) {\n          var iBb = Drawing.bBox(this);\n          var iTr = Drawing.getTranslate(this);\n          var deltaX;\n          if (i === last) {\n            var iRight = iBb.right + iTr.x;\n            var oRight = oBb.right + oTr.x + vPx - borderwidth - TEXTPAD + optsX;\n            deltaX = oRight - iRight;\n            if (deltaX > 0) deltaX = 0;\n          } else if (i === first) {\n            var iLeft = iBb.left + iTr.x;\n            var oLeft = oBb.left + oTr.x + vPx + borderwidth + TEXTPAD;\n            deltaX = oLeft - iLeft;\n            if (deltaX < 0) deltaX = 0;\n          }\n          if (deltaX) {\n            if (numTicks < 3) {\n              // adjust position\n              this.setAttribute('transform', 'translate(' + deltaX + ',0) ' + this.getAttribute('transform'));\n            } else {\n              // hide\n              this.setAttribute('visibility', 'hidden');\n            }\n          }\n        }\n      });\n    }\n\n    // auto margin adjustment\n    var marginOpts = {};\n    var lFrac = FROM_TL[xanchor];\n    var rFrac = FROM_BR[xanchor];\n    var tFrac = FROM_TL[yanchor];\n    var bFrac = FROM_BR[yanchor];\n    var extraThickness = outerThickness - thickPx;\n    if (isVertical) {\n      if (lenmode === 'pixels') {\n        marginOpts.y = optsY;\n        marginOpts.t = lenPx * tFrac;\n        marginOpts.b = lenPx * bFrac;\n      } else {\n        marginOpts.t = marginOpts.b = 0;\n        marginOpts.yt = optsY + len * tFrac;\n        marginOpts.yb = optsY - len * bFrac;\n      }\n      if (thicknessmode === 'pixels') {\n        marginOpts.x = optsX;\n        marginOpts.l = outerThickness * lFrac;\n        marginOpts.r = outerThickness * rFrac;\n      } else {\n        marginOpts.l = extraThickness * lFrac;\n        marginOpts.r = extraThickness * rFrac;\n        marginOpts.xl = optsX - thickness * lFrac;\n        marginOpts.xr = optsX + thickness * rFrac;\n      }\n    } else {\n      // horizontal colorbars\n      if (lenmode === 'pixels') {\n        marginOpts.x = optsX;\n        marginOpts.l = lenPx * lFrac;\n        marginOpts.r = lenPx * rFrac;\n      } else {\n        marginOpts.l = marginOpts.r = 0;\n        marginOpts.xl = optsX + len * lFrac;\n        marginOpts.xr = optsX - len * rFrac;\n      }\n      if (thicknessmode === 'pixels') {\n        marginOpts.y = 1 - optsY;\n        marginOpts.t = outerThickness * tFrac;\n        marginOpts.b = outerThickness * bFrac;\n      } else {\n        marginOpts.t = extraThickness * tFrac;\n        marginOpts.b = extraThickness * bFrac;\n        marginOpts.yt = optsY - thickness * tFrac;\n        marginOpts.yb = optsY + thickness * bFrac;\n      }\n    }\n    var sideY = opts.y < 0.5 ? 'b' : 't';\n    var sideX = opts.x < 0.5 ? 'l' : 'r';\n    gd._fullLayout._reservedMargin[opts._id] = {};\n    var possibleReservedMargins = {\n      r: fullLayout.width - lx - xShift,\n      l: lx + marginOpts.r,\n      b: fullLayout.height - ly - yShift,\n      t: ly + marginOpts.b\n    };\n    if (isPaperX && isPaperY) {\n      Plots.autoMargin(gd, opts._id, marginOpts);\n    } else if (isPaperX) {\n      gd._fullLayout._reservedMargin[opts._id][sideY] = possibleReservedMargins[sideY];\n    } else if (isPaperY) {\n      gd._fullLayout._reservedMargin[opts._id][sideX] = possibleReservedMargins[sideX];\n    } else {\n      if (isVertical) {\n        gd._fullLayout._reservedMargin[opts._id][sideX] = possibleReservedMargins[sideX];\n      } else {\n        gd._fullLayout._reservedMargin[opts._id][sideY] = possibleReservedMargins[sideY];\n      }\n    }\n  }\n  return Lib.syncOrAsync([Plots.previousPromises, drawDummyTitle, drawAxis, drawCbTitle, Plots.previousPromises, positionCB], gd);\n}\nfunction makeEditable(g, opts, gd) {\n  var isVertical = opts.orientation === 'v';\n  var fullLayout = gd._fullLayout;\n  var gs = fullLayout._size;\n  var t0, xf, yf;\n  dragElement.init({\n    element: g.node(),\n    gd: gd,\n    prepFn: function () {\n      t0 = g.attr('transform');\n      setCursor(g);\n    },\n    moveFn: function (dx, dy) {\n      g.attr('transform', t0 + strTranslate(dx, dy));\n      xf = dragElement.align((isVertical ? opts._uFrac : opts._vFrac) + dx / gs.w, isVertical ? opts._thickFrac : opts._lenFrac, 0, 1, opts.xanchor);\n      yf = dragElement.align((isVertical ? opts._vFrac : 1 - opts._uFrac) - dy / gs.h, isVertical ? opts._lenFrac : opts._thickFrac, 0, 1, opts.yanchor);\n      var csr = dragElement.getCursor(xf, yf, opts.xanchor, opts.yanchor);\n      setCursor(g, csr);\n    },\n    doneFn: function () {\n      setCursor(g);\n      if (xf !== undefined && yf !== undefined) {\n        var update = {};\n        update[opts._propPrefix + 'x'] = xf;\n        update[opts._propPrefix + 'y'] = yf;\n        if (opts._traceIndex !== undefined) {\n          Registry.call('_guiRestyle', gd, update, opts._traceIndex);\n        } else {\n          Registry.call('_guiRelayout', gd, update);\n        }\n      }\n    }\n  });\n}\nfunction calcLevels(gd, opts, zrange) {\n  var levelsIn = opts._levels;\n  var lineLevels = [];\n  var fillLevels = [];\n  var l;\n  var i;\n  var l0 = levelsIn.end + levelsIn.size / 100;\n  var ls = levelsIn.size;\n  var zr0 = 1.001 * zrange[0] - 0.001 * zrange[1];\n  var zr1 = 1.001 * zrange[1] - 0.001 * zrange[0];\n  for (i = 0; i < 1e5; i++) {\n    l = levelsIn.start + i * ls;\n    if (ls > 0 ? l >= l0 : l <= l0) break;\n    if (l > zr0 && l < zr1) lineLevels.push(l);\n  }\n  if (opts._fillgradient) {\n    fillLevels = [0];\n  } else if (typeof opts._fillcolor === 'function') {\n    var fillLevelsIn = opts._filllevels;\n    if (fillLevelsIn) {\n      l0 = fillLevelsIn.end + fillLevelsIn.size / 100;\n      ls = fillLevelsIn.size;\n      for (i = 0; i < 1e5; i++) {\n        l = fillLevelsIn.start + i * ls;\n        if (ls > 0 ? l >= l0 : l <= l0) break;\n        if (l > zrange[0] && l < zrange[1]) fillLevels.push(l);\n      }\n    } else {\n      fillLevels = lineLevels.map(function (v) {\n        return v - levelsIn.size / 2;\n      });\n      fillLevels.push(fillLevels[fillLevels.length - 1] + levelsIn.size);\n    }\n  } else if (opts._fillcolor && typeof opts._fillcolor === 'string') {\n    // doesn't matter what this value is, with a single value\n    // we'll make a single fill rect covering the whole bar\n    fillLevels = [0];\n  }\n  if (levelsIn.size < 0) {\n    lineLevels.reverse();\n    fillLevels.reverse();\n  }\n  return {\n    line: lineLevels,\n    fill: fillLevels\n  };\n}\nfunction mockColorBarAxis(gd, opts, zrange) {\n  var fullLayout = gd._fullLayout;\n  var isVertical = opts.orientation === 'v';\n  var cbAxisIn = {\n    type: 'linear',\n    range: zrange,\n    tickmode: opts.tickmode,\n    nticks: opts.nticks,\n    tick0: opts.tick0,\n    dtick: opts.dtick,\n    tickvals: opts.tickvals,\n    ticktext: opts.ticktext,\n    ticks: opts.ticks,\n    ticklen: opts.ticklen,\n    tickwidth: opts.tickwidth,\n    tickcolor: opts.tickcolor,\n    showticklabels: opts.showticklabels,\n    labelalias: opts.labelalias,\n    ticklabelposition: opts.ticklabelposition,\n    ticklabeloverflow: opts.ticklabeloverflow,\n    ticklabelstep: opts.ticklabelstep,\n    tickfont: opts.tickfont,\n    tickangle: opts.tickangle,\n    tickformat: opts.tickformat,\n    exponentformat: opts.exponentformat,\n    minexponent: opts.minexponent,\n    separatethousands: opts.separatethousands,\n    showexponent: opts.showexponent,\n    showtickprefix: opts.showtickprefix,\n    tickprefix: opts.tickprefix,\n    showticksuffix: opts.showticksuffix,\n    ticksuffix: opts.ticksuffix,\n    title: opts.title,\n    showline: true,\n    anchor: 'free',\n    side: isVertical ? 'right' : 'bottom',\n    position: 1\n  };\n  var letter = isVertical ? 'y' : 'x';\n  var cbAxisOut = {\n    type: 'linear',\n    _id: letter + opts._id\n  };\n  var axisOptions = {\n    letter: letter,\n    font: fullLayout.font,\n    noAutotickangles: letter === 'y',\n    noHover: true,\n    noTickson: true,\n    noTicklabelmode: true,\n    noInsideRange: true,\n    calendar: fullLayout.calendar // not really necessary (yet?)\n  };\n  function coerce(attr, dflt) {\n    return Lib.coerce(cbAxisIn, cbAxisOut, axisLayoutAttrs, attr, dflt);\n  }\n  handleAxisDefaults(cbAxisIn, cbAxisOut, coerce, axisOptions, fullLayout);\n  handleAxisPositionDefaults(cbAxisIn, cbAxisOut, coerce, axisOptions);\n  return cbAxisOut;\n}\nmodule.exports = {\n  draw: draw\n};","map":{"version":3,"names":["d3","require","tinycolor","Plots","Registry","Axes","dragElement","Lib","strTranslate","extendFlat","setCursor","Drawing","Color","Titles","svgTextUtils","flipScale","handleAxisDefaults","handleAxisPositionDefaults","axisLayoutAttrs","alignmentConstants","LINE_SPACING","FROM_TL","FROM_BR","cn","draw","gd","fullLayout","_fullLayout","colorBars","_infolayer","selectAll","colorbar","data","makeColorBarData","opts","_id","enter","append","attr","classed","each","g","select","ensureSingle","cbbg","cbfills","cblines","cbaxis","s","crisp","cbtitleunshift","cbtitle","cboutline","done","drawColorBar","then","_promises","push","_context","edits","colorbarPosition","makeEditable","exit","autoMargin","remove","order","calcdata","out","cont","trace","cbOpt","initOpts","_fillcolor","_line","color","width","dash","_levels","start","end","size","_filllevels","_fillgradient","_zrange","calcOpts","calc","reversescale","colorscale","min","max","i","length","cd","_module","moduleOpts","visible","allowsMultiplotCbs","Array","isArray","cbOpts","j","contName","container","showscale","uid","_traceIndex","index","_propPrefix","_meta","k","_colorAxes","colorAxOpts","isVertical","orientation","len","lenmode","thickness","thicknessmode","outlinewidth","borderwidth","bgcolor","xanchor","yanchor","xpad","ypad","optsX","x","optsY","y","isPaperY","yref","isPaperX","xref","gs","_size","fillColor","line","title","titleSide","side","zrange","extent","domain","lineColormap","fillColormap","levelsIn","levelsOut","calcLevels","fillLevels","fill","lineLevels","thickPx","Math","round","w","h","thickFrac","lenPx","lenFrac","posW","posH","height","uPx","xRatio","center","right","yRatio","top","middle","uFrac","vFrac","vPx","_lenFrac","_thickFrac","_uFrac","_vFrac","ax","_axis","mockColorBarAxis","position","topOrBottom","indexOf","titlex","titley","tickmode","tick0","dtick","autoNtick","constrain","dtFactor","nticks","dtexp","pow","floor","log","LN10","roundUp","abs","setScale","l","t","titleCont","ticklabelposition","titleFontSize","font","axLayer","titleEl","titleHeight","titleWidth","drawTitle","titleClass","titleOpts","dfltTitleOpts","propContainer","propName","traceIndex","placeholder","_dfltTitle","containerGroup","otherClass","charAt","substr","drawDummyTitle","attributes","drawCbTitle","pos","mid","_offset","_length","showticklabels","tickfont","ticks","ticklen","nlines","text","split","avoid","selection","offsetTop","offsetLeft","maxShift","transform","rotate","offset","drawAxis","titleGroup","titleText","titleTrans","mathJaxNode","node","lineSize","parseInt","style","fontSize","bb","bBox","jsPlaceholder","lineCount","fills","cbfill","zBounds","map","c2p","sort","a","b","d","z","fillEl","gradient","colorString","replace","toHexString","lines","cbline","call","lineGroupStyle","shift","vals","calcTicks","tickSign","getTickSigns","drawTicks","clipEnds","layer","path","makeTickPath","transFn","makeTransTickFn","drawLabels","makeTransTickLabelFn","labelFns","makeLabelFns","positionCB","innerThickness","topSideVertical","rightSideHorizontal","moveY","_titleHeight","bottom","outerThickness","hColorbarMoveTitle","_hColorbarMoveTitle","_hColorbarMoveCBTitle","extraW","lx","ly","stroke","bordercolor","moveX","outlinecolor","xShift","yShift","getAlpha","equals","paper_bgcolor","tickLabels","numTicks","border","oBb","oTr","getTranslate","TEXTPAD","first","last","iBb","iTr","deltaX","iRight","oRight","iLeft","left","oLeft","setAttribute","getAttribute","marginOpts","lFrac","rFrac","tFrac","bFrac","extraThickness","yt","yb","r","xl","xr","sideY","sideX","_reservedMargin","possibleReservedMargins","syncOrAsync","previousPromises","t0","xf","yf","init","element","prepFn","moveFn","dx","dy","align","csr","getCursor","doneFn","undefined","update","l0","ls","zr0","zr1","fillLevelsIn","v","reverse","cbAxisIn","type","range","tickvals","ticktext","tickwidth","tickcolor","labelalias","ticklabeloverflow","ticklabelstep","tickangle","tickformat","exponentformat","minexponent","separatethousands","showexponent","showtickprefix","tickprefix","showticksuffix","ticksuffix","showline","anchor","letter","cbAxisOut","axisOptions","noAutotickangles","noHover","noTickson","noTicklabelmode","noInsideRange","calendar","coerce","dflt","module","exports"],"sources":["E:/tog_workspace/TestFabric_main/TestFabric-main/node_modules/plotly.js/src/components/colorbar/draw.js"],"sourcesContent":["'use strict';\n\nvar d3 = require('@plotly/d3');\nvar tinycolor = require('tinycolor2');\n\nvar Plots = require('../../plots/plots');\nvar Registry = require('../../registry');\nvar Axes = require('../../plots/cartesian/axes');\nvar dragElement = require('../dragelement');\nvar Lib = require('../../lib');\nvar strTranslate = Lib.strTranslate;\nvar extendFlat = require('../../lib/extend').extendFlat;\nvar setCursor = require('../../lib/setcursor');\nvar Drawing = require('../drawing');\nvar Color = require('../color');\nvar Titles = require('../titles');\nvar svgTextUtils = require('../../lib/svg_text_utils');\nvar flipScale = require('../colorscale/helpers').flipScale;\n\nvar handleAxisDefaults = require('../../plots/cartesian/axis_defaults');\nvar handleAxisPositionDefaults = require('../../plots/cartesian/position_defaults');\nvar axisLayoutAttrs = require('../../plots/cartesian/layout_attributes');\n\nvar alignmentConstants = require('../../constants/alignment');\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar FROM_TL = alignmentConstants.FROM_TL;\nvar FROM_BR = alignmentConstants.FROM_BR;\n\nvar cn = require('./constants').cn;\n\nfunction draw(gd) {\n    var fullLayout = gd._fullLayout;\n\n    var colorBars = fullLayout._infolayer\n        .selectAll('g.' + cn.colorbar)\n        .data(makeColorBarData(gd), function(opts) { return opts._id; });\n\n    colorBars.enter().append('g')\n        .attr('class', function(opts) { return opts._id; })\n        .classed(cn.colorbar, true);\n\n    colorBars.each(function(opts) {\n        var g = d3.select(this);\n\n        Lib.ensureSingle(g, 'rect', cn.cbbg);\n        Lib.ensureSingle(g, 'g', cn.cbfills);\n        Lib.ensureSingle(g, 'g', cn.cblines);\n        Lib.ensureSingle(g, 'g', cn.cbaxis, function(s) { s.classed(cn.crisp, true); });\n        Lib.ensureSingle(g, 'g', cn.cbtitleunshift, function(s) { s.append('g').classed(cn.cbtitle, true); });\n        Lib.ensureSingle(g, 'rect', cn.cboutline);\n\n        var done = drawColorBar(g, opts, gd);\n        if(done && done.then) (gd._promises || []).push(done);\n\n        if(gd._context.edits.colorbarPosition) {\n            makeEditable(g, opts, gd);\n        }\n    });\n\n    colorBars.exit()\n        .each(function(opts) { Plots.autoMargin(gd, opts._id); })\n        .remove();\n\n    colorBars.order();\n}\n\nfunction makeColorBarData(gd) {\n    var fullLayout = gd._fullLayout;\n    var calcdata = gd.calcdata;\n    var out = [];\n\n    // single out item\n    var opts;\n    // colorbar attr parent container\n    var cont;\n    // trace attr container\n    var trace;\n    // colorbar options\n    var cbOpt;\n\n    function initOpts(opts) {\n        return extendFlat(opts, {\n            // fillcolor can be a d3 scale, domain is z values, range is colors\n            // or leave it out for no fill,\n            // or set to a string constant for single-color fill\n            _fillcolor: null,\n            // line.color has the same options as fillcolor\n            _line: {color: null, width: null, dash: null},\n            // levels of lines to draw.\n            // note that this DOES NOT determine the extent of the bar\n            // that's given by the domain of fillcolor\n            // (or line.color if no fillcolor domain)\n            _levels: {start: null, end: null, size: null},\n            // separate fill levels (for example, heatmap coloring of a\n            // contour map) if this is omitted, fillcolors will be\n            // evaluated halfway between levels\n            _filllevels: null,\n            // for continuous colorscales: fill with a gradient instead of explicit levels\n            // value should be the colorscale [[0, c0], [v1, c1], ..., [1, cEnd]]\n            _fillgradient: null,\n            // when using a gradient, we need the data range specified separately\n            _zrange: null\n        });\n    }\n\n    function calcOpts() {\n        if(typeof cbOpt.calc === 'function') {\n            cbOpt.calc(gd, trace, opts);\n        } else {\n            opts._fillgradient = cont.reversescale ?\n                flipScale(cont.colorscale) :\n                cont.colorscale;\n            opts._zrange = [cont[cbOpt.min], cont[cbOpt.max]];\n        }\n    }\n\n    for(var i = 0; i < calcdata.length; i++) {\n        var cd = calcdata[i];\n        trace = cd[0].trace;\n        if(!trace._module) continue;\n        var moduleOpts = trace._module.colorbar;\n\n        if(trace.visible === true && moduleOpts) {\n            var allowsMultiplotCbs = Array.isArray(moduleOpts);\n            var cbOpts = allowsMultiplotCbs ? moduleOpts : [moduleOpts];\n\n            for(var j = 0; j < cbOpts.length; j++) {\n                cbOpt = cbOpts[j];\n                var contName = cbOpt.container;\n                cont = contName ? trace[contName] : trace;\n\n                if(cont && cont.showscale) {\n                    opts = initOpts(cont.colorbar);\n                    opts._id = 'cb' + trace.uid + (allowsMultiplotCbs && contName ? '-' + contName : '');\n                    opts._traceIndex = trace.index;\n                    opts._propPrefix = (contName ? contName + '.' : '') + 'colorbar.';\n                    opts._meta = trace._meta;\n                    calcOpts();\n                    out.push(opts);\n                }\n            }\n        }\n    }\n\n    for(var k in fullLayout._colorAxes) {\n        cont = fullLayout[k];\n\n        if(cont.showscale) {\n            var colorAxOpts = fullLayout._colorAxes[k];\n\n            opts = initOpts(cont.colorbar);\n            opts._id = 'cb' + k;\n            opts._propPrefix = k + '.colorbar.';\n            opts._meta = fullLayout._meta;\n\n            cbOpt = {min: 'cmin', max: 'cmax'};\n            if(colorAxOpts[0] !== 'heatmap') {\n                trace = colorAxOpts[1];\n                cbOpt.calc = trace._module.colorbar.calc;\n            }\n\n            calcOpts();\n            out.push(opts);\n        }\n    }\n\n    return out;\n}\n\nfunction drawColorBar(g, opts, gd) {\n    var isVertical = opts.orientation === 'v';\n    var len = opts.len;\n    var lenmode = opts.lenmode;\n    var thickness = opts.thickness;\n    var thicknessmode = opts.thicknessmode;\n    var outlinewidth = opts.outlinewidth;\n    var borderwidth = opts.borderwidth;\n    var bgcolor = opts.bgcolor;\n    var xanchor = opts.xanchor;\n    var yanchor = opts.yanchor;\n    var xpad = opts.xpad;\n    var ypad = opts.ypad;\n    var optsX = opts.x;\n    var optsY = isVertical ? opts.y : 1 - opts.y;\n\n    var isPaperY = opts.yref === 'paper';\n    var isPaperX = opts.xref === 'paper';\n\n    var fullLayout = gd._fullLayout;\n    var gs = fullLayout._size;\n\n    var fillColor = opts._fillcolor;\n    var line = opts._line;\n    var title = opts.title;\n    var titleSide = title.side;\n\n    var zrange = opts._zrange ||\n        d3.extent((typeof fillColor === 'function' ? fillColor : line.color).domain());\n\n    var lineColormap = typeof line.color === 'function' ?\n        line.color :\n        function() { return line.color; };\n    var fillColormap = typeof fillColor === 'function' ?\n        fillColor :\n        function() { return fillColor; };\n\n    var levelsIn = opts._levels;\n    var levelsOut = calcLevels(gd, opts, zrange);\n    var fillLevels = levelsOut.fill;\n    var lineLevels = levelsOut.line;\n\n    // we calculate pixel sizes based on the specified graph size,\n    // not the actual (in case something pushed the margins around)\n    // which is a little odd but avoids an odd iterative effect\n    // when the colorbar itself is pushing the margins.\n    // but then the fractional size is calculated based on the\n    // actual graph size, so that the axes will size correctly.\n    var thickPx = Math.round(thickness * (thicknessmode === 'fraction' ? (isVertical ? gs.w : gs.h) : 1));\n    var thickFrac = thickPx / (isVertical ? gs.w : gs.h);\n    var lenPx = Math.round(len * (lenmode === 'fraction' ? (isVertical ? gs.h : gs.w) : 1));\n    var lenFrac = lenPx / (isVertical ? gs.h : gs.w);\n\n    var posW = isPaperX ? gs.w : gd._fullLayout.width;\n    var posH = isPaperY ? gs.h : gd._fullLayout.height;\n\n    // x positioning: do it initially just for left anchor,\n    // then fix at the end (since we don't know the width yet)\n    var uPx = Math.round(isVertical ?\n        optsX * posW + xpad :\n        optsY * posH + ypad\n    );\n\n    var xRatio = {center: 0.5, right: 1}[xanchor] || 0;\n    var yRatio = {top: 1, middle: 0.5}[yanchor] || 0;\n\n    // for dragging... this is getting a little muddled...\n    var uFrac = isVertical ?\n        optsX - xRatio * thickFrac :\n        optsY - yRatio * thickFrac;\n\n    // y/x positioning (for v/h) we can do correctly from the start\n    var vFrac = isVertical ?\n        optsY - yRatio * lenFrac :\n        optsX - xRatio * lenFrac;\n\n    var vPx = Math.round(isVertical ?\n        posH * (1 - vFrac) :\n        posW * vFrac\n    );\n\n    // stash a few things for makeEditable\n    opts._lenFrac = lenFrac;\n    opts._thickFrac = thickFrac;\n    opts._uFrac = uFrac;\n    opts._vFrac = vFrac;\n\n    // stash mocked axis for contour label formatting\n    var ax = opts._axis = mockColorBarAxis(gd, opts, zrange);\n\n    // position can't go in through supplyDefaults\n    // because that restricts it to [0,1]\n    ax.position = thickFrac + (isVertical ?\n        optsX + xpad / gs.w :\n        optsY + ypad / gs.h\n    );\n\n    var topOrBottom = ['top', 'bottom'].indexOf(titleSide) !== -1;\n\n    if(isVertical && topOrBottom) {\n        ax.title.side = titleSide;\n        ax.titlex = optsX + xpad / gs.w;\n        ax.titley = vFrac + (title.side === 'top' ? lenFrac - ypad / gs.h : ypad / gs.h);\n    }\n\n    if(!isVertical && !topOrBottom) {\n        ax.title.side = titleSide;\n        ax.titley = optsY + ypad / gs.h;\n        ax.titlex = vFrac + xpad / gs.w; // right side\n    }\n\n    if(line.color && opts.tickmode === 'auto') {\n        ax.tickmode = 'linear';\n        ax.tick0 = levelsIn.start;\n        var dtick = levelsIn.size;\n        // expand if too many contours, so we don't get too many ticks\n        var autoNtick = Lib.constrain(lenPx / 50, 4, 15) + 1;\n        var dtFactor = (zrange[1] - zrange[0]) / ((opts.nticks || autoNtick) * dtick);\n        if(dtFactor > 1) {\n            var dtexp = Math.pow(10, Math.floor(Math.log(dtFactor) / Math.LN10));\n            dtick *= dtexp * Lib.roundUp(dtFactor / dtexp, [2, 5, 10]);\n            // if the contours are at round multiples, reset tick0\n            // so they're still at round multiples. Otherwise,\n            // keep the first label on the first contour level\n            if((Math.abs(levelsIn.start) / levelsIn.size + 1e-6) % 1 < 2e-6) {\n                ax.tick0 = 0;\n            }\n        }\n        ax.dtick = dtick;\n    }\n\n    // set domain after init, because we may want to\n    // allow it outside [0,1]\n    ax.domain = isVertical ? [\n        vFrac + ypad / gs.h,\n        vFrac + lenFrac - ypad / gs.h\n    ] : [\n        vFrac + xpad / gs.w,\n        vFrac + lenFrac - xpad / gs.w\n    ];\n\n    ax.setScale();\n\n    g.attr('transform', strTranslate(Math.round(gs.l), Math.round(gs.t)));\n\n    var titleCont = g.select('.' + cn.cbtitleunshift)\n        .attr('transform', strTranslate(-Math.round(gs.l), -Math.round(gs.t)));\n\n    var ticklabelposition = ax.ticklabelposition;\n    var titleFontSize = ax.title.font.size;\n\n    var axLayer = g.select('.' + cn.cbaxis);\n    var titleEl;\n    var titleHeight = 0;\n    var titleWidth = 0;\n\n    function drawTitle(titleClass, titleOpts) {\n        var dfltTitleOpts = {\n            propContainer: ax,\n            propName: opts._propPrefix + 'title',\n            traceIndex: opts._traceIndex,\n            _meta: opts._meta,\n            placeholder: fullLayout._dfltTitle.colorbar,\n            containerGroup: g.select('.' + cn.cbtitle)\n        };\n\n        // this class-to-rotate thing with convertToTspans is\n        // getting hackier and hackier... delete groups with the\n        // wrong class (in case earlier the colorbar was drawn on\n        // a different side, I think?)\n        var otherClass = titleClass.charAt(0) === 'h' ?\n            titleClass.substr(1) :\n            'h' + titleClass;\n        g.selectAll('.' + otherClass + ',.' + otherClass + '-math-group').remove();\n\n        Titles.draw(gd, titleClass, extendFlat(dfltTitleOpts, titleOpts || {}));\n    }\n\n    function drawDummyTitle() {\n        // draw the title so we know how much room it needs\n        // when we squish the axis.\n        // On vertical colorbars this only applies to top or bottom titles, not right side.\n        // On horizontal colorbars this only applies to right, etc.\n\n        if(\n            (isVertical && topOrBottom) ||\n            (!isVertical && !topOrBottom)\n        ) {\n            var x, y;\n\n            if(titleSide === 'top') {\n                x = xpad + gs.l + posW * optsX;\n                y = ypad + gs.t + posH * (1 - vFrac - lenFrac) + 3 + titleFontSize * 0.75;\n            }\n\n            if(titleSide === 'bottom') {\n                x = xpad + gs.l + posW * optsX;\n                y = ypad + gs.t + posH * (1 - vFrac) - 3 - titleFontSize * 0.25;\n            }\n\n            if(titleSide === 'right') {\n                y = ypad + gs.t + posH * optsY + 3 + titleFontSize * 0.75;\n                x = xpad + gs.l + posW * vFrac;\n            }\n\n            drawTitle(ax._id + 'title', {\n                attributes: {x: x, y: y, 'text-anchor': isVertical ? 'start' : 'middle'}\n            });\n        }\n    }\n\n    function drawCbTitle() {\n        if(\n            (isVertical && !topOrBottom) ||\n            (!isVertical && topOrBottom)\n        ) {\n            var pos = ax.position || 0;\n            var mid = ax._offset + ax._length / 2;\n            var x, y;\n\n            if(titleSide === 'right') {\n                y = mid;\n                x = gs.l + posW * pos + 10 + titleFontSize * (\n                    ax.showticklabels ? 1 : 0.5\n                );\n            } else {\n                x = mid;\n\n                if(titleSide === 'bottom') {\n                    y = gs.t + posH * pos + 10 + (\n                        ticklabelposition.indexOf('inside') === -1 ?\n                            ax.tickfont.size :\n                            0\n                    ) + (\n                        ax.ticks !== 'intside' ?\n                            opts.ticklen || 0 :\n                            0\n                    );\n                }\n\n                if(titleSide === 'top') {\n                    var nlines = title.text.split('<br>').length;\n                    y = gs.t + posH * pos + 10 - thickPx - LINE_SPACING * titleFontSize * nlines;\n                }\n            }\n\n            drawTitle((isVertical ?\n                // the 'h' + is a hack to get around the fact that\n                // convertToTspans rotates any 'y...' class by 90 degrees.\n                // TODO: find a better way to control this.\n                'h' :\n                'v'\n            ) + ax._id + 'title', {\n                avoid: {\n                    selection: d3.select(gd).selectAll('g.' + ax._id + 'tick'),\n                    side: titleSide,\n                    offsetTop: isVertical ? 0 : gs.t,\n                    offsetLeft: isVertical ? gs.l : 0,\n                    maxShift: isVertical ? fullLayout.width : fullLayout.height\n                },\n                attributes: {x: x, y: y, 'text-anchor': 'middle'},\n                transform: {rotate: isVertical ? -90 : 0, offset: 0}\n            });\n        }\n    }\n\n    function drawAxis() {\n        if(\n            (!isVertical && !topOrBottom) ||\n            (isVertical && topOrBottom)\n        ) {\n            // squish the axis top to make room for the title\n            var titleGroup = g.select('.' + cn.cbtitle);\n            var titleText = titleGroup.select('text');\n            var titleTrans = [-outlinewidth / 2, outlinewidth / 2];\n            var mathJaxNode = titleGroup\n                .select('.h' + ax._id + 'title-math-group')\n                .node();\n            var lineSize = 15.6;\n            if(titleText.node()) {\n                lineSize = parseInt(titleText.node().style.fontSize, 10) * LINE_SPACING;\n            }\n\n            var bb;\n            if(mathJaxNode) {\n                bb = Drawing.bBox(mathJaxNode);\n                titleWidth = bb.width;\n                titleHeight = bb.height;\n                if(titleHeight > lineSize) {\n                    // not entirely sure how mathjax is doing\n                    // vertical alignment, but this seems to work.\n                    titleTrans[1] -= (titleHeight - lineSize) / 2;\n                }\n            } else if(titleText.node() && !titleText.classed(cn.jsPlaceholder)) {\n                bb = Drawing.bBox(titleText.node());\n                titleWidth = bb.width;\n                titleHeight = bb.height;\n            }\n\n            if(isVertical) {\n                if(titleHeight) {\n                    // buffer btwn colorbar and title\n                    // TODO: configurable\n                    titleHeight += 5;\n\n                    if(titleSide === 'top') {\n                        ax.domain[1] -= titleHeight / gs.h;\n                        titleTrans[1] *= -1;\n                    } else {\n                        ax.domain[0] += titleHeight / gs.h;\n                        var nlines = svgTextUtils.lineCount(titleText);\n                        titleTrans[1] += (1 - nlines) * lineSize;\n                    }\n\n                    titleGroup.attr('transform', strTranslate(titleTrans[0], titleTrans[1]));\n                    ax.setScale();\n                }\n            } else { // horizontal colorbars\n                if(titleWidth) {\n                    if(titleSide === 'right') {\n                        ax.domain[0] += (titleWidth + titleFontSize / 2) / gs.w;\n                    }\n\n                    titleGroup.attr('transform', strTranslate(titleTrans[0], titleTrans[1]));\n                    ax.setScale();\n                }\n            }\n        }\n\n        g.selectAll('.' + cn.cbfills + ',.' + cn.cblines)\n            .attr('transform', isVertical ?\n                strTranslate(0, Math.round(gs.h * (1 - ax.domain[1]))) :\n                strTranslate(Math.round(gs.w * ax.domain[0]), 0)\n            );\n\n        axLayer.attr('transform', isVertical ?\n            strTranslate(0, Math.round(-gs.t)) :\n            strTranslate(Math.round(-gs.l), 0)\n        );\n\n        var fills = g.select('.' + cn.cbfills)\n            .selectAll('rect.' + cn.cbfill)\n            .attr('style', '')\n            .data(fillLevels);\n        fills.enter().append('rect')\n            .classed(cn.cbfill, true)\n            .attr('style', '');\n        fills.exit().remove();\n\n        var zBounds = zrange\n            .map(ax.c2p)\n            .map(Math.round)\n            .sort(function(a, b) { return a - b; });\n\n        fills.each(function(d, i) {\n            var z = [\n                (i === 0) ? zrange[0] : (fillLevels[i] + fillLevels[i - 1]) / 2,\n                (i === fillLevels.length - 1) ? zrange[1] : (fillLevels[i] + fillLevels[i + 1]) / 2\n            ]\n            .map(ax.c2p)\n            .map(Math.round);\n\n            // offset the side adjoining the next rectangle so they\n            // overlap, to prevent antialiasing gaps\n            if(isVertical) {\n                z[1] = Lib.constrain(z[1] + (z[1] > z[0]) ? 1 : -1, zBounds[0], zBounds[1]);\n            } /* else {\n                // TODO: horizontal case\n            } */\n\n            // Colorbar cannot currently support opacities so we\n            // use an opaque fill even when alpha channels present\n            var fillEl = d3.select(this)\n            .attr(isVertical ? 'x' : 'y', uPx)\n            .attr(isVertical ? 'y' : 'x', d3.min(z))\n            .attr(isVertical ? 'width' : 'height', Math.max(thickPx, 2))\n            .attr(isVertical ? 'height' : 'width', Math.max(d3.max(z) - d3.min(z), 2));\n\n            if(opts._fillgradient) {\n                Drawing.gradient(fillEl, gd, opts._id, isVertical ? 'vertical' : 'horizontalreversed', opts._fillgradient, 'fill');\n            } else {\n                // tinycolor can't handle exponents and\n                // at this scale, removing it makes no difference.\n                var colorString = fillColormap(d).replace('e-', '');\n                fillEl.attr('fill', tinycolor(colorString).toHexString());\n            }\n        });\n\n        var lines = g.select('.' + cn.cblines)\n            .selectAll('path.' + cn.cbline)\n            .data(line.color && line.width ? lineLevels : []);\n        lines.enter().append('path')\n            .classed(cn.cbline, true);\n        lines.exit().remove();\n        lines.each(function(d) {\n            var a = uPx;\n            var b = (Math.round(ax.c2p(d)) + (line.width / 2) % 1);\n\n            d3.select(this)\n                .attr('d', 'M' +\n                    (isVertical ? a + ',' + b : b + ',' + a) +\n                    (isVertical ? 'h' : 'v') +\n                    thickPx\n                )\n                .call(Drawing.lineGroupStyle, line.width, lineColormap(d), line.dash);\n        });\n\n        // force full redraw of labels and ticks\n        axLayer.selectAll('g.' + ax._id + 'tick,path').remove();\n\n        var shift = uPx + thickPx +\n            (outlinewidth || 0) / 2 - (opts.ticks === 'outside' ? 1 : 0);\n\n        var vals = Axes.calcTicks(ax);\n        var tickSign = Axes.getTickSigns(ax)[2];\n\n        Axes.drawTicks(gd, ax, {\n            vals: ax.ticks === 'inside' ? Axes.clipEnds(ax, vals) : vals,\n            layer: axLayer,\n            path: Axes.makeTickPath(ax, shift, tickSign),\n            transFn: Axes.makeTransTickFn(ax)\n        });\n\n        return Axes.drawLabels(gd, ax, {\n            vals: vals,\n            layer: axLayer,\n            transFn: Axes.makeTransTickLabelFn(ax),\n            labelFns: Axes.makeLabelFns(ax, shift)\n        });\n    }\n\n    // wait for the axis & title to finish rendering before\n    // continuing positioning\n    // TODO: why are we redrawing multiple times now with this?\n    // I guess autoMargin doesn't like being post-promise?\n    function positionCB() {\n        var bb;\n        var innerThickness = thickPx + outlinewidth / 2;\n        if(ticklabelposition.indexOf('inside') === -1) {\n            bb = Drawing.bBox(axLayer.node());\n            innerThickness += isVertical ? bb.width : bb.height;\n        }\n\n        titleEl = titleCont.select('text');\n\n        var titleWidth = 0;\n\n        var topSideVertical = isVertical && titleSide === 'top';\n        var rightSideHorizontal = !isVertical && titleSide === 'right';\n\n        var moveY = 0;\n\n        if(titleEl.node() && !titleEl.classed(cn.jsPlaceholder)) {\n            var _titleHeight;\n\n            var mathJaxNode = titleCont.select('.h' + ax._id + 'title-math-group').node();\n            if(mathJaxNode && (\n                (isVertical && topOrBottom) ||\n                (!isVertical && !topOrBottom)\n            )) {\n                bb = Drawing.bBox(mathJaxNode);\n                titleWidth = bb.width;\n                _titleHeight = bb.height;\n            } else {\n                // note: the formula below works for all title sides,\n                // (except for top/bottom mathjax, above)\n                // but the weird gs.l is because the titleunshift\n                // transform gets removed by Drawing.bBox\n                bb = Drawing.bBox(titleCont.node());\n                titleWidth = bb.right - gs.l - (isVertical ? uPx : vPx);\n                _titleHeight = bb.bottom - gs.t - (isVertical ? vPx : uPx);\n\n                if(\n                    !isVertical && titleSide === 'top'\n                ) {\n                    innerThickness += bb.height;\n                    moveY = bb.height;\n                }\n            }\n\n            if(rightSideHorizontal) {\n                titleEl.attr('transform', strTranslate(titleWidth / 2 + titleFontSize / 2, 0));\n\n                titleWidth *= 2;\n            }\n\n            innerThickness = Math.max(innerThickness,\n                isVertical ? titleWidth : _titleHeight\n            );\n        }\n\n        var outerThickness = (isVertical ?\n            xpad :\n            ypad\n        ) * 2 + innerThickness + borderwidth + outlinewidth / 2;\n\n        var hColorbarMoveTitle = 0;\n        if(!isVertical && title.text && yanchor === 'bottom' && optsY <= 0) {\n            hColorbarMoveTitle = outerThickness / 2;\n\n            outerThickness += hColorbarMoveTitle;\n            moveY += hColorbarMoveTitle;\n        }\n        fullLayout._hColorbarMoveTitle = hColorbarMoveTitle;\n        fullLayout._hColorbarMoveCBTitle = moveY;\n\n        var extraW = borderwidth + outlinewidth;\n\n        // TODO - are these the correct positions?\n        var lx = (isVertical ? uPx : vPx) - extraW / 2 - (isVertical ? xpad : 0);\n        var ly = (isVertical ? vPx : uPx) - (isVertical ? lenPx : ypad + moveY - hColorbarMoveTitle);\n\n        g.select('.' + cn.cbbg)\n        .attr('x', lx)\n        .attr('y', ly)\n        .attr(isVertical ? 'width' : 'height', Math.max(outerThickness - hColorbarMoveTitle, 2))\n        .attr(isVertical ? 'height' : 'width', Math.max(lenPx + extraW, 2))\n        .call(Color.fill, bgcolor)\n        .call(Color.stroke, opts.bordercolor)\n        .style('stroke-width', borderwidth);\n\n        var moveX = rightSideHorizontal ? Math.max(titleWidth - 10, 0) : 0;\n\n        g.selectAll('.' + cn.cboutline)\n        .attr('x', (isVertical ? uPx : vPx + xpad) + moveX)\n        .attr('y', (isVertical ? vPx + ypad - lenPx : uPx) + (topSideVertical ? titleHeight : 0))\n        .attr(isVertical ? 'width' : 'height', Math.max(thickPx, 2))\n        .attr(isVertical ? 'height' : 'width', Math.max(lenPx - (isVertical ?\n            2 * ypad + titleHeight :\n            2 * xpad + moveX\n        ), 2))\n        .call(Color.stroke, opts.outlinecolor)\n        .style({\n            fill: 'none',\n            'stroke-width': outlinewidth\n        });\n\n        var xShift = ((isVertical ? xRatio * outerThickness : 0));\n        var yShift = ((isVertical ? 0 : (1 - yRatio) * outerThickness - moveY));\n        xShift = isPaperX ? gs.l - xShift : -xShift;\n        yShift = isPaperY ? gs.t - yShift : -yShift;\n\n        g.attr('transform', strTranslate(\n            xShift,\n            yShift\n        ));\n\n        if(!isVertical && (\n            borderwidth || (\n                tinycolor(bgcolor).getAlpha() &&\n                !tinycolor.equals(fullLayout.paper_bgcolor, bgcolor)\n            )\n        )) {\n            // for horizontal colorbars when there is a border line or having different background color\n            // hide/adjust x positioning for the first/last tick labels if they go outside the border\n            var tickLabels = axLayer.selectAll('text');\n            var numTicks = tickLabels[0].length;\n\n            var border = g.select('.' + cn.cbbg).node();\n            var oBb = Drawing.bBox(border);\n            var oTr = Drawing.getTranslate(g);\n\n            var TEXTPAD = 2;\n\n            tickLabels.each(function(d, i) {\n                var first = 0;\n                var last = numTicks - 1;\n                if(i === first || i === last) {\n                    var iBb = Drawing.bBox(this);\n                    var iTr = Drawing.getTranslate(this);\n                    var deltaX;\n\n                    if(i === last) {\n                        var iRight = iBb.right + iTr.x;\n                        var oRight = oBb.right + oTr.x + vPx - borderwidth - TEXTPAD + optsX;\n\n                        deltaX = oRight - iRight;\n                        if(deltaX > 0) deltaX = 0;\n                    } else if(i === first) {\n                        var iLeft = iBb.left + iTr.x;\n                        var oLeft = oBb.left + oTr.x + vPx + borderwidth + TEXTPAD;\n\n                        deltaX = oLeft - iLeft;\n                        if(deltaX < 0) deltaX = 0;\n                    }\n\n                    if(deltaX) {\n                        if(numTicks < 3) { // adjust position\n                            this.setAttribute('transform',\n                                'translate(' + deltaX + ',0) ' +\n                                this.getAttribute('transform')\n                            );\n                        } else { // hide\n                            this.setAttribute('visibility', 'hidden');\n                        }\n                    }\n                }\n            });\n        }\n\n        // auto margin adjustment\n        var marginOpts = {};\n        var lFrac = FROM_TL[xanchor];\n        var rFrac = FROM_BR[xanchor];\n        var tFrac = FROM_TL[yanchor];\n        var bFrac = FROM_BR[yanchor];\n\n        var extraThickness = outerThickness - thickPx;\n        if(isVertical) {\n            if(lenmode === 'pixels') {\n                marginOpts.y = optsY;\n                marginOpts.t = lenPx * tFrac;\n                marginOpts.b = lenPx * bFrac;\n            } else {\n                marginOpts.t = marginOpts.b = 0;\n                marginOpts.yt = optsY + len * tFrac;\n                marginOpts.yb = optsY - len * bFrac;\n            }\n\n            if(thicknessmode === 'pixels') {\n                marginOpts.x = optsX;\n                marginOpts.l = outerThickness * lFrac;\n                marginOpts.r = outerThickness * rFrac;\n            } else {\n                marginOpts.l = extraThickness * lFrac;\n                marginOpts.r = extraThickness * rFrac;\n                marginOpts.xl = optsX - thickness * lFrac;\n                marginOpts.xr = optsX + thickness * rFrac;\n            }\n        } else { // horizontal colorbars\n            if(lenmode === 'pixels') {\n                marginOpts.x = optsX;\n                marginOpts.l = lenPx * lFrac;\n                marginOpts.r = lenPx * rFrac;\n            } else {\n                marginOpts.l = marginOpts.r = 0;\n                marginOpts.xl = optsX + len * lFrac;\n                marginOpts.xr = optsX - len * rFrac;\n            }\n\n            if(thicknessmode === 'pixels') {\n                marginOpts.y = 1 - optsY;\n                marginOpts.t = outerThickness * tFrac;\n                marginOpts.b = outerThickness * bFrac;\n            } else {\n                marginOpts.t = extraThickness * tFrac;\n                marginOpts.b = extraThickness * bFrac;\n                marginOpts.yt = optsY - thickness * tFrac;\n                marginOpts.yb = optsY + thickness * bFrac;\n            }\n        }\n        var sideY = opts.y < 0.5 ? 'b' : 't';\n        var sideX = opts.x < 0.5 ? 'l' : 'r';\n\n        gd._fullLayout._reservedMargin[opts._id] = {};\n        var possibleReservedMargins = {\n            r: (fullLayout.width - lx - xShift),\n            l: lx + marginOpts.r,\n            b: (fullLayout.height - ly - yShift),\n            t: ly + marginOpts.b\n        };\n\n        if(isPaperX && isPaperY) {\n            Plots.autoMargin(gd, opts._id, marginOpts);\n        } else if(isPaperX) {\n            gd._fullLayout._reservedMargin[opts._id][sideY] = possibleReservedMargins[sideY];\n        } else if(isPaperY) {\n            gd._fullLayout._reservedMargin[opts._id][sideX] = possibleReservedMargins[sideX];\n        } else {\n            if(isVertical) {\n                gd._fullLayout._reservedMargin[opts._id][sideX] = possibleReservedMargins[sideX];\n            } else {\n                gd._fullLayout._reservedMargin[opts._id][sideY] = possibleReservedMargins[sideY];\n            }\n        }\n    }\n\n    return Lib.syncOrAsync([\n        Plots.previousPromises,\n        drawDummyTitle,\n        drawAxis,\n        drawCbTitle,\n        Plots.previousPromises,\n        positionCB\n    ], gd);\n}\n\nfunction makeEditable(g, opts, gd) {\n    var isVertical = opts.orientation === 'v';\n    var fullLayout = gd._fullLayout;\n    var gs = fullLayout._size;\n    var t0, xf, yf;\n\n    dragElement.init({\n        element: g.node(),\n        gd: gd,\n        prepFn: function() {\n            t0 = g.attr('transform');\n            setCursor(g);\n        },\n        moveFn: function(dx, dy) {\n            g.attr('transform', t0 + strTranslate(dx, dy));\n\n            xf = dragElement.align(\n                (isVertical ? opts._uFrac : opts._vFrac) + (dx / gs.w),\n                isVertical ? opts._thickFrac : opts._lenFrac,\n                0, 1, opts.xanchor);\n            yf = dragElement.align(\n                (isVertical ? opts._vFrac : (1 - opts._uFrac)) - (dy / gs.h),\n                isVertical ? opts._lenFrac : opts._thickFrac,\n                0, 1, opts.yanchor);\n\n            var csr = dragElement.getCursor(xf, yf, opts.xanchor, opts.yanchor);\n            setCursor(g, csr);\n        },\n        doneFn: function() {\n            setCursor(g);\n\n            if(xf !== undefined && yf !== undefined) {\n                var update = {};\n                update[opts._propPrefix + 'x'] = xf;\n                update[opts._propPrefix + 'y'] = yf;\n                if(opts._traceIndex !== undefined) {\n                    Registry.call('_guiRestyle', gd, update, opts._traceIndex);\n                } else {\n                    Registry.call('_guiRelayout', gd, update);\n                }\n            }\n        }\n    });\n}\n\nfunction calcLevels(gd, opts, zrange) {\n    var levelsIn = opts._levels;\n    var lineLevels = [];\n    var fillLevels = [];\n    var l;\n    var i;\n\n    var l0 = levelsIn.end + levelsIn.size / 100;\n    var ls = levelsIn.size;\n    var zr0 = (1.001 * zrange[0] - 0.001 * zrange[1]);\n    var zr1 = (1.001 * zrange[1] - 0.001 * zrange[0]);\n\n    for(i = 0; i < 1e5; i++) {\n        l = levelsIn.start + i * ls;\n        if(ls > 0 ? (l >= l0) : (l <= l0)) break;\n        if(l > zr0 && l < zr1) lineLevels.push(l);\n    }\n\n    if(opts._fillgradient) {\n        fillLevels = [0];\n    } else if(typeof opts._fillcolor === 'function') {\n        var fillLevelsIn = opts._filllevels;\n\n        if(fillLevelsIn) {\n            l0 = fillLevelsIn.end + fillLevelsIn.size / 100;\n            ls = fillLevelsIn.size;\n            for(i = 0; i < 1e5; i++) {\n                l = fillLevelsIn.start + i * ls;\n                if(ls > 0 ? (l >= l0) : (l <= l0)) break;\n                if(l > zrange[0] && l < zrange[1]) fillLevels.push(l);\n            }\n        } else {\n            fillLevels = lineLevels.map(function(v) {\n                return v - levelsIn.size / 2;\n            });\n            fillLevels.push(fillLevels[fillLevels.length - 1] + levelsIn.size);\n        }\n    } else if(opts._fillcolor && typeof opts._fillcolor === 'string') {\n        // doesn't matter what this value is, with a single value\n        // we'll make a single fill rect covering the whole bar\n        fillLevels = [0];\n    }\n\n    if(levelsIn.size < 0) {\n        lineLevels.reverse();\n        fillLevels.reverse();\n    }\n\n    return {line: lineLevels, fill: fillLevels};\n}\n\nfunction mockColorBarAxis(gd, opts, zrange) {\n    var fullLayout = gd._fullLayout;\n\n    var isVertical = opts.orientation === 'v';\n\n    var cbAxisIn = {\n        type: 'linear',\n        range: zrange,\n        tickmode: opts.tickmode,\n        nticks: opts.nticks,\n        tick0: opts.tick0,\n        dtick: opts.dtick,\n        tickvals: opts.tickvals,\n        ticktext: opts.ticktext,\n        ticks: opts.ticks,\n        ticklen: opts.ticklen,\n        tickwidth: opts.tickwidth,\n        tickcolor: opts.tickcolor,\n        showticklabels: opts.showticklabels,\n        labelalias: opts.labelalias,\n        ticklabelposition: opts.ticklabelposition,\n        ticklabeloverflow: opts.ticklabeloverflow,\n        ticklabelstep: opts.ticklabelstep,\n        tickfont: opts.tickfont,\n        tickangle: opts.tickangle,\n        tickformat: opts.tickformat,\n        exponentformat: opts.exponentformat,\n        minexponent: opts.minexponent,\n        separatethousands: opts.separatethousands,\n        showexponent: opts.showexponent,\n        showtickprefix: opts.showtickprefix,\n        tickprefix: opts.tickprefix,\n        showticksuffix: opts.showticksuffix,\n        ticksuffix: opts.ticksuffix,\n        title: opts.title,\n        showline: true,\n        anchor: 'free',\n        side: isVertical ? 'right' : 'bottom',\n        position: 1\n    };\n\n    var letter = isVertical ? 'y' : 'x';\n\n    var cbAxisOut = {\n        type: 'linear',\n        _id: letter + opts._id\n    };\n\n    var axisOptions = {\n        letter: letter,\n        font: fullLayout.font,\n        noAutotickangles: letter === 'y',\n        noHover: true,\n        noTickson: true,\n        noTicklabelmode: true,\n        noInsideRange: true,\n        calendar: fullLayout.calendar  // not really necessary (yet?)\n    };\n\n    function coerce(attr, dflt) {\n        return Lib.coerce(cbAxisIn, cbAxisOut, axisLayoutAttrs, attr, dflt);\n    }\n\n    handleAxisDefaults(cbAxisIn, cbAxisOut, coerce, axisOptions, fullLayout);\n    handleAxisPositionDefaults(cbAxisIn, cbAxisOut, coerce, axisOptions);\n\n    return cbAxisOut;\n}\n\nmodule.exports = {\n    draw: draw\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script"}