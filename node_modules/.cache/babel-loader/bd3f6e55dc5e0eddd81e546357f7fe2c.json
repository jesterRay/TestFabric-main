{"ast":null,"code":"'use strict';\n\nvar maplibregl = require('maplibre-gl/dist/maplibre-gl-unminified');\nvar Lib = require('../../lib');\nvar geoUtils = require('../../lib/geo_location_utils');\nvar Registry = require('../../registry');\nvar Axes = require('../cartesian/axes');\nvar dragElement = require('../../components/dragelement');\nvar Fx = require('../../components/fx');\nvar dragHelpers = require('../../components/dragelement/helpers');\nvar drawMode = dragHelpers.drawMode;\nvar selectMode = dragHelpers.selectMode;\nvar prepSelect = require('../../components/selections').prepSelect;\nvar clearOutline = require('../../components/selections').clearOutline;\nvar clearSelectionsCache = require('../../components/selections').clearSelectionsCache;\nvar selectOnClick = require('../../components/selections').selectOnClick;\nvar constants = require('./constants');\nvar createMapLayer = require('./layers');\nfunction Map(gd, id) {\n  this.id = id;\n  this.gd = gd;\n  var fullLayout = gd._fullLayout;\n  var context = gd._context;\n  this.container = fullLayout._glcontainer.node();\n  this.isStatic = context.staticPlot;\n\n  // unique id for this Map instance\n  this.uid = fullLayout._uid + '-' + this.id;\n\n  // create framework on instantiation for a smoother first plot call\n  this.div = null;\n  this.xaxis = null;\n  this.yaxis = null;\n  this.createFramework(fullLayout);\n\n  // state variables used to infer how and what to update\n  this.map = null;\n  this.styleObj = null;\n  this.traceHash = {};\n  this.layerList = [];\n  this.belowLookup = {};\n  this.dragging = false;\n  this.wheeling = false;\n}\nvar proto = Map.prototype;\nproto.plot = function (calcData, fullLayout, promises) {\n  var self = this;\n  var promise;\n  if (!self.map) {\n    promise = new Promise(function (resolve, reject) {\n      self.createMap(calcData, fullLayout, resolve, reject);\n    });\n  } else {\n    promise = new Promise(function (resolve, reject) {\n      self.updateMap(calcData, fullLayout, resolve, reject);\n    });\n  }\n  promises.push(promise);\n};\nproto.createMap = function (calcData, fullLayout, resolve, reject) {\n  var self = this;\n  var opts = fullLayout[self.id];\n\n  // store style id and URL or object\n  var styleObj = self.styleObj = getStyleObj(opts.style);\n  var bounds = opts.bounds;\n  var maxBounds = bounds ? [[bounds.west, bounds.south], [bounds.east, bounds.north]] : null;\n\n  // create the map!\n  var map = self.map = new maplibregl.Map({\n    container: self.div,\n    style: styleObj.style,\n    center: convertCenter(opts.center),\n    zoom: opts.zoom,\n    bearing: opts.bearing,\n    pitch: opts.pitch,\n    maxBounds: maxBounds,\n    interactive: !self.isStatic,\n    preserveDrawingBuffer: self.isStatic,\n    doubleClickZoom: false,\n    boxZoom: false,\n    attributionControl: false\n  }).addControl(new maplibregl.AttributionControl({\n    compact: true\n  }));\n  var requestedIcons = {};\n  map.on('styleimagemissing', function (e) {\n    var id = e.id;\n    if (!requestedIcons[id] && id.includes('-15')) {\n      requestedIcons[id] = true;\n      var img = new Image(15, 15);\n      img.onload = function () {\n        map.addImage(id, img);\n      };\n      img.crossOrigin = 'Anonymous';\n      img.src = 'https://unpkg.com/maki@2.1.0/icons/' + id + '.svg';\n    }\n  });\n  map.setTransformRequest(function (url) {\n    url = url.replace('https://fonts.openmaptiles.org/Open Sans Extrabold', 'https://fonts.openmaptiles.org/Open Sans Extra Bold');\n    url = url.replace('https://tiles.basemaps.cartocdn.com/fonts/Open Sans Extrabold', 'https://fonts.openmaptiles.org/Open Sans Extra Bold');\n    url = url.replace('https://fonts.openmaptiles.org/Open Sans Regular,Arial Unicode MS Regular', 'https://fonts.openmaptiles.org/Klokantech Noto Sans Regular');\n    return {\n      url: url\n    };\n  });\n\n  // make sure canvas does not inherit left and top css\n  map._canvas.style.left = '0px';\n  map._canvas.style.top = '0px';\n  self.rejectOnError(reject);\n  if (!self.isStatic) {\n    self.initFx(calcData, fullLayout);\n  }\n  var promises = [];\n  promises.push(new Promise(function (resolve) {\n    map.once('load', resolve);\n  }));\n  promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n  Promise.all(promises).then(function () {\n    self.fillBelowLookup(calcData, fullLayout);\n    self.updateData(calcData);\n    self.updateLayout(fullLayout);\n    self.resolveOnRender(resolve);\n  }).catch(reject);\n};\nproto.updateMap = function (calcData, fullLayout, resolve, reject) {\n  var self = this;\n  var map = self.map;\n  var opts = fullLayout[this.id];\n  self.rejectOnError(reject);\n  var promises = [];\n  var styleObj = getStyleObj(opts.style);\n  if (JSON.stringify(self.styleObj) !== JSON.stringify(styleObj)) {\n    self.styleObj = styleObj;\n    map.setStyle(styleObj.style);\n\n    // need to rebuild trace layers on reload\n    // to avoid 'lost event' errors\n    self.traceHash = {};\n    promises.push(new Promise(function (resolve) {\n      map.once('styledata', resolve);\n    }));\n  }\n  promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n  Promise.all(promises).then(function () {\n    self.fillBelowLookup(calcData, fullLayout);\n    self.updateData(calcData);\n    self.updateLayout(fullLayout);\n    self.resolveOnRender(resolve);\n  }).catch(reject);\n};\nproto.fillBelowLookup = function (calcData, fullLayout) {\n  var opts = fullLayout[this.id];\n  var layers = opts.layers;\n  var i, val;\n  var belowLookup = this.belowLookup = {};\n  var hasTraceAtTop = false;\n  for (i = 0; i < calcData.length; i++) {\n    var trace = calcData[i][0].trace;\n    var _module = trace._module;\n    if (typeof trace.below === 'string') {\n      val = trace.below;\n    } else if (_module.getBelow) {\n      // 'smart' default that depend the map's base layers\n      val = _module.getBelow(trace, this);\n    }\n    if (val === '') {\n      hasTraceAtTop = true;\n    }\n    belowLookup['trace-' + trace.uid] = val || '';\n  }\n  for (i = 0; i < layers.length; i++) {\n    var item = layers[i];\n    if (typeof item.below === 'string') {\n      val = item.below;\n    } else if (hasTraceAtTop) {\n      // if one or more trace(s) set `below:''` and\n      // layers[i].below is unset,\n      // place layer below traces\n      val = 'traces';\n    } else {\n      val = '';\n    }\n    belowLookup['layout-' + i] = val;\n  }\n\n  // N.B. If multiple layers have the 'below' value,\n  // we must clear the stashed 'below' field in order\n  // to make `traceHash[k].update()` and `layerList[i].update()`\n  // remove/add the all those layers to have preserve\n  // the correct layer ordering\n  var val2list = {};\n  var k, id;\n  for (k in belowLookup) {\n    val = belowLookup[k];\n    if (val2list[val]) {\n      val2list[val].push(k);\n    } else {\n      val2list[val] = [k];\n    }\n  }\n  for (val in val2list) {\n    var list = val2list[val];\n    if (list.length > 1) {\n      for (i = 0; i < list.length; i++) {\n        k = list[i];\n        if (k.indexOf('trace-') === 0) {\n          id = k.split('trace-')[1];\n          if (this.traceHash[id]) {\n            this.traceHash[id].below = null;\n          }\n        } else if (k.indexOf('layout-') === 0) {\n          id = k.split('layout-')[1];\n          if (this.layerList[id]) {\n            this.layerList[id].below = null;\n          }\n        }\n      }\n    }\n  }\n};\nvar traceType2orderIndex = {\n  choroplethmap: 0,\n  densitymap: 1,\n  scattermap: 2\n};\nproto.updateData = function (calcData) {\n  var traceHash = this.traceHash;\n  var traceObj, trace, i, j;\n\n  // Need to sort here by trace type here,\n  // in case traces with different `type` have the same\n  // below value, but sorting we ensure that\n  // e.g. choroplethmap traces will be below scattermap traces\n  var calcDataSorted = calcData.slice().sort(function (a, b) {\n    return traceType2orderIndex[a[0].trace.type] - traceType2orderIndex[b[0].trace.type];\n  });\n\n  // update or create trace objects\n  for (i = 0; i < calcDataSorted.length; i++) {\n    var calcTrace = calcDataSorted[i];\n    trace = calcTrace[0].trace;\n    traceObj = traceHash[trace.uid];\n    var didUpdate = false;\n    if (traceObj) {\n      if (traceObj.type === trace.type) {\n        traceObj.update(calcTrace);\n        didUpdate = true;\n      } else {\n        traceObj.dispose();\n      }\n    }\n    if (!didUpdate && trace._module) {\n      traceHash[trace.uid] = trace._module.plot(this, calcTrace);\n    }\n  }\n\n  // remove empty trace objects\n  var ids = Object.keys(traceHash);\n  idLoop: for (i = 0; i < ids.length; i++) {\n    var id = ids[i];\n    for (j = 0; j < calcData.length; j++) {\n      trace = calcData[j][0].trace;\n      if (id === trace.uid) continue idLoop;\n    }\n    traceObj = traceHash[id];\n    traceObj.dispose();\n    delete traceHash[id];\n  }\n};\nproto.updateLayout = function (fullLayout) {\n  var map = this.map;\n  var opts = fullLayout[this.id];\n  if (!this.dragging && !this.wheeling) {\n    map.setCenter(convertCenter(opts.center));\n    map.setZoom(opts.zoom);\n    map.setBearing(opts.bearing);\n    map.setPitch(opts.pitch);\n  }\n  this.updateLayers(fullLayout);\n  this.updateFramework(fullLayout);\n  this.updateFx(fullLayout);\n  this.map.resize();\n  if (this.gd._context._scrollZoom.map) {\n    map.scrollZoom.enable();\n  } else {\n    map.scrollZoom.disable();\n  }\n};\nproto.resolveOnRender = function (resolve) {\n  var map = this.map;\n  map.on('render', function onRender() {\n    if (map.loaded()) {\n      map.off('render', onRender);\n      // resolve at end of render loop\n      //\n      // Need a 10ms delay (0ms should suffice to skip a thread in the\n      // render loop) to workaround map-gl bug introduced in v1.3.0\n      setTimeout(resolve, 10);\n    }\n  });\n};\nproto.rejectOnError = function (reject) {\n  var map = this.map;\n  function handler() {\n    reject(new Error(constants.mapOnErrorMsg));\n  }\n  map.once('error', handler);\n  map.once('style.error', handler);\n  map.once('source.error', handler);\n  map.once('tile.error', handler);\n  map.once('layer.error', handler);\n};\nproto.createFramework = function (fullLayout) {\n  var self = this;\n  var div = self.div = document.createElement('div');\n  div.id = self.uid;\n  div.style.position = 'absolute';\n  self.container.appendChild(div);\n\n  // create mock x/y axes for hover routine\n  self.xaxis = {\n    _id: 'x',\n    c2p: function (v) {\n      return self.project(v).x;\n    }\n  };\n  self.yaxis = {\n    _id: 'y',\n    c2p: function (v) {\n      return self.project(v).y;\n    }\n  };\n  self.updateFramework(fullLayout);\n\n  // mock axis for hover formatting\n  self.mockAxis = {\n    type: 'linear',\n    showexponent: 'all',\n    exponentformat: 'B'\n  };\n  Axes.setConvert(self.mockAxis, fullLayout);\n};\nproto.initFx = function (calcData, fullLayout) {\n  var self = this;\n  var gd = self.gd;\n  var map = self.map;\n\n  // keep track of pan / zoom in user layout and emit relayout event\n  map.on('moveend', function (evt) {\n    if (!self.map) return;\n    var fullLayoutNow = gd._fullLayout;\n\n    // 'moveend' gets triggered by map.setCenter, map.setZoom,\n    // map.setBearing and map.setPitch.\n    //\n    // Here, we make sure that state updates amd 'plotly_relayout'\n    // are triggered only when the 'moveend' originates from a\n    // mouse target (filtering out API calls) to not\n    // duplicate 'plotly_relayout' events.\n\n    if (evt.originalEvent || self.wheeling) {\n      var optsNow = fullLayoutNow[self.id];\n      Registry.call('_storeDirectGUIEdit', gd.layout, fullLayoutNow._preGUI, self.getViewEdits(optsNow));\n      var viewNow = self.getView();\n      optsNow._input.center = optsNow.center = viewNow.center;\n      optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n      optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n      optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n      gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n    }\n    if (evt.originalEvent && evt.originalEvent.type === 'mouseup') {\n      self.dragging = false;\n    } else if (self.wheeling) {\n      self.wheeling = false;\n    }\n    if (fullLayoutNow && fullLayoutNow._rehover) {\n      fullLayoutNow._rehover();\n    }\n  });\n  map.on('wheel', function () {\n    self.wheeling = true;\n  });\n  map.on('mousemove', function (evt) {\n    var bb = self.div.getBoundingClientRect();\n    var xy = [evt.originalEvent.offsetX, evt.originalEvent.offsetY];\n    evt.target.getBoundingClientRect = function () {\n      return bb;\n    };\n    self.xaxis.p2c = function () {\n      return map.unproject(xy).lng;\n    };\n    self.yaxis.p2c = function () {\n      return map.unproject(xy).lat;\n    };\n    gd._fullLayout._rehover = function () {\n      if (gd._fullLayout._hoversubplot === self.id && gd._fullLayout[self.id]) {\n        Fx.hover(gd, evt, self.id);\n      }\n    };\n    Fx.hover(gd, evt, self.id);\n    gd._fullLayout._hoversubplot = self.id;\n  });\n  function unhover() {\n    Fx.loneUnhover(fullLayout._hoverlayer);\n  }\n  map.on('dragstart', function () {\n    self.dragging = true;\n    unhover();\n  });\n  map.on('zoomstart', unhover);\n  map.on('mouseout', function () {\n    gd._fullLayout._hoversubplot = null;\n  });\n  function emitUpdate() {\n    var viewNow = self.getView();\n    gd.emit('plotly_relayouting', self.getViewEditsWithDerived(viewNow));\n  }\n  map.on('drag', emitUpdate);\n  map.on('zoom', emitUpdate);\n  map.on('dblclick', function () {\n    var optsNow = gd._fullLayout[self.id];\n    Registry.call('_storeDirectGUIEdit', gd.layout, gd._fullLayout._preGUI, self.getViewEdits(optsNow));\n    var viewInitial = self.viewInitial;\n    map.setCenter(convertCenter(viewInitial.center));\n    map.setZoom(viewInitial.zoom);\n    map.setBearing(viewInitial.bearing);\n    map.setPitch(viewInitial.pitch);\n    var viewNow = self.getView();\n    optsNow._input.center = optsNow.center = viewNow.center;\n    optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n    optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n    optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n    gd.emit('plotly_doubleclick', null);\n    gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n  });\n\n  // define event handlers on map creation, to keep one ref per map,\n  // so that map.on / map.off in updateFx works as expected\n  self.clearOutline = function () {\n    clearSelectionsCache(self.dragOptions);\n    clearOutline(self.dragOptions.gd);\n  };\n\n  /**\n   * Returns a click handler function that is supposed\n   * to handle clicks in pan mode.\n   */\n  self.onClickInPanFn = function (dragOptions) {\n    return function (evt) {\n      var clickMode = gd._fullLayout.clickmode;\n      if (clickMode.indexOf('select') > -1) {\n        selectOnClick(evt.originalEvent, gd, [self.xaxis], [self.yaxis], self.id, dragOptions);\n      }\n      if (clickMode.indexOf('event') > -1) {\n        // TODO: this does not support right-click. If we want to support it, we\n        // would likely need to change map to use dragElement instead of straight\n        // map event binding. Or perhaps better, make a simple wrapper with the\n        // right mousedown, mousemove, and mouseup handlers just for a left/right click\n        // pie would use this too.\n        Fx.click(gd, evt.originalEvent);\n      }\n    };\n  };\n};\nproto.updateFx = function (fullLayout) {\n  var self = this;\n  var map = self.map;\n  var gd = self.gd;\n  if (self.isStatic) return;\n  function invert(pxpy) {\n    var obj = self.map.unproject(pxpy);\n    return [obj.lng, obj.lat];\n  }\n  var dragMode = fullLayout.dragmode;\n  var fillRangeItems;\n  fillRangeItems = function (eventData, poly) {\n    if (poly.isRect) {\n      var ranges = eventData.range = {};\n      ranges[self.id] = [invert([poly.xmin, poly.ymin]), invert([poly.xmax, poly.ymax])];\n    } else {\n      var dataPts = eventData.lassoPoints = {};\n      dataPts[self.id] = poly.map(invert);\n    }\n  };\n\n  // Note: dragOptions is needed to be declared for all dragmodes because\n  // it's the object that holds persistent selection state.\n  // Merge old dragOptions with new to keep possibly initialized\n  // persistent selection state.\n  var oldDragOptions = self.dragOptions;\n  self.dragOptions = Lib.extendDeep(oldDragOptions || {}, {\n    dragmode: fullLayout.dragmode,\n    element: self.div,\n    gd: gd,\n    plotinfo: {\n      id: self.id,\n      domain: fullLayout[self.id].domain,\n      xaxis: self.xaxis,\n      yaxis: self.yaxis,\n      fillRangeItems: fillRangeItems\n    },\n    xaxes: [self.xaxis],\n    yaxes: [self.yaxis],\n    subplot: self.id\n  });\n\n  // Unregister the old handler before potentially registering\n  // a new one. Otherwise multiple click handlers might\n  // be registered resulting in unwanted behavior.\n  map.off('click', self.onClickInPanHandler);\n  if (selectMode(dragMode) || drawMode(dragMode)) {\n    map.dragPan.disable();\n    map.on('zoomstart', self.clearOutline);\n    self.dragOptions.prepFn = function (e, startX, startY) {\n      prepSelect(e, startX, startY, self.dragOptions, dragMode);\n    };\n    dragElement.init(self.dragOptions);\n  } else {\n    map.dragPan.enable();\n    map.off('zoomstart', self.clearOutline);\n    self.div.onmousedown = null;\n    self.div.ontouchstart = null;\n    self.div.removeEventListener('touchstart', self.div._ontouchstart);\n    // TODO: this does not support right-click. If we want to support it, we\n    // would likely need to change map to use dragElement instead of straight\n    // map event binding. Or perhaps better, make a simple wrapper with the\n    // right mousedown, mousemove, and mouseup handlers just for a left/right click\n    // pie would use this too.\n    self.onClickInPanHandler = self.onClickInPanFn(self.dragOptions);\n    map.on('click', self.onClickInPanHandler);\n  }\n};\nproto.updateFramework = function (fullLayout) {\n  var domain = fullLayout[this.id].domain;\n  var size = fullLayout._size;\n  var style = this.div.style;\n  style.width = size.w * (domain.x[1] - domain.x[0]) + 'px';\n  style.height = size.h * (domain.y[1] - domain.y[0]) + 'px';\n  style.left = size.l + domain.x[0] * size.w + 'px';\n  style.top = size.t + (1 - domain.y[1]) * size.h + 'px';\n  this.xaxis._offset = size.l + domain.x[0] * size.w;\n  this.xaxis._length = size.w * (domain.x[1] - domain.x[0]);\n  this.yaxis._offset = size.t + (1 - domain.y[1]) * size.h;\n  this.yaxis._length = size.h * (domain.y[1] - domain.y[0]);\n};\nproto.updateLayers = function (fullLayout) {\n  var opts = fullLayout[this.id];\n  var layers = opts.layers;\n  var layerList = this.layerList;\n  var i;\n\n  // if the layer arrays don't match,\n  // don't try to be smart,\n  // delete them all, and start all over.\n\n  if (layers.length !== layerList.length) {\n    for (i = 0; i < layerList.length; i++) {\n      layerList[i].dispose();\n    }\n    layerList = this.layerList = [];\n    for (i = 0; i < layers.length; i++) {\n      layerList.push(createMapLayer(this, i, layers[i]));\n    }\n  } else {\n    for (i = 0; i < layers.length; i++) {\n      layerList[i].update(layers[i]);\n    }\n  }\n};\nproto.destroy = function () {\n  if (this.map) {\n    this.map.remove();\n    this.map = null;\n    this.container.removeChild(this.div);\n  }\n};\nproto.toImage = function () {\n  this.map.stop();\n  return this.map.getCanvas().toDataURL();\n};\n\n// convenience wrapper to create set multiple layer\n// 'layout' or 'paint options at once.\nproto.setOptions = function (id, methodName, opts) {\n  for (var k in opts) {\n    this.map[methodName](id, k, opts[k]);\n  }\n};\nproto.getMapLayers = function () {\n  return this.map.getStyle().layers;\n};\n\n// convenience wrapper that first check in 'below' references\n// a layer that exist and then add the layer to the map,\nproto.addLayer = function (opts, below) {\n  var map = this.map;\n  if (typeof below === 'string') {\n    if (below === '') {\n      map.addLayer(opts, below);\n      return;\n    }\n    var mapLayers = this.getMapLayers();\n    for (var i = 0; i < mapLayers.length; i++) {\n      if (below === mapLayers[i].id) {\n        map.addLayer(opts, below);\n        return;\n      }\n    }\n    Lib.warn(['Trying to add layer with *below* value', below, 'referencing a layer that does not exist', 'or that does not yet exist.'].join(' '));\n  }\n  map.addLayer(opts);\n};\n\n// convenience method to project a [lon, lat] array to pixel coords\nproto.project = function (v) {\n  return this.map.project(new maplibregl.LngLat(v[0], v[1]));\n};\n\n// get map's current view values in plotly.js notation\nproto.getView = function () {\n  var map = this.map;\n  var mapCenter = map.getCenter();\n  var lon = mapCenter.lng;\n  var lat = mapCenter.lat;\n  var center = {\n    lon: lon,\n    lat: lat\n  };\n  var canvas = map.getCanvas();\n  var w = parseInt(canvas.style.width);\n  var h = parseInt(canvas.style.height);\n  return {\n    center: center,\n    zoom: map.getZoom(),\n    bearing: map.getBearing(),\n    pitch: map.getPitch(),\n    _derived: {\n      coordinates: [map.unproject([0, 0]).toArray(), map.unproject([w, 0]).toArray(), map.unproject([w, h]).toArray(), map.unproject([0, h]).toArray()]\n    }\n  };\n};\nproto.getViewEdits = function (cont) {\n  var id = this.id;\n  var keys = ['center', 'zoom', 'bearing', 'pitch'];\n  var obj = {};\n  for (var i = 0; i < keys.length; i++) {\n    var k = keys[i];\n    obj[id + '.' + k] = cont[k];\n  }\n  return obj;\n};\nproto.getViewEditsWithDerived = function (cont) {\n  var id = this.id;\n  var obj = this.getViewEdits(cont);\n  obj[id + '._derived'] = cont._derived;\n  return obj;\n};\nfunction getStyleObj(val) {\n  var styleObj = {};\n  if (Lib.isPlainObject(val)) {\n    styleObj.id = val.id;\n    styleObj.style = val;\n  } else if (typeof val === 'string') {\n    styleObj.id = val;\n    if (constants.stylesMap[val]) {\n      styleObj.style = constants.stylesMap[val];\n    } else {\n      styleObj.style = val;\n    }\n  } else {\n    styleObj.id = constants.styleValueDflt;\n    styleObj.style = convertStyleVal(constants.styleValueDflt);\n  }\n  styleObj.transition = {\n    duration: 0,\n    delay: 0\n  };\n  return styleObj;\n}\n\n// if style is part of the 'official' map values, add URL prefix and suffix\nfunction convertStyleVal(val) {\n  return constants.styleUrlPrefix + val + '-' + constants.styleUrlSuffix;\n}\nfunction convertCenter(center) {\n  return [center.lon, center.lat];\n}\nmodule.exports = Map;","map":{"version":3,"names":["maplibregl","require","Lib","geoUtils","Registry","Axes","dragElement","Fx","dragHelpers","drawMode","selectMode","prepSelect","clearOutline","clearSelectionsCache","selectOnClick","constants","createMapLayer","Map","gd","id","fullLayout","_fullLayout","context","_context","container","_glcontainer","node","isStatic","staticPlot","uid","_uid","div","xaxis","yaxis","createFramework","map","styleObj","traceHash","layerList","belowLookup","dragging","wheeling","proto","prototype","plot","calcData","promises","self","promise","Promise","resolve","reject","createMap","updateMap","push","opts","getStyleObj","style","bounds","maxBounds","west","south","east","north","center","convertCenter","zoom","bearing","pitch","interactive","preserveDrawingBuffer","doubleClickZoom","boxZoom","attributionControl","addControl","AttributionControl","compact","requestedIcons","on","e","includes","img","Image","onload","addImage","crossOrigin","src","setTransformRequest","url","replace","_canvas","left","top","rejectOnError","initFx","once","concat","fetchTraceGeoData","all","then","fillBelowLookup","updateData","updateLayout","resolveOnRender","catch","JSON","stringify","setStyle","layers","i","val","hasTraceAtTop","length","trace","_module","below","getBelow","item","val2list","k","list","indexOf","split","traceType2orderIndex","choroplethmap","densitymap","scattermap","traceObj","j","calcDataSorted","slice","sort","a","b","type","calcTrace","didUpdate","update","dispose","ids","Object","keys","idLoop","setCenter","setZoom","setBearing","setPitch","updateLayers","updateFramework","updateFx","resize","_scrollZoom","scrollZoom","enable","disable","onRender","loaded","off","setTimeout","handler","Error","mapOnErrorMsg","document","createElement","position","appendChild","_id","c2p","v","project","x","y","mockAxis","showexponent","exponentformat","setConvert","evt","fullLayoutNow","originalEvent","optsNow","call","layout","_preGUI","getViewEdits","viewNow","getView","_input","emit","getViewEditsWithDerived","_rehover","bb","getBoundingClientRect","xy","offsetX","offsetY","target","p2c","unproject","lng","lat","_hoversubplot","hover","unhover","loneUnhover","_hoverlayer","emitUpdate","viewInitial","dragOptions","onClickInPanFn","clickMode","clickmode","click","invert","pxpy","obj","dragMode","dragmode","fillRangeItems","eventData","poly","isRect","ranges","range","xmin","ymin","xmax","ymax","dataPts","lassoPoints","oldDragOptions","extendDeep","element","plotinfo","domain","xaxes","yaxes","subplot","onClickInPanHandler","dragPan","prepFn","startX","startY","init","onmousedown","ontouchstart","removeEventListener","_ontouchstart","size","_size","width","w","height","h","l","t","_offset","_length","destroy","remove","removeChild","toImage","stop","getCanvas","toDataURL","setOptions","methodName","getMapLayers","getStyle","addLayer","mapLayers","warn","join","LngLat","mapCenter","getCenter","lon","canvas","parseInt","getZoom","getBearing","getPitch","_derived","coordinates","toArray","cont","isPlainObject","stylesMap","styleValueDflt","convertStyleVal","transition","duration","delay","styleUrlPrefix","styleUrlSuffix","module","exports"],"sources":["E:/tog_workspace/TestFabric_main/TestFabric-main/node_modules/plotly.js/src/plots/map/map.js"],"sourcesContent":["'use strict';\n\nvar maplibregl = require('maplibre-gl/dist/maplibre-gl-unminified');\n\nvar Lib = require('../../lib');\nvar geoUtils = require('../../lib/geo_location_utils');\nvar Registry = require('../../registry');\nvar Axes = require('../cartesian/axes');\nvar dragElement = require('../../components/dragelement');\n\nvar Fx = require('../../components/fx');\nvar dragHelpers = require('../../components/dragelement/helpers');\nvar drawMode = dragHelpers.drawMode;\nvar selectMode = dragHelpers.selectMode;\n\nvar prepSelect = require('../../components/selections').prepSelect;\nvar clearOutline = require('../../components/selections').clearOutline;\nvar clearSelectionsCache = require('../../components/selections').clearSelectionsCache;\nvar selectOnClick = require('../../components/selections').selectOnClick;\n\nvar constants = require('./constants');\nvar createMapLayer = require('./layers');\n\nfunction Map(gd, id) {\n    this.id = id;\n    this.gd = gd;\n\n    var fullLayout = gd._fullLayout;\n    var context = gd._context;\n\n    this.container = fullLayout._glcontainer.node();\n    this.isStatic = context.staticPlot;\n\n    // unique id for this Map instance\n    this.uid = fullLayout._uid + '-' + this.id;\n\n    // create framework on instantiation for a smoother first plot call\n    this.div = null;\n    this.xaxis = null;\n    this.yaxis = null;\n    this.createFramework(fullLayout);\n\n    // state variables used to infer how and what to update\n    this.map = null;\n    this.styleObj = null;\n    this.traceHash = {};\n    this.layerList = [];\n    this.belowLookup = {};\n    this.dragging = false;\n    this.wheeling = false;\n}\n\nvar proto = Map.prototype;\n\nproto.plot = function(calcData, fullLayout, promises) {\n    var self = this;\n\n    var promise;\n\n    if(!self.map) {\n        promise = new Promise(function(resolve, reject) {\n            self.createMap(calcData, fullLayout, resolve, reject);\n        });\n    } else {\n        promise = new Promise(function(resolve, reject) {\n            self.updateMap(calcData, fullLayout, resolve, reject);\n        });\n    }\n\n    promises.push(promise);\n};\n\nproto.createMap = function(calcData, fullLayout, resolve, reject) {\n    var self = this;\n    var opts = fullLayout[self.id];\n\n    // store style id and URL or object\n    var styleObj = self.styleObj = getStyleObj(opts.style);\n\n\n    var bounds = opts.bounds;\n    var maxBounds = bounds ? [[bounds.west, bounds.south], [bounds.east, bounds.north]] : null;\n\n    // create the map!\n    var map = self.map = new maplibregl.Map({\n        container: self.div,\n\n        style: styleObj.style,\n        center: convertCenter(opts.center),\n        zoom: opts.zoom,\n        bearing: opts.bearing,\n        pitch: opts.pitch,\n        maxBounds: maxBounds,\n\n        interactive: !self.isStatic,\n        preserveDrawingBuffer: self.isStatic,\n\n        doubleClickZoom: false,\n        boxZoom: false,\n\n        attributionControl: false\n    })\n    .addControl(new maplibregl.AttributionControl({\n        compact: true\n    }));\n\n    var requestedIcons = {};\n    map.on('styleimagemissing', function(e) {\n        var id = e.id;\n        if(!requestedIcons[id] && id.includes('-15')) {\n            requestedIcons[id] = true;\n            var img = new Image(15, 15);\n            img.onload = function() {\n                map.addImage(id, img);\n            };\n            img.crossOrigin = 'Anonymous';\n            img.src = 'https://unpkg.com/maki@2.1.0/icons/' + id + '.svg';\n        }\n    });\n\n    map.setTransformRequest(function(url) {\n        url = url.replace('https://fonts.openmaptiles.org/Open Sans Extrabold', 'https://fonts.openmaptiles.org/Open Sans Extra Bold');\n        url = url.replace('https://tiles.basemaps.cartocdn.com/fonts/Open Sans Extrabold', 'https://fonts.openmaptiles.org/Open Sans Extra Bold');\n        url = url.replace('https://fonts.openmaptiles.org/Open Sans Regular,Arial Unicode MS Regular', 'https://fonts.openmaptiles.org/Klokantech Noto Sans Regular');\n        return {\n            url: url\n        };\n    });\n\n\n    // make sure canvas does not inherit left and top css\n    map._canvas.style.left = '0px';\n    map._canvas.style.top = '0px';\n\n    self.rejectOnError(reject);\n\n    if(!self.isStatic) {\n        self.initFx(calcData, fullLayout);\n    }\n\n    var promises = [];\n\n    promises.push(new Promise(function(resolve) {\n        map.once('load', resolve);\n    }));\n\n    promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n\n    Promise.all(promises).then(function() {\n        self.fillBelowLookup(calcData, fullLayout);\n        self.updateData(calcData);\n        self.updateLayout(fullLayout);\n        self.resolveOnRender(resolve);\n    }).catch(reject);\n};\n\nproto.updateMap = function(calcData, fullLayout, resolve, reject) {\n    var self = this;\n    var map = self.map;\n    var opts = fullLayout[this.id];\n\n    self.rejectOnError(reject);\n\n    var promises = [];\n    var styleObj = getStyleObj(opts.style);\n\n    if(JSON.stringify(self.styleObj) !== JSON.stringify(styleObj)) {\n        self.styleObj = styleObj;\n        map.setStyle(styleObj.style);\n\n        // need to rebuild trace layers on reload\n        // to avoid 'lost event' errors\n        self.traceHash = {};\n\n        promises.push(new Promise(function(resolve) {\n            map.once('styledata', resolve);\n        }));\n    }\n\n    promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n\n    Promise.all(promises).then(function() {\n        self.fillBelowLookup(calcData, fullLayout);\n        self.updateData(calcData);\n        self.updateLayout(fullLayout);\n        self.resolveOnRender(resolve);\n    }).catch(reject);\n};\n\nproto.fillBelowLookup = function(calcData, fullLayout) {\n    var opts = fullLayout[this.id];\n    var layers = opts.layers;\n    var i, val;\n\n    var belowLookup = this.belowLookup = {};\n    var hasTraceAtTop = false;\n\n    for(i = 0; i < calcData.length; i++) {\n        var trace = calcData[i][0].trace;\n        var _module = trace._module;\n\n        if(typeof trace.below === 'string') {\n            val = trace.below;\n        } else if(_module.getBelow) {\n            // 'smart' default that depend the map's base layers\n            val = _module.getBelow(trace, this);\n        }\n\n        if(val === '') {\n            hasTraceAtTop = true;\n        }\n\n        belowLookup['trace-' + trace.uid] = val || '';\n    }\n\n    for(i = 0; i < layers.length; i++) {\n        var item = layers[i];\n\n        if(typeof item.below === 'string') {\n            val = item.below;\n        } else if(hasTraceAtTop) {\n            // if one or more trace(s) set `below:''` and\n            // layers[i].below is unset,\n            // place layer below traces\n            val = 'traces';\n        } else {\n            val = '';\n        }\n\n        belowLookup['layout-' + i] = val;\n    }\n\n    // N.B. If multiple layers have the 'below' value,\n    // we must clear the stashed 'below' field in order\n    // to make `traceHash[k].update()` and `layerList[i].update()`\n    // remove/add the all those layers to have preserve\n    // the correct layer ordering\n    var val2list = {};\n    var k, id;\n\n    for(k in belowLookup) {\n        val = belowLookup[k];\n        if(val2list[val]) {\n            val2list[val].push(k);\n        } else {\n            val2list[val] = [k];\n        }\n    }\n\n    for(val in val2list) {\n        var list = val2list[val];\n        if(list.length > 1) {\n            for(i = 0; i < list.length; i++) {\n                k = list[i];\n                if(k.indexOf('trace-') === 0) {\n                    id = k.split('trace-')[1];\n                    if(this.traceHash[id]) {\n                        this.traceHash[id].below = null;\n                    }\n                } else if(k.indexOf('layout-') === 0) {\n                    id = k.split('layout-')[1];\n                    if(this.layerList[id]) {\n                        this.layerList[id].below = null;\n                    }\n                }\n            }\n        }\n    }\n};\n\nvar traceType2orderIndex = {\n    choroplethmap: 0,\n    densitymap: 1,\n    scattermap: 2\n};\n\nproto.updateData = function(calcData) {\n    var traceHash = this.traceHash;\n    var traceObj, trace, i, j;\n\n    // Need to sort here by trace type here,\n    // in case traces with different `type` have the same\n    // below value, but sorting we ensure that\n    // e.g. choroplethmap traces will be below scattermap traces\n    var calcDataSorted = calcData.slice().sort(function(a, b) {\n        return (\n            traceType2orderIndex[a[0].trace.type] -\n            traceType2orderIndex[b[0].trace.type]\n        );\n    });\n\n    // update or create trace objects\n    for(i = 0; i < calcDataSorted.length; i++) {\n        var calcTrace = calcDataSorted[i];\n\n        trace = calcTrace[0].trace;\n        traceObj = traceHash[trace.uid];\n\n        var didUpdate = false;\n        if(traceObj) {\n            if(traceObj.type === trace.type) {\n                traceObj.update(calcTrace);\n                didUpdate = true;\n            } else {\n                traceObj.dispose();\n            }\n        }\n        if(!didUpdate && trace._module) {\n            traceHash[trace.uid] = trace._module.plot(this, calcTrace);\n        }\n    }\n\n    // remove empty trace objects\n    var ids = Object.keys(traceHash);\n    idLoop:\n    for(i = 0; i < ids.length; i++) {\n        var id = ids[i];\n\n        for(j = 0; j < calcData.length; j++) {\n            trace = calcData[j][0].trace;\n            if(id === trace.uid) continue idLoop;\n        }\n\n        traceObj = traceHash[id];\n        traceObj.dispose();\n        delete traceHash[id];\n    }\n};\n\nproto.updateLayout = function(fullLayout) {\n    var map = this.map;\n    var opts = fullLayout[this.id];\n\n    if(!this.dragging && !this.wheeling) {\n        map.setCenter(convertCenter(opts.center));\n        map.setZoom(opts.zoom);\n        map.setBearing(opts.bearing);\n        map.setPitch(opts.pitch);\n    }\n\n    this.updateLayers(fullLayout);\n    this.updateFramework(fullLayout);\n    this.updateFx(fullLayout);\n    this.map.resize();\n\n    if(this.gd._context._scrollZoom.map) {\n        map.scrollZoom.enable();\n    } else {\n        map.scrollZoom.disable();\n    }\n};\n\nproto.resolveOnRender = function(resolve) {\n    var map = this.map;\n\n    map.on('render', function onRender() {\n        if(map.loaded()) {\n            map.off('render', onRender);\n            // resolve at end of render loop\n            //\n            // Need a 10ms delay (0ms should suffice to skip a thread in the\n            // render loop) to workaround map-gl bug introduced in v1.3.0\n            setTimeout(resolve, 10);\n        }\n    });\n};\n\nproto.rejectOnError = function(reject) {\n    var map = this.map;\n\n    function handler() {\n        reject(new Error(constants.mapOnErrorMsg));\n    }\n\n    map.once('error', handler);\n    map.once('style.error', handler);\n    map.once('source.error', handler);\n    map.once('tile.error', handler);\n    map.once('layer.error', handler);\n};\n\nproto.createFramework = function(fullLayout) {\n    var self = this;\n\n    var div = self.div = document.createElement('div');\n    div.id = self.uid;\n    div.style.position = 'absolute';\n    self.container.appendChild(div);\n\n    // create mock x/y axes for hover routine\n    self.xaxis = {\n        _id: 'x',\n        c2p: function(v) { return self.project(v).x; }\n    };\n    self.yaxis = {\n        _id: 'y',\n        c2p: function(v) { return self.project(v).y; }\n    };\n\n    self.updateFramework(fullLayout);\n\n    // mock axis for hover formatting\n    self.mockAxis = {\n        type: 'linear',\n        showexponent: 'all',\n        exponentformat: 'B'\n    };\n    Axes.setConvert(self.mockAxis, fullLayout);\n};\n\nproto.initFx = function(calcData, fullLayout) {\n    var self = this;\n    var gd = self.gd;\n    var map = self.map;\n\n    // keep track of pan / zoom in user layout and emit relayout event\n    map.on('moveend', function(evt) {\n        if(!self.map) return;\n\n        var fullLayoutNow = gd._fullLayout;\n\n        // 'moveend' gets triggered by map.setCenter, map.setZoom,\n        // map.setBearing and map.setPitch.\n        //\n        // Here, we make sure that state updates amd 'plotly_relayout'\n        // are triggered only when the 'moveend' originates from a\n        // mouse target (filtering out API calls) to not\n        // duplicate 'plotly_relayout' events.\n\n        if(evt.originalEvent || self.wheeling) {\n            var optsNow = fullLayoutNow[self.id];\n            Registry.call('_storeDirectGUIEdit', gd.layout, fullLayoutNow._preGUI, self.getViewEdits(optsNow));\n\n            var viewNow = self.getView();\n            optsNow._input.center = optsNow.center = viewNow.center;\n            optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n            optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n            optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n            gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n        }\n        if(evt.originalEvent && evt.originalEvent.type === 'mouseup') {\n            self.dragging = false;\n        } else if(self.wheeling) {\n            self.wheeling = false;\n        }\n\n        if(fullLayoutNow && fullLayoutNow._rehover) {\n            fullLayoutNow._rehover();\n        }\n    });\n\n    map.on('wheel', function() {\n        self.wheeling = true;\n    });\n\n    map.on('mousemove', function(evt) {\n        var bb = self.div.getBoundingClientRect();\n        var xy = [\n            evt.originalEvent.offsetX,\n            evt.originalEvent.offsetY\n        ];\n\n        evt.target.getBoundingClientRect = function() { return bb; };\n\n        self.xaxis.p2c = function() { return map.unproject(xy).lng; };\n        self.yaxis.p2c = function() { return map.unproject(xy).lat; };\n\n        gd._fullLayout._rehover = function() {\n            if(gd._fullLayout._hoversubplot === self.id && gd._fullLayout[self.id]) {\n                Fx.hover(gd, evt, self.id);\n            }\n        };\n\n        Fx.hover(gd, evt, self.id);\n        gd._fullLayout._hoversubplot = self.id;\n    });\n\n    function unhover() {\n        Fx.loneUnhover(fullLayout._hoverlayer);\n    }\n\n    map.on('dragstart', function() {\n        self.dragging = true;\n        unhover();\n    });\n    map.on('zoomstart', unhover);\n\n    map.on('mouseout', function() {\n        gd._fullLayout._hoversubplot = null;\n    });\n\n    function emitUpdate() {\n        var viewNow = self.getView();\n        gd.emit('plotly_relayouting', self.getViewEditsWithDerived(viewNow));\n    }\n\n    map.on('drag', emitUpdate);\n    map.on('zoom', emitUpdate);\n\n    map.on('dblclick', function() {\n        var optsNow = gd._fullLayout[self.id];\n        Registry.call('_storeDirectGUIEdit', gd.layout, gd._fullLayout._preGUI, self.getViewEdits(optsNow));\n\n        var viewInitial = self.viewInitial;\n        map.setCenter(convertCenter(viewInitial.center));\n        map.setZoom(viewInitial.zoom);\n        map.setBearing(viewInitial.bearing);\n        map.setPitch(viewInitial.pitch);\n\n        var viewNow = self.getView();\n        optsNow._input.center = optsNow.center = viewNow.center;\n        optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n        optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n        optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n\n        gd.emit('plotly_doubleclick', null);\n        gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n    });\n\n    // define event handlers on map creation, to keep one ref per map,\n    // so that map.on / map.off in updateFx works as expected\n    self.clearOutline = function() {\n        clearSelectionsCache(self.dragOptions);\n        clearOutline(self.dragOptions.gd);\n    };\n\n    /**\n     * Returns a click handler function that is supposed\n     * to handle clicks in pan mode.\n     */\n    self.onClickInPanFn = function(dragOptions) {\n        return function(evt) {\n            var clickMode = gd._fullLayout.clickmode;\n\n            if(clickMode.indexOf('select') > -1) {\n                selectOnClick(evt.originalEvent, gd, [self.xaxis], [self.yaxis], self.id, dragOptions);\n            }\n\n            if(clickMode.indexOf('event') > -1) {\n                // TODO: this does not support right-click. If we want to support it, we\n                // would likely need to change map to use dragElement instead of straight\n                // map event binding. Or perhaps better, make a simple wrapper with the\n                // right mousedown, mousemove, and mouseup handlers just for a left/right click\n                // pie would use this too.\n                Fx.click(gd, evt.originalEvent);\n            }\n        };\n    };\n};\n\nproto.updateFx = function(fullLayout) {\n    var self = this;\n    var map = self.map;\n    var gd = self.gd;\n\n    if(self.isStatic) return;\n\n    function invert(pxpy) {\n        var obj = self.map.unproject(pxpy);\n        return [obj.lng, obj.lat];\n    }\n\n    var dragMode = fullLayout.dragmode;\n    var fillRangeItems;\n\n    fillRangeItems = function(eventData, poly) {\n        if(poly.isRect) {\n            var ranges = eventData.range = {};\n            ranges[self.id] = [\n                invert([poly.xmin, poly.ymin]),\n                invert([poly.xmax, poly.ymax])\n            ];\n        } else {\n            var dataPts = eventData.lassoPoints = {};\n            dataPts[self.id] = poly.map(invert);\n        }\n    };\n\n    // Note: dragOptions is needed to be declared for all dragmodes because\n    // it's the object that holds persistent selection state.\n    // Merge old dragOptions with new to keep possibly initialized\n    // persistent selection state.\n    var oldDragOptions = self.dragOptions;\n    self.dragOptions = Lib.extendDeep(oldDragOptions || {}, {\n        dragmode: fullLayout.dragmode,\n        element: self.div,\n        gd: gd,\n        plotinfo: {\n            id: self.id,\n            domain: fullLayout[self.id].domain,\n            xaxis: self.xaxis,\n            yaxis: self.yaxis,\n            fillRangeItems: fillRangeItems\n        },\n        xaxes: [self.xaxis],\n        yaxes: [self.yaxis],\n        subplot: self.id\n    });\n\n    // Unregister the old handler before potentially registering\n    // a new one. Otherwise multiple click handlers might\n    // be registered resulting in unwanted behavior.\n    map.off('click', self.onClickInPanHandler);\n    if(selectMode(dragMode) || drawMode(dragMode)) {\n        map.dragPan.disable();\n        map.on('zoomstart', self.clearOutline);\n\n        self.dragOptions.prepFn = function(e, startX, startY) {\n            prepSelect(e, startX, startY, self.dragOptions, dragMode);\n        };\n\n        dragElement.init(self.dragOptions);\n    } else {\n        map.dragPan.enable();\n        map.off('zoomstart', self.clearOutline);\n        self.div.onmousedown = null;\n        self.div.ontouchstart = null;\n        self.div.removeEventListener('touchstart', self.div._ontouchstart);\n        // TODO: this does not support right-click. If we want to support it, we\n        // would likely need to change map to use dragElement instead of straight\n        // map event binding. Or perhaps better, make a simple wrapper with the\n        // right mousedown, mousemove, and mouseup handlers just for a left/right click\n        // pie would use this too.\n        self.onClickInPanHandler = self.onClickInPanFn(self.dragOptions);\n        map.on('click', self.onClickInPanHandler);\n    }\n};\n\nproto.updateFramework = function(fullLayout) {\n    var domain = fullLayout[this.id].domain;\n    var size = fullLayout._size;\n\n    var style = this.div.style;\n    style.width = size.w * (domain.x[1] - domain.x[0]) + 'px';\n    style.height = size.h * (domain.y[1] - domain.y[0]) + 'px';\n    style.left = size.l + domain.x[0] * size.w + 'px';\n    style.top = size.t + (1 - domain.y[1]) * size.h + 'px';\n\n    this.xaxis._offset = size.l + domain.x[0] * size.w;\n    this.xaxis._length = size.w * (domain.x[1] - domain.x[0]);\n\n    this.yaxis._offset = size.t + (1 - domain.y[1]) * size.h;\n    this.yaxis._length = size.h * (domain.y[1] - domain.y[0]);\n};\n\nproto.updateLayers = function(fullLayout) {\n    var opts = fullLayout[this.id];\n    var layers = opts.layers;\n    var layerList = this.layerList;\n    var i;\n\n    // if the layer arrays don't match,\n    // don't try to be smart,\n    // delete them all, and start all over.\n\n    if(layers.length !== layerList.length) {\n        for(i = 0; i < layerList.length; i++) {\n            layerList[i].dispose();\n        }\n\n        layerList = this.layerList = [];\n\n        for(i = 0; i < layers.length; i++) {\n            layerList.push(createMapLayer(this, i, layers[i]));\n        }\n    } else {\n        for(i = 0; i < layers.length; i++) {\n            layerList[i].update(layers[i]);\n        }\n    }\n};\n\nproto.destroy = function() {\n    if(this.map) {\n        this.map.remove();\n        this.map = null;\n        this.container.removeChild(this.div);\n    }\n};\n\nproto.toImage = function() {\n    this.map.stop();\n    return this.map.getCanvas().toDataURL();\n};\n\n// convenience wrapper to create set multiple layer\n// 'layout' or 'paint options at once.\nproto.setOptions = function(id, methodName, opts) {\n    for(var k in opts) {\n        this.map[methodName](id, k, opts[k]);\n    }\n};\n\nproto.getMapLayers = function() {\n    return this.map.getStyle().layers;\n};\n\n// convenience wrapper that first check in 'below' references\n// a layer that exist and then add the layer to the map,\nproto.addLayer = function(opts, below) {\n    var map = this.map;\n\n    if(typeof below === 'string') {\n        if(below === '') {\n            map.addLayer(opts, below);\n            return;\n        }\n\n        var mapLayers = this.getMapLayers();\n        for(var i = 0; i < mapLayers.length; i++) {\n            if(below === mapLayers[i].id) {\n                map.addLayer(opts, below);\n                return;\n            }\n        }\n\n        Lib.warn([\n            'Trying to add layer with *below* value',\n            below,\n            'referencing a layer that does not exist',\n            'or that does not yet exist.'\n        ].join(' '));\n    }\n\n    map.addLayer(opts);\n};\n\n// convenience method to project a [lon, lat] array to pixel coords\nproto.project = function(v) {\n    return this.map.project(new maplibregl.LngLat(v[0], v[1]));\n};\n\n// get map's current view values in plotly.js notation\nproto.getView = function() {\n    var map = this.map;\n    var mapCenter = map.getCenter();\n    var lon = mapCenter.lng;\n    var lat = mapCenter.lat;\n    var center = { lon: lon, lat: lat };\n\n    var canvas = map.getCanvas();\n    var w = parseInt(canvas.style.width);\n    var h = parseInt(canvas.style.height);\n\n    return {\n        center: center,\n        zoom: map.getZoom(),\n        bearing: map.getBearing(),\n        pitch: map.getPitch(),\n        _derived: {\n            coordinates: [\n                map.unproject([0, 0]).toArray(),\n                map.unproject([w, 0]).toArray(),\n                map.unproject([w, h]).toArray(),\n                map.unproject([0, h]).toArray()\n            ]\n        }\n    };\n};\n\nproto.getViewEdits = function(cont) {\n    var id = this.id;\n    var keys = ['center', 'zoom', 'bearing', 'pitch'];\n    var obj = {};\n\n    for(var i = 0; i < keys.length; i++) {\n        var k = keys[i];\n        obj[id + '.' + k] = cont[k];\n    }\n\n    return obj;\n};\n\nproto.getViewEditsWithDerived = function(cont) {\n    var id = this.id;\n    var obj = this.getViewEdits(cont);\n    obj[id + '._derived'] = cont._derived;\n    return obj;\n};\n\nfunction getStyleObj(val) {\n    var styleObj = {};\n\n    if(Lib.isPlainObject(val)) {\n        styleObj.id = val.id;\n        styleObj.style = val;\n    } else if(typeof val === 'string') {\n        styleObj.id = val;\n\n        if(constants.stylesMap[val]) {\n            styleObj.style = constants.stylesMap[val];\n        } else {\n            styleObj.style = val;\n        }\n    } else {\n        styleObj.id = constants.styleValueDflt;\n        styleObj.style = convertStyleVal(constants.styleValueDflt);\n    }\n\n    styleObj.transition = {duration: 0, delay: 0};\n\n    return styleObj;\n}\n\n// if style is part of the 'official' map values, add URL prefix and suffix\nfunction convertStyleVal(val) {\n    return constants.styleUrlPrefix + val + '-' + constants.styleUrlSuffix;\n}\n\nfunction convertCenter(center) {\n    return [center.lon, center.lat];\n}\n\nmodule.exports = Map;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script"}